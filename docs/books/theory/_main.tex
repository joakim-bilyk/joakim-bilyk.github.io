% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
%
\documentclass[
]{book}
\usepackage{amsmath,amssymb,amsfonts,mathabx}
\usepackage{lmodern}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  %\usepackage{unicode-math}
  %\defaultfontfeatures{Scale=MatchLowercase}
  %\defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
%\usepackage{fontspec}
%\setmainfont{Latin Modern Roman}
%\setmathrm{Cambria Math}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
% INSERT PACKAGES
\usepackage{imakeidx}
\makeindex
\usepackage{graphicx}
\usepackage[margin=1in]{geometry}
\usepackage{wrapfig}
\usepackage{graphics}
\usepackage{titling}
\usepackage{fancyhdr}
\pagenumbering{gobble}
\addtocontents{toc}{\protect\thispagestyle{empty}}
\addtocontents{title}{\protect\thispagestyle{empty}}

\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{5}
\usepackage{booktabs}
\usepackage{subfig}
\usepackage{float}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage[]{natbib}
\bibliographystyle{plainnat}
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Complete Theory},
  pdfauthor={Joakim Bilyk},
  pdfkeywords={probability theory, insurance mathematics, life insurance,
non-life insurance, stochastic differential equations.},
  hidelinks,
  pdfcreator={LaTeX via pandoc}}

\title{Complete Theory}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{Msc in Actuarial Mathematics}
\author{Joakim Bilyk}
\date{March 18, 2023}

\begin{document}
%\maketitle


{
%title
\begin{titlepage}
\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Defines a new command for the horizontal lines, change thickness here

\center % Center everything on the page
 
%----------------------------------------------------------------------------------------
%	HEADING SECTIONS
%----------------------------------------------------------------------------------------

\textsc{\LARGE University of Copenhagen}\\[4cm] % Name of your university/college
\textsc{\Large Msc in Actuarial Mathematics}\\[0.5cm] % Major heading such as course name
%\textsc{\large Assignment 1}\\[0.5cm] % Minor heading such as course title

%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\HRule \\[0.4cm]
{ \huge \bfseries \thetitle}\\[0.4cm] % Title of your document
\HRule \\[1.5cm]
 
%----------------------------------------------------------------------------------------
%	AUTHOR SECTION
%----------------------------------------------------------------------------------------

\begin{minipage}{0.4\textwidth}
\begin{flushleft} \large
\emph{Author:}\\
\textsc{\theauthor} \\
\end{flushleft}
\end{minipage}
~
\begin{minipage}{0.4\textwidth}
\begin{flushright} \large
\emph{Date:} \\
\textsc{\thedate} \\
\end{flushright}
\end{minipage}\\[2cm]

% If you don't want a supervisor, uncomment the two lines below and remove the section above
%\Large \emph{Author:}\\
%John \textsc{Smith}\\[3cm] % Your name

%----------------------------------------------------------------------------------------
%	DATE SECTION
%----------------------------------------------------------------------------------------

%{\large \thedate}\\[2cm] % Date, change the \today to a set date if you want to be precise

%----------------------------------------------------------------------------------------
%	LOGO SECTION
%----------------------------------------------------------------------------------------

\includegraphics[width = 0.45\textwidth]{logo_ku.png}% Include a department/university logo - this will require the graphicx package
 
%----------------------------------------------------------------------------------------

\vfill % Fill the rest of the page with whitespace
\end{titlepage}

\thispagestyle{empty}
\begin{center}
\textbf{\large Abstract}
\end{center}

This document contain a comprehensive outline of theory on probability theory and mathematical statistics applied in finance, life insurance and non-life insurance.

Keywords: \emph{probability theory, insurance mathematics, life insurance,
non-life insurance, stochastic differential equations.}
\vfill
\pagebreak

\setcounter{tocdepth}{3}
\tableofcontents
}
\thispagestyle{empty}
\newpage
\setcounter{page}{1}
\pagenumbering{arabic}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE]{\fontsize{10}{12} \selectfont\nouppercase{\rightmark\hfill\leftmark}}
\fancyhead[RO]{\fontsize{10}{12} \selectfont\nouppercase{\leftmark\hfill\rightmark}}
\fancyfoot[LE,RO]{\hfill\thepage\hfill}
\hypertarget{introduction}{%
\chapter{Introduction}\label{introduction}}

\hypertarget{abbreviations}{%
\section{Abbreviations}\label{abbreviations}}

Below is given the abbreviations used when referencing to books:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3235}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1471}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.5294}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
Chapter
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Abbreviation
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Source
\end{minipage} \\
\midrule()
\endhead
Basic Life Insurance Mathematics & & \\
Stochastic Processes in Life Insurance Mathematics & & \\
Life Insurance Mathematics & Asmussen & \emph{Risk and Insurance}: A Graduate Text by Soren Asmussen and Mogens Steffensen (2020). \\
& Bladt & Notes from lectures in Liv2. \\
Topics in Life Insurance Mathematics & Asmussen & \emph{Risk and Insurance}: A Graduate Text by Soren Asmussen and Mogens Steffensen (2020). \\
Continuous Time Finance & Bjork & \emph{Arbitrage Theory in Continuous Time (Fourth edition)} by Thomas Bjork, Oxford University Press (2019). \\
Basic Non-Life Insurance Mathematics & & \\
Stochastic Processes in Life Insurance Mathematics & & \\
Topics in Non-Life Insurance Mathematics & & \\
Probabilistic Machine Learning & \emph{None} & Slides from lectures. \\
Quantative Risk Management & & \\
Measure Theory & Bjork & \emph{Arbitrage Theory in Continuous Time (Fourth edition)} by Thomas Bjork, Oxford University Press (2019). \\
& Protter & \emph{Probability Essentials (2. edition)} by Jean Jacod and Philip Protter (2004). \\
Random Variables & Bjork & \emph{Arbitrage Theory in Continuous Time (Fourth edition)} by Thomas Bjork, Oxford University Press (2019). \\
& Hansen & \emph{Stochastic Processes} (2. edition) by Ernst Hansen (2021). \\
Discrete Time Stochastic Processes & Hansen & \emph{Stochastic Processes} (2. edition) by Ernst Hansen (2021). \\
Continuous Time Stochastic Processes & Bjork & \emph{Arbitrage Theory in Continuous Time (Fourth edition)} by Thomas Bjork, Oxford University Press (2019). \\
Stochastic Calculus & Bjork & \emph{Arbitrage Theory in Continuous Time (Fourth edition)} by Thomas Bjork, Oxford University Press (2019). \\
& Bladt & Notes from lectures in Liv2. \\
Linear Algebra & Wiki & Wikipedia \\
\bottomrule()
\end{longtable}

\hypertarget{to-do-reading}{%
\section{To-do reading}\label{to-do-reading}}

\begin{longtable}[]{@{}lll@{}}
\toprule()
Chapter & Note & Progress \\
\midrule()
\endhead
Liv2 & Properties of product integral & Done \\
& Phase-type distributions & Bevis 2.3 og 2.12 \\
& Interest Theory & \\
ML & Supervied learning & Done \\
& Training validating testing & Done \\
& Linear models & Finetune proofs \\
& Nonparametric regression & Done \\
QRM & Finish risk measures & \\
StokLiv & Week 1 & \\
StokLiv & Week 2 & \\
SkadeStok & Week 1 & \\
SkadeStok & Week 2 & \\
Liv1 & Week 1 & \\
Liv1 & Week 2 & \\
Nonlife1 & Week 1 & \\
Nonlife1 & Week 2 & \\
MI & Insert notes & Mangler indeks \\
Stok & Insert notes & Mangler indeks \\
\bottomrule()
\end{longtable}

\hypertarget{basic-life-insurance-mathematics}{%
\chapter{Basic Life Insurance Mathematics}\label{basic-life-insurance-mathematics}}

Noget indhold

\hypertarget{stochastic-processes-in-life-insurance-mathematics}{%
\chapter{Stochastic Processes in Life Insurance Mathematics}\label{stochastic-processes-in-life-insurance-mathematics}}

Noget indhold

\hypertarget{topics-in-life-insurance-mathematics}{%
\chapter{Topics in Life Insurance Mathematics}\label{topics-in-life-insurance-mathematics}}

\hypertarget{markov-jump-processes}{%
\section{Markov Jump Processes}\label{markov-jump-processes}}

Life insurance mathematics revolves arrow Markov processes in continuous time on some discrete (or at least countable) state space. This may in the simplest model be the life-death model or it can be a generalized life-death model with interest levels. In any case, we use Markov processes to determine the possible payments that may occur in the future or have occurred in the past. Let us start by define the Markov jump process as follows.

\textbf{Definition 2.1. (Bladt)} \emph{A continuous-time stochastic process \(\{X_t\}_{t\ge 0}\) taking values in a countable space \(E\) is called a Markov jump process\index{Markov jump process} with state space \(E\) if for all \(t_n>t_{n-1}>\cdots > t_1>0\) and \(i_n,i_{n-1},...,i_0\in E\) it holds that}

\[
P(X_{t_n}=i_n \ \vert\ X_{t_{n-1}}=i_{n-1},...,X_{t_1}=i_1,X_0=i_0)=P(X_{n-1}=i_n\ \vert\ X_{n-1}=i_{n-1}).
\]

It is seen that process have some property of ``forgetability'' in the sense that the jump to a fixed state at some future time only depends on the current state, not the sample path of \(X\). We may then define the transition probabilities\index{transition probabilities} as

\[
p_{ij}(s,t)=P(X_t=j\ \vert\ X_s=i),
\]

being the probability of the process being in state \(j\) at time \(t\) given that the process is in state \(i\) at time \(s\). This gives the natural transition matrix\index{transition matrix}

\[
\mathbf{P}(t,s)=\big\{p_{ij}(s,t)\big\}_{i,j\in E},\hspace{10pt} s\le t.
\]

In general, we study the time in-homogeneous models where the above is possibly different for any pair \(s\le t\). There does however exist the special case, where the probabilities only depends on the time \(h=t-s\). We call these time homogeneous Markov jump processes\index{time homogeneous Markov jump processes} and they have the form

\[
p_{ij}(t,s)=p_{ij}(t-s).
\]

I.e. the probability of jumping from \(i\) to \(j\) is the same so long the interval is the same length. Let us now define the transition intensities as below.

\textbf{Definition 2.2. (Bladt)} \emph{Assume that the limit}

\[
\mathbf{M}(s)=\big\{\mu_{ij}(s)\big\}_{i,j\in E}=\lim_{h\to 0_+}\frac{\mathbf{P}(s,s+h)+\mathbf{I}}{j}
\]

\emph{exist for all \(s\ge 0\). The matrices \(\mathbf{M}(s)\) are called intensity matrices\index{intensity matrices}. The the special case of time-homogenous processes we have \(\mathbf{M}(s)=\mathbf{M}\) is a constant matrix. }

We may interpret the intensity matrices in the infinitesimal interpretation as

\[
\mathbf{P}(s,s+h) = \mathbf{I}+h\mathbf{M}(s)+o(h),
\]

i.e.

\[
p_{ij}(s,s+h)=\delta_{ij}+\mu_{ij}(s)h+o(h),
\]

where \(\delta_{ij}=1_{i=j}\) is the Kronecker delta. We furthermore see, that the matrix \(\mathbf{M}(s)\) has non-positive diagonal and non-negative upper and lower triangle. Furthermore, the matrix has zero row sums and so it follows that

\[
\mu_{ii}(s)=-\sum_{j\ne i}\mu_{ij}(s):=-\mu_{i}(t),
\]

for all \(i\in E\). Returning to the infinitesimal interpretation we may write the dynamics of \(\mu_{ij}\) in the following manner

\[
d\mu_{ij}(t)=\mu_{ij}(t)\ dt=P(X_{t+dt}=j\ \vert\ X_t=i)
\]

i.e.~the probability of a jump from state \(i\) to state \(j\) during \([t,t+dt)\). On the other hand we have

\[
1-\mu_{ii}(t)\ dt=P(X_{t+dt}=i\ \vert\ X_t=i),
\]

i.e.~the probability that no jumps occur during \([t,t+dt)\). We can then define the conditional probability that a jump, if one occurs, is to state \(j\) from \(i\) as
\begin{align*}
q_{ij}(t)&=P(X_{t+dt}=j\ \vert\  X_t=i,X_{t+dt}\ne i)=\frac{P(X_{t+dt}=j\ \vert\  X_t=i)}{P(X_{t+dt}\ne i\ \vert\  X_t=i)}\\
&=\frac{\mu_{ij}(t)}{\mu_i(t)}=-\frac{\mu_{ij}(t)}{\mu_{ii}(t)}.
\end{align*}
We can now look at the time until the next jump as the random variable

\[
T(s)=\inf\left\{u\ge 0\ :\ X_{s+u}\ne X_s\right\},
\]

i.e.~\(T(s)\) is a positive random variable. If we condition on \(X_s=i\) then \(T(s)\ \vert\ X_s=i\) is the time until \(X\) jumps out of state \(i\) into some other state \(j\ne i\). If we set \(S_i(t)=P(T(s)>t\ \vert\ X_s=i)\) and \(f_i(t)\) is the density of \(T(s)\ \vert\ X_s=i\), then we have

\[
\mu_i(u)=\frac{f_i(u)}{S_i(u)}=-\frac{S'_i(u)}{S_i(u)}=-\frac{d}{du}\log(S_i(u))
\]

which is solved for

\[
S_i(t)=P(T(s)>t\ \vert\ X_s=i)=\exp\left(-\int_s^t \mu_i(u)\ du\right)
\]

and then

\[
f_i(t)=\exp\left(-\int_s^t \mu_i(u)\ du\right)\mu_i(t).
\]

\textbf{Theorem 2.3. (Bladt)} \textbf{(Kolmogorov' Differential Equations)}\index{Kolmogorov' Differential Equations} \emph{Relation between \(\mathbf{M}(s)\) and \(\mathbf{P}(s,t)\) are given by Kolmogorov' forward and backward differential equations:}

\[
\frac{\partial}{\partial s}\mathbf{P}(s,t)=-\mathbf{M}(s)\mathbf{P}(s,t)
\]

and

\[
\frac{\partial}{\partial t}\mathbf{P}(s,t)=\mathbf{P}(s,t)\mathbf{M}(t).
\]

\emph{the soluction of which is given by}

\[
\mathbf{P}(s,t)=\prod_s^t(\mathbf{I}+\mathbf{M}(x)\ dx).
\]

\emph{In the time-homogeneous case we have that}

\[
\frac{d}{d t}\mathbf{P}(t)=\mathbf{M}\mathbf{P}(t)=\mathbf{P}(t)\mathbf{M}
\]

\emph{with solution}

\[
\mathbf{P}(t)=\exp(\mathbf{M}t).
\]

\textbf{Proof.}

We may subdivide the interval \([s,t]\) into \([s,u]\) and \([u,t]\) and use theorem 1.5 from the chapter on Product Integrals to obtain the Chapman-Kolmogorov's\index{Chapman-Kolmogorov's} equation

\[
\mathbf{P}(s,t)=\mathbf{P}(s,u)\mathbf{P}(u,t)
\]

and in the time homogeneous case we have

\[
\mathbf{P}(s+t)=\mathbf{P}(s)\mathbf{P}(t).
\]

Finally, let us define a stopping time and introduce the strong markov property.

\textbf{Definition 2.4. (Bladt)} \textbf{(Stopping time)}\index{Stopping time} \emph{Let \(X\) be a Markov jump process and let \(\mathcal{F}_t=\sigma(X_s\ :\ s\le t)\). A nonnegative random variable \(\tau\) is called a stopping time for \(X\) of \(\{\tau \le t\}\in\mathcal{F}_t\) for all \(t\).}\textbackslash{}
\emph{The \(\sigma\)-algebra of the process up to a stopping time \(\tau\), \(\mathcal{F}_\tau\), is defined by the measurable sets \(A\) for which}

\[
\forall t\ge 0 : A\cap \{\tau\le t\}\in\mathcal{F}_t.
\]

We see that a stopping time in an intuitive sense is a random variable which at any time \(t\) we know either that the stopping time is in the future i.e.~\(\tau > t\) or that the stopping time already occured and so \(\tau\) becomes known at time \(t\). Furthermore, we see that \(\{\tau \le t\}\) is \(\mathcal{F}_t\) measurable and so we only need information from the Markov jump process in order to determine the above.

\textbf{Theorem 2.5. (Bladt)} \textbf{(Strong Markov property)}\index{Strong Markov property} \emph{Every Markov jump process satisfies the strong Markov property, i.e., for all \(0\le h_1\le h_2\le \cdots \le h_n\), we have that}

\[
P(X_{\tau +h_1}=i_1,...,X_{\tau + h_n}=i_n\ \vert\ \mathcal{F}_t)=P(X_{\tau +h_1}=i_1,...,X_{\tau + h_n}=i_n\ \vert\ X_\tau)
\]

\emph{on \(\{\tau <\infty\}\). For time-homogeneous processes this further reduces to}

\[
P(X_{\tau +h_1}=i_1,...,X_{\tau + h_n}=i_n\ \vert\ \mathcal{F}_t)=P_{X_\tau}(X_{\tau +h_1}=i_1,...,X_{\tau + h_n}=i_n)
\]

\emph{also on \(\{\tau <\infty\}\).}

\hypertarget{phase-type-distributions}{%
\section{Phase-type distributions}\label{phase-type-distributions}}

In life insurance models we often, that is always, have a model with one absorbing state, namely, \emph{death}. This means that the state space \(E\) will have the form of \(p\ge 1\) transient states (states that may interact in both ways) and one absorbing state (a state that is never moved away from). In this case we would often like to study the distribution of

\[
\inf\{t\ge 0 : X(t)=p+1\},
\]

where \(p+1\) is the absorbing state and \(1,...,p\) are the transient states. We will assume that \(P(X(0)=p+1)=0\) i.e.~the above is at least zero and never \(-\infty\). Let us now formalise this setup.

Consider a time-inhomogeneous Markov jump process \(\{X_t\}_{t\ge 0}\) on the finite state-space \(E=\{1,...,p,p+1\}\) where the states \(1,...,p\) are transient states and \(p+1\) is the only absorbing state. This implies that the intesity matrix of \(\{X_t\}_{t\ge 0}\) take the form

\[
\Lambda(t)=\begin{bmatrix}
\mathbf{T}(t) & \mathbf{t}(t)\\
\mathbf{0} & 0
\end{bmatrix}.
\]

In the above \(\mathbf{T}(t)\) is a \(p\times p\) matrix function and \(\mathbf{t}(t)\) is a \(p\times 1\) matrix function. We now define the initial distribution of \(X_0\) as

\[
\{P(X_0=i)\}_{i\in E\setminus \{p+1\}}=\mathbf{\pi}=\begin{pmatrix}\pi_1\\ \vdots\\ \pi_p\end{pmatrix}^\top.
\]

By assumption we have \(P(X_0=p+1)=0\) and so \(\sum_{i=1}^p\pi_i=1\) and \(\mathbf{\pi}\) is a proper distribution.

\textbf{Definition 2.10. (Bladt)} \textbf{(Phase-Type distribution)}\index{Phase-Type distribution} \emph{Let}

\[
\tau = \inf\{t\ge 0 : X(t)=p+1\}
\]

\emph{denote the time until absorption of \(X\). The distribution of \(\tau\) is then said to be an inhomogeneous phase-type distribution with representation \((\mathbf{\pi},\mathbf{T}(t))\) and we write \(\tau \sim IPH(\mathbf{\pi},\mathbf{T}(t))\).}

\textbf{Lemma 2.11. (Bladt)} \emph{We have the following decomposition:}

\[
\mathbf{P}(s,t)=\prod_s^t(\mathbf{I}+\mathbf{\Lambda}(u)\ du)=
\begin{bmatrix}
\prod_s^t(\mathbf{I}+\mathbf{T}(u)\ du) & \mathbf{e} -\prod_s^t(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{e}\\
\mathbf{0} & 1
\end{bmatrix},
\]

\emph{where \(\mathbf{e}=(1,1,...,1)^\top\).}

\textbf{Theorem 2.12. (Bladt)} \emph{Assume that \(\tau \sim IPH(\mathbf{\pi},\mathbf{T}(t))\). Then the density \(f\) and the distribution function \(F\) of \(\tau\) are given by}
\begin{align*}
f(x)&=\mathbf{\pi}\prod_0^x(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{t}(x),\\
F(x)&=1-\mathbf{\pi}\prod_0^x(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{e}.
\end{align*}

\textbf{Proof.}

\textbf{Theorem 2.13. (Bladt)} \emph{If \(\tau \sim IPH(\mathbf{\pi},\mathbf{T}(t))\) then}

\[
P(\tau >s+t\ \vert\ \tau >s)=\frac{\mathbf{\pi}\prod_0^s(\mathbf{I}+\mathbf{T}(u)\ du)}{\mathbf{\pi}\prod_0^s(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{e}}\prod_s^t(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{e}
\]

\emph{so that}

\[
\tau-s\ \vert\ \{\tau>s\}\sim IPH(\mathbf{\alpha},\mathbf{S}(\cdot)),
\]

\emph{where \(\mathbf{S}(u)=\mathbf{T}(s+u)\) and }

\[
\mathbf{\alpha}=\frac{\mathbf{\pi}\prod_0^s(\mathbf{I}+\mathbf{T}(u)\ du)}{\mathbf{\pi}\prod_0^s(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{e}}.
\]

\textbf{Corollary 2.14. (Bladt)} \emph{If \(\tau\sim IPH(\mathbf{\alpha},\mathbf{T}(t))\) and \(\mathbf{T}(t_1)\) and \(\mathbf{T}(t_2)\) commute for all \(t_1,t_2\ge 0\), then the density \(f\) and the distribution function \(F\) of \(\tau\) are given by}
\begin{align*}
f(x)&=\mathbf{\pi}\exp\left(\int_0^x\mathbf{T}(u)\ du\right)\mathbf{t}(x),\\
F(x)&=1-\mathbf{\pi}\exp\left(\int_0^x\mathbf{T}(u)\ du\right)\mathbf{e}.
\end{align*}

\textbf{Example (Approximation in time-inhomogeneous case).}

Consider the Markov jump process on the state space \(E=\{1,2,3\}\) where 1 is the state \emph{``alive''} (working), 2 is \emph{``disabled''} and 3 is the state \emph{``death''}. We assume that \(\Lambda(t)\) has the structure:
\begin{align*}
\Lambda(t)&=\begin{bmatrix}
\mu_{11}(t) & \mu_{12}(t) & \mu_{13}(t)\\
\mu_{21}(t) & \mu_{22}(t) & \mu_{23}(t)\\
\mu_{31}(t) & \mu_{32}(t) & \mu_{33}(t)
\end{bmatrix}\\
&=
\begin{bmatrix}
-\mu_{12}(t)-\mu_{13}(t) &  0.000015 + 10^{(4.6-10+0.015\cdot t)} & 0.00005 + 10^{(4.6-10+0.05\cdot t)}\\
0.000005 + 10^{(4.6-10+0.015\cdot t)} & -\mu_{21}(t)-\mu_{23}(t) & 0.0001 + 10^{(4.6-10+0.05\cdot t)}\\
0 & 0 & 0
\end{bmatrix}
\end{align*}
We can now implement this intensity matrix as a function in R:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mu12 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FloatTok{0.000015} \SpecialCharTok{+} \DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\FloatTok{4.6}\DecValTok{{-}10}\FloatTok{+0.015}\SpecialCharTok{*}\NormalTok{t)}
\NormalTok{\}}
\NormalTok{mu13 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FloatTok{0.00005} \SpecialCharTok{+} \DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\FloatTok{4.6}\DecValTok{{-}10}\FloatTok{+0.05}\SpecialCharTok{*}\NormalTok{t)}
\NormalTok{\}}
\NormalTok{mu11 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \SpecialCharTok{{-}}\FunctionTok{mu12}\NormalTok{(t)}\SpecialCharTok{{-}}\FunctionTok{mu13}\NormalTok{(t)}
\NormalTok{\}}
\NormalTok{mu21 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FloatTok{0.000005} \SpecialCharTok{+} \DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\FloatTok{4.6}\DecValTok{{-}10}\FloatTok{+0.015}\SpecialCharTok{*}\NormalTok{t)}
\NormalTok{\}}
\NormalTok{mu23 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FloatTok{0.0001} \SpecialCharTok{+} \DecValTok{10}\SpecialCharTok{\^{}}\NormalTok{(}\FloatTok{4.6}\DecValTok{{-}10}\FloatTok{+0.05}\SpecialCharTok{*}\NormalTok{t)}
\NormalTok{\}}
\NormalTok{mu22 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \SpecialCharTok{{-}}\FunctionTok{mu21}\NormalTok{(t)}\SpecialCharTok{{-}}\FunctionTok{mu23}\NormalTok{(t)}
\NormalTok{\}}
\NormalTok{mu31 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}\DecValTok{0}\NormalTok{\}}
\NormalTok{mu32 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}\DecValTok{0}\NormalTok{\}}
\NormalTok{mu33 }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}\DecValTok{0}\NormalTok{\}}
\NormalTok{M }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FunctionTok{matrix}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FunctionTok{mu11}\NormalTok{(t),}\FunctionTok{mu21}\NormalTok{(t),}\FunctionTok{mu31}\NormalTok{(t),}
      \FunctionTok{mu12}\NormalTok{(t),}\FunctionTok{mu22}\NormalTok{(t),}\FunctionTok{mu32}\NormalTok{(t),}
      \FunctionTok{mu13}\NormalTok{(t),}\FunctionTok{mu23}\NormalTok{(t),}\FunctionTok{mu33}\NormalTok{(t)),}
    \AttributeTok{ncol =} \DecValTok{3}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{M}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               [,1]          [,2]         [,3]
## [1,] -7.296214e-05  1.898107e-05 5.398107e-05
## [2,]  8.981072e-06 -1.129621e-04 1.039811e-04
## [3,]  0.000000e+00  0.000000e+00 0.000000e+00
\end{verbatim}

We see that the intensities is choosen such that the following holds for any time interval \([t,t+dt)\)

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The transition \(1\to 3\) is less likely than \(2\to 3\),
\item
  The transition \(2\to 1\) is less likely than \(1\to 2\),
\item
  The transition \(1\to 2\) is less likely than \(1\to 3\).
\end{enumerate}

We now wish to compute the density and distribution of

\[
\tau =\inf\{t\ge 0\ :\ X(t)=3\}.
\]

We assume that \(\pi=(1,0)\) i.e.~the person is alive. Calculating the distribution of \(\tau\) is then the distribution of the length of a newborn child lifespan. From theorem 2.12 this ammount to calculating the product integral of

\[
\mathbf{T}(t)=\{\mu_{ij}(t)\}_{i,j\in \{1,2\}}
\]

i.e.~

\[
\prod_0^x(\mathbf{I}+\mathbf{T}(u)\ du).
\]

To du this we simply approximate with stepsize \(h=1/n\) (for some \(n\ge 1\)) by

\[
\prod_0^{x+h}(\mathbf{I}+\mathbf{T}(u)\ du)=h\prod_0^x(\mathbf{I}+\mathbf{T}(u)\ du)\mathbf{T}(x)+\prod_0^x(\mathbf{I}+\mathbf{T}(u)\ du),
\]

and

\[
\prod_0^0(\mathbf{I}+\mathbf{T}(u)\ du)=\mathbf{I}.
\]

This is done in the code below

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{12} \CommentTok{\#monthly}
\NormalTok{h }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{/}\NormalTok{n}
\NormalTok{N }\OtherTok{\textless{}{-}} \DecValTok{120} \CommentTok{\#max number years}
\NormalTok{T\_matrix }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FunctionTok{matrix}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FunctionTok{mu11}\NormalTok{(t),}\FunctionTok{mu21}\NormalTok{(t),}
      \FunctionTok{mu12}\NormalTok{(t),}\FunctionTok{mu22}\NormalTok{(t)),}
    \AttributeTok{ncol =} \DecValTok{2}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{T\_matrix}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##               [,1]          [,2]
## [1,] -7.296214e-05  1.898107e-05
## [2,]  8.981072e-06 -1.129621e-04
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{t\_matrix }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(t) \{}
  \FunctionTok{matrix}\NormalTok{(}
    \FunctionTok{c}\NormalTok{(}\FunctionTok{mu13}\NormalTok{(t),}\FunctionTok{mu23}\NormalTok{(t)),}
    \AttributeTok{ncol=}\DecValTok{1}
\NormalTok{  )}
\NormalTok{\}}
\FunctionTok{t\_matrix}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##              [,1]
## [1,] 5.398107e-05
## [2,] 1.039811e-04
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{library}\NormalTok{(rlist)}
\CommentTok{\#Initial condition t=0}
\NormalTok{T\_product\_integral }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)))}
\NormalTok{pi }\OtherTok{\textless{}{-}} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{),}\AttributeTok{ncol =} \DecValTok{1}\NormalTok{)}
\NormalTok{f }\OtherTok{\textless{}{-}} \FunctionTok{t}\NormalTok{(pi) }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%*\%} \FunctionTok{t\_matrix}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\NormalTok{F }\OtherTok{\textless{}{-}} \DecValTok{1}\SpecialCharTok{{-}}\FunctionTok{t}\NormalTok{(pi) }\SpecialCharTok{\%*\%} \FunctionTok{diag}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)) }\SpecialCharTok{\%*\%} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{ncol =} \DecValTok{1}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ (i }\ControlFlowTok{in} \DecValTok{1}\SpecialCharTok{:}\NormalTok{(N}\SpecialCharTok{*}\NormalTok{n)) \{}
\NormalTok{  x\_1 }\OtherTok{\textless{}{-}}\NormalTok{ i}\SpecialCharTok{/}\NormalTok{n}
\NormalTok{  x\_0 }\OtherTok{\textless{}{-}}\NormalTok{ (i}\DecValTok{{-}1}\NormalTok{)}\SpecialCharTok{/}\NormalTok{n}
\NormalTok{  T\_0 }\OtherTok{\textless{}{-}} \FunctionTok{T\_matrix}\NormalTok{(x\_0)}
\NormalTok{  M\_0 }\OtherTok{\textless{}{-}}\NormalTok{ T\_product\_integral[[i]]}
\NormalTok{  M\_1 }\OtherTok{\textless{}{-}}\NormalTok{ h}\SpecialCharTok{*}\NormalTok{M\_0 }\SpecialCharTok{\%*\%}\NormalTok{ T\_0 }\SpecialCharTok{+}\NormalTok{ M\_0}
\NormalTok{  T\_product\_integral }\OtherTok{\textless{}{-}} \FunctionTok{list.append}\NormalTok{(T\_product\_integral,M\_1)}
\NormalTok{  f }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(f,}\FunctionTok{t}\NormalTok{(pi) }\SpecialCharTok{\%*\%}\NormalTok{ M\_1 }\SpecialCharTok{\%*\%} \FunctionTok{t\_matrix}\NormalTok{(x\_1))}
\NormalTok{  F }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(F,}\DecValTok{1}\SpecialCharTok{{-}}\FunctionTok{t}\NormalTok{(pi) }\SpecialCharTok{\%*\%}\NormalTok{ M\_1 }\SpecialCharTok{\%*\%} \FunctionTok{matrix}\NormalTok{(}\FunctionTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{),}\AttributeTok{ncol =} \DecValTok{1}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=0.48\textwidth]{figures/ex1_PT_dist.png}
  \end{center}
\end{figure}

We see that by calculating

\[
E[\tau\ \vert\ X_0=1]=\int_0^\infty \tau f(\tau)\ d\tau\approx\int_0^{120}\tau f(\tau)\ d\tau\approx\frac{1}{n}\sum_{i=0}^{120\cdot n} i/n\cdot f(i/n).
\]

that the life expectation is 84.01 years. We have that we may approximate \(f\) and \(F\) with an arbitrary precision by choosing \(n\) appropriately. \(\square\)

I practice we may have alot complications in calculating the product integral of \(\mathbf T\) as the matrix may have large dimensions, be non-cummative, encounter alternating sums with growing terms and obviously being time in-homogeneous. So one has to be smart when constructing numerical methods in computing the integral. We will briefly consider some considerations an implementer may use in calculating the product integral.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Applying differential equation.} Assume that \(X\) is a time in-homogeneous markov jump process then we may always calculate \(\prod_s^t(\mathbf I + \mathbf T(x)\ dx)\) using a stepwise argument:
  \[
    \prod_s^t(\mathbf I + \mathbf T(x)\ dx)=\prod_s^{s+1\cdot (t-s)/n}(\mathbf I + \mathbf T(x)\ dx)\prod_s^{s+2\cdot (t-s)/n}(\mathbf I + \mathbf T(x)\ dx)\cdots\prod_s^{t}(\mathbf I + \mathbf T(x)\ dx)
    \]
  for some \(n\ge 1\). In particular one can simply choose \(n\) large enough such that the increments is approximately linear and so this is a brute force methods (see example above).
\item
  \textbf{Piece wise constant matrix.} Since data is scarce it often occur that mortality rates are constant over at least a monthly timeline hence one may assume that \(\Lambda\) is piecewise constant for some fine grid. This in particular means that if the grid has size \(1/n\) (for instance \(n=12\) or \(n=4\)) we have
  \[
    \prod_s^{s+1/n}(\mathbf I + \mathbf T(x)\ dx)=\mathbf{I}e^{\mathbf{T}(s)\frac{1}{n}}=e^{\mathbf{T}(s)\frac{1}{n}}.
    \]
  and so the above reduces to
  \[
    \prod_s^t(\mathbf I + \mathbf T(x)\ dx)=e^{\mathbf{T}(s)\frac{1}{n}}e^{\mathbf{T}(s+1/n)\frac{1}{n}}\cdots e^{\mathbf{T}(t-1/n)\frac{1}{n}},
    \]
  assuming that \(s\) and \(t\) are integers (one could make this more general).
\item
  \textbf{Diagonalization.} Assume that \(\mathbf{T}(x)\) is constant on some interval \([s,t]\) and that for the constant matrix \(\mathbf{T}:=\mathbf{T}(s)\) there exist unique eigenvalues \(\lambda_1,...,\lambda_p\). Then we can diagonalize \(\mathbf{T}\) as
  \[
    \mathbf{T}=\mathbf{B}\mathbf{D}\mathbf{B}^{-1},
    \]
  where as usual \(\mathbf{D}=\text{diag}(\lambda_1,...,\lambda_p)\) and \(\mathbf{B}\) is a \(p\times p\) matrix with columns of eigenvectors for \(\lambda_1,...,\lambda_p\). In this case we can calculate
  \begin{align*}
    \prod_s^t(\mathbf I + \mathbf T(x)\ dx)&=e^{\mathbf{T}(t-s)}=e^{\mathbf{B}\mathbf{D}\mathbf{B}^{-1}(t-s)}=\sum_{n=0}^\infty \frac{\left(\mathbf{B}\mathbf{D}\mathbf{B}^{-1}\right)^n(t-s)^n}{n!}\\
    &=\sum_{n=0}^\infty \frac{\mathbf{B}\mathbf{D}\mathbf{B}^{-1}\mathbf{B}\mathbf{D}\mathbf{B}^{-1}\cdots \mathbf{B}\mathbf{D}\mathbf{B}^{-1}\mathbf{B}\mathbf{D}\mathbf{B}^{-1}(t-s)^n}{n!}\\
    &=\sum_{n=0}^\infty \frac{\mathbf{B}\mathbf{D}^n\mathbf{B}^{-1}(t-s)^n}{n!}=\mathbf{B}\left(\sum_{n=0}^\infty \frac{\mathbf{D}^n(t-s)^n}{n!}\right)\mathbf{B}^{-1}\\
    &=\mathbf{B}\left(\sum_{n=0}^\infty \frac{\text{diag}(\lambda_1^n(t-s)^n,...,\lambda_p^n(t-s)^n)}{n!}\right)\mathbf{B}^{-1}\\
    &=\mathbf{B}\text{diag}\left(\sum_{n=0}^\infty \frac{\lambda_1^n(t-s)^n}{n!},...,\sum_{n=0}^\infty \frac{\lambda_p^n(t-s)^n}{n!}\right)\mathbf{B}^{-1}\\
    &=\mathbf{B}\text{diag}\left(e^{\lambda_1(t-s)},...,e^{\lambda_p(t-s)}\right)\mathbf{B}^{-1}.
    \end{align*}
  which is much easier than any approximation. This is however a unrealisitic expectations to have.
\item
  \textbf{Univerformization.}\index{Univerformization} Assume that \(\mathbf{T}(x)\) is constant on some interval \([s,t]\) and define \(\mathbf{T}:=\mathbf{T}(s)\). We may furthermore define \(\lambda= \max_{i}(-\lambda_{ii})\) as the largest diagonal entry in \(\mathbf T\) (\(\lambda <0\)). We now set
  \[
    \mathbf P = \mathbf I + \lambda^{-1}\mathbf T,
    \]
  and see that \(\mathbf P\) is a transition matrix i.e.~rowsums is 1 and the the diagonals \(0\le p_{ii}\le 1\). We see this as \(0\le \lambda^{-1}\lambda_{ii}\le1\) as \(\lambda_{ii}\le 0\) for all \(i\) and \(\lambda\ge 0\) and dominates all diagonal entries. The rowsums is 1 as \(\mathbf T\) is a intensity matrix i.e.~rowsums is 0 and so adding one to the diagonal of the scaled matrix gives a rowsum of 1. We can now rearrange and see that
  \begin{align*}
    \prod_s^t(\mathbf I + \mathbf T(x)\ dx)&=e^{\mathbf{T}(t-s)}=e^{\lambda (\mathbf P - \mathbf I)(t-s)}=e^{\lambda \mathbf P (t-s)}e^{-\lambda \mathbf I(t-s)}\\
    &=e^{\lambda \mathbf P (t-s)}\mathbf Ie^{-\lambda (t-s)}=e^{-\lambda (t-s)}e^{\lambda \mathbf P (t-s)}\\
    &=e^{-\lambda (t-s)}\sum_{n=0}^\infty \frac{(t-s)^n}{n!}\mathbf{P}^n.
    \end{align*}
  This is nice since \(\mathbf P\) has entries in the interval \([0,1]\) and so the series above converges and is monotonic, so we avoid the alternating sums from the negative diagonal in \(\mathbf T\).
\item
  \textbf{Scaling and squaring argument.}\index{Scaling and squaring argument} Assuming the setup above. If the interval \((t-s)\) is large we may apply a scaling and squaring argument by setting
  \[
    e^{\mathbf T(t-s)}=\mathbf{S}^{2^n},\hspace{15pt}\mathbf{S}=e^{\mathbf T (t-s)2^{-n}}.
    \]
  This ensures small entries in the matrix \(S\) and we can simply square \(\mathbf S\) \(n\) times after approximating \(\mathbf S\) numerically.
\end{enumerate}

\hypertarget{interest-rates}{%
\section{Interest rates}\label{interest-rates}}

\hypertarget{basic-definitions-and-properties}{%
\subsection{Basic definitions and properties}\label{basic-definitions-and-properties}}

In money markets interest is derived from the short term rate \(r\) that is a continuously compounded interest rate i.e.~a bank account \(B(t)\)\index{bank account} is on the form

\[
B(t)=B(0)e^{\int_0^tr(u)\ du}
\]

where we will by convention assume \(B(0)=1\). Let us define what we will require for the process \(r\).

\textbf{Definition. (Interest rate process)}\index{Interest rate process} \emph{A stochastic process \(\{r(t)\}_{t\ge 0}\) is an interest rate process if and only if \(r(t)\) is adapted to some filtration \(\mathcal F_t\) on the probability space \((\Omega,\mathcal F,\mathbb P)\).}

This in particular means that in theory we may construct the rate as a diffusion process, piecewise constant function jumping at random times and so forth. The class of possible rate process is large but few is realistic. We will in the following think of \(r\) generally as a given process which we only assume is adapted to some filtration \(\mathcal F\). The most important price process other than the bank account is the zero-coupon bond.

\textbf{Definition. (Zero-Coupon Bond)}\index{Zero-Coupon Bond} \emph{A zero-coupon bond with maturity \(T\) with underlying interest rate process \(r(t)\) is a security which at time \(T\) pays the holder 1 and the price of the claim at time \(0\le t\le T\), \(B(t,T)\), satisfies}

\[
\left\{\frac{B(t,T)}{B_t}\right\}_{0\le t\le T},
\]

\emph{is a \(\mathbb Q\)-martingale measure for some equivalent martingale measure \(\mathbb Q\sim \mathbb P\) (including \(\mathbb Q = \mathbb P\)).}

We can in particular deduce the price process under a \(\mathbb Q\)-expectation by the equation

\[
E^{\mathbb Q}\left[\left.\frac{1}{B_T}\right\vert \mathcal F_t\right]=E^{\mathbb Q}\left[\left.\frac{B(T,T)}{B_T}\right\vert \mathcal F_t\right]=\frac{B(t,T)}{B_t},
\]

since \(B(T,T)=1\) and the integrant is a \(\mathbb Q\)-martingale. Rearranging we have

\[
B(t,T)=B_tE^{\mathbb Q}\left[\left.\frac{1}{B_T}\right\vert \mathcal F_t\right]=e^{\int_0^t r(u)\ du}E^{\mathbb Q}\left[\left.e^{-\int_0^T r(u)\ du}\right\vert \mathcal F_t\right]=E^{\mathbb Q}\left[\left.e^{-\int_t^T r(u)\ du}\right\vert \mathcal F_t\right].\tag{11}
\]

\hypertarget{forward-rates-and-yields}{%
\subsubsection{Forward rates and yields}\label{forward-rates-and-yields}}

There exist alot of different transformations of \(r(t)\) which may be useful in simplifying complex equation and/or easing interpretation. Some of the most used include \emph{forward rates} and \emph{yields}. Let us start by defining a simple forward rate called the LIBOR forward rate.

\textbf{Definition 3.1. (Bladt)}\index{LIBOR forward rate} \emph{Consider three fixed time-points \(t\le S< T\) and the corresponding self-financing portfolio consisting of one short position in a zero-coupon bond with maturity \(S\) and a long position in a zero-coupon bond with maturity \(T\) of size \(B(t,S)/B(t,T)\). This portfolio gives the payout: -1 at time \(S\) and \(B(t,S)/B(t,T)\) at time \(T\). This in particular results in the investment of 1 dollar at time \(S\) with a \(\mathcal F_t\) deterministic payout}

\[
\frac{B(t,S)}{B(t,T)}
\]

\emph{at time \(T\). The \textbf{LIBOR forward rate} \(L(t,S,T)\) is thus the average return in the interval i.e.}

\[
L(t,S,T)=\frac{1}{T-S}\left(\frac{B(t,S)}{B(t,T)}-1\right).
\]

We could of couse define the rate as a continuously compounding rate by solving

\[
e^{(T-S)R}=\frac{B(t,S)}{B(t,T)}\iff R=\frac{1}{T-S}\left(\log B(t,S)-\log B(t,T)\right).
\]

\textbf{Definition. (Continuously compounded forward rate)}\index{continuously compounded forward rate} \emph{Let \(t\le T\) be a fixed maturity date. The continuously compounded forward rate on \([S,T]\) is defined by}

\[
f(t,S,T)=-\frac{\log B(t,T)-\log B(t,S)}{T-S}
\]

\emph{being the continuously compounded rate for a portfolio consisting of \(B(t,S)/B(t,T)\) zero-coupon bond with maturity \(T\).}

The yield with maturity \(T\) is the defined by.

\textbf{Definition. (Yield)}\index{Yield} \emph{Let \(t\le T\) be a fixed maturity date. The yield on \([t,T]\) is defined by}

\[
Y(t,T)=-\frac{\log B(t,T)}{T-t},
\]

\emph{being the continuous rate on the portfolio consisting of 1 zero-coupon bond with maturity \(T\).}

We obviously have that \(Y(t,T)=f(t,t,T)\) is the continuous compounded forward rate on \([S,T]\) with \(S=t\). Furthermore, we call \(\{Y(t,T)\}_{T\ge t}\) the \textbf{yield curve}\index{yield curve}.

\textbf{Definition. (Forward rate)}\index{forward rate} \emph{Let \(t\le T\) be a fixed maturity date. The forward rate on \([t,T]\) is defined by}

\[
f(t,T)=-\frac{\partial}{\partial T}\log(B(t,T)).
\]

We see that the forward rate is simply the continuously compounded forward rate on a infinitesimal interval of time \([T-d t,T]\) i.e.

\[
f(t,T)=\lim_{S\to T}f(t,S,T)=\lim_{S\to T}-\frac{\log B(t,T)-\log B(t,S)}{T-S}=-\frac{\partial}{\partial T}\log(B(t,T)).
\]

Note that this is all in expectation. The forward rate is useful in the sense that we can write

\[
B(t,T)=\exp\left[-\int_t^T f(t,s)\ ds\right]=\mathbb E^{\mathbb Q}\left[\left.\exp\left(-\int_t^T r(s)\ ds\right) \right\vert \mathcal{F}_t\right].
\]

We may use forward rate interchangeably as expectation-weighted discounting factor, in constructing fixed rates and arbitrage free loans.

\hypertarget{phase-type-representation-of-bond-prices}{%
\subsection{Phase-type representation of bond prices}\label{phase-type-representation-of-bond-prices}}

Consider the interest rate process

\[
r(t)=r_{X(t)}(t),
\]

where \(\{X(t)\}_{t\ge 0}\) is a time-inhomogeneous Markov jump process on a statespace \(E=\{1,...p\}\) with intensity matrix \(\mathbf M(t)=\{\mu_{ij}\}_{i,j\in E}\) and \(r_i(t)\) for \(i=1,...,p\) are deterministic functions. We call this a Markov-jump representation interest model and we summaries the model below.

\textbf{Definition. (Markov-jump representation interest model)}\index{Markov-jump representation interest model} \emph{Let \(\{X(t)\}_{t\ge 0}\) be a \(p\) dimensional time-inhomogeneous Markov jump process. Define \(\mathcal F_t=\sigma(X(s) : 0\le s\le t)\). Then if \(r_i(t)\) is bounded from below and deterministic the process}

\[
r(t)=r_{X(t)}(t),
\]

\emph{is an \(\mathcal F_t\) adapted interest rate process.}

We see that in the context of this interest rate model the zero-coupon bond with maturity \(T\) has price process

\[
B(t,T)=\mathbb E^{\mathbb Q}\left[\left.\exp\left(-\int_t^Tr_{X(s)}(s)\ ds\right) \right\vert \mathcal F_t\right]=\mathbb E^{\mathbb Q}\left[\left.\exp\left(-\int_t^Tr_{X(s)}(s)\ ds\right) \right\vert X_t\right].
\]

We can then make the matrix representation of the discounting factors.

\textbf{Theorem 3.2. (Bladt)} \emph{For \(i,j\in E\), let}

\[
d_{ij}(s,t)=\mathbb E^{\mathbb Q}\left[\left.1_{\{X(t)=j\}}\exp\left(-\int_s^tr_{X(u)}(u)\ du\right) \right\vert X_s=i\right],
\]

\emph{for \(s\le t\). Then the matrix \(\mathbf D(s,t)=\{d_{ij}(s,t)\}_{i,j\in E}\) has representation}

\[
\mathbf D(s,t)=\prod_s^t\Big(\mathbf I+(\mathbf M(u)-\Delta (r(u)))\ du\Big),
\]

\emph{with \(\Delta(r(u))=\text{diag}(r_1(u),...,r_p(u))\).}

We can then by setting \(\rho\) as

\[
\rho=\max\left(0,-\min_{i\in E}\inf_{x\ge 0}r_i(x)\right),
\]

use the matrix representation of \(\mathbf D(s,t)\) to represent the zero-coupon bond and make a statement that relate \(B(t,T)\) to an IPH distributed random variable.

\textbf{Theorem 3.3. (Bladt)} \textbf{(Phase-type representation of bond prices)}\index{Phase-type representation of bond prices} \emph{Assume the Markov-jump interest model. The price process of the zero-coupon bond satisfies}

\[
B(t,T)=\mathbb E^{\mathbb Q}\left[\left.\exp\left(-\int_t^Tr_{X(s)}(s)\ ds\right) \right\vert X_t\right]=\pi_{X(t)}^\top\mathbf D(t,T)\mathbf e,
\]

\emph{where \(\mathbf e=(1,...,1)^\top\) and \(\pi_{X(t)}\) is the distribution of \(X(t)\). Let \(\tau\sim IPH(\pi_{X(t)},\mathbf M(x+t)-\Delta (r(x+t))-\rho \mathbf I)\) and define \(\overline F(t)\) as the survival function for \(\tau\). Then we have}

\[
B(t,T)=e^{\rho (T-t)}\overline F(T).
\]

\emph{In particular if \(\rho = 0\) then \(B(t,T)=\overline F(T)\) is the survival function of \(\tau\).}

We furthermore have the following result regarding the forward rate.

\textbf{Corollary 3.4. (Bladt)} \emph{Assume the Markov-jump interest model and that \(X(t)=i\). The forward rate is then the hazard rate at \(T\) for the random variable \(\tau\sim IPH(\pi_{X(t)},\mathbf M(x+t)-\Delta (r(x+t))-\rho \mathbf I)\) less \(\rho\) i.e.}

\[
f(t,T)=\frac{f_{\tau}(T)}{\overline F(T)}-\rho.
\]

\emph{where \(f_\tau\) is the density function of \(\tau\).}

We can now for explicity write the distribution function of \(\tau\) in 3.3 and 3.4 above.

\textbf{Corollary 3.5. (Bladt)} \emph{The stopping time \(\tau(t)\sim IPH(\mathbb \pi,\mathbf M(x+t)-\Delta (r(x+t))-\rho \mathbf I)\) with \(\pi_j=1_{\{j=i\}}\) has distribution function}

\[
F_{\tau(t)}(T)=\mathbb E^{\mathbb Q}\left[\left.\int_t^T r_{X(y)}(y)\exp\left(-\int_t^yr_{X(u)}(u)\ du\right)\ dy\ \right\vert\ X(t)=i\right].
\]

\textbf{Corollary 3.6. (Bladt)} \emph{The stopping time \(\tau(t)\sim IPH(\mathbb \pi,\mathbf M(x+t)-\Delta (r(x+t))-\rho \mathbf I)\), with \(\pi\) as the initial distribution of \(X(t)\). Then the following holds}
\begin{align*}
\mathbb P(\tau > T)&=\mathbb E^{\mathbb Q}\left(\exp\left(-\int_0^T r_{X(u)}(u)\ du\right)\right),\\
F_{\tau(t)}(T)&=\mathbb E^{\mathbb Q}\left(\int_0^T r_{X(y)}(y)\exp\left(-\int_0^y r_{X(u)}(u)\ du\right)\ dy\right),\\
f_{\tau(t)}(t)&=\mathbb E^{\mathbb Q}\left( r_{X(t)}(t)\exp\left(-\int_0^t r_{X(u)}(u)\ du\right)\right),\\
f(0,T)&=\frac{f_{\tau(t)}(T)}{1-F_{\tau(t)}(T)}.
\end{align*}

\hypertarget{term-structure-models}{%
\subsection{Term structure models}\label{term-structure-models}}

We may introduce another rate model, where \(r\) is drifting with a locally deterministic term and a drift given by a Brownian motion. We call these models term structure models.

\textbf{Definition. (Term structure interest model)}\index{Term structure interest model} \emph{Let \(\mathbb Q\) be an equivalent martingale measure and let \(W^{\mathbb Q}\) be a \(\mathbb Q\)-Brownian motion. Assume that the process \(r\) has dynamics}

\[
dr(t)=\alpha(t,r(t))\ dt + \sigma(t,r(t))\ dW^{\mathbb Q}(t),
\]

\emph{with \(r(0)=r_0\). Assume that \(\alpha(t,r)\) and \(\sigma(t,r)\) are deterministic functions. Define \(\mathcal F_t=\sigma(W^{\mathbb Q}(s) : 0\le s\le t)\). Then \(r\) is \(\mathcal F_t\)-adapted and we call \(r\) a term structure interest rate with local drift \(\alpha\) and volatility \(\sigma\).}

One easily sees that \(r\) is indeed a Markov process and the arbitrage free price of a zero-coupon bond in this model is given by the price process

\[
B(t,T)=p(t,r(t))
\]

i.e.~a function of time and the current rate. Furthermore, the pricing is derived from the risk neutral valuation formula:

\[
p(t,r(r))=\mathbb E^{\mathbb Q}\left[\left.e^{-\int_t^Tr(\tau)\ d\tau} \right\vert \mathcal{F}_t\right]=\mathbb E^{\mathbb Q}\left[\left.e^{-\int_t^Tr(\tau)\ d\tau} \right\vert r(t)\right],
\]

as \(r\) is Markov. We then know that the process

\[
e^{-\int_0^t r(u)\ du}B(t,T)=\mathbb E^{\mathbb Q}\left[\left.e^{-\int_0^Tr(\tau)\ d\tau} \right\vert \mathcal{F}_t\right]\tag{23}
\]

is a Doob \(\mathbb Q\)-martingale and so this gives rise to the term structure equation below.

\textbf{Theorem 3.9. (Bladt)} \textbf{(Term structure equation)}\index{Term structure equation} \emph{Assume the term structure model. Then the bond price \(B(t,T)=p(t,r(t))\) satisfies the PDE}

\[
p_t(t,r)=rp(t,r)-\alpha(t,r)p_r(t,r)-\frac{1}{2}\sigma^2(t,r)p_{rr}(t,r)
\]

\emph{subect to the condition}

\[
p(T,r)=1.
\]

The result follows from Ito's formula on the martingale in (23) (simply set the local drift equal to 0).

The equation above is generally not solvable, but there exist some restricted models, that does have an explicit solution. One of the models that does have a solution is the \textbf{affine model}.

\textbf{Corollary.} \textbf{(Affine models)} \emph{Assume that the pricing function \(p\) of a zero-coupon bond has representation}

\[
B(t,T)=p(t,r(t))=e^{f(t)r(t)+g(t)},
\]

\emph{then the term structure equation becomes}

\[
r=f'(t)r+g'(t)+\alpha(t,r)f(t)+\frac{1}{2}\sigma^2(t,r)f^2(t),
\]

\emph{with terminal conditions}

\[
f(T)=g(T)=0.
\]

\emph{Assume furthermore that \(\alpha\) and \(\sigma\) has representation}

\[
\alpha(t,r)=a(t)+b(t)r\quad \text{and}\quad\sigma(t,r)=\sqrt{c(t)+d(t)r}
\]
\emph{then it follows that}

\[
f'(t)=1-b(t)f(t)-\frac{1}{2}d(t)f^2(t)\quad \text{and}\quad g'(t)=-a(t)f(t)-\frac{1}{2}c(t)f^2(t).
\]

\textbf{Proof.}

From theorem 3.9 the term structure equation is

\[
p_t(t,r)=rp(t,r)-\alpha(t,r)p_r(t,r)-\frac{1}{2}\sigma^2(t,r)p_{rr}(t,r).
\]

Under assumption that the log of the price process is affine we find that

\[
p_t(t,r)=(f'(t)r+g'(t)p(t,r),\quad p_r(t,r)=f(t)p(t,r),\quad p_{rr}(t,r)=f^2(t)p(t,r)
\]

and so

\[
(f'(t)r+g'(t)p(t,r)=rp(t,r)-\alpha(t,r)f(t)p(t,r)-\frac{1}{2}\sigma^2(t,r)f^2(t)p(t,r)
\]

Hence

\[
r=f'(t)r+g'(t)+\alpha(t,r)f(t)+\frac{1}{2}\sigma^2(t,r)f^2(t).
\]

This shows the first part. Now assume that

\[
\alpha(t,r)=a(t)+b(t)r,\quad\sqrt{c(t)+d(t)r}.
\]

When inserting in the equation before we have

\[
 r=f'(t)r+g'(t)+(a(t)+b(t)r)f(t)+\frac{1}{2}(c(t)+d(t)r)f^2(t).
\]

Then by a coefficient matching argument we have

\[
\begin{pmatrix}
1\\ 0
\end{pmatrix}^\top=
\begin{pmatrix}
f'(t)+b(t)f(t)+\frac{1}{2}d(t)f^2(t)\\
g'(t)+a(t)f(t)+\frac{1}{2}c(t)f^2(t)
\end{pmatrix}^\top
\]

since by multiplying by \((r,1)^\top\) we get the equation above. Isolating \(f'\) and \(g'\) yields the result. \(\blacksquare\)

One popular model is proposed by Vasicek where

\[
\alpha(t,r)=a-br(t)\quad \text{and}\quad \sigma(t,r)=\sigma,
\]

with \(a,b\in \mathbb R\) and \(\sigma\in\mathbb R_+\) are constants. Given the initial condition \(r(0)=r_0\in\mathbb R\) we have the solution as

\[
r(t)=r_0e^{-bt}+\frac{a}{b}\left(1-e^{-bt}\right)+\sigma\int_0^t e^{-(t-s)b}\ dW^{\mathbb Q}(t).
\]

One may achieve the above integration result by differentiating the function \(h(t,r)=r(t)e^{bt}\) and integrating the derivative giving
\begin{align*}
r(t)e^{bt}-r(0)&=\int_0^tdh=\int_0^tbe^{bs}r(s)+e^{bs}(a-br(s))\ ds+\int_0^te^{bs}\sigma\ dW^{\mathbb Q}(s)\\
&=\frac{a}{b}(e^{bt}-1)+\sigma\int_0^te^{bs}\ dW^{\mathbb Q}(s)
\end{align*}
where simpel isolation gives the equation.

\hypertarget{estimation-of-ph-bond-models}{%
\subsection{Estimation of PH bond models}\label{estimation-of-ph-bond-models}}

Estimation of rate models may be done by observing current spot rates on the market for zero-coupon bonds with a variety of maturity dates. One may for instance consider \(T=t+1,...,t+30\) or even up to \(T=t+100\). This gives us the corresponding yield curve defined as

\[
T\mapsto Y(t,T)=-\frac{\log p(t,T)}{T-t}=-\frac{\log B(t,T)}{T-t}.
\]

If we make probabilistic assumptions on \(r(t)\) we may in a parametrialized model estimate a parameter \(\theta\) that associate a distribution function for \(r(t)\) i.e.~\(\theta \mapsto F_{\theta,t}(r)\). Let us see how we may estimate a Markov-jump model and a term structure model below.

\hypertarget{data-for-estimation}{%
\subsubsection{Data for estimation}\label{data-for-estimation}}

We consider yield for non-zero coupon bonds listed on \href{https://www.wsj.com/market-data/bonds/treasuries?mod=md_bond_view_treasury_quotes}{The Wall Street Journal}. The data considered was pulled on the 17th of february 2023.

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=0.48\textwidth]{figures/ph_est_data.png}
  \end{center}
\end{figure}

It must be stressed that the rates are not from zero-coupon bonds and so we in general have yields form contracts paying \(R\) continuously until maturity where the face value of \(1\) is payed. This in particular means that the prices in the data is prices according to

\[
B_R(t,T]=\mathbb E^{\mathbb Q}\left[\left.\int_t^T Re^{-\int_t^s r(u)\ du}\ ds+e^{-\int_0^T r(u)\ du} \right\vert\mathcal F_t\right]=R\ \mathbb  E^{\mathbb Q}\left[\left.\int_t^T e^{-\int_t^s r(u)\ du}\ ds \right\vert\mathcal F_t\right]+ B(t,T]
\]

This means that the yields are not equivalent to the zero-coupon yields. In fact it must hold that

\[
Y_R(t,T]\ge Y(t,T]
\]

with \(Y_R(t,T)\approx Y(t,T]+R\cdot f(T-t)\) where \(f\to 0\) for \(T-t\to 0\) and \(f\to 1\) for \(T-t\to \infty\). We will in any case try to determine estimate a statistical model of the yield curve based on the yields in the dataset.

\hypertarget{estimation-of-phase-type-models}{%
\subsubsection{Estimation of Phase-type models}\label{estimation-of-phase-type-models}}

We restrict ourselves to the transition matrices on the form

\[
\mathbf T(x)=\lambda_\theta(x)\mathbf T,
\]

where \(\mathbf T\) is a constant \(p\times p\) matrix and \(\lambda_\theta\) is a real-valued function. The parameter space \(\Theta\subset \mathbb R^d\) for some \(d\ge 1\). This then gives a constant \emph{base dynamic} between the rate states \(1,...,p\in E\) and \(\lambda_\theta\) homogeneously speeds up or slows down the waiting time in each state by scaling the transitions intensities.

\hypertarget{survival-and-mortality-rates}{%
\section{Survival and mortality rates}\label{survival-and-mortality-rates}}

\hypertarget{survival-probabilities-and-forward-mortality-rates}{%
\subsection{Survival probabilities and forward mortality rates}\label{survival-probabilities-and-forward-mortality-rates}}

We consider a non-negative random variable \(\tau\) on a probability space \((\Omega,\mathcal F, P)\). The mortality rate of \(\tau\) at time \(t\) is defined through the dynamics in the following definition.

\textbf{Definition. (Mortality rate)}\index{Mortality rate} \emph{Let \(\tau\ge 0\) be a non-negative stochastic variable. The mortality rate function \(\mu(t)\) is a, possibly stochastic, function defined as}

\[
\mu(t)\ dt=\mathbb P(\tau\in[t,t+dt)\ \vert\ \tau > t)=\frac{f(t)}{\overline F(t)}\ dt,
\]

\emph{where \(\overline F(t)=1-F(t)=\mathbb P(\tau >t)\) is the survival function of \(\tau\).}

The definition above shows that we may alternatively define \(\mu\) in terms of the below derivative

\[
\mu(t)=-\frac{d}{dt}\log\Big(\overline F(t)\Big),
\]

hence we have that

\[
-\int_0^t\mu(s)\ ds=\log\Big(\overline F(t)\Big)-\log\Big(\overline F(0)\Big)=\log\Big(\overline F(t)\Big),
\]

giving the well-known formula

\[
\overline F(t)=\exp\left(-\int_0^t\mu(s)\ ds\right).
\]

This also gives the nice interpretation for the conditional distribution of \(\tau\) given \(\tau>t\) since.

\[
\mathbb P(\tau > s\ \vert\ \tau > t)=\frac{\overline F(s)}{\overline F(t)}=\exp\left(-\int_t^s\mu(u)\ du\right).
\]

\textbf{Corollary.} \emph{Let \(\tau\ge 0\) be a non-negative stochastic variable with mortality rate \(\mu(t)\). The probability that \(\tau \in [t,s)\) in the event \(\tau >t\) is}

\[
p(t,s)=\mathbb P(\tau > s\ \vert\ \tau > t)=\exp\left(-\int_t^s\mu(u)\ du\right).
\]

How to deal with these random intensities. Either we could model them directly under a probability measure, \(\mathbb P\) say, but since we do not know much about the probabilities anyway, we might as well model the consequences in price (reserve) by changes of the intensities. That is, how much does a change in intensity cost? This might been seen in a financial context, even as a derivative security, and should therefore be evaluated relative to a risk--free asset, i.e.~by using an equivalent martingale measure, \(\mathbb Q\) say. We therefore define the mortality forward rates as

\textbf{Definition. (Mortality forward rate)}\index{Mortality forward rate} \emph{Let \(\tau\ge 0\) be a non-negative stochastic variable with mortality rate \(\mu(t)\). The mortality forward rate rate \(m(t,s)\) is a function defined by}

\[
\exp\left(-\int_t^s m(t,u)\ du\right)=q(t,s)=\mathbb E^{\mathbb Q}\left[\left. \exp\left(-\int_t^s\mu(u)\ du\right)\right\vert \mathcal F(t)\right].
\]

Notice that in particular the function \(q(t,s)\) solves the differential equation

\[
\frac{\partial q(t,s)}{\partial s}=-m(t,s)q(t,s),\qquad q(t,t)=1.
\]

When evaluating a payment from insurance company and the insuread we also need to take into account the interest rate \(r\) and so bonds would be priced according to the quantity

\[
E^{\mathbb Q}\left[\left. \exp\left(-\int_t^sr(u)+\mu(u)\ du\right)\right\vert \mathcal F(t)\right].
\]

Notice that the filtration \(\mathcal F(t)\) is now given by the path of \((\mu(t),r(t))\). A payment of 1 in the event the insured dies in the time interval \([s,s+dt)\) is given by

\[
E^{\mathbb Q}\left[\left. \exp\left(-\int_t^sr(u)+\mu(u)\ du\right)\mu(s)\right\vert \mathcal F(t)\right].
\]

Then means that we may price for instance a contract of a payment of 1 in the event of death as

\[
E^{\mathbb Q}\left[\left. \int_t^T\exp\left(-\int_t^sr(u)+\mu(u)\ du\right)\mu(s)\ ds\right\vert \mathcal F(t)\right]
\]

where the contract matures at time \(T>t\). Furhermore if we assume indepence between the mortality and the rates (obviously satisfies) we have the following decompositions:
\begin{align*}
(\text{Forward rates}):\qquad& E^{\mathbb Q}\left[\left. \exp\left(-\int_t^sr(u)\ du\right)\right\vert \mathcal F(t)\right]=e^{-\int_t^sf(t,u)\ du},\\
(\text{Bond prices}):\qquad& E^{\mathbb Q}\left[\left. \exp\left(-\int_t^sr(u)+\mu(u)\ du\right)\right\vert \mathcal F(t)\right]=e^{-\int_t^sf(t,u)+m(t,u)\ du},\\
(\text{Insurance event}):\qquad& E^{\mathbb Q}\left[\left. \exp\left(-\int_t^sr(u)\ du\right)\mu(s)\right\vert \mathcal F(t)\right]=e^{-\int_t^sf(t,u)+m(t,u)\ du}m(t,s).
\end{align*}

\hypertarget{forward-transistion-rates}{%
\subsection{Forward transistion rates}\label{forward-transistion-rates}}

In the above sections we considered the simple Markov process with two states, one real and a absorbing state. In that context we simply model one jump. However in the general case, we would assume a Markov jump on a finite state space \(E\) i.e.~\(\{Z(t)\}_{t\ge 0}\) with random intensities \(\mu_{ij}(t)\) with \(i,j\in E\). We can combine these intensities into the matrix function

\[
\mathbf M(s)=\{\mu_{ij}(s)\}_{i,j\in E}.
\]

Then the natural definition of forward transition rates are the elements of the matrix, \(\mathbf F(t,s)\), given by the product integral below

\[
\mathbb E^{\mathbb Q}\left(\left.\prod_t^s(\mathbf I+\mathbf M(u))\ du\right\vert \mathcal F (t)\right)=\prod_t^s(\mathbf I+\mathbf F(t,u))\ du.
\]

We in this context define

\[
\mathbf P(t,s)=\prod_t^s(\mathbf I+\mathbf M(u))\ du,
\]

being the transition probabilities \(p_{ij}(t,s)\). We furthemore set the matrix \(\mathbf q\) to

\[
\mathbf q(t,s)=\mathbb E^{\mathbb Q}\left(\left.\mathbf P(t,s)\right\vert \mathcal F (t)\right)=\prod_t^s(\mathbf I+\mathbf F(t,u))\ du.
\]

If we assume we may differentiate under the \(\mathbb Q\) expectation we get
\begin{align*}
\mathbb E^{\mathbb Q}\left(\left.\mathbf P(t,s)\mathbf M(s)\right\vert \mathcal F (t)\right)&=\mathbb E^{\mathbb Q}\left(\left.\frac{\partial}{\partial s}\mathbf P(t,s)\right\vert \mathcal F (t)\right)=\frac{\partial}{\partial s}\mathbb E^{\mathbb Q}\left(\left.\mathbf P(t,s)\right\vert \mathcal F (t)\right)\\
&=\frac{\partial}{\partial s}\prod_t^s(\mathbf I+\mathbf F(t,u))\ du=\mathbf q(t,s)\mathbf F(t,s),
\end{align*}
where we simply use the above definition and the definition of the product integral.

\textbf{Lemma. (Mortality forward rate)}\index{Mortality forward rate} \emph{Let \(\{Z(t)\}_{t\ge 0}\) be a Markov jump process on the finite state space \(E\). Assume that the intensity matrix function \(\mathbf M(t)\) exists, then}

\[
\mathbf F(t,s)=\mathbf q(t,s)^{-1}\mathbb E^{\mathbb Q}\left(\left.\mathbf P(t,s)\mathbf M(s)\right\vert \mathcal F (t)\right)
\]

with

\[
\mathbf q(t,s) = \mathbb E^{\mathbb Q}\left(\left.\mathbf P(t,s)\right\vert \mathcal F (t)\right).
\]

\hypertarget{reserves-revisited}{%
\subsection{Reserves revisited}\label{reserves-revisited}}

Consider an life insurance contract of an insured with underlying Markov jump process \(\{Z(t)\}_{t\ge 0}\) commencing at time \(T>0\). The contract pays continuous rate \(b^i(t)\) while \(Z(t)= i\) and transition lump sum payments \(b^{ij}(t)\) in the event \(Z\) jumps from \(i\) to \(j\) at time \(t\). That is the payment has dynamics

\[
dB(t)=dB^{Z(t)}(t)+\sum_{j\ne Z(t-)}b^{Z(t-)j}dN_{Z(t-)j}(t),
\]

where \(N_{ij}(t)=\#\{s\le t:Z(s-)=i,Z(s)=j\}\) is the number of jumps from \(i\) to \(j\)
in the interval \([0,t]\). The above is equivalent with the process

\[
dB(t)=\sum_{i\in E}I^i(t)\ dB^i(t)+\sum_{i\in E}\sum_{j\in E : j\ne i}b^{ij}(t)\ dN_{ij}(t),
\]

where obviously \(I^i(t)=1_{Z(t)=i}\). We assume that \(\{r(t)\}_{t\ge 0}\) is the stochastic interest rate process which is independent of the payment process. The market reserve or third order reserve is defined under the martingale measure \(\mathbb Q\) as

\[
V(t)=\mathbb E^{\mathbb Q}\left[\left.\int_t^Te^{-\int_t^ur(s)\ ds}\ dB(u)\right\vert \mathcal F(t)\right],
\]

i.e.~the discounted expected value of the payments. The above filtration is the one given by the sample path of both \(r\) and \(Z\). Using the independence assumption we have
\begin{align*}
V(t)&=\int_t^TE^{\mathbb Q}\left[\left.e^{-\int_t^ur(s)\ ds}\ dB(u)\right\vert \mathcal F(t)\right]\\
&=\int_t^TE^{\mathbb Q}\left[\left.e^{-\int_t^ur(s)\ ds}\right\vert \mathcal F(t)\right]E^{\mathbb Q}\left[\left.dB(u)\right\vert \mathcal F(t)\right]\\
&=\int_t^Te^{-\int_t^uf(t,s)\ ds}E^{\mathbb Q}\left[\left.dB(u)\right\vert \mathcal F(t)\right],
\end{align*}
by the definition of the forward rate \(f(t,s)\). Notice that now we have two terms both not depending on one another. In other words, \(E^{\mathbb Q}\left[\left.dB(u)\right\vert \mathcal F(t)\right]\) only depends on \(Z\) not \(r\). When evaluating the expected dynamics under \(\mathbb Q\) we have

\[
E^{\mathbb Q}\left[\left.dB(u)\right\vert \mathcal F(t)\right]=E^{\mathbb Q}\left[\left.dB(u)\right\vert Z(t)\right]=\sum_{i\in E}I^i(t)E^{\mathbb Q}\left[\left.dB(u)\right\vert Z(t)=i\right]
\]

with
\begin{align*}
&E^{\mathbb Q}\left[\left.dB(u)\right\vert Z(t)=i\right]=E^{\mathbb Q}\left[\left.\sum_{k\in E}I^k(u)\ dB^k(u)+\sum_{k\in E}\sum_{j\in E : j\ne k}b^{kj}(u)\ dN_{jk}(u)\right\vert Z(t)=i\right]\\
&=\sum_{k\in E}E^{\mathbb Q}\left[\left.I^k(u)\right\vert Z(t)=i\right]\ dB^i(u)+\sum_{k\in E}\sum_{j\in E : j\ne k}b^{kj}(u)\ E^{\mathbb Q}\left[\left.dN_{jk}(u)\right\vert Z(t)=i\right]\\
&=\sum_{k\in E}q_{ik}(t,u)\ dB^i(u)+\sum_{k\in E}\sum_{j\in E : j\ne k}b^{kj}(u)\ E^{\mathbb Q}\left[\left.p_{ik}(t,u)\mu_{kj}(u)\right\vert Z(t)=i\right]\ du\\
&=\sum_{k\in E}q_{ik}(t,u)\ dB^i(u)+\sum_{k\in E}\sum_{j\in E : j\ne k}E^{\mathbb Q}\left[\left.p_{ik}(t,u)b^{kj}(u)\mu_{kj}(u)\right\vert Z(t)=i\right]\ du.
\end{align*}

\hypertarget{stochastic-mortality-rates}{%
\subsection{Stochastic mortality rates}\label{stochastic-mortality-rates}}

\hypertarget{matrix-methods-in-life-insurance}{%
\section{Matrix methods in life insurance}\label{matrix-methods-in-life-insurance}}

\hypertarget{basic-setup}{%
\subsection{Basic setup}\label{basic-setup}}

We consider the time-inhomogeneous Markov jump process \(X=\{X(t)\}_{t\ge 0}\) with a finite state--space \(E\) and intensity matrix \(\mathbf \Lambda(t)=\{\lambda_{ij}(t)\}_{i,j\in E}\). We then define the payment process as

\[
dB(t)=\sum_{i\in E}1_{X(t-)=i}\left(b_i(t)\ dt +\sum_{j\in E}b_{ij}(t)\ dN_{ij}(t)\right),
\]

with \(b_i(t)\) are continuous payment rates (negative if premiums) and \(b_{ij}(t)\) lump sum payments, which occur according to the counting measure \(N_{ij}(t)\). The intensity matrix is decomposed into

\[
\mathbf \Lambda(t)=\mathbf \Lambda^0(t) + \mathbf \Lambda^1(t),
\]

where \(\mathbf \Lambda^1(t)\) is a non--negative matrix and, consequently, \(\mathbf \Lambda^0(t)\) a sub--intensity matrix, i.e.~row sums are non--positive. We choose this decomposition in a way such that \(\mathbf \Lambda^1(t)\) contains the intensities with a factor \(l_{ij}(t)\) being the probability upon jump from \(i\) to \(j\) at time \(t\) of recieving the payment \(b_{ij}(t)\). In other words, we have the decomposition

\[
\lambda_{ij}(t)=\lambda_{ij}^0(t)+\lambda_{ij}^1(t)=l_{ij}(t)\lambda_{ij}^0(t)+(1-l_{ij}(t))\lambda_{ij}^1(t)\iff l_{ij}(t)=\frac{\lambda_{ij}^1(t)}{\lambda_{ij}^0(t)+\lambda_{ij}^1(t)}.
\]

In the case \(i=j\) then the counting measure \(N_{ii}\) denotes a poisson arrival process for lump sum payments arriving during the visit in the state \(i\). This in particular means that the payment \(b_{ii}(t)\) will be triggered in \([t,t+dt)\) with probability \(\lambda_{ii}^1\ dt\) given that \(X(t-)=i\).

Finally, we assume that the spot interest rates in state i follow a deterministic function \(r_i(t)\). Hence the interest rates follow the model

\[
r(u) = r_{X(u)}(u).
\]

Recall that the reserve is defined as

\[
V(t)=\mathbb E^{\mathbb Q}\left[\left.\int_t^Te^{-\int_t^ur(s)\ ds}\ dB(u)\right\vert \mathcal F(t)\right].
\]

We will be using the following matrix functions when computing the reserve and higher order moments.
\begin{align*}
\mathbf B(t)&=\{b_{ij}(t)\}_{i,j\in E},\\
\mathbf R(t)&=\mathbf \Lambda^1(t)\bullet \mathbf B(t) + \mathbf \Delta (\mathbf b(t)),\\
\mathbf C^{(k)}(t)&=\mathbf \Lambda^1(t)\bullet \mathbf B^{\bullet k}(t),\qquad k\ge 2,
\end{align*}
where \(\bullet\) denotes the Schur product simply defined as \(\mathbf A\bullet\mathbf B=\{a_{ij}b_{ij}\}\) with \(\mathbf A=\{a_{ij}\}\) and \(\mathbf B=\{b_{ij}\}\). The notation \(\mathbf \Delta (\cdot)\) operator sets \(\cdot\) as the diagonal i.e.

\[
\mathbf \Delta (\mathbf b(t))=\text{diag}(b_1(t),...,b_p(t)),
\]

assuming \(E=\{1,...,p\}\). We call \(\mathbf B(t)\) the transition payments, \(\mathbf R(t)\) the rewards and \(\mathbf C^{(k)}(t)\) the \(k\)th order contributions. The matrix \(\mathbf C^{(k)}(t)\) is mostly usefull notationally rather than intuitively.

\hypertarget{interest-rate-free-analysis}{%
\subsection{Interest rate free analysis}\label{interest-rate-free-analysis}}

In this section, we consider the risk free context where we are not concerned with any discounting of expected payments. This make us introduce the following random process

\[
U^0(s,t) = \sum_{i\in E}\int_s^tb_i(u)1_{X(u-)=i}\ du+\sum_{i,j\in E}\int_s^tb_{ij}(u)\ dN_{ij}(u),
\]

giving the total reward obtained in the time interval \([s,t]\). We are interested in higher order moments of this quantity (representing the rate free reserve). To this goal we introduce the conditional moments with

\[
m_{ij}^{(k)}(s,t)=\mathbb E\left.\Big[1_{X(t)=j}U^0(s,t)^k\right\vert X(s)=i\Big],
\]

representing the weighted expected moment upon start in state \(i\) weighted with the probability with end in state \(j\). This forms the matrix

\[
\mathbf m^{(k)}(s,t)=\left\{m_{ij}^{(k)}(s,t)\right\}_{i,j\in E}.
\]

For simplicity we simply for \(k=1\) write \(\mathbf m^{(1)}(s,t) = \mathbf m(s,t)\).

\textbf{Theorem 5.1. (Bladt)} \emph{With the above assumptions it holds that}

\[
\mathbf m(s,t)=\int_s^t\mathbf P(s,u)\mathbf R(u)\mathbf P(u,t)\ du.
\]

\emph{In particular, by Van Loans formula we have}

\[
\prod_s^t\left(\mathbf I + \begin{pmatrix}\mathbf \Lambda(x) & \mathbf R(t)\\ \mathbf 0 & \mathbf \Lambda(x)\end{pmatrix} dx\right)=
\begin{pmatrix}
\mathbf P(s,t) & \mathbf m(s,t)\\
\mathbf 0 & \mathbf P(s,t).
\end{pmatrix}
\]

\textbf{Proof.}

\hypertarget{transform-of-rewards-and-higher-order-moments}{%
\subsection{Transform of rewards and higher order moments}\label{transform-of-rewards-and-higher-order-moments}}

\hypertarget{continuous-time-finance}{%
\chapter{Continuous Time Finance}\label{continuous-time-finance}}

This topic revolves around the theory of the Brownian motion and martingale processes. Other main topics are the binomial model and an introduction to financial derivatives. Financial derivatives is contingent on the outcome of a stochastic process at some future time \(t=T\) and often is a function \(\Phi\) of some assets price \(S_t\). As such the derivative will give a stochastic payout, at time \(t=T\) of the size \(X_T=\Phi(S_T)\). Naturally we want to say something about the \emph{fair} price of the derivative in the form of

\[\Pi_t(X_T)=\mathbb{E}\left[\Phi(S_T)\ \vert\ \mathcal{F}_t\right],\]

where \(\mathcal{F}_t\subset\mathcal{F}\) is the available information at time \(t\). We will by defualt intepret the times \(t=0\) as \emph{today} and \(t=T\) as \emph{tomorrow}. This indeed require some fundamental understanding of the behaviour of the asset price \(S_t\). This lead us over to discussing the process in center of the \emph{Black-Scholes} model: the Brownian motion.

\hypertarget{discrete-time-models}{%
\section{Discrete time models}\label{discrete-time-models}}

\hypertarget{one-period-time-models}{%
\subsection{One-period time models}\label{one-period-time-models}}

The study of this course is the \textbf{European call} option\index{European call option} (and \emph{put} option). This financial derivative\index{financial derivative} is an agreement between two parties where the holder of the option has the right to \emph{``exercise''} the derivative, at a future time \(t=T\). Exercising means buying an asset at a certain agreed opon price-strike \(K\). In the case of the put-option: the holder has the right (but not obligation) to sell the asset at the strike price \(K\). As such the derivative has the payoff

\[\text{Call}\ \text{option:}\hspace{10pt}\Phi(S_T)=(S_T-K)^+,\hspace{20pt}\text{Put}\ \text{option:}\hspace{10pt}\Phi(S_T)=(K-S_T)^+.\]

Our objective is to understand when an arbitrage exist and to find the fair price of these derivative. The strategy in pricing is finding a replicating portfolio with the same payoff as the option (with probability one) and then price the derivative accordingly.

\hypertarget{model-description}{%
\subsubsection{Model description}\label{model-description}}

In the one-period model we consider the simplest possible market. We have two distinct times \(t=0\) (today) and \(t=1\) (tomorrow) and we may buy any portfolio as a mixture of bonds and one stock. We denote the bonds price by \(B_t\) and the stocks price by \(S_t\) and we assume the following:

\[
B_0=1,\ B_1=1+R,\hspace{20pt}S_0=s,\ S_1=\left\{\begin{matrix}s\cdot u, & with\ probability\ p_u.\\s\cdot d, & with\ probability\ p_d.\end{matrix}\right.
\]

We may introduce \(Z\) as the random variable

\[
Z=u\cdot (I)+d\cdot (1-I),
\]

for an bernoulli variable \(I\) with succes probability \(p_u\). Naturally, we assume \(d\le (1+R)\le u\) (this is imperative to ensure no arbitrage as we will see).

\hypertarget{portfolios-and-arbirtage}{%
\subsubsection{Portfolios and arbirtage}\label{portfolios-and-arbirtage}}

We study any portfolio on the \((B,S)\) market as a vector \(h=(x,y)\) where \(x\) is the amount of bonds and \(y\) is the amount of stock held in the portfolio. Notice that we allow for shorting, that is \(x<0\) or \(y<0\). As such, we have that \(h\in \mathbb{R}^2\). In this we have made some unrealistic, but attractable assumptions included in the assumptions:

\begin{itemize}
\tightlist
\item
  We allow short positions and fractional holding, i.e.~\(h\in \mathbb{R}^2\),
\item
  We assume no spread between ask and bids,
\item
  No transaction costs and
\item
  A completely liquid market i.e.~we may borrow and buy as much stock and bonds as wanted.
\end{itemize}

Given that we have chosen a portfolio \(h\) we may introduce the value process.

\textbf{Definition 2.1. (Bjork)} \emph{The \textbf{value process}\index{value process} of the porfolio \(h\in\mathbb{R}^2\) is the stochastic process}

\[V^h_t=xB_t+yS_t,\ t=0,1.\]

Given this notation we may define what an arbitrage is.

\textbf{Definition 2.2. (Bjork)} \emph{An \textbf{arbitrage}\index{arbitrage} is a portfolio \(h\) with the properties: 1) \(V^h_0=0\), 2) \(P(V^h_1\ge 0)=1\) and 3) \(P(V^h_1>0)>0\).}

That is \(h\) is an deterministic money-machine where we at least never loose any money. Granted the bonds give a determinictic non-negative return, but an arbitrage does not require any money out of pocket. With the notion of an arbitrage we will show the first proposition regarding the choice of \(R,u,d\) as defined above.

\textbf{Proposition 2.3. (Bjork)} \emph{The one-period binomial model\index{one-period binomial model} is arbitrage free if and only if the following inequality hold:}

\[d\le (1+R)\le u.\tag{2.1}\]

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

\textbf{Proof.}

The statement is proofed by contradiction. Assume that \(d>1+R\) holds. Then by definition \(u>d>1+R\). Notice that any portfolio satisfying \(V_0^h=0\) must satisfy

\[0=xB_0+yS_0=x+ys\iff x=-ys\]

That is for some choice \(y\) the only arbitrage candidate is the portfolio \(h=(-ys,y)\). Calculating the value at time \(t=1\) we have

\[V_1^h=-ys\cdot(1+R)+y\cdot s\cdot Z=ys(Z-1-R)\]

However since \(Z\ge d\) we have \(Z-(1+R)\ge 0\) and therefore an arbitrage (for \(y>0\)). The other inequality \(1+R>u\) follows analog steps. Simply choose some \(y<0\) and the result follows. \(\blacksquare\)

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}
From inequality (2.1) we see that since \(1+R\) is between \(u\) and \(d\) we may find a pair \(q_d,q_u\ge 0\) with \(q_d+q_u=1\) such that

\[1+R=q_u\cdot u+q_d\cdot d.\]

This yields the important risk neutral valuation formula as summed op in the following definition

\textbf{Definition 2.4. (Bjork)} \emph{A probability measure \(Q\) is called a \textbf{martingale meausre}\index{martingale meausre} if the following condition holds:}

\[S_0=\frac{1}{1+R}E^Q[S_1].\]

The above measure \(Q\) is the measure \(Q(Z=d)=q_d\) and \(Q(Z=u)=q_u\) for the binomial model. This does in fact yield the risk neautral valuation formula:
\begin{align*}
S_0&=\frac{1}{1+R}E^Q[S_1]=\frac{1}{1+R}(Q(Z=d)\cdot d\cdot s+Q(Z=u)\cdot u\cdot s)\\
&=s\frac{1}{1+R}(q_d\cdot d+q_u\cdot u)=s,
\end{align*}
where we simply use \(1+R=q_d\cdot d+q_u\cdot u\). We call this the risk neautral valuation formula because it in some sense gives an expected discounted value of the future stock price. We end this endavour with reformulating the arbitrage proposition and determining the values of the \(Q\)-measure.

\textbf{Proposition 2.5. (Bjork)} \emph{The one-period binomial model is arbitrage free if and only if there exists a martingale measure \(Q\).}

\textbf{Proposition 2.6. (Bjork)} \emph{The one-period binomial model has martingale probabilities given by:}

\[\left\{\begin{matrix}q_u=\frac{(1+R)-d}{u-d},\\ q_u=\frac{u-(1+R)}{u-d}.\end{matrix}\right.\]

\hypertarget{contingent-claims}{%
\subsubsection{Contingent Claims}\label{contingent-claims}}

This chapter revolves around the financial derivative and we start by stating the definition of the financial derivative.

\textbf{Definition 2.7. (Bjork)} \emph{A \textbf{contingent claim}\index{contingent claim} (financial derivative)\index{financial derivative} is \emph{any} stochastic variable \(X\) of the form \(\Phi(Z)\), where \(Z\) is the stochastic varible driving the stock price process.}

We may also call the function \(\Phi\) the \textbf{contract function}\index{contract function} as it states how the contract is resolved once the stochastic variable \(Z\) has been realised. Our objective is now to study, what a buyer of said contract would have to pay at any given time \(t\). We call the fair price of \(X\) at time \(t\): \(\Pi_t[X]\). As such it is easy to see that the fair price at the time of maturity \(T\) is simply the payout \(X\) i.e.~\(\Pi_T[X]=X\). Our strategy is to find a replicating portfolio \(h\) and determine the price of said portfolio.

\textbf{Definition 2.8. (Bjork)} \emph{A contingent claim \(X\) can be \textbf{replicated}\index{replicated}, or said to be \textbf{reachable}\index{reachable} if there exist a portfolio \(h\) such that}

\[
V_1^h=X,
\]

\emph{with probability one. In that case, we say that the portfolio \(h\) is a \textbf{hedging} portfolio\index{hedging portfolio} or a \textbf{replicating} portfolio.\index{replicating portfolio} If all claims can be replicated we say that the market is \textbf{complete}\index{complete market}.}

Our pricing strategy is then to determine the value process of the replicating portfolio and then by the first pricing principle below we say that the price is imply the value of the replicating portfolio.

\textbf{Pricing principle 1.} If a clain \(X\) is reachable with replicating portfolio \(h\), then the only reasonable price process for \(X\) is given by

\[
\Pi_t[X]=V_t^h.
\]

Notice, that this assumes that a replicating portfolio exist and even so we have a uniqueness statement to solve. We end this section by writing two important results.

\textbf{Proposition 2.9. (Bjork)} \emph{Suppose that a claim \(X\) is reachable with replicating portfolio \(h\). Then any price at time \(t\ge 0\) of the claim \(X\) other than the value process of \(h\) will lead to an arbitrage on the extended market \((B,S,X)\).}

\textbf{Proposition 2.10. (Bjork)} \emph{If the one-period binomial model is free of arbitrage, then it is also complete.}

The hedging portfolio in the one-period binomial model is given by the portfolio \((x,y)\) below
\begin{align*}
x&=\frac{1}{1+R}\cdot\frac{u\Phi(d)-d\Phi(u)}{u-d},\tag{2.2}\\
y&=\frac{1}{s}\cdot\frac{\Phi(u)-\Phi(d)}{u-d}.\tag{2.3}
\end{align*}

\hypertarget{risk-neutral-valuation}{%
\subsubsection{Risk Neutral Valuation}\label{risk-neutral-valuation}}

We see that since the one-period model is complete we can price any contingent claim and we see that
\begin{align*}
\Pi_0[X]&=\frac{1}{1+R}\cdot\frac{u\Phi(d)-d\Phi(u)}{u-d}+s\frac{1}{s}\cdot\frac{\Phi(u)-\Phi(d)}{u-d}\\
&=\frac{1}{1+R}\left\{\frac{u\Phi(d)-d\Phi(u)}{u-d}+(1+R)\frac{\Phi(u)-\Phi(d)}{u-d}\right\}\\
&=\frac{1}{1+R}\left\{\frac{(1+R)-d}{u-d}\Phi(u)+\frac{u-(1+R)}{u-d}\Phi(d)\right\}\\
&=\frac{1}{1+R}E^Q[X].
\end{align*}
i.e.~the price at time \(t=0\) should simply be the expected discounted payout according to the martingale measure. This leads to the important pricing proposition:\index{risk-neutral valueation formula}

\textbf{Proposition 2.11. (Bjork)} \emph{If the one-period binomial model is free of arbitrage, then the arbitrage free price of a contingent claim \(X\) is given by}

\[
\Pi_0[X]=\frac{1}{1+R}E^Q[X].\tag{2.4}
\]

\emph{Here the martingale measure \(Q\) is uniquely determined by the relation}

\[
S_0=\frac{1}{1+R}E^Q[S_1],\tag{2.5}
\]

and the explicit expressions for \(q_u\) and \(q_d\) are given in proposition 2.6. Furthermore the claim \(X\) can be replicated using the portfolio
\begin{align*}
x&=\frac{1}{1+R}\cdot\frac{u\Phi(d)-d\Phi(u)}{u-d},\tag{2.6}\\
y&=\frac{1}{s}\cdot\frac{\Phi(u)-\Phi(d)}{u-d}.\tag{2.7}
\end{align*}

\newpage

\hypertarget{multi-period-model}{%
\subsection{Multi-period model}\label{multi-period-model}}

The one-period binomial model can easily be extended to a multi-period model,\index{multi-period model} by assuming that the bond and stock pricess evolve by the processes:

\[
t\ge1:\ B_t=(1+R)B_{t-1}\hspace{20pt}\text{and}\hspace{20pt}B_0=1,
\]

\[
t\ge1:\ S_t=Z_{t-1}S_{t-1}\hspace{20pt}\text{and}\hspace{20pt}S_0=s,
\]

where we obviously have that \(B_t=(1+R)^t\) for \(t\ge 0\). In the above \(Z_t\) is \(u\) with probability \(p_u\) and \(d\) with probability \(p_d\). In this context, we need to define a portfolio in terms of a strategy.

\textbf{Definition 2.13. (Bjork)} \emph{A \textbf{portfolio strategy}\index{portfolio strategy} is a stochastic process on \(\{1,...,T\}\)}

\[
h=\left\{h_t=(x_t,y_t);\ t=1,...,T\right\}
\]

\emph{such that \(h_t\) is a function of \(S_0,S_1,...,S_{t-1}\). For a given portfolio strategy \(h\) we set \(h_0=h_1\) by convention. The associated \textbf{value process}\index{value process} corresponding to the portfolio \(h\) is defined by}

\[
V_t^h=x_t(1+R)+y_tS_t.
\]

Given this notation we may define what an arbitrage is, but first we introduce the notion of a self-financing portfolio. A self-financing portfolio in an intuative sense is a portfolio that is not withdrawn from or deposited into.

\textbf{Definition 2.14. (Bjork)} \emph{A portfolio strategy \(h\) is said to be \textbf{self-financing}\index{self-financing portfolio} if the following condition holds for all \(t=0,...,T-1\):}

\[
x_t(1+R)+y_tS_t=x_{t+1}+y_{t+1}S_t.
\]

The above equation says that the portfolio purchased at time \(t\) and helt until \(t+1\) \((x_{t+1},y_{t+1})\) can only be financed by the market value of the portfolio held from \([t-1,t)\) i.e.~\((x_{t},y_{t})\). We now define an arbitrage.

\textbf{Definition 2.15. (Bjork)} \emph{An \textbf{arbitrage} is a self-financing portfolio \(h\) with the properties: 1) \(V^h_0=0\), 2) \(P(V^h_T\ge 0)=1\) and 3) \(P(V^h_T>0)>0\).}

The multiperiod binomial model has an just like the oneperiod model a result regarding when an arbitrage exists.

\textbf{Lemma 2.16. (Bjork)} \emph{If \(d\le (1+R)\le u\) (eq. 2.8) then the multiperiod model is arbitrage-free.}

As one can see, the multiperiod model is rather similar to the one period model. We wil in the following summarise equivalent statements for the multiperiod model as the ones in the oneperiod model.

\textbf{Definition 2.17. (Bjork)} \emph{The martingale probabilities \(q_u\) and \(q_d\) are defined as the probabilities for which the relation below holds.}

\[
s=\frac{1}{1+R}E^Q[S_{t+1}\ \vert\ S_t].
\]

\textbf{Proposition 2.18. (Bjork)} \emph{The martingale probabilities \(q_u\) and \(q_d\) are given by}

\[
\left\{\begin{matrix}q_u=\frac{(1+R)-d}{u-d},\\ q_u=\frac{u-(1+R)}{u-d}.\end{matrix}\right.
\]

\textbf{Definition 2.19. (Bjork)} \emph{A \textbf{contingent claim}\index{contingent claim} is a stochastic variable \(X\) of the form}

\[
X=\Phi(S_T),
\]

\emph{where the \textbf{contract function}\index{contract function} \(\mathbf{\Phi}\) is some given real valued function.}

\textbf{Definition 2.20. (Bjork)} \emph{A given contingent claim \(X\) is said to be \textbf{reachable}\index{reachable} if there exists a self-financing portfolio \(h\) such that}

\[
V_T^h=X,
\]

\emph{with probability one. In that case we say that the portfolio \(h\) is a \textbf{hedging} portfolio\index{hedging portfolio} or a \textbf{replicating} portfolio\index{replicating portfolio}. If all claims can be replicated we say that the market is \emph{(dynamically)} \textbf{complete}\index{complete market}.}

\textbf{Pricing principle 2. (Bjork)} \emph{If a claim \(X\) is reachable with replicating portfolio \(h\), then the only reasonable price process for \(X\) os given by}

\[
\Pi_t[X]=V_t^h,\ t=0,1,...,T.
\]

\textbf{Proposition 2.21. (Bjork)} \emph{Assume \(X\) is reachable by \(h\), then any price other than \(V_t^h\) for some \(t\ge 0\) leads to an arbitrage opportunity.}

\textbf{Proposition 2.22. (Bjork)} \emph{The multiperiod model is complete, i.e.~every claim can be replicated by a self-financing portfolio.}

\textbf{Proposition 2.24. (Bjork)} \emph{\textbf{(Binomial algorithm)}\index{Binomial algorithm} Consider a \(T\)-claim \(X=\Phi(S_T)\). Then this claim can be replicated using af self-financing portfolio. If \(V_t(k)\) denotes the value of the portfolio at the node \((t,k)\) (\(k\) referring to \(k\) amount of up-moves for the stock), then \(V_t(k)\) can be computed recursively by the scheme}

\[
\left\{\begin{matrix}V_t(k)=\frac{1}{1+R}\left\{q_uV_{t+1}(k+1)+q_dV_{t+1}(k)\right\},\\ V_T(k)=\Phi(su^kd^{T-k}).\end{matrix}\right.
\]

\emph{where the martingale probabilities \(q_u\) and \(q_d\) are given by}

\[
\left\{\begin{matrix}q_u=\frac{(1+R)-d}{u-d},\\ q_u=\frac{u-(1+R)}{u-d}.\end{matrix}\right.
\]

\emph{With the notation as above, the hedging portfolio is given by}

\[
\left\{\begin{matrix}x_t(k)=\frac{1}{1+R}\cdot\frac{uV_t(k)-dV_t(k+1)}{u-d},\\ y_t(k)=\frac{1}{S_{t-1}}\cdot\frac{V_t(k+1)-V_t(k)}{u-d}.\end{matrix}\right.
\]

\emph{In particular, the arbitrage free price of the claim at \(t=0\) is given by \(V_0(0)\).}

\textbf{Example.}

\begin{center}\includegraphics[width=0.75\linewidth]{_main_files/figure-latex/unnamed-chunk-6-1} \end{center}

Consider \(R=0.04\), \(s=100\), \(u=1.1\), \(d=0.9\), \(p_u=0.6\) and \(p_d=0.4\). We consider a model of length \(T=2\) and we want to evaluate the price of the european call option with srike \(K=90\) that is the contingent claim

\[
X=(S_T-K)^+,\hspace{20pt}\Phi(s)=(s-K)^+.
\]

For each time \(t\) we know the replicating portfolio, if we know the payoff the following period. Therefore we start from the leaves of the tree and work towards the root. Since the strike price is \(K=90\) the end result will be the following payoffs:
\begin{align*}
u^2:\hspace{20pt}&(121-90)^+=31\\
ud:\hspace{20pt}&(99-90)^+=9\\
du:\hspace{20pt}&(99-90)^+=9\\
d^2:\hspace{20pt}&(81-90)^+=0
\end{align*}
Therefore by the risk neautral valuation formula with \(q_u=\frac{(1+R)-d}{u-d}=0.7\) and \(q_d=\frac{u-(1+R)}{u-d}=0.3\) we have that the cost of the replicating portfolio at time \(t=1\) is respectively
\begin{align*}
u:\hspace{20pt}&\frac{1}{1+R}\left\{31\cdot q_u + 9 \cdot q_d\right\}\approx 23.46\\
d:\hspace{20pt}&\frac{1}{1+R}\left\{9\cdot q_u + 0 \cdot q_d\right\}\approx 6.06
\end{align*}
To replicate this payoff at time \(t=1\) we can use the risk neutral valuation formula once more to find the base cost of the replicating portfolio i.e.~the price of \(X\) at time \(t=0\)

\[
\frac{1}{1+R}\left\{23.46\cdot q_u + 6.06 \cdot q_d\right\}\approx 17.54.
\]

Working from the root to the leaves we can now calculate the hedging portfolio at time \(t=0,1\) for each path. For time \(t=0\) we calculate
\begin{align*}
x=&\frac{1}{1+R}\cdot \frac{u\cdot 6.06-d\cdot 23.46}{u-d}\approx -69.46,\\
y=&\frac{1}{s}\cdot\frac{23.46-6.06}{u-d}\approx0.87
\end{align*}
We see by calculations that this does indeed replicate the payoff at time \(t=1\):
\begin{align*}
u:\hspace{20pt}&V_1^h=(1+R)\cdot x + 110\cdot y\approx 23.46,\\
d:\hspace{20pt}&V_1^h=(1+R)\cdot x + 90\cdot y\approx 6.06.
\end{align*}
We also see by calculation that the initial portfolio does cost the expected 17.54 as

\[
x\cdot 1+y\cdot100=87-69.46=17.54.
\]

Following these steps at time \(t=1\) the portfolios \((-86.54,1)\) (for the up-scenario) and \((-38.94,0.5)\) (for the down-scenario) would arise. Notice when calculating \(y\) one has to use the current price \(S_1=S_0\cdot Z\) not \(S_0\). One should also check by similar calculations as above, that these portfolios does indeed replicate the payoff of the contingent claim \(X\). \(\square\)

\textbf{Proposition 2.25. (Bjork)} \emph{The arbitrage free price at \(t=0\) of a \(T\)-claim \(X\) is given by}

\[
\Pi_0[X]=\frac{1}{(1+R)^T}E^Q[X]
\]

\emph{where \(Q\) denotes the martingale measure, or more explicitly}

\[
\Pi_0[X]=\frac{1}{(1+R)^T}\sum_{k=0}^T\binom{T}{k}q_u^kq_d^{T-k}\Phi(su^kd^{T-k}).
\]

\textbf{Example.}

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=0.75\textwidth]{figures/BS_call_price.png}
  \end{center}
  \caption{The pricing function of the European call option.}
\end{figure}

We follow an analog example as the one after proposition 2.24. Let \(K=90\) and we see that
\begin{align*}
&\Pi_0[X]\\
&=\frac{1}{(1+0.04)^2}\sum_{k=0}^2\binom{2}{k}\cdot0.7^k\cdot0.3^{2-k}\cdot\Phi(100\cdot 1.1^k\cdot0.9^{2-k})\\
&=0.9245562\cdot\left(\underbrace{1\cdot 1\cdot0.09\cdot0}_{k=0}+\underbrace{2\cdot 0.7\cdot0.
3\cdot 9}_{k=1}+\underbrace{1\cdot 0.49\cdot1\cdot31}_{k=2}\right)\\
&=0.9245562\cdot\left(0+3.78+15.19\right)\\
&=17.53883
\end{align*}
Since we know that \(K\) must meaningfully range in \([0,121]\) we could try to calculate the price of the contingent claim at time \(t=0\) for all integers in this interval. We see that the price range between \(S_0\) and 0 as expected. One can also see that the price changes slope at the prices 99 and 121 as the function is linear in \(\Phi\) and som realisations loose any effect on the price when the strike is higher than the outcome. \(\square\)

\textbf{Proposition 2.26. (Bjork)} \emph{The condition \(d<(1+R)<u\) is necessary and sufficient condition for absence of arbitrage.}

\newpage

\hypertarget{generelised-one-period-model}{%
\subsection{Generelised one-period model}\label{generelised-one-period-model}}

In the previous we had the simpel model where we only had one stochastic asset \(S\) and only one stochastic variable \(Z\) determining the future stock price. Now we will generelise this model by introducing \(N\) assets and introducing som stochastic behaviour to the system.

\hypertarget{model-specification}{%
\subsubsection{Model specification}\label{model-specification}}

We consider the market consisting of a collection of stochastic prices assets \(i=1,...,N\) with \(N\)-dimensional price process.

\[
S_t=\begin{bmatrix} S_t^1\\
\vdots\\
S_t^N\end{bmatrix}
\]

We now assume that \(S_t\) is defined on a background space with finite sample space \(\Omega = \{\omega_1,...,\omega_M\}\) with associated probabilities \(p_j=P(\omega_j)\), \(j=1,...,M\). We can then for eact time \(t=1,...,T\) define the \(N\times M\) matrix \(D_t\) as such

\[
D_t=\begin{bmatrix} S_t^1(\omega_1)&\cdots &S_t^1(\omega_M)\\
\vdots &\ddots & \vdots\\
S_t^N(\omega_1) &\cdots&S_t^M(\omega_M)\end{bmatrix}.
\]

We will assume that \(S_0^1>0\) and \(S_1^1(\omega_j)>0\), \(j=1,...,M\).

\hypertarget{absence-of-arbitrage}{%
\subsubsection{Absence of Arbitrage}\label{absence-of-arbitrage}}

We now define a \textbf{portfolio}\index{portfolio} as an \(N\)-dimensional row vector

\[
h=\begin{bmatrix} h^1, \dots,h^N\end{bmatrix}
\]

representing the amount of assets held at time \(t=0\) and held until \(t=1\). The \textbf{value process} is then

\[
V^h_t=h\cdot S_t=\sum_{i=1}^N h^iS_t^i,\ t=0,1.\tag{3.1}
\]

For a given \(\omega_j\in\Omega\) we have the realisation

\[
V_t^h=hS_t(\omega_j)=hd_j=(hD)_j.
\]

\textbf{Definition 3.1. (Bjork)} \emph{The portfolio \(h\) is an \textbf{arbitrage portfolio}\index{arbitrage portfolio} fil it satisfies the conditions: \(V_0^h=0\), \(P(V_1^h\ge 0)=1\) and \(P(V_1^h>0)>0\).}

\textbf{Lemma 3.2. (Bjork)} \emph{\textbf{(Farkas' Lemma)}\index{Farkas' Lemma} Suppose that \(d_0,d_1,...,d_M\) are column vectors in \(\mathbb{R}^N\). Then exactly one of the following problems possesses a solution.}

\begin{itemize}
\tightlist
\item
  \textbf{Problem 1}: \emph{There exist \(\lambda_1,...,\lambda_M\ge0\) such that \(d_0=\sum_{j=1}^M\lambda_jd_j\).}
\item
  \textbf{Problem 2}: \emph{There exist \(h\in\mathbb{R}^N\) such that \(h^\top d_0<0\) and \(h^\top d_j\ge 0\) for \(j=1,...,M\).}
\end{itemize}

We now investegate this system for any possible arbitrage portfolios. However first we acknowledge that there exist a nominal price system \(S_t\) and a normalised price system \(Z_t\). The latter we define as the nominel pricess under the numeraire \(S_t^1\) that is

\[
Z_t=\begin{bmatrix} S_t^1/S_t^1\\
S_t^2/S_t^1\\
\vdots\\
S_t^N/S_t^1\end{bmatrix}=\begin{bmatrix} 1\\
S_t^2/S_t^1\\
\vdots\\
S_t^N/S_t^1\end{bmatrix}.
\]

The reason for introducing the normalized price system is that we can without much effort translate results in this system to the nominal system and the normalised system is easier to analize. For this, however, we need af few results.

\textbf{Lemma 3.3. (Bjork)} \emph{With notation as above, the following hold.}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{The \(Z_t\) value process i related to the \(S_t\) value process by}
  \[
    V_t^{h,Z}=hZ_t=\frac{1}{S_t^1}V_t^h.
    \]
\item
  \emph{A portfolio is an arbitrage in the \(S_t\) system if and only if there is an arbitrage in the \(Z_t\) system.}
\item
  \emph{In the \(Z_t\) price system, the numeraie asset \(Z^1\)\index{numeraie asset} has unit constant prices i.e.~\(Z_t^1=1\) for all \(t\ge 0\).}
\end{enumerate}

One of the reason that the normalised system is attractable is that the numeraire asset is constant i.e.~risk free in the normalised system. Let us formulate our first main result.

\textbf{Proposition 3.4. (Bjork)} \emph{The market is arbitrage free if and only if there exists strictly positive real numbers \(q_1,...,q_M\ge 0\) with \(q_1+\cdots + q_M=1\) (eq. 3.2) (probability vector) such that the following vector equality holds}

\[
\begin{bmatrix} Z_0^1\\
\vdots\\
Z_N^1\end{bmatrix}=\begin{bmatrix} Z_1^1(\omega_1)\\
\vdots\\
Z_1^N(\omega_1)\end{bmatrix}q_1+\cdots +\begin{bmatrix} Z_1^1(\omega_M)\\
\vdots\\
Z_1^N(\omega_M)\end{bmatrix}q_M.\tag{3.3}
\]

\hypertarget{martingale-measures}{%
\subsubsection{Martingale Measures}\label{martingale-measures}}

\textbf{Definition 3.5. (Bjork)} \emph{Given the objective probability measure \(P\) on \((\Omega,\mathcal{F},P)\), we say that another probability measure \(Q\) defined on \(\Omega\) is \textbf{equivalent}\index{equivalent measure} to \(P\) if}

\[
\forall A\in\mathcal{F}:P(A)=0\iff Q(A)=0,
\]

or equivalently

\[
\forall A\in\mathcal{F}:P(A)=1\iff Q(A)=1.
\]

\textbf{Definition 3.7. (Bjork)} \emph{Consider the market model above and set \(S^1\) as the numeraire asset. We say that a probability measure \(Q\) defined on \(\Omega\) is a \textbf{martingale measure}\index{martingale measure} if it satisfies the following conditions:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{\(Q\) is equivalent to \(P\), i.e.~\(Q\sim P\).}
\item
  \emph{For every \(i=1,...,N\), the normalized asset price process}
  \[
    Z_t^i=\frac{S_t^i}{S_t^1},
    \]
  \emph{is martingale under the measure \(Q\).}
\end{enumerate}

\textbf{Theorem 3.8. (Bjork)} \textbf{(First Fundamental Theorem)}\index{First Fundamental Theorem} \emph{Given a fixed numeraire, ther market is free of arbitrage possibilities if and only if there exists a martingale measure \(Q\).}

By assuming that the numeraire asset is risk free (i.e.~does not depend on \(\omega\)) then by scaling we can derive the short interest rate as

\[
1+R=\frac{S_1^1}{S_0^1}.
\]

With this in mind we can formulate theorem 3.8 in its more widely used form.

\textbf{Theorem 3.9. (Bjork)} \textbf{(First Fundamental Theorem)} \emph{Assume that there exist a risk free asset, and denote the corresponding risk free interest rate by \(R\). Then the market is arbitrage free if and only if there exist a measure \(Q\sim P\) such that}

\[
S_0^i=\frac{1}{1+R}E^Q[S_1^i],\hspace{20pt}\text{for all}\ i=1,...,N.\tag{3.9}
\]

\hypertarget{martingale-pricing}{%
\subsubsection{Martingale Pricing}\label{martingale-pricing}}

Moving forward we will assume that there exist a risk free asset and we will denote it by \(B_t\) (\(B_t=S^1_t/S^1_0\)).

\textbf{Definition 3.10. (Bjork)} \emph{A \textbf{contingent claim}\index{contingent claim} is any random variable \(X\), defined on the sample space \(\Omega\).}

To ensure no arbitrage in the extended market containing the \(N\) assets and the contingent claim we can apply the first fundamental pricing theorem on the extended market.

\textbf{Proposition 3.11. (Bjork)} \emph{Consider a given claim \(X\). In order to avoid arbitrage, \(X\) must then be priced according to the formula}

\[
\Pi_0[X]=\frac{1}{1+R}E^Q[X],\tag{3.10}
\]

\emph{where \(Q\) is a martingale measure for the underlying market \((\Pi,S^1,...,S^N)\).}

\hypertarget{completeness}{%
\subsubsection{Completeness}\label{completeness}}

Given that a market is arbitrage-free we may run into a uniqueness issue when determining the price of a contingent claim. If a martingale measure exist we will very much like it to be unique as this will ensure that the price from the risk neutral valuation formula is unique. To this we need the market to be complete.

\textbf{Definition 3.12. (Bjork)} \emph{Consider a contingent claim \(X\). If there exists a portfolio \(h\), based on the underlying assets, such that}

\[
V_1^h=X,\ \text{with probability 1}\tag{3.11}
\]

\emph{i.e.}

\[
V_1^h(\omega_j)=X(\omega_j),\ j=1,...,M,\tag{3.12}
\]

\emph{then we say that \(X\) is \textbf{replicated}\index{replicated}, or \textbf{hedged}\index{hedged} by \(h\). Such a portfolio \(h\) is called a replicating, or hedging portfolio\index{replicating portfolio}\index{hedging portfolio}. If every contingent claim can be replicated, we say that the market is \textbf{complete}.}

We can now formulate a proposition on when the market is complete in terms of the matrix \(D\).

\textbf{Proposition 3.13. (Bjork)} \emph{The market is complete if and only if the rows of the matrix \(D\) span \(\mathbb{R}^M\), i.e.~if and only if \(D\) has rank \(M\).}

Now we formulate the second fundamental pricing theorem in terms of the martingale measure \(Q\).

\textbf{Proposition 3.14. (Bjork)} \textbf{(Second Fundamental Theorem)}\index{Second Fundamental Theorem} \emph{Assume that the model is arbitrage free i.e.~\(Q\) exist. Then the market is unique if and only if the martingale measure is unique.}

\hypertarget{stochastic-discount-factors}{%
\subsubsection{Stochastic Discount Factors}\label{stochastic-discount-factors}}

\textbf{Definition 3.16. (Bjork)} \emph{The random variable \(L\) on \(\Omega\) is defined by}

\[
L(\omega_i)=\frac{q_i}{p_i},\hspace{20pt} i=1,...,M.
\]

\textbf{Definition 3.17. (Bjork)} \emph{Assume the absence of arbitrage, and fix a martingale measure \(Q\). With notation as above, the \textbf{stochastic discount factor}\index{stochastic discount factor} (or ``state price deflator''\index{state price deflator}) is the random variable \(\Lambda\) on \(\Omega\) by}

\[
\mathbf{M}(\omega)=\frac{1}{1+R}\cdot L(\omega).\tag{3.19}
\]

\textbf{Proposition 3.18. (Bjork)} \emph{The arbitrage free price of any claim \(X\) is given by the formula}

\[
\Pi_0[X]=E^P[\mathbf{M}\cdot X]\tag{3.20}
\]

\emph{where \(\mathbf{M}\) is a stochastic discount factor.}

\pagebreak

\hypertarget{self-financing-portfolios}{%
\section{Self-financing portfolios}\label{self-financing-portfolios}}

We move forward in this chapter by first defining a self-financing portfolio in discrete time and then by letting the step length tend to zero obtain the continuous time analogue.

\hypertarget{discrete-time-sf-portfolio}{%
\subsection{Discrete time SF portfolio}\label{discrete-time-sf-portfolio}}

We consider \(N\) different adapted price processes \(S^1,...,S^N\). We use the following definition.

\textbf{Definition 6.1. (Bjork)} \emph{We use the following definitions.}

\begin{itemize}
\tightlist
\item
  \emph{\(S_n^i\) is th price of asset \(i\) at time \(n\),}
\item
  \emph{\(h_n^i\) is the number of units of asset \(i\) held during \([n,n+1)\), that is bought at time \(n\),}
\item
  \emph{\(d_n^i\) is the dividends from asset \(i\) in the time-interval \([n-1,n)\), that is recieved at time \(n\),}
\item
  \emph{\(h_n\) is the portfolio \((h_n^1,...,h_n^N)\) held during \([n,n+1)\),}
\item
  \emph{\(c_n\) is the consumption i.e.~withdrawel at time \(n\) (negative being deposits/saving),}
\item
  \emph{\(V_n\) is the value of the portfolio just before time \(n\) i.e.~of the portfolio \(h_{n-1}\) at time \(n\).}
\end{itemize}

We are now ready to define the self-financing portfolio

\textbf{Definition 6.2. (Bjork)} \emph{A \textbf{self-financing portfolio supporting the consumption stream}\index{self-financing portfolio}\index{consumption stream} \(\mathbf{c}\) is a portfolio adhering to the \textbf{budget constraint}\index{budget constraint} given as}

\[
h_{n+1}S_{n+1}+c_{n+1}=h_nS_{n+1}+h_nd_{n+1.}
\]

\emph{The interpretation being, that we may only use funds obtained from selling the old portfolio \(h_n\) and recieved in dividends to buy the new portfolio \(h_{n+1}\) and consume the amount \(c_{n+1}\).}

Before studying the self-financing portfolio we define the operator \(\Delta\) (in definition 6.3) as the increment \(\Delta x_n=x_{n+1}-x_n\) of a countable sequence \((x_n)_{n\in\mathbb{N}_0}\). Notice that we define the increment forward so the increment \(n\) is the increment over the time period \([n,n+1)\) with the first increment being \([0,1)\). Using this notation we can derive the lemma below.

\textbf{Lemma 6.4. (Bjork)} \emph{For any pair of sequences of real numbers \((x_n)_{n\in\mathbb{N}_0}\) and \((y_n)_{n\in\mathbb{N}_0}\) we have the relations}
\begin{align*}
\Delta(xy)_n&=x_n\Delta y_n+y_{n+1}\Delta x_n,\tag{6.5}\\
\Delta(xy)_n&=y_n\Delta x_n+x_{n+1}\Delta y_n,\tag{6.6}\\
\Delta(xy)_n&=x_n\Delta y_n+y_n\Delta x_n+\Delta x_n\Delta y_n.\tag{6.7}
\end{align*}
\emph{This is also valid if the sequances are \(N\)-dimensional, where we interpret the products above as scalar products (\(xy^\top\)).}

Using these definitions and the lemma above we see that the dynamics of the self-financing portfolio is given below.

\textbf{Proposition 6.6. (Bjork)} \emph{The dynamics of any self-financing portfolio supporting the consumption stream \(c\) are given by}

\[
\Delta V_n=h_n \Delta S_n+h_nd_{n+1}-c_{n+1},\tag{6.11}
\]

\emph{or, in more detail}

\[
\Delta V_n=\sum_{i=1}^Nh_n^i(\Delta S_n^i+d^i_{n+1})-c_{n+1}.\tag{6.12}
\]

We may rewrite the dividends as accumulating dividends \(D^i_n=\sum_{k=1}^nd^i_k\) and see that \(d_{n+1}^i=\Delta D^i_n\) and so the above condition is equivalent with.

\textbf{Proposition 6.8. (Bjork)} \emph{The dynamics of any self-financing portfolio supporting the consumption stream \(c\) are given by}

\[
\Delta V_n=h_n \Delta S_n+h_n\Delta D_n-c_{n+1},\tag{6.15}
\]

\emph{or, in more detail}

\[
\Delta V_n=\sum_{i=1}^Nh_n^i(\Delta S_n^i+\Delta D^i_n)-c_{n+1}.\tag{6.16}
\]

\hypertarget{continuous-time-sf-portfolio}{%
\subsection{Continuous time SF portfolio}\label{continuous-time-sf-portfolio}}

Formulating the dynamics of the self-financing portfolio in continuous time is easy work given the discrete setup above. However since we now are in continuous time we will change the \(n\) with a \(t\) and cosider the behavour \(V_{t+dt}-V_t\) as we let \(dt\to 0\). First we formulate some basic notation.

\textbf{Definition 6.9. (Bjork)} \emph{We use the following definitions.}

\begin{itemize}
\tightlist
\item
  \emph{\(S_t^i\) is th price of asset \(i\) at time \(t\),}
\item
  \emph{\(h_t^i\) is the number of units of asset \(i\) held at time \(t\),}
\item
  \emph{\(D_t^i\) is the cumulative dividend processs for asset \(i\),}
\item
  \emph{\(h_t\) is the portfolio \((h_t^1,...,h_t^N)\) held at time \(t\),}
\item
  \emph{\(c_t\) is the consumption rate at time \(n\) (negative being deposits/saving),}
\item
  \emph{\(V_t\) is the value of the portfolio at time \(t\) i.e.~of the portfolio \(h_t\) at time \(t\).}
\end{itemize}

Given these definitions we may define a portfolio strategy that is self-financing.

\textbf{Definition 6.10. (Bjork)} \emph{Let \(S\) be and adapted \(N\)-dimensional price process. We define the following}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{A \textbf{portfolio strategy}\index{portfolio strategy} is any adapted \(N\)-dimensional process \(h\).}
\item
  \emph{The \textbf{value process}\index{value process} \(V^h\) corresponding to the portfolio \(h\) is given by}
  \[
    V_t^h=\sum_{i=1}^N h_t^iS_t^i.\tag{6.17}
    \]
\item
  \emph{A \textbf{consumption process}\index{consumption process} is any adapted one-dimensional process \(c\).}
\item
  \emph{A portfolio-consumption pair \((h,c)\) is called \textbf{self-financing} if the value process \(V^h\) satisfies the condition}
  \[
    dV_t^h=\sum_{i=1}^N h_t^i(dS_t^i+d D^i_t)-c_t\ dt,\tag{6.18}
    \]
  \emph{i.e.~if}
  \[
    dV_t^h=h_t\ dS_t + h_t\ dD_t -c_t\ dt.
    \]
\item
  \emph{The \textbf{gain process}\index{gain process} \(G\) is defined by}
  \[
    G_t=S_t+D_t\tag{6.19}
    \]
  \emph{so we can write the self-financing condition\index{self-financing condition} as}
  \[
    dV_t=h_t\ dG_t-c_t\ dt.\tag{6.20}
    \]
\item
  \emph{The portfolio \(h\) is said to be \textbf{Markovian}\index{Markovian} if it is of the form}
  \[
    h_t=h(t,S_t),
    \]
  \emph{for some function \(h : \mathbb{R}_+\times \mathbb{R}^N\to\mathbb{R}^N\).}
\end{enumerate}

\hypertarget{portfolio-weights}{%
\subsection{Portfolio weights}\label{portfolio-weights}}

\textbf{Definition 6.11. (Bjork)} \emph{For a given portfolio \(h\) the corresponding \textbf{relative portfolio}\index{relative portfolio} or \textbf{portfolio weights}\index{portfolio weights} \(w\) are defined by}

\[
w_t^i=\frac{h_t^iS_t^i}{V_t^h},\ i=1,...,N,\tag{6.21}
\]

\emph{so, in particular, we have \(\sum_{i=1}^N w_i=1\).}

\textbf{Lemma 6.12. (Bjork)} \emph{A portfolio-consumption pair\index{portfolio-consumption pair} \((h,c)\) is self-financing if and only if}

\[
dV_t^h=V_t^h\sum_{i=1}^N w_t^i\frac{dS_t^i+dD_t^i}{S_t^i}-c_t\ dt\tag{6.22}
\]

\emph{or equivalently with the absolute weights}

\[
dV_t^h=\sum_{i=1}^N h_t^i(dS_t^i+dD_t^i)-c_t\ dt.
\]

\textbf{Lemma 6.13. (Bjork)} \emph{Consider the case with no dividends. Let \(c\) be a consumption process, and assume that there exist a scalar process \(Z\) and a vector process \(q=(q^1,...,q^N)\) such that}

\[
dZ_t=Z_t\sum_{i=1}^N q_t^i\frac{dS_t^i}{S_t^i}-c_t\ dt,\tag{6.23}
\]

\emph{and \(\sum_{i=1}^Nqq^i=1\) (eq. 6.24). Now define a portfolio \(h\) by}

\[
h_t^i=\frac{q_t^iZ_t}{S_t^i}.\tag{6.25}
\]

\emph{Then the value process \(V^h\) is given by \(V^h=Z\), the pair \((h,c)\) is self-financing, and the corresponding relative portfolio \(w\) is given by \(w=q\).}

\newpage

\hypertarget{black-scholes-pde}{%
\section{Black-Scholes PDE}\label{black-scholes-pde}}

The Black-Scholes model revolves arround SDE's as seen above. In this model we have two assets a risk free asset \(B\) and a stochastic priced asset \(S\). We therefore start by defining what we mean by a quote-on-qoute \emph{risk free} asset.

\textbf{Definition 7.1. (Bjork)} \emph{The price process \(B\) is the price of a \textbf{risk free asset}\index{risk free asset} if it has the dynamics}

\[
dB_t=r_t B_t\ dt,\tag{7.1}
\]

\emph{where \(r\) is any \(\mathcal{F}_t\) adapted process.}

We see from this definition that the meaning of ``risk free'' is the property, that \(B\) is priced locally deterministic in the sence that \(r\) is adapted and therefore known at time \(t\) and we therefore know the yield on a short term basis. This is also why we may call \(r\) the \textbf{short interest rate}\index{short interest rate}. Given the dynamics above, we know that \(B\) in fact is represented by the process

\[
B_t=B_0e^{\int_0^tr_s\ ds},
\]

for some \(B_0\) initial value. We will moving forward assume that \(B_0=1\). The stochastic asset \(S\) has dynamics.

\[
dS_t=\mu(t,S_t)\ dt + \sigma(t,S_t)\ dW_t,\tag{7.2}
\]

where as usual \(\mu\) and \(\sigma\) are deterministic functions and \(W_t\) is a standard Brownian motion. Note that the risk free asset has a similarly process with \(\sigma = 0\). We may now include this in the definition of the Black-Scholes model.

\textbf{Definition 7.2. (Bjork)} \emph{The \textbf{Black-Scholes model}\index{Black-Scholes model} consists of two assets with dynamics given by}
\begin{align*}
dB_t&=rB_t\ dt,\tag{7.3}\\
dS_t&=\mu S_t\ dt+\sigma S_t\ dW_t,\tag{7.4}
\end{align*}
\emph{where \(r,\mu,\sigma\) are deterministic constants.}

\textbf{Definition 7.3. (Bjork)} \emph{A \textbf{zero coupon bond}\index{zero coupon bond} with maturity \(T\) (henceforth ``\(T\)-bond''\index{$T$-bond}) is an asset which pays the holder the face value 1 dollar at time \(T\). The price at time \(n\) of a \(T\)-bond is denoted by \(p(n,T)\).}

\textbf{Definition 7.4.} \emph{The (possible stochastic) discrete \textbf{short rate}\index{short rate} \(r_n\), for the period \([n,n+1]\), is defined as}

\[
p(n,n+1)=\frac{1}{1+ r_n}.\tag{7.6}
\]

From this short rate we may derive the dynamics of the bank account recieving zero-coupon rates for each distinct time interval.

\textbf{Definition 7.5. (Bjork)} \emph{The dynamics of the bank account\index{bank account} are given by}

\[
\Delta B_n=r_n B_n.\tag{7.7}
\]

\hypertarget{contingent-claims-and-arbitrage}{%
\subsection{Contingent Claims and Arbitrage}\label{contingent-claims-and-arbitrage}}

\textbf{Definition 7.6. (Bjork)} \emph{A \textbf{European call option}\index{European call option} with \textbf{exercise price}\index{exercise price} (or strike price\index{strike price}) \(K\) and \textbf{time of maturity}\index{time of maturity} (exercise date\index{exercise date}) \(T\) on the \textbf{underlying asset} \(S\) is a contract defined by the following clauses:}

\begin{itemize}
\tightlist
\item
  \emph{The holder of the option has, at time \(T\), the right to buy one share of the underlying stock at the price \(K\) dollars from the underwriter of the option.}
\item
  \emph{The holder of the option is in no way obliged to buy the underlying stock.}
\item
  \emph{The right to buy the underlying stock at the price \(K\) can only be exercised at the precise time \(T\).}
\end{itemize}

Obviously, we also have the \textbf{european put} option which gives the owner the right to sell an asset at price \(K\) at time \(T\). Let os formally define a contingent claim.

\textbf{Definition 7.7.} \emph{Consider a financial market with vector price process \(S\). A \textbf{contingent claim} with \textbf{date of maturity} \(T\), also called a \(T\)-claim, is any random variable \(\mathcal{X}\in\mathcal{F}_T^S\). A contingent claim \(\mathcal{X}\) is called a \textbf{simple} claim if it is of the form \(\mathcal{X} = \Phi(S_t)\). The function \(\Phi\) is called the \textbf{contract function}.}

\textbf{Definition 7.8. (Bjork)} \emph{An \textbf{arbitrage} possibility\index{arbitrage portfolio} on a financial market is a self-financed portfolio \(h\) such that}
\begin{align*}
V^h(0)&=0,\tag{7.13}\\
P(V_T^h\ge0)&=1,\tag{7-14}\\
P(V_T^h>0)&>0.\tag{7.15}
\end{align*}
\emph{We say that the market is \textbf{arbitrage free} if there are no arbitrage possibilities.}

\textbf{Definition 7.9. (Bjork)} \emph{Suppose that there exists a self-financing portfolio \(h\), such that the value process \(V^h\) has the dynamics}

\[
d V_t^h=k_tV_t^h\ dt,\tag{7.16}
\]

\emph{where \(k\) is an adapted process. Then it must hold that \(k_t=r_t\) for all \(t\), ore there exists an arbitrage possibility.}

\textbf{Theorem 7.10. (Bjork)} \textbf{(Black-Scholes equation)}\index{Black-Scholes equation} \emph{Assume that the market is specified by the equations}
\begin{align*}
dB_t&=rB_t\ dt,\tag{7.18}\\
dS_t&=\mu(t,S_t) S_t\ dt+\sigma(t,S_t)S_t\ dW_t,\tag{7.19}
\end{align*}
\emph{and that we want to price a contingent claim of the form \(\mathcal{X}=\Phi(S_t)\) (eq. 7.20). Then the only pricing function of the form \(\Pi_t[\Phi(S_t)]=F(t,S_t)\) (eq. 7.21) which is consistent with the absence of arbitrage in the market \([B_t,S_t,\Pi_t]\) is when \(F\) is the solution of the following boundary value problem in the domain \([0,T]\times\mathbb{R}_+\):}
\begin{align*}
F_t(t,s)+rsF_s(t,s)+\frac{1}{2}s^2\sigma^2(t,s)F_{ss}(t,s)-rF(t,s)&=0,\\
F(T,s)&=\Phi(s).
\end{align*}

\hypertarget{risk-neutral-valuation-1}{%
\subsection{Risk Neutral Valuation}\label{risk-neutral-valuation-1}}

\textbf{Theorem 7.11. (Bjork)} \textbf{(Risk Neutral Valuation)}\index{Risk Neutral Valuation formula} \emph{The arbitrage free price of the claim \(\Phi(S_t)\) is given by \(\Pi_t[\Phi]=F(t,S_t)\), where \(F\) is given by the formula}

\[
F(t,s)=e^{-r(T-t)}E^Q_{t,s}[\Phi(S_T)],\tag{7.43}
\]

\emph{where the \(Q\)-dynamics of \(S\) are those of}

\[
dS_t=rS_t\ dt+S_t\sigma(t,S_t)\ dW_t^Q.\tag{7.42}
\]

\textbf{Property 7.12. (Bjork)} \textbf{(The Martingale Property)}\index{Martingale Property} \emph{In the Black-Scholes model, the price process \(\Pi_t\) for every traded asset, be it the underlying or derivate asset, has the property the the normalized price process}

\[
Z_t=\frac{\Pi_t}{B_t},
\]

\emph{(including \(S_t/B_t\)) is a martingale under the measure \(Q\).}

\hypertarget{black-scholes-formula}{%
\subsection{Black-Scholes formula}\label{black-scholes-formula}}

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=0.75\textwidth]{figures/BS_sim.png}
  \end{center}
\end{figure}

This chapter will center on deriving the famous Black-Scholes formula. We start by laying out the assumptions of the model. We have a market consiting of two assets: a stochastic prices asset \(S\) and a risk free asset \(B\). The prices processes have dynamics:
\begin{align*}
dS_t&=\mu S_t\ dt+\sigma S_t\ dW_t,\tag{7.45}\\
dB_t&=r B_t\ dt,\tag{7.44}
\end{align*}
where \(S_0=s\) and \(B_0=1\) (by assumption). Now from Feymann-Kac and the definition of arbitrage we know that a simple claim \(\Phi(S_t)\) has the arbitrage free price given by the risk neutral valueation formula.

\[
F(t,s)=e^{-r(T-t)}E^Q_{t,s}[\Phi(S_T)],\tag{7.46}
\]

where \(Q\) is a probability measure, namely a Martingale measure, such that the dynamics of \(S\) under this measure is

\[
dS_t=r S_t\ dt+\sigma S_t\ dW^Q_t,\tag{7.47}
\]

with \(W_t^Q\) being a Brownian motion wrt. to the probability measure \(Q\) (not \(P\)). The above still has the initial condition \(S_0=s\). Given these assumptions we may formulate the Black-Scholes formula.

\textbf{Theorem 7.13. (Bjork)} \textbf{(Black-Scholes formula)}\index{Black-Scholes formula} \emph{The price of the european call option with strikeprice \(K\) and maturity \(T\) (contract function \(\Phi(S_t)=\left( S_t - K\right)^+\)) takes the form \(\Pi_t=F(t,s)\), where}

\[
F(t,s)=s N(d_1(t,s))-e^{-r(T-t)}KN(d_2(t,s)),\tag{7.52}
\]

\emph{where \(N\) is the distribution-function for an \(\mathcal{N}(0,1)\)-distributed random variable and}
\begin{align*}
d_1(t,s)&=\frac{1}{\sigma \sqrt{T-t}}\left(\log\left(\frac{s}{K}\right)+\left(r+\frac{1}{2}\sigma^2\right)(T-t)\right),\tag{7.53}\\
d_2(t,s)&=d_1(t,s)-\sigma\sqrt{T-t}.\tag{7.54}
\end{align*}

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

\textbf{Proof.}

We let the market be given in terms of the price processes \(S\) and \(B\) with dynamics.
\begin{align*}
dS_t&=\mu S_t\ dt+\sigma S_t\ dW_t,\\
dB_t&=r B_t\ dt,
\end{align*}
with \(B_t=1\) and \(S_t=s\). We assume that \(\mu,\sigma, r\) are deterministic real numbers. Consider the contingent claim

\[
\Phi(S_t)=\left( S_t - K\right)^+,
\]

that is the European call option. Let \(Q\) be a martingale measure such that the dynamics of \(S\) may be written as

\[
dS_t=r S_t\ dt+\sigma S_t\ dW^Q_t,
\]

then \(S_t\) is clearly a GBM wrt. the measure \(Q\). Therefore we know the solution given in terms of the increment of the Brownian motion \(W^Q\) as follows

\[
S_u=s\cdot \exp\left\{\left(r-\frac{1}{2}\sigma^2\right)(u-t)+\sigma\left(W_u^Q-W_t^Q\right)\right\},
\]

for some initial condition \(S_t=s\). From theorem 7.10 we know that the only pricing function which takes the form

\[
\Pi_t[\Phi(S_T)]=F(t,S_t),
\]

can only be consistent with the absence of arbitrage if \(F\) is the solution the the boundary value problem
\begin{align*}
F_t(t,s)+rsF_s(t,s)+\frac{1}{2}s^2\sigma^2F_{ss}(t,s)-rF(t,s)&=0,\\
F(T,s)&=\Phi(s).
\end{align*}
From Feymann-Kac we then know that the stochastic representation of such a solution take the form

\[
F(t,s)=e^{-r(T-t)}E_{t,s}^Q[\Phi(S_T)].
\]

Here the superscript refers to taking mean value with respect to the measure \(Q\). This gives the solution to the pricing function

\[
F(t,s)=e^{-r(T-t)}\int \Phi(S_T)\ dQ.
\]

Under the measure \(Q\) we have that for \(u\ge t\):

\[
Z_u=\log (S_u/s)\sim \mathcal{N}\left(\left(r-\frac{1}{2}\sigma^2\right)(u-t),\sigma\sqrt{u-t}\right)
\]

Hence we may set \(u=T\) and observe that
\begin{align*}
F(t,s)&=e^{-r(T-t)}\int_{-\infty}^\infty \Phi(se^z) f(z)\ dz\\
&=e^{-r(T-t)}\int_{-\infty}^\infty (se^z-K)^+ f(z)\ dz\\
&=e^{-r(T-t)}\int_{\log\left(\frac{K}{s}\right)}^{\infty} (se^z-K) f(z)\ dz\\
&=e^{-r(T-t)}\left(s\int_{\log\left(\frac{K}{s}\right)}^{\infty} e^z f(z)\ dz-K\int_{\log\left(\frac{K}{s}\right)}^{\infty} f(z)\ dz\right),
\end{align*}
where we used that \(f\) is the distribution function of a normal distributed random variable with mean \((r-\sigma^2/2)(T-t)\) and variance \(\sigma\sqrt{T-t}\) and that

\[
(se^z-K)^+ \ge 0\iff se^z\ge K\iff z\ge \log\left(\frac{K}{s}\right)
\]

Using that the MGF of a \(X\sim\mathcal{N}(\alpha, \beta^2)\) variable is

\[
E[e^{tX}]=e^{\alpha t+\frac{1}{2}\beta ^2t^2},
\]

and the shorthand \(N(t)\) for the distribution function of the standard normal distribution, we have
\begin{align*}
F(t,s)&=e^{-r(T-t)}\left(sE\left[e^{Z_T}1_{Z_T\ge \log\left(\frac{K}{s}\right)}\right]-K P\left(Z_T\ge \log\left(\frac{K}{s}\right)\right)\right)\\
&=e^{-r(T-t)}s\exp\left\{\left(r-\frac{1}{2}\sigma^2\right)(T-t)+\frac{1}{2}\sigma^2(T-t)\right\}E\left[1_{Z_T\ge \log\left(\frac{K}{s}\right)}\right]\\
&-e^{-r(T-t)}K P\left(X\ge\frac{1}{\sigma\sqrt{T-t}}\left( \log\left(\frac{K}{s}\right)-(r-\sigma^2/2)(T-t)\right)\right)\\
&=sE\left[1_{Z_T\ge \log\left(\frac{K}{s}\right)}\right]-e^{-r(T-t)}K P\left(X\le\frac{1}{\sigma\sqrt{T-t}}\left(\log\left(\frac{s}{K}\right)+(r-\sigma^2/2)(T-t)\right)\right)\\
&=sN(d_1(s,t))-e^{-r(T-t)}K N\left(d_2(s,t)\right),
\end{align*}
as desired. \(\blacksquare\)

\newpage

\hypertarget{completeness-and-hedging}{%
\section{Completeness and Hedging}\label{completeness-and-hedging}}

We derived the pricing function of the european call option above and introduced the theory around boundary value problems and Feymann-Kac solution to the partial differential stochastic equation. Now we want to see if a portfolio exists such that it gives the payout \(\Phi(S_T)\) with probability one.

In order to do this, we return to the concept of hedge and replication.

\textbf{Definition 8.1. (Bjork)} \emph{We say that a \(T\)-claim \(\mathcal{X}\) can be \textbf{replicated}\index{replicated}, alternatively the it is \textbf{reachable}\index{reachable} or \textbf{hedgeable}\index{hedgeable}, if there exists a self-financing portfolio \(h\) such that}

\[
V_T^h=\mathcal{X},\ P-\text{a.s.}\tag{8.1}
\]

\emph{In this case we say that \(h\) is a \textbf{hedge} against \(\mathcal{X}\). Alternatively, \(h\) is called a \textbf{replicating} or \textbf{hedging} portfolio\index{replicating portfolio}\index{hedging portfolio}. If every contingent claim is reachable we say that the market is \textbf{complete}\index{complete market}.}

If we can find a portfolio \(h\) that reaches \(\mathcal{X}\) in value over the time period \([t,T]\) it must mean, that holding the portfolio is equivalent with holding the contract itself. We therefore have the natural assumption that the price process must satisfie \(\Pi_t[\mathcal{X}]=V_t^h\) for all \(t\ge 0\). How this relates to the absence of arbitrage is given below.

\textbf{Proposition 8.2. (Bjork)} \emph{Suppose \(\mathcal{X}\) is hedged using the portfolio \(h\). Then the only price process \(\Pi_t[\mathcal{X}]\) which is consistent with no arbitrage is given by \(\Pi_t[\mathcal{X}]=V_t^h\). Furthermore, if \(\mathcal{X}\) can be hedged by both \(h\) and \(g\) then \(V_t^g=V_t^h\) for all \(t\) with probability one.}

\hypertarget{completeness-in-black-scholes}{%
\subsection{Completeness in Black-Scholes}\label{completeness-in-black-scholes}}

The Black-Scholes model will be investegated in the following. We start by stating the important theorem.

\textbf{Theorem 8.3. (Bjork)} \emph{Consider the Black-Scholes model given by}
\begin{align*}
dS_t&=\mu(t,S_t) S_t\ dt+\sigma(t,S_t) S_t\ dW_t,\tag{8.2}\\
dB_t&=r B_t\ dt,\tag{8.3}
\end{align*}
\emph{The model above is complete.}

The following lemma gives us replicability of a \textbf{simple} claim\index{simple claim} (which we will restrict ud to).

\textbf{Lemma 8.4. (Bjork)} \emph{Suppose that there exist an adapted process \(V\) and an adapted process \(w=[w^B,w^S]\) with \(w^B_t+w^S_t=1\) (eq. 8.4) for all \(t\ge 0\), such that}
\begin{align*}
dV_t&=V_t(w_t^Br+w_t^S\mu(t,S_t))\ dt+V_tw_t^S\sigma(t,S_t)\ dW_t,\tag{8.5}\\
V_t&=\Phi(S_t).\tag{8.5}
\end{align*}
\emph{Then the claim \(\mathcal{X}=\Phi(S_t)\) can be replicated using \(w\) as the relative portfolio. The corresponding value process is given by the process \(V\) and the absolute portfolio \(h\) is given by}
\begin{align*}
h_t^B&=\frac{w_t^B V_t}{B_t},\tag{8.6}\\
h_t^S&=\frac{w_t^S V_t}{S_t}.\tag{8.7}
\end{align*}

Doing some heuristics we come up with some clever weights, which turns on to adhere to the boundary value problem formulated in the Black-Scholes equation. Given that the weights gives rise to the desired value process, we have succesfully found the portfolio weight (see lemma above).

\textbf{Theorem 8.5. (Bjork)} \emph{Consider the Black-Scholes model given in (8.3)-(8.4), and a simple contingent claim \(\mathcal{X}=\Phi(S_t)\). Define \(F\) as the solution to the boundary value problem}
\begin{align*}
F_t(t,s)+rsF_s(t,s)+\frac{1}{2}s^2\sigma^2F_{ss}(t,s)-rF(t,s)&=0,\tag{8.17}\\
F(T,s)&=\Phi(s).\tag{8.17}
\end{align*}
\emph{Then \(\mathcal{X}\) can be replicated by the relative portfolio}
\begin{align*}
w_t^B&=\frac{F(t,S_t)-S_tF_s(t,S_t)}{F(t,S_t)},\tag{8.18}\\
w_t^S&=\frac{S_tF_s(t,S_t)}{F(t,S_t)}.\tag{8.19}
\end{align*}
\emph{The corresponding absolute portfolio is given by}
\begin{align*}
h_t^B&=\frac{F(t,S_t)-S_tF_s(t,S_t)}{B_t},\tag{8.20}\\
h_t^S&=F_s(t,S_t),\tag{8.21}
\end{align*}
\emph{and the value process \(V^h\) is given by}

\[
V^h_t=F(t,S_t).\tag{8.22}
\]

\textbf{Proposition 8.6. (Bjork)} \emph{Consider the Black-Scholes model given in (8.3)-(8.4), and a contingent claim on the form \(\mathcal{X}=\Phi(S_T,Z_T)\) (eq. 8.29). We define the process \(Z_t\) as}

\[
Z_t=\int_0^tg(u,S_u)\ du,\tag{8.30}
\]

\emph{for some choice of the deterministic function \(g\). Then \(\mathcal{X}\) can be replicated using a relative portfolio given by}
\begin{align*}
w_t^B&=\frac{F(t,S_t,Z_t)-S_tF_s(t,S_t,Z_t)}{F(t,S_t,Z_t)},\tag{8.31}\\
w_t^S&=\frac{S_tF_s(t,S_t,Z_t)}{F(t,S_t,Z_t)}.\tag{8.32}
\end{align*}
\emph{where \(F\) is the solution to the boundary value problem}
\begin{align*}
F_t(t,s,z)+rsF_s(t,s,z)+\frac{1}{2}s^2\sigma^2F_{ss}(t,s,z)-rF(t,s,z)&=0,\tag{8.33}\\
F(T,s,z)&=\Phi(s,z).\tag{8.33}
\end{align*}
\emph{The corresponding value process is given by \(V_t=F(t,S_t,Z_t)\), and \(F\) has the stochastic representation}

\[
F(t,s,z)=e^{-r(T-t)}E^Q_{t,s,z}[\Phi(S_T,Z_T)],\tag{8.34}
\]

\emph{where the \(Q\)-dynamics are given by}
\begin{align*}
dS_u&=rS_u\ du + S_u\sigma(u,S_u)\ dW^Q_u,\tag{8.35}\\
S_t&=s,\tag{8.36}\\
dZ_u&=g(u,S_u)\ du,\tag{8.37}\\
Z_t&=z.\tag{8.38}
\end{align*}

\hypertarget{absence-of-arbitrage-1}{%
\subsection{Absence of Arbitrage}\label{absence-of-arbitrage-1}}

In general we have conflicting forces when evaluating when a certain market is arbitrage free and/or complete. We have in simple terms the non-rigorous theorem below.

\textbf{Meta-theorem 8.3.1. (Bjork)} \emph{Let \(N\) denote the number of underlying \textbf{traded} assets in the model \textbf{excluding} the risk free asset, and let \(R\) denote the number of random sources driving the price system. Genericallly we then have the following statements.}

\begin{itemize}
\tightlist
\item
  \emph{The model is arbitrage free if and only if \(N\le R\).}
\item
  \emph{The model is complete if and only if \(N\ge R\).}
\item
  \emph{The model is arbitrage free and complete if and only if \(N=R\).}
\end{itemize}

\hypertarget{incomplete-markets}{%
\subsection{Incomplete Markets}\label{incomplete-markets}}

We \index{incomplete market}assume a market with a risk free asset and one risky assets with dynamics

\[
dX_t=\mu(t,X_t)\ dt+\sigma(t,X_t)\ dW_t.\tag{9.1}
\]

We want to find a unique price of a derivative on a functional form of the risky asset. We assume that we cannot invest in the asset representing the process \(X_t\) and so we can solely write contracts based on the observation \(X_T\). The problem here is that we can only short or long the risk free asset and so no derivative is replicable.

The way we solve this problem is by having the market set the price of risk and universally price derivatives based on this given price process. We then have the assumptions

\textbf{Assumption 9.2.1} \emph{We have the market given with the only investable asset \(B\) with dynamics}

\[
dB_t=rB_t\ dt.\tag{9.2}
\]

\emph{We furthermore, have an empirically observable stochastic process \(X\) which is \textbf{not} the price process of any traded asset. The \(P\)-dynamics of \(X\) is given by}

\[
dX_t=\mu(t,X_t)\ dt+\sigma(t,X_t)\ dW_t.
\]

\textbf{Assumption 9.2.2} \emph{There is a liquid market for every contingent claim.}

\textbf{Assumption 9.2.3} \emph{We assume that}

\begin{itemize}
\tightlist
\item
  \emph{There is a liquid, frictionless market for each of the contingent claims \(\mathcal{Y}\) and \(\mathcal{Z}\).}
\item
  \emph{The market prices of the claims are of the form}
  \[ \Pi_t[\mathcal{Y}] = F(t,X_t),\]
  \[ \Pi_t[\mathcal{Z}] = G(t,X_t),\]
  \emph{where \(F\) and \(G\) are smooth real valued function.}
\end{itemize}

From Ito's formula we have the dynamics
\begin{align*}
dF=\mu_F F\ dt+\sigma_F F\ dW,\tag{9.4}\\
dG=\mu_G G\ dt+\sigma_G G\ dW.\tag{9.5}
\end{align*}
Where the processes \(\mu_F\) and \(\sigma_F\) are given by
\begin{align*}
\mu_F&=\frac{F_t+\mu F_x+\frac{1}{2}\sigma^2 F_{xx}}{F},\\
\sigma_F&=\frac{\sigma F_x}{F}.
\end{align*}
By forming a portfolio of the two contracts we lead to the relation.

\[
\frac{\mu_F-r}{\sigma_F}=\frac{\mu_G-r}{\sigma_G}.
\]

This gives the important insight.

\textbf{Proposition 9.1. (Bjork)} \emph{Assume that the market for derivatives is free of arbitrage. Then there exists a universal process \(\lambda(t,X_t)\) such that, with probability one, and for all \(t\), we have}

\[
\frac{\mu_F(t,X_t)-r}{\sigma_F(t,X_t)}=\mu(t,X_t),\tag{9.7}
\]

\emph{regardless of the specific choice of the derivative \(F\).}

\textbf{Proposition 9.2. (Bjork)} \emph{Assume absence of arbitrage, the pricing function \(F(t,x)\) of the \(T\)-claim \(\Phi(X_T)\) solves the following boundary value problem.}
\begin{align*}
F_t(t,x)+\mathcal{A}F(t,x)-rF(t,x)&=0,\hspace{15pt}&(t,x)\in (0,T)\times \mathbb{R},\tag{9.8}\\
F(T,x)&=\Phi(x), &x\in\mathbb{R},\tag{9.9}
\end{align*}
\emph{where}

\[
\mathcal{A}F(t,x)=\left\{\mu(t,x)-\lambda(t,x)\sigma(t,x)\right\}F_x(t,x)+\frac{1}{2}\sigma^2(t,x)F_{xx}(t,x).
\]

\textbf{Proposition 9.3. (Bjork)} \textbf{(Risk neutral valuation)}\index{risk-neutral valueation formula} \emph{Assuming absence of arbitrage, the pricing function \(F(t,x)\) of the \(T\)-claim \(\Phi(X_T)\) is given by the formula}

\[
F(t,x)=e^{-r(T-t)}E^Q_{t,x}[\Phi(X_T)].\tag{9.11}
\]

\emph{The dynamics of \(X\) under the martingale measure \(Q\) are given by}

\[
dX_t=\left\{\mu(t,x)-\lambda(t,x)\sigma(t,x)\right\}F_x(t,x)+\sigma(t,x)\ dW^Q_t,
\]

\emph{where \(W^Q\) is a \(Q\)-Brownien motion.}

\newpage

\hypertarget{parity-relations}{%
\section{Parity relations}\label{parity-relations}}

\hypertarget{put-call-parity}{%
\subsection{Put-call Parity}\label{put-call-parity}}

The notion of continuous rebalancing the replicating portfolio require leads to problems in the real world. Trading does cost some money (typical in fractions) and so contiuous balancing would make the portfolio go to 0 rather quickly. Why? The Brownian motion has unbounded variation and so we would have to sell and buy the portfolio uncountable many time in any interval and the shift in weight is not neglible. Because of this we would like to see which claims we can replicate by buying and holding a combination of assets and derivatives.

\textbf{Proposition 10.1. (Bjork)} \emph{Let \(\Phi\) and \(\Psi\) be contract functions for the \(T\)-claims \(\mathcal{X}=\Phi(S_T)\) and \(\mathcal{Y}=\Psi(S_T)\). Then for any real numbers \(\alpha\) and \(\beta\) we have the following price relation:}

\[
\Pi_t[\alpha \Phi + \beta\Psi]=\alpha \Pi_t[\Phi]+\beta\Pi_t[\Psi].\tag{10.1}
\]

If we consider the basic contract functions
\begin{align*}
\Phi_S(x)&=x,\tag{10.2}\\
\Phi_B(x)&=1,\tag{10.3}\\
\Phi_{C,K}(x)&=(x-K)^+,\tag{10.4}\\
\Phi_{P,K}(x)&=(K-x)^+.
\end{align*}
That is a contract paying (respectively): the price of one stock, 1 dollar, one european call and one european put both with strike \(K\). It is clear that the following prices are
\begin{align*}
\Pi_t[\Phi_S]&=S_t,\tag{10.5}\\
\Pi_t[\Phi_B]&=e^{-r(T-t)},\tag{10.6}\\
\Pi_t[\Phi_{C,K}]&=c(t,S_t;K,T),\tag{10.7}\\
\Pi_t[\Phi_{P,K}]&=p(t,S_t;K,T).
\end{align*}
Where \(c(t,s,K,T,r,\sigma)\) and \(p(t,s,K,T,r,\sigma)\) are the pricing function of the european call and put option. We see that we can replicate these payouts by: buying the stock today and selling at time \(T\), buying a zero coupon \(T\)-bond with face value 1, buying the call and put option.

Then we can by choosing \(\alpha,\beta,\gamma_1,...,\gamma_n\) form a portfolio consisting of \(\alpha\) stocks, \(\beta\) \(T\)-bonds and \(\gamma_i\) call options with maturity \(T\) and strike \(K_i\). The price is then a linear combination given the choice (se proposition 10.1).

The put option is not includet in the above portfolio as we have the put-call parity below

\textbf{Proposition 10.2. (Bjork)} \textbf{(Put-call parity)}\index{Put-call parity} \emph{Consider a European call and a European put, both with strike \(K\) and time of maturity \(T\). Then we have the relation.}

\[
p(t,s) = Ke^{-r(T-t)}+c(t,s)-s.\tag{10.11}
\]

\emph{In particular the put option can be replicated by a constant portfolio consisting of \(K\) zero coupon \(T\)-bonds, a European call option and a single short position in the underlying stock.}

We now have the pleasing proposition given the class of claims we can reach with the buy-and-hold portfolio with \(T\)-bonds, stock and call options

\textbf{Proposition 10.3. (Bjork)} \emph{Fix an arbitrary continuous contract function \(\Phi\) with compact support. Then the corresponding contract can be replicated with arbitrary precision (in sup-norm) using a constant portfolio consisting only of bonds, call options and the underlying stock.}

\hypertarget{the-greeks}{%
\subsection{The Greeks}\label{the-greeks}}

When holding a portfolio we may denote the pricing function by \(P(t,s)\). Here we only have one \textbf{underlying} asset with price process \(S_t\). We now have two types of risk:

\begin{itemize}
\tightlist
\item
  Price changes in the underlying asset.
\item
  Misspecifications in the model parameters.
\end{itemize}

These two risk give rise to ``the greeks'' as defined below.

\textbf{Definition 10.4. (Bjork)} \emph{The greeks of a portfolio is given by}

\[
\Delta=\frac{\partial P}{\partial s},\ \Gamma=\frac{\partial^2 P}{\partial s^2},\ \rho=\frac{\partial P}{\partial r},\ \Theta=\frac{\partial P}{\partial t},\ \mathcal{V}=\frac{\partial P}{\partial s}.
\]

For the call option in particular we have the following derivatives.

\textbf{Proposition 10.5. (Bjork)} \emph{The greeks\index{the greeks} of a portfolio consisting of a single European call option with maturity \(T\) and strike price \(K\) have the following greeks (\(\varphi\) denoting the density function of a \(\mathcal{N}(0,1)\)-variable):}
\begin{align*}
\Delta&=N(d_1),\tag{10.17}\\
\Gamma&=\frac{\varphi(d_1)}{s\sigma\sqrt{T-t}},\tag{10.18}\\
\rho&=K(T-t)e^{-r(T-t)}N(d_2),\tag{10.19}\\
\Theta&=-\frac{s\varphi(d_1)\sigma}{2\sqrt{T-t}}-rKe^{-r(T-t)}N(d_2),\tag{10.20}\\
\mathcal{V}&=s\varphi(d_1)\sqrt{T-t}\tag{10.21}.
\end{align*}

\newpage

\hypertarget{fundamental-pricing-theorem-i-and-ii}{%
\section{Fundamental pricing theorem I and II}\label{fundamental-pricing-theorem-i-and-ii}}

We start by stating the following theorem.

\textbf{Theorem 11.1. (Bjork)} \emph{If at least on of the assets \(S^1,...,S^N\) has diffusion term which is non-zero at all times, and if naive portfolio strategies are admitted, then the model admits arbitrage.}

We will go as follows. Derive the fundamental pricing theorem 1 and 2 in a setting with zero interest rate. Then we will extend the result in general by choosing a simple numeraire. We start by defining some basic notation.

\textbf{Definition 11.2. (Bjork)} \emph{Define the process \(h\) as}

\[
h=[h^0,h^S]:=[h^0,h^1,...,h^N]
\]

\emph{We define the following.}

\begin{itemize}
\tightlist
\item
  \emph{For a process \(h\), its \textbf{value process} \(V_t^h\) is defined by}
  \[
    V_t^h=h^0_t\cdot 1+\sum_{i=1}^Nh_t^iS_t^i,\tag{11.3}
    \]
  \emph{or in compact form}
  \[
    V_t^h=h_t^0\cdot 1 + h_t^S S_t\tag{11.4}
    \]
\item
  \emph{An adapted process \(h^S\) is called \textbf{admissible}\index{admissible portfolio} if there exists a non-negative real number \(\alpha\) (which may depend on the choice of \(h^S\)) such that}
  \[
    \int_0^th_u^SdS_u\ge -\alpha,\tag{11.5}
    \]
  \emph{for all \(t\in[0,T]\). A process \(h\), is called an \textbf{admissible portfolio} process if \(h^S\) is admissible.}
\item
  \emph{An admissible portfolio is said to be \textbf{self-financing}, if}
  \[
    V_t^h=V_0^h+\int_0^th_u^S\ dS_u,\tag{11.6}
    \]
  \emph{i.e.~if}
  \[
    dV_t^h=h_t^S\ dS_t.\tag{11.7}
    \]
\end{itemize}

\textbf{Lemma 11.3. (Bjork)} \emph{For any adapted process \(h^S\) satisfying the admissibility condition above, and for any real number \(x\), there exists a unique adapted process \(h^0\), such that:}

\begin{itemize}
\tightlist
\item
  \emph{The process \(h\) defined by \(h=[h^0,h^S]\) is self-financing.}
\item
  \emph{The value process is given by}
  \[
    V_t^h=x+\int_0^th_u^S\ dS_u.\tag{11.8}
    \]
\end{itemize}

\emph{In particular, the space \(\mathcal{K}_0\) of portfolio values, reachable at time \(T\) by means of a self-financing portfolio with zero initial cost is given by}

\[
\mathcal{K}_0=\left\{\int_0^Th_t^S\ dS_u :\ h^S\ \text{is}\ \text{admissible}\right\}.\tag{11.9}
\]

\textbf{Definition 11.4. (Bjork)} \emph{A probability measure \(Q\) on \(\mathcal{F}_T\) is called \textbf{equivalent martingale measure}\index{equivalent martingale measure} for the market model, the numeraire \(S^0\), and the time interval \([0,T]\), if it has the following properties:}

\begin{itemize}
\tightlist
\item
  \emph{\(Q\sim P\) on \(\mathcal{F}_T\), so \(P\) and \(Q\) are equivalent.}
\item
  \emph{All price processes \(S^0,S^1,...,S^N\) are martingales under \(Q\) on the time interval \([0,T]\).}
\end{itemize}

\emph{An equivalent martingale measure will often be referred to as just ``a martingale measure'' or as ``an EMM''. If \(Q\sim P\) has the property that \(S^0,S^1,...,S^N\) are local martingales, then \(Q\) is called a \textbf{local martingale measure}\index{local martingale measure}.}

\textbf{Theorem 11.5. (Bjork)} \textbf{(The First Fundamental Theorem)}\index{the First Fundamental Theorem} \emph{The model is arbitrage free ``essentially'' if and only if there existis a (local) martingale measure \(Q\).}

\textbf{Definition 11.6. (Bjork)} \emph{With the notation above, we say that the model admits}

\begin{itemize}
\tightlist
\item
  \emph{\textbf{No Arbitrage} (NA)\index{no arbitrage, NA} if}
  \[
    \mathcal{C}\cap L_+^\infty=\{0\},\tag{11.21}
    \]
\item
  \emph{\textbf{No Free Lunch with Vanishing Risk} (NFLVR)\index{No Free Lunch with Vanishing Risk, NFLVR} if}
  \[
    \tilde{\mathcal{C}}\cap L_+^\infty=\{0\},\tag{11.22}
    \]
  \emph{where \(\tilde{\mathcal{C}}\) denotes the closure of \(\mathcal{C}\) in \(L^\infty\).}
\end{itemize}

\textbf{Theorem 11.7. (Bjork)} \textbf{(Kreps-Yan Separation Theorem)}\index{Kreps-Yan Separation Theorem} \emph{If \(\mathcal{C}\) is weak* closed, and if}

\[
\mathcal{C}\cap L_+^\infty=\{0\},
\]

\emph{then there exists a random variable \(L\in L^1\) such that \(L\) is \(P\) almost surely strictly positive, and}

\[
E^P[L\cdot X]\le 0,
\]

\emph{for all \(X\in\mathcal{C}\).}

\textbf{Proposition 11.8. (Bjork)} \emph{If the asset price processes are uniformly bounded, then the condition NFLVR implies that \(\mathcal{C}\) is weak* closed.}

\textbf{Theorem 11.9. (Bjork)} \textbf{(First Fundamental Theorem)}\index{First Fundamental Theorem} \emph{Assume that the asset price process \(S\) is bounded. Then there exists an equivalent martingale measure if and only if the model satisfies NFLVR.}

\textbf{Theorem 11.10. (Bjork)} \textbf{(First Fundamental Theorem)} \emph{Assume that the asset price process \(S\) is locally bounded. Then there exists an equivalent martingale measure if and only if the model satisfies NFLVR.}

\textbf{Assumption 11.4.1. (Bjork)} \emph{We assume that }\(S_t^0>0\) \(P\)\emph{-a.s. for all }\(t\ge 0\).

\textbf{Definition 11.11. (Bjork)} \emph{The \textbf{normalized economy}\index{normalized economy} (also referred to as the ``Z-economy'') is defined by the price vector process \(Z\), where}

\[
Z_t=\frac{S_t}{S_t^0}.
\]

\textbf{Definition 11.12. (Bjork)}

\begin{itemize}
\tightlist
\item
  \emph{A \textbf{portfolio stragegy} is any adapted \((N+1)\)-dimensional process}
  \[
    h_t=[h_t^0,h_t^1,...,h_t^N].
    \]
\item
  \emph{The \textbf{S-value process} \(V_t^S\) corresponding to the portfolio \(h\) is \(h_tS_t\).}
\item
  \emph{The \textbf{Z-value process} \(V_t^Z\) corresponding to the portfolio \(h\) is \(h_tZ_t\).}
\item
  \emph{A portfolio is said to be \textbf{admissible} if it is admissible as an \(Z\) portfolio.}
\item
  \emph{An admissible portfolio is \textbf{S-self-balancing} if}
  \[
    dV_t^S=\sum_{i=0}^Nh_t^i\ dS_t^i\tag{11.26}
    \]
\item
  \emph{An admissible portfolio is \textbf{Z-self-balancing} if}
  \[
    dV_t^Z=\sum_{i=0}^Nh_t^i\ dZ_t^i.\tag{11.28}
    \]
\end{itemize}

\textbf{Lemma 11.13. (Bjork)} \textbf{(Invariance Lemma)}\index{Invariance Lemma} \emph{With assumptions as above, the following hold.}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \emph{A portfolio \(h\) is S-self-financing if and only if it is Z-self-financing.}
\item
  \emph{The value processes \(V^S\) and \(V^Z\) are connected by}
  \[
    V_t^Z=\frac{1}{S_t^0}\cdot V_t^S.
    \]
\item
  \emph{A claim \(\mathcal{Y}\) is S-replical if and only if the claim}
  \[
    \frac{\mathcal{Y}}{S_T^0}
    \]
  \emph{is Z-replicable.}
\item
  \emph{The model is S arbitrage free if and only if it is Z arbitrage free.}
\end{enumerate}

\textbf{Theorem 11.14. (Bjork)} \textbf{(The First Fundamental Theorem)} \emph{Consider the market model \(S^0,S^1,...,S^N\) where we assume that \(S^0_t>0\), \(P\)-a.s. for all \(t\ge 0\). Assume furthermore that \(S^0,S^1,...,S^N\) are locally bounded. Then the followin conditions are equivalent:}

\begin{itemize}
\tightlist
\item
  \emph{The model satisfies NFLVR.}
\item
  \emph{There exists a measure \(Q\sim P\) such that the processes}
  \[
    Z^0,Z^1,...,Z^N,
    \]
  \emph{are local martingales under \(Q\).}
\end{itemize}

\hypertarget{completeness-1}{%
\subsection{Completeness}\label{completeness-1}}

\textbf{Lemma 11.15. (Bjork)} \emph{Consider a given \(T\)-claim \(X\). Fix a martingale measure \(Q\) and assume that the normalized claim \(X/S^0_T\) is integrable. If the \(Q\)-martingale \(M\), defined by}

\[
M_t=E^Q\left[\left. \frac{X}{S^0_T}\right\vert \mathcal{F}_t\right],\tag{11.34}
\]

\emph{admits an integral representation of the form}

\[
M_t=x+\sum_{i=1}^N\int_0^th_s^i\ dZ_s^i,\tag{11.35}
\]

\emph{then \(X\) can be hedged in the S-economy. Furthermore, the replicating portfolio \((h^0,h^1,...,h^N)\) is given by the above for \(h^i\), \(i=1,...,N\) and \(h_t^0=M_t-\sum_{i=1}^Nh_t^iZ_t^i\).}

\textbf{Theorem 11.16. (Bjork)} \textbf{(Jacod)}\index{Jacod} \emph{Let \(\mathcal{M}\) denote the convex set of equivalent martingale measures. Then, for any fixed \(Q\in\mathcal{M}\), the following statements are equivalent:}

\begin{itemize}
\tightlist
\item
  \emph{Every \(Q\) local martingale \(M\) has dynamics of the form}
  \[
    dM_t=\sum_{i=1}^Nh_s^i\ dZ_s^i.
    \]
\item
  \emph{\(Q\) is an extremal point of \(\mathcal{M}\).}
\end{itemize}

\textbf{Theorem 11.17. (Bjork)} \textbf{(The Second Fundamental Theorem)}\index{The Second Fundamental Theorem} \emph{Assume that the market is arbitrage free and consider a fixed numeraire asset \(S^0\). Then the market is complete if and onlt if the martingale measure \(Q\), corresponding to the numeraire \(S^0\), is unique.}

\hypertarget{risk-neutral-valuation-formula}{%
\subsection{Risk Neutral Valuation Formula}\label{risk-neutral-valuation-formula}}

We have the setting of a market consisting of the assets \(S^0,...,S^N\) of \(N+1\) assets. We consider the numeraire \(S^0\) being a risk free asset. We introduce a price of contingent claim \(X\), such that the extended market consisting of the price process of \(X\) and the \(N+1\) assets is arbitrage free. Alternatively, we can, equivalently, find a replicating portfolio \(h\) such that \(V^h_T=X\) with probability one.

\textbf{Theorem 11.18. (Bjork)} \textbf{(General Pricing Equation)}\index{General Pricing Equation} \emph{The arbitrage free price process for the \(T\)-claim \(X\) is given by}

\[
\Pi_t[X]=S_t^0E^Q\left[\left.\frac{X}{S^0_T}\right\vert \mathcal{F}_t\right],\tag{11.41}
\]

\emph{where \(Q\) is the (not necessarily unique) martingale measure for the a priori given market \(S^0,S^1,...,S^N\), with \(S^0\) as the numeraire.}

If if we assume that the bank account takes the form

\[
S_t^0=S_0^0e^{-\int_0^tr(s)\ ds},
\]

where \(r\) is the short rate, then we have the familier \emph{risk neutral valuation formula}.

\textbf{Theorem 11.19. (Bjork)} \textbf{(Risk Neutral Valuation Formula)}\index{Risk Neutral Valuation Formula} \emph{Assuming the existence of a short rate, the pricing formula takes the form}

\[
\Pi_t[X]=E^Q\left[\left.e^{-\int_0^Tr(s)\ ds}X\right\vert \mathcal{F}_t\right],\tag{11.42}
\]

\emph{where \(Q\) is the (not necessarily unique) martingale measure with the bank account as the numeraire.}

\textbf{Definition 11.20. (Bjork)} \emph{A \textbf{zero coupon bond}\index{zero coupon bond} with \textbf{maturity date} \(T\), also called a \(T\)-bond, is a contract which guarantees the holder one dollar to be paid on the date \(T\). The price at time \(t\) of a bond with maturity date \(T\) is denoted by \(p(t,T)\).}

\textbf{Proposition 11.21. (Bjork)} \emph{The price of a zero coupon \(T\)-bond\index{$T$-bond} is given by}

\[
p(t,T)=E^Q\left[\left.e^{-\int_t^Tr(s)\ ds}\right\vert \mathcal{F}_t\right],\tag{11.43}
\]

\emph{and in particular we have \(p(T,T)=1\) for all \(T\ge 0\) (eq. 11.44).}

\hypertarget{stochastic-discount-factors-1}{%
\subsection{Stochastic Discount Factors}\label{stochastic-discount-factors-1}}

\textbf{Definition 11.22. (Bjork)} \emph{Assume the existence of a short rate \(r\). For any fixed martingale measure \(Q\), let the likelihood process\index{likelihood process} \(L\) be defined by}

\[
L_t=\frac{dQ}{dP},\ on\ \mathcal{F}_t.\tag{11.48}
\]

\emph{The \textbf{stochastic discount factor}\index{stochastic discount factor} (SDF) process \(\mathbf{M}\), corresponding to \(Q\), is defined as}

\[
\mathbf{M}_t=e^{-\int_0^tr(s)\ ds}L_t\ \ \left(=\frac{1}{B_t}\cdot L_t\right).\tag{11.49/50}
\]

\textbf{Proposition 11.23. (Bjork)} \emph{Assume absence of arbitrage. With notation as above, the following hold:}

\begin{itemize}
\tightlist
\item
  \emph{For any sufficiently integrable \(T\)-claim \(X\), the arbitrage free price is given by}
  \[
    \Pi_t[X]=E^P\left[\left. \frac{\mathbf{M}_T}{\mathbf{M}_t} X \ \right\vert\ \mathcal{F}_t\right].\tag{11.51}
    \]
\item
  \emph{For any arbitrage free asset price process \(S\) (derivative or underlying) the process \(\mathbf{M}_tS_t\) is a (local) \(P\)-martingale.}
\item
  \emph{The \(P\)-dynamics of \(\mathbf{M}\) are given by}
  \[
    d\mathbf{M}_t=-r_t\mathbf{M}_t\ dt+\frac{1}{B_t}\ dL_t.\tag{11.53}
    \]
\end{itemize}

\hypertarget{summary}{%
\subsection{Summary}\label{summary}}

\textbf{Theorem 11.24. (Bjork)} \textbf{(First Fundamental Theorem)} \emph{The market model is free of arbitrage if and only if there exists a \textbf{martingale measure}, i.e.~a measure \(Q\sim P\) such that the processes}
\[
\frac{S_t^0}{S_t^0},\frac{S_t^1}{S_t^0},...,\frac{S_t^N}{S_t^0}
\]
\emph{are (local) martingales under \(Q\).}

\textbf{Proposition 11.25. (Bjork)} \emph{If the numeraire \(S^0\) is the money account, i.e.}
\[
S^0_t=e^{\int_0^t r(s)\ ds},
\]
\emph{where \(r\) is the (possibly stochastic) short rate, and if we assume that all processes are Brownian driven, then a measure \(Q\sim P\) is a martingale measure if and only if all assets \(S^0,S^1,...,S^N\) have the short rate as their local rates of return, i.e.~if the \(Q\)-dynamics are of the form}
\[
dS_t^i=S_t^ir_t\ dt+S_t^i \sigma_t^i\ dW_t^Q,\tag{11.54}
\]
\emph{where \(W^Q\) is a (multidimensional) \(Q\)-Brownian motion.}

\textbf{Theorem 11.26. (Bjork)} \textbf{(Second Fundamental Theorem)} \emph{Assuming absence of arbitrage, the market model is complete if and only if the martingale measure \(Q\) is unique.}

\textbf{Proposition 11.27. (Bjork)}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{In order to avoid arbitrage, \(X\) must be priced according to the formula}
  \[
    \Pi_t[X]=S^0_tE^Q\left[\left. \frac{X}{S^0_T}\ \right\vert\ \mathcal{F}_t\right],\tag{11.55}
    \]
  \emph{where \(Q\) is a martingale measure for \([S^0,S^1,...,S^N]\), with \(S^0\) as the numeraire.}
\item
  \emph{In particular, we can choose the bank account \(B_t\), as the numeraire. Then \(B\) has the dynamics}
  \[
    dB_t=r_tB_t\ dt,\tag{11.56}
    \]
  \emph{where \(r\) is the (possibly stochastic) short rate process. In this case the pricing formula above reduces to}
  \[
    \Pi_t[X]=E^Q\left[\left. e^{-\int_t^T r(s)\ ds}X\ \right\vert\ \mathcal{F}_t\right].\tag{11.57}
    \]
\item
  \emph{As a special case, the price of a zero coupon \(T\)-bond is given by}
  \[
    p(t,T)=E^Q\left[\left. e^{-\int_t^T r(s)\ ds}\ \right\vert\ \mathcal{F}_t\right].\tag{11.58}
    \]
\item
  \emph{Defining the stochastic discount factor \(\mathbf{M}\) by \(\mathbf{M}_t=B_t^{-1}L_t\) we also have the pricing formula.}
  \[
    \Pi_t[X]=E^Q\left[\left. \frac{\mathbf{M}_T}{\mathbf{M}_t}X\ \right\vert\ \mathcal{F}_t\right].\tag{11.59}
    \]
\item
  \emph{Different choices of \(Q\) will generically give rise to different price processes for a fixed claim \(X\). However, if \(X\) is attainable then all choices of \(Q\) will produce the same price process, which then is given by}
  \[
    \Pi_t[X]=V_t^h,\tag{11.60}
    \]
  \emph{where \(h\) is the hedging portfolio. Different choices of hedging portfolios (if such exist) will produce the same price process.}
\item
  \emph{In particular, for every replicable claim \(X\) it holds that}
  \[
    V_t^Q=E^Q\left[\left. e^{-\int_t^T r(s)\ ds}X\ \right\vert\ \mathcal{F}_t\right].\tag{11.61}
    \]
\end{enumerate}

\newpage

\hypertarget{mathematics-of-the-martingale-approach}{%
\section{Mathematics of the martingale approach}\label{mathematics-of-the-martingale-approach}}

\hypertarget{martingale-representation-theorem}{%
\subsection{Martingale representation theorem}\label{martingale-representation-theorem}}

\textbf{Theorem 12.1. (Bjork)} \textbf{(Representation of Brownian Functionals)}\index{Representation of Brownian Functionals} \emph{Let \(W\) be a \(d\) dimensional Brownian motions, and let \(X\) be a random variable such that}

\begin{itemize}
\tightlist
\item
  \(X\in\mathcal{F}^W_T\),
\item
  \(E[\vert X\vert]<\infty\).
\end{itemize}

\emph{Then there exist uniquely determined \(\mathcal{F}^W_t\)-adapted processes \(h^1,...,h^d\), such that \(X\) has the representation}

\[
X=E[X]+\sum_{i=1}^d\int_0^Th^i_s\ dW_s^i.\tag{12.2}
\]

\emph{Under the additional assumption}

\[
E[X^2]<\infty,
\]

\emph{then \(h^1,...,h^d\) are in \(\mathcal{L}^2\).}

\textbf{Theorem 12.2. (Bjork)} \textbf{(The Martingale Representation Theorem)}\index{Martingale Representation Theorem} \emph{Let \(W\) be a \(d\) dimensional Brownian motions, and assume that the filtration \(\mathbf{F}\) is defined as}

\[
\mathcal{F}_t=\mathcal{F}^W_t,\hspace{20pt}t\in[0,T].
\]

\emph{Let \(M\) be any \(\mathcal{F}_t\)-adapted martingale. Then there exist uniquely determined \(\mathcal{F}_t\)-adapted processes \(h^1,...,h^d\) such that \(M\) has the representation}

\[
M_t=M_0+\sum_{i=1}^d\int_0^t h_s^i\ dW_s^i,\hspace{20pt}t\in[0,T].\tag{12.9}
\]

\emph{If the martingale \(M\) is square integrable, then \(h^1,...,h^d\) are in \(\mathcal{L}^2\).}

\hypertarget{girsanov-theorem}{%
\subsection{Girsanov theorem}\label{girsanov-theorem}}

\textbf{Theorem 12.3. (Bjork)} \textbf{(The Girsanov Theorem)}\index{Girsanov Theorem} \emph{Let \(W\) be a \(d\) dimensional \(P\)-Brownian motion on \((\Omega,\mathcal{F},P,\mathbf{F})\) and let \(\varphi\) be any \(d\)-dimensional adapted column vector process. Choose a fixed \(T\) and define the process \(L\) on \([0,T]\) by}
\begin{align*}
dL_t&=\varphi^\top_t L_t\ dW_t,\tag{12.16}\\
L_0&=1,\tag{12.17}
\end{align*}
\emph{i.e.}

\[
L_t = \exp\left\{\int_0^t \varphi^\top_s\ dW_s - \frac{1}{2}\int_0^t \Vert\varphi_s\Vert ^2\ ds\right\}.
\]

\emph{Assume that}

\[
E^P[L_T]=1,\tag{12.18}
\]

\emph{and define the new probability measure \(Q\) on \(\mathcal{F}_T\) by}

\[
L_T=\frac{dQ}{dP},\hspace{15pt}on\ \mathcal{F}_T.\tag{12.19}
\]

\emph{Then}

\[
dW_t=\varphi\ dt+dW_t^Q,\tag{12.20}
\]

\emph{where \(W^Q\) is a \(d\) dimensional \(Q\)-Brownian motion or equivalently}

\[
W_t^Q=W_t-\int_0^t\varphi_s\ ds\tag{12.21}
\]

\emph{is a standard \(Q\)-Brownian motion.}

We will often refere to \(\varphi\) as the \textbf{Girsanov kernel}\index{Girsanov kernel} of the measure transformation. Furthermore, we have written on component form above and the \(L\) dynamics will have the form

\[
dL_t=L_t\sum_{i=1}^d\varphi^i_t\ dW_t^i,
\]

and \(L\) will have the explicit form

\[
L_t=\exp\left\{\sum_{i=1}^d\int_0^t\varphi^i_s\ dW_s^i - \frac{1}{2}\int_0^d\sum_{i=1}^d(\varphi^i_s)^2\ ds\right\}.
\]

The conclusion of the Girsanov Theorem is thwn that we can write

\[
dW_t^i=\varphi_t^i\ dt+dW_t^{Q,i},
\]

for \(i=1,...,d\) where \(W_t^{Q,1},...,W_t^{Q,d}\) are independent standard Brownian motions under \(Q\).

\textbf{Definition 12.4. (Bjork)} \emph{For any Brownian motion \(W\) and any kernel process \(\varphi\), the \textbf{Doleans exponential} process\index{Doleans exponential process} \(\mathcal{E}\) is defined by}

\[
\mathcal{E}(\varphi\bullet W)_t=\exp\left\{\int_0^t\varphi^\top_s\ dW_s -\frac{1}{2}\int_0^t\Vert \varphi\Vert^2_s\ ds\right\}.\tag{12.24}
\]

\textbf{Lemma 12.5. (Bjork)} \textbf{(The Novikov Condition)}\index{Novikov Condition} \emph{Assume that the Girsanov kernel \(\varphi\) is such that}

\[
E^P\left[e^{\frac{1}{2}\int_0^T\Vert \varphi_t\Vert^2\ dt}\right]<\infty.\tag{12.27}
\]

\emph{Then \(L\) is a martingale and in particular \(E^P[L_T]=1\).}

\textbf{Theorem 12.6. (Bjork)} \textbf{(The Converse of the Girsanov Theorem)}\index{Girsanov Theorem, converse} \emph{Let \(W\) be a \(d\)-dimensional standard \(P\)-Brownian motion on \((\Omega,\mathcal{F},P,\mathbf{F})\) and assume that}

\[
\mathcal{F}_t=\mathcal{F}^W_t,\ \forall t.
\]

\emph{Assume that there exists a probability measure \(Q\) such that \(Q<<P\) on \(\mathcal{F}_T\). Then there exists an adapted process \(\varphi\) such that the likelihood process \(L\) has the dynamics}
\begin{align*}
dL_t&=L_t\varphi^\top_t\ dW_t,\\
L_0&=1.
\end{align*}

This gives us a recipe to transform dynamics of Ito processes under the measure \(Q\) as we may rewrite the dynamics of the Brownian motion. We therefore have for an Ito process \(X\) with dynamics

\[
dX_t=\mu(t,X_t)X_t\ dt+\sigma(t,X_t) X_t\ dW_t,
\]

may be transformed under \(Q\) as
\begin{align*}
dX_t&=\mu(t,X_t)X_t\ dt+\sigma(t,X_t) X_t\ dW_t\\
&=\mu(t,X_t)X_t\ dt+\sigma(t,X_t) X_t\ (\varphi_t\ dt+dW_t^Q)\\
&=\left(\mu(t,X_t) + \varphi_t\right) X_t\ dt + \sigma(t,X_t)X_t\ dW_t^Q.
\end{align*}
This may lead us into deducing that

\[
\mu(t,X_t)+\sigma(t,X_t)\varphi_t=r_t\iff\varphi_t=\frac{r_t-\mu(t,X_t)}{\sigma(t,X_t)}.
\]

We furthermore have the Levy characterisation of a Brownian motion.

\textbf{Theorem. (Remark FinKont)} \textbf{(Levy Characterisation of Brownian motion)}\index{Levy Characterisation of Brownian motion} \emph{Let \(X_t\) be an Ito process with \(X_0=0\). Then \(X_t\) is a Brownian motion if and only if the two processes \(X_t\) and \(X_t^2-t\) are continuous martingales.}

\newpage

\hypertarget{black-scholes-model---martingale-approach}{%
\section{Black-Scholes model - martingale approach}\label{black-scholes-model---martingale-approach}}

We consider the standard Black-Scholes model with a single risk free asset and risky asset with dynamics
\begin{align*}
dS_t &= \mu S_t\ dt+\sigma S_t\ dW_t,\tag{13.1}\\
dB_t &= r B_t\ dt.\tag{13.2}
\end{align*}
We want check whether the model is arbitrage free on any time interval \([0,T]\), and find a (perhaps unique) martingale measure such that we may apply the fundamental pricing theorem 1 and 2. From Girsanov this endavour is equivalent with searching for a (perhaps unique) Girsanov kernel \(\varphi\). We therefore define as usual the likelihood process

\[
dL_t=\varphi_ tL_t\ dW_t,
\]

and setting \(dQ=L_T\ dP\) on \(\mathcal{F}_T\), we know from Girsanov theorem that

\[
dW_t=\varphi_t\ dt+dW_t^Q.
\]

Inserting into the Black-Scholes model we have

\[
dS_t=S_t(\mu + \sigma \varphi_t)\ dt+\sigma S_t\ dW_t^Q.
\]

We know that for \(Q\) to be a martingale measure we know that the local rate of return under \(Q\) of \(S\) must be the short rate \(r\) i.e.~we have

\[
\mu + \sigma \varphi_t=r\iff \varphi_t=\frac{r-\mu}{\sigma}=-\frac{\mu -r}{\sigma},\tag{13.3}
\]

and so we see the Girsanov kernel is \textbf{constant and deterministic}. The process has the economic interpretation that the Girsanov kernel is the risk premium per unit volatility.

\textbf{Lemma 13.1. (Bjork)} \emph{The Girsanov kernel \(\varphi\) is given by}

\[
\varphi = -\lambda
\]

\emph{where the market price of risk \(\lambda\) is defined by}

\[
\lambda =\frac{r-\mu}{\sigma}.
\]

We therefore have determined \emph{a martingale} and so we have the result.

\textbf{Theorem 13.2. (Bjork)} \emph{The Black-Scholes model above is arbitrage free.}

We could in general have that \(\mu,\sigma,r\) are adapted processes. If this is the case we would have to show the Nivokov condition.

Pricing then of any \(T\)-claim \(X\) then is given by the risk neatral pricing formula

\[
\Pi_t[X]=e^{-r(T-t)}E^Q[X\ \vert\ \mathcal{F}_t],\tag{13.7}
\]

where the \(Q\) dynamics of \(S\) has local drift \(r\) and volatility from the \(Q\)-brownian motion \(W^Q\).

\textbf{Theorem 13.3. (Bjork)} \emph{The Black-Scholes model above is complete. This also holds for the more general model where \(r,\mu,\sigma\) are adapted processes.}

Hedging is the possible by considiering a \(T\) claim with

\[
E^Q\left[\frac{X}{B_T}\right]<\infty.
\]

Notice the numeraire \(B_t\) as in the normalized \(Z\)-economy. Consider now the \(Q\)-martingale

\[
M_t=E^Q\left[\left. \frac{X}{B_T}\ \right\vert\ \mathcal{F}_t\right],\tag{13.9}
\]

and it now follows from lemma 11.15 the the model is complete if we can find a process \(h_t^1\) such that

\[
dM_t=h_t^1\ dZ_t^i.\tag{13.10}
\]

In order to prove existance of such a process \(h^1\) we use the Martingale Representation Theorem 12.2, which says that there \emph{exists} a process \(g_t\) such that

\[
dM_t=g_t\ dW_t^Q.\tag{13.11}
\]

We can now combine these two equation by the following \(Q\) dynamics

\[
dZ_t^1=Z_t^1\sigma\ dW_t^Q.\tag{13.12}
\]

Hence we have

\[
dM_t=h_t^1Z_t^1\sigma\ dW_t^Q=g_t\ dW_t^Q\ \Rightarrow\ h_t^1=\frac{g_t}{Z_t^1\sigma}.
\]

\textbf{Theorem 13.4. (Bjork)} \emph{In the Black-Scholes model every \(T\)-claim \(X\) satisfying}

\[
E^Q\left[\frac{X}{B_T}\right]<\infty
\]

\emph{can be replicated. The replicating portfolio is given by}
\begin{align*}
h_t^1&=\frac{g_t}{Z_t^1\sigma},\tag{13.13}\\
h_t^0&=M_t-h_t^1Z_t^1,\tag{13.14}
\end{align*}
\emph{where \(M\) is defined by the above and \(g\) is defined by above.}

If the \(T\)-claim is simple that is \(X=\Phi(S_T)\) we may solve a boundary value problem with Feymann-Kac to arrive at the familiar result.

\textbf{Proposition 13.5. (Bjork)} \emph{In the Black-Scholes model every \(T\)-claim on the form \(X=\Phi(S_T)\). Then \(X\) can be replicated by the portfolio}
\begin{align*}
h_t^0&=\frac{F(t,S_t)-S_t\frac{\partial F}{\partial s}(t,S_t)}{B_t},\tag{13.15}\\
h_t^1&=\frac{\partial F}{\partial s}(t,S_t),\tag{13.15}
\end{align*}
\emph{where \(F\) solves the \textbf{Black-Scholes equation}\index{Black-Scholes equation}}
\begin{align*}
\frac{\partial F}{\partial t}(t,s)+rs\frac{\partial F}{\partial s}(t,s)+\frac{1}{2}\sigma^2s^2 \frac{\partial^2 F}{\partial s^2}(t,s)-rF(t,s)&=0,\tag{13.16}\\
F(T,s)&=\Phi(s).\tag{13.16}
\end{align*}
\emph{Furthermore the value process for the replicating portfolio is given by}

\[
V_t=F(t,S_t).
\]

\newpage

\hypertarget{multidimensional-models}{%
\section{Multidimensional models}\label{multidimensional-models}}

We specify the general model by the assumptions below.

\textbf{Assumption 14.0.1} \emph{We assume the following:}

\begin{itemize}
\tightlist
\item
  \emph{There are \(n\) risky assets \(S^1,...,S^n\).}
\item
  \emph{Under the objective probability measure \(P\)\index{objective probability measure}, the \(S\)-dynamics are given by}
  \[
    dS_t^i=\mu_t^iS_t^i\ dt +S_t^i\sum_{j=1}^N\sigma_t^{ij}\ dW_t^j,\tag{14.1}
    \]
  \emph{for \(i=1,...,n\).}
\item
  \emph{The coefficients processes \(\mu^i\) and \(\sigma^{ij}\) above are assumed to be adapted.}
\item
  \emph{We have a standard risk free asset with price process \(B\) with dynamics}
  \[
    dB_t=r_tB_t\ dt,\tag{14.2}
    \]
  \emph{where the short rate process \(r\) is assumed to be an adapted stochastic process.}
\end{itemize}

We can use the representation of \(\mu^i\), \(\sigma^{ij}\) and \(S^i\) as vectors and matrices on the form.

\[
\mu =
\begin{bmatrix}
\mu ^1\\
\vdots\\
\mu ^n
\end{bmatrix},\ \sigma=
\begin{bmatrix}
\sigma^{1,1}& \cdots & \sigma^{i,N}\\
\vdots & \ddots & \vdots\\
\sigma^{n,1}&\cdots&\sigma^{n,N}
\end{bmatrix},\ D(S)=
\begin{bmatrix}
S^{1}& \cdots & 0\\
\vdots & \ddots & \vdots\\
0&\cdots&S^n
\end{bmatrix}.
\]

And so we have the model on compact form.
\begin{align*}
dS_t&= D(S_t)\mu_t\ dt+D(S_t)\sigma_t\ dW_t,\tag{14.3}\\
dB_t&=r_tB_t\ dt.\tag{14.4}
\end{align*}
Now using Girsanov Theorem we can define the prospective likelihood process\index{likelihood process} \(L\) by
\begin{align*}
dL_t&=L_t\varphi_t^\top\ dW_t,\tag{14.5}\\
L_0&=1,\tag{14.6}
\end{align*}
where \(\varphi\) is an adapted \(N\)-dimensional process. Then our candidate martingale measure \(Q\) is given by \(dQ=L_t\ dP\) on \(\mathcal{F}_t\) and the Girsanov theorem give the dynamics

\[
dW_t=\varphi_t\ dt+dW_t^Q,\tag{14.7}
\]

where \(W^Q\) is a standard \(Q\)-Brownian motion. Inserting into the \(P\)-dynamics we obtain.

\[
dS_t=D(S_t)[\mu_t+\sigma_t\varphi_t]\ dt+D(S_t)\sigma_t\ dW_t^Q.\tag{14.8}
\]

The from (11.54) we know that \(Q\) is a martingale measure if and only if the local rate of return (the \(dt\)-term) is the short interest rate i.e.~if and only if

\[
\mu_t+\sigma_t\varphi=\mathbf{r}_t,\tag{14.9}
\]

where \(\mathbf{r}_t=[r,...,r]^\top\in\mathbb{R}^n\). We then have that

\[
\sigma_t\varphi_t = \mathbf{r}_t-\mu_t,\tag{14.11}
\]

where we want to solve for \(\varphi\). Thus we may write a condition for the absence of arbitrage in linear algebra terms.

\textbf{Proposition 14.1. (Bjork)} \emph{A necessary condition for absence of arbitrage is that}

\[
\mathbf{r}_t-\mu_t\in Im[\sigma_t]
\]

\emph{with probability one for each \(t\). A sufficient condition for absence of arbitrage is that there exists a process \(\varphi\) which solves (14.11) and such that \(L\) is a martingale.}

Note that it is not enought for \(\varphi\) to solce (14.11). We also need that \(L\) is a martingale.

\textbf{Definition 14.2. (Bjork)} \emph{A Girsanov kernel \(\varphi\) is said to be \textbf{admissible} if it generates a martingale measure, i.e.~it solves (14.11) and \(L\) is a true martingale.}

\textbf{Definition 14.3. (Bjork)} \emph{The model above is said to be \textbf{generically arbitrage free}\index{generically arbitrage free} if it is arbitrage free for every choice of \(\mu\).}

\textbf{Proposition 14.4. (Bjork)} \emph{Disregarding integrability problems the model is generically arbitrage free if and only if, for each \(t\le T\) and \(P\)-a.s., the mapping}

\[
\sigma_t : \mathbb{R}^B\to \mathbb{R}^n
\]

\emph{is surjective, i.e.~if and only if the volatility matrix \(\sigma_t\) has rank \(n\).}

\textbf{Proposition 14.5. (Bjork)} \emph{Assume that the model i generically arbitrage free and that the filtration \(\mathbf{F}\) is defined by}

\[
\mathcal{F}_t=\mathcal{F}^W_t.\tag{14.14}
\]

\emph{Then, disregarding integrability problems, the model is complete if and only if \(n=N\) and the volatility matrix \(\sigma_t\) is invertible \(P\)-a.s. for each \(t\le T\).}

\textbf{Assumption 14.3.1. (Bjork)} \emph{We assume that the model is generically free of arbitrage, i.e.~that}

\[
Im[\sigma_t]=\mathbb{R}^n,\tag{14.16}
\]

\emph{for all \(t\) and with probability one. We also assume that the model is purely Brownian driven, i.e.~that \(\mathcal{F}_t=\mathcal{F}_t^W\).}

\textbf{Proposition 14.6. (Bjork)} \emph{Under assumption 14.3.1 the model is complete if and only if}

\[
Im[\sigma_t^\top]=\mathbb{R}^N.\tag{14.23}
\]

\emph{If the model is complete then, using the notation of chapter 11, the replicating portfolio \([h^0,h^S]\) is given by}
\begin{align*}
h_t^S&=g_t\sigma_t^{-1}D^{-1}(Z_t),\tag{14.24}\\
h_t^2&=M_t-h_tZ_t.\tag{14.25}
\end{align*}
\emph{With \(M_t\) defined by}

\[
M_t=E^Q\left[\left. \frac{\mathcal{X}}{B_T}\ \right\vert\ \mathcal{F}_t \right].\tag{14.17}
\]

\textbf{Theorem 14.7. (Bjork)} \textbf{(The Second Fundamental Theorem)}\index{The Second Fundamental Theorem} \emph{Under assumptions 14.3.1 the model is complete if and only if the martingale measure is unique. This is equivalent with the statements: \(Ker[\sigma_t]=\{0\}\), \(Im[\sigma_t^\top]=\mathbb{R}^N\) and \(\sigma_t^{-1}\) exists (i.e.~\(\sigma_t\) is invertible).}

Pricing of any \(T\)-claim \(\mathcal{X}\) is now given by the risk neutral valuation formula

\[
\Pi_t[\mathcal{X}] = E^Q\left[\left. e^{-\int_t^Tr_u\ du}\mathcal{X} \ \right\vert\ \mathcal{F}_t\right],\tag{14.27}
\]

where \(Q\) is some choice of martingale measure. Alternatively we can write the price as

\[
\Pi_t[\mathcal{X}] = E^Q\left[\left. \frac{\mathbf{M}_T}{\mathbf{M}_t}\mathcal{X} \ \right\vert\ \mathcal{F}_t\right],\tag{14.29}
\]

where \(\mathbf{M}\) is the stochastic discount factor, defined by

\[
\mathbf{M}_t=\frac{1}{B_t}L_t.
\]

If we have a simple claim i.e.~of the form \(\mathcal{X}=\Phi(S_t)\) and if \(S\) is Markovian we have

\[
e^{-r(T-t)}E^Q[\Phi(S_t)\ \vert\ \mathcal{F}_t]=e^{-r(T-t)}E^Q[\Phi(S_t)\ \vert\ S_t],
\]

and then the pricing process must be of the form \(\Pi_t[\Phi]=F(t,S_t)\). We then have \(F\) to be the solutions to the PDE
\begin{align*}
F_t(t,s)+\sum_{i=1}^nrs_iF_i(t,s)+\frac{1}{2}\text{tr}\left\{\sigma^\top D(S)F_{ss}D(S)\sigma\right\}-rF(t,s)&=0,\tag{14.31}\\
F(T,s)&=\Phi(s),\tag{14.31}
\end{align*}
where \(F_i=\frac{\partial F}{\partial s_i}\) and \(F_{ss}\) denotes the Hessian matrix. Furthermore, \(\text{tr}(A)\) denotes the trace of \(A\) i.e.~the sum of the diagonal. We have that the hedging portfolio has value process \(V_t^h=F(t,S_t)\) with dynamics

\[
dV_t^h=\sum_{i=1}^n F_i(t,S_t)\ dS_t^i.
\]

Then we must gave the solution
\begin{align*}
h_t^i&=\frac{\partial F}{\partial s_i}(t,S_t),\hspace{10pt}i=1,...,n,\tag{14.32}\\
h_t^0&=\frac{1}{B_t}\left\{F(t,S_t)-\sum_{i=1}^n \frac{\partial F}{\partial s_i}(t,S_t)\ S_t^i\right\}.\tag{14.33}
\end{align*}

\textbf{Proposition 14.8. (Bjork)} \emph{With \(L\)-dynamics as in \(dL_t=L_t\varphi^\top_t\ dW_t\), the \(\mathbf{M}\)-dynamics are}

\[
d\mathbf{M}_t=-r_t\mathbf{M}_t\ dt+\mathbf{M}_t\varphi_t^\top\ dW_t,\tag{14.39}
\]

\emph{or alternatively in terms of the market price of risk \(\lambda_t=-\varphi_t\)}

\[
d\mathbf{M}_t=-r_t\mathbf{M}_t\ dt-\mathbf{M}_t\lambda_t^\top\ dW_t.\tag{14.40}
\]

\textbf{Proposition 14.9. (Bjork)} \textbf{(The Hansen-Jagannathan Bounds)}\index{The Hansen-Jagannathan Bounds} \emph{Assume generic absence of arbitrage. Then the following holds for all assets, underlying or derivative, and for all admissible Girsanov kernels \(\varphi\), and market prices of risk \(\lambda\).}

\[
\frac{\vert \mu_t^p - r_t\vert}{\Vert \sigma_t ^p\Vert}\le \Vert \varphi_t\Vert,\hspace{15pt} \frac{\vert \mu_t^p - r_t\vert}{\Vert \sigma_t ^p\Vert}\le \Vert \lambda_t\Vert.\tag{14.42}
\]

\hypertarget{basic-non-life-insurance-mathematics}{%
\chapter{Basic Non-Life Insurance Mathematics}\label{basic-non-life-insurance-mathematics}}

Noget indhold

\hypertarget{stochastic-processes-in-non-life-insurance-mathematics}{%
\chapter{Stochastic Processes in Non-Life Insurance Mathematics}\label{stochastic-processes-in-non-life-insurance-mathematics}}

Noget indhold

\hypertarget{topics-in-non-life-insurance-mathematics}{%
\chapter{Topics in Non-Life Insurance Mathematics}\label{topics-in-non-life-insurance-mathematics}}

Noget indhold

\hypertarget{probabilistic-machine-learning}{%
\chapter{Probabilistic Machine Learning}\label{probabilistic-machine-learning}}

\hypertarget{supervised-learning}{%
\section{Supervised Learning}\label{supervised-learning}}

In this chapter we restrict our selves to the area of \emph{Supervised Learning} as we use numerical methods and machine learning algorithms to estimate models in a restricted framework. Take for instance the random forest, this algorithm's estimation method is perfectly capable of being written recursively and so no ``leaning'' is done in the sense, that the calculations are predetermined from the algorithm. We therefore call the area of study supervised learning instead of the wider area of study \emph{machine learning}. Let us define what we mean by supervised learning.

\textbf{Definition. (Supervised Learning)}\index{Supervised Learning} \emph{Supervised learning is a field in machine learning that works with labeled data, i.e.~data consisting of a set of features \(X\), and a response \(Y\). The goal is to learn a function \(m^*\) that maps a given input \(x\) to an output \(y\).}

We will in this chapter only use data in the form of a spread sheet e.g.

\[
\mathcal{D}_n=
\left(X_i, Y_i \right)_{i=1,...,n}=
\left[
\begin{array}{cccc|c}
X_{11} & X_{12} & \cdots & X_{1p} & Y_1\\
X_{21} & X_{22} & \cdots & X_{2p} & Y_2\\
\vdots & \vdots & \ddots & \vdots & \vdots\\
X_{n1} & X_{n2} & \cdots & X_{np} & Y_n
\end{array}
\right],
\]

we could however consider any data that may be interpreted by computer software.

The setting is then; assume that we have \(n\) independent copies of the random variable \(D=(X,Y)\in \mathcal{X}\times \mathcal{Y}\), where \(X\) is \(p\)-dimensional and \(Y\) is one-dimensional. We make no assumption on whether \(X_j\), \(j=1,..,p\) and \(Y\) are discrete or continuous, however in concrete cases this will be specified. We combine the sample of the \(n\) observations in the matrix \(\mathcal{D}_n=(X_i,Y_i)_{i=1,...,n}\) being a \(n\times p+1\) matrix as in the above. We call \(\mathcal{D}_n\) the \textbf{training data}\index{training data}.

This specification does indeed imply that \(D_i=(X_i,Y_i)\) are iid. This is actually a bit controversial as we would expect that the distribution of \(D\) will shift over time. For instance, the distribution of ages in a population changes over time and have been more right skewed as humanity advances. This may be accounted for by transforming the data such that the distribution becomes the same. This may be done in a variety of ways some example include: 1) transforming to uniform variable with the time dependent distribution \(F_t\), 2) normalizing using a price index and so forth. One should therefore start any analysis by ensuring that the data a given algorithm is trained on is iid.

The job becomes finding a good estimator such that we may predict \(Y\) given \(X\) i.e.~\(Y\ \vert\ X\). Let us define what an estimator is.

\textbf{Definition. (Estimator)}\index{Estimator} \emph{Consider a training dataset \(\mathcal{D}_n\). A estimator \(m\) is a function-valued mapping that takes \(\mathcal{D}_n\) as input and associates a function \(m_n : \mathcal{X}\to \mathcal{Y}\) i.e.~\(m\) takes the form}

\[
m(\mathcal{D}_n)=m_n:\mathcal{X}\to \mathcal{Y}
\]

\emph{the class of estimators is called \(\mathcal{G}\).}

\hypertarget{what-is-a-good-estimator}{%
\subsection{What is a good estimator?}\label{what-is-a-good-estimator}}

It is easy to construct an estimator \(\hat{m}\) for instance by maximum likelihood esitmation, bayes optimization or simply by taking conditional expectations. We are however interested in two problems:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  What is the best class of estimators \(\mathcal{G}_0\subset\mathcal{G}\),
\item
  In the subset of estimators \(m \in \mathcal{G}_0\), what is then the best estimator.
\end{enumerate}

We will now discuss the meaning of being the \emph{``best''} estimator. Obviously, the first type of consideration is regarding the inherent restrictions of some algorithm, where the second is the problem of error comming from the restriction that we do not have infinite observations. We therefore have two problems namely the \textbf{inductive bias} from the class \(\mathcal{G}_0\) and the \textbf{estimation error} from the available data. A typical problem is that the larger a class \(\mathcal{G}_0\) gives low inductive bias we then may not be able to estimate anything and so the estimation error will be large. The converse also applies.

\textbf{Definition.} \emph{Let \(D=(X,Y)\) be a random variable on the background space \((\Omega, \mathcal{F},P)\). Then we define the following:}

\begin{itemize}
\tightlist
\item
  \emph{A \textbf{decision rule}\index{decision rule} is a deterministic function \(m:\mathcal{X}\to \mathcal{Y}\),}
\item
  \emph{A \textbf{loss function}\index{loss function} is a deterministic function \(L: \mathcal{Y}\times \mathcal{Y}\to \mathbb{R}_+\),}
\item
  \emph{The \textbf{risk}\index{risk} of a decision rule \(m\) is given a loss function \(L\) is \(r(m)=E[L(Y,m(X))]\).}
\end{itemize}

Notice that in the definition of risk we see that \(m\) is included inside the expectation. This means in particular that the training data \(\mathcal{D}_n\) is also accounted for i.e.~by the tower rule we have

\[
r(m)=\mathbb{E}[L(Y,m(X))]=\mathbb{E}\left[\mathbb{E}\Big[L(Y,m_n(X))\ \Big\vert\ \mathcal{D}_n\Big]\right]:=\mathbb{E}\left[R(m)\right].
\]

Some widely used loss function include

\begin{itemize}
\tightlist
\item
  Quadratic loss function:\index{Quadratic loss function} \(L(y_1,y_2)=(y_1-y_2)^2\),
\item
  Poisson Deviance:\index{Poisson Deviance} \(L(y_1,y_2)=2\left(y_1\log\frac{y_1}{y_2}-y_1+y_2\right)\),
\item
  Binary loss function:\index{Binary loss function} \(L(y_1,y_2)=1_{y_1\ne y_2}\).
\end{itemize}

Given a loss function \(L\) we may find a (possibly non-unique) solution \(m^*\) that minimizes \(R(m)\). We call this the \textbf{Bayes estimator}\index{Bayes estimator}. The quantity \(R(m^*)\) is called the \textbf{Bayes risk}\index{Bayes risk}. On some special case loss functions we may determine the unique solution.

\textbf{Lemma.} \emph{Assume \(Y\) is \(L_2\) (square integrable), then the decision function that minimized the risk for the quadratic loss function is}

\[
m^*=\underset{m}{\text{argmin}}\ \mathbb{E}[(Y-m(X))^2]=E[Y\ \vert\ X=x]
\]
i.e.~the conditional expectation.

\textbf{Lemma.} \emph{Assume \(\mathcal{Y}=\{1,...,K\}\), the decision function that minimizes the risk for the binary loss function satisfies}

\[
m^*=\underset{m}{\text{argmin}}\ \mathbb{E}[1_{Y\ne m(X)}]=\underset{m}{\text{argmin}}\  \mathbb{P}(Y\ne m(X))=\underset{k=1,..,K}{\text{argmax}}\ \mathbb{P}(Y=k\ \vert\ X=x).
\]

We can now define the prediction risk and the generalization error which relates to the balance of a sufficiently large class \(\mathcal{G}_0\) and how effective the optimal estimator is conditional on the class \(\mathcal{G}_0\).

\textbf{Definition. (Conditional risk)}\index{Conditional risk} \emph{Let \(\mathcal{D}_n\) be some training data. Given an estimator \(\hat{m}_n\) we call}

\[
R(\hat{m}_n)=\mathbb{E}[L(Y,\hat{m}_n(X))\ \vert\ \mathcal{D}_n]
\]

\emph{the prediction risk or conditional generalized error.\index{conditional generalized error}}

\textbf{Definition. (Risk)}\index{Risk} \emph{We call}

\[
r(\hat{m}_n)=\mathbb{E}[R(\hat{m}_n)],
\]

\emph{the prediction risk or generalized error.\index{generalized error}}

\hypertarget{excess-risk}{%
\subsection{Excess risk}\label{excess-risk}}

\textbf{Definition. (Excess Risk)}\index{Excess Risk} \emph{Consider the set \(\mathcal{G}\) be the set of all measurable estimators. Fix a subset \(\mathcal{G}_0\subset\mathcal{G}\). Given some training data \(\mathcal{D}_n\) consider the Bayes estimator restricted to \(\mathcal{G}_0\) denoted by \(\hat{m}_n\) and the unconditional Bayes estimator restricted to \(\mathcal{G}\) we define the quantity}

\[
R(\hat{m}_n)-r(m^*)
\]

\emph{or}

\[
\mathbb{E}[R(\hat{m}_n)\ \vert\ X_1,...,X_n]-r(m^*),
\]

\emph{as the excess risk. This is the difference between the generalization error and the risk obtained by an optimal decision function.}

In the context of the above definition we can decompose the risk associated with the optimal estimator \(\hat{m}_n\in\mathcal{G}_0\) into the estimation error and the inductive bias.

\[
R(\hat{m}_n)-r(m^*)=\underbrace{\left[R(\hat{m}_n)-\inf_{m\in\mathcal{G}_0}R(m)\right]}_{\text{estimation error}}+\underbrace{\left[\inf_{m\in\mathcal{G}_0}R(m)-R(m^*)\right].}_{\text{inductions bias/approximation error}}
\]
\index{estimation error}\index{inductions bias}
where we have to balance the trade-off with a larger \(\mathcal{G}_0\) infer a lower induction bias but larger estimation error and a smaller class \(\mathcal{G}_0\) infer a lower estimation error but larger induction bias.

\textbf{Definition. (Empirical risk and empirical risk minimizer)}\index{empirical risk}\index{empirical risk minimizer} \emph{Given training data \(\mathcal{D}_n\) and a loss function \(L\), we call}

\[
\hat{R}_n(m):=\sum_{i=1}^nL(Y_i,m(X_i))
\]

\emph{the \textbf{empirical risk}. Given an additional function class \(\mathcal{G}_0\),}

\[
\underset{m\in\mathcal{G}_0}{\text{argmin}}\ \hat{R}_n(m)=\underset{m\in\mathcal{G}_0}{\text{argmin}}\ \sum_{i=1}^nL(Y_i,m(X_i))
\]

\emph{is called \textbf{empirical risk minimizer} or (standard leaner).}

For larger function classes \(\mathcal{G}_0\) the empirical risk minimizer might not be unique and possibly too noisy. In this case one sometimes adds a penalty term \(J_\lambda : \mathcal{G}\to \mathbb{R}_+\) that penalizes the complexity of \(m\) and minimizes the penalized empirical risk:

\[
\underset{m\in\mathcal{G}_0}{\text{argmin}}\ \hat{R}_{n,\lambda}:=\underset{m\in\mathcal{G}_0}{\text{argmin}}\ \sum_{i=1}^nL(Y_i,m(X_i)) + J_\lambda(m).
\]

If \(J_\lambda\) and \(\hat{R}_n\) is convex one can show that

\[
\underset{m\in\mathcal{G}_0}{\text{argmin}}\ \hat{R}_{n,\lambda}=\underset{m\in\mathcal{G}_\eta}{\text{argmin}}\ \hat{R}_{n}
\]

for the class \(\mathcal{G}_\eta=\{m\in \mathcal{G}_0\ \vert\ J_\lambda(m)\le \eta\}\). Some penalty terms could be

\begin{itemize}
\tightlist
\item
  \(J_\lambda(m)=\lambda\int m''(x)\ dx\),
\item
  \(J_\lambda(m)=\lambda \int\vert m'(x)\vert\ dx\),
\item
  \(J_\lambda(m)=\lambda \int(m(x))^2\ dx\).
\end{itemize}

\textbf{Proposition. (Probability bounds)} \emph{Let \(\tilde{m}=\underset{m}{\text{argmin}}\ r(m)\). We have}

\[
r(\hat{m}_n)-r(\tilde{m})\le 2\sup_{m\in\mathcal{G}_0}\Big\vert\hat{R}_n(m) - r(m) \Big\vert,
\]

\emph{and for all \(\lambda \in \Lambda\),}

\[
r(\hat{m}_{n,\lambda})-r(\tilde{m})\le 2\sup_{m\in\mathcal{G}_0}\Big\vert\hat{R}_{n,\lambda}(m) - r(m) \Big\vert + J_\lambda(\tilde{m})-J_\lambda(\hat{m}_n).
\]

\textbf{Definition.} \emph{We say \(\hat{m}_n\) is \(\varepsilon\)-accurate with probabiltiy \(1-\delta\), if}

\[
P\Big(R(\hat{m}_n)-\inf_{m\in\mathcal{G}}r(m)>\varepsilon\Big)<\delta.
\]

\hypertarget{training-validating-and-testing}{%
\section{Training, Validating and Testing}\label{training-validating-and-testing}}

When deciding which method too choose for a given task, one may like to pick the method with the smallest generalization error. However, most machine learning methods depend on hyper parameters and one may first need to decide which hyper parameters are best for the given task. In short: We would like to compare the generalization error of optimally tuned machine learning methods given our data.

\textbf{Definition. (Training and test set)} \emph{One often randomly divides the given data into training data and test data:}

\begin{itemize}
\tightlist
\item
  \(\mathcal{D}_n=(X_i,Y_i)_{i=1,...,n}\) \emph{(training data)\index{traning data}}
\item
  \(\mathcal{T}_m=(\tilde{X}_j,\tilde{Y}_j)_{j=1,...,m}\) \emph{(test data)\index{test data}}
\end{itemize}

\emph{with \(n\in[0.8m,0.95m]\).}

\textbf{Definition. (Training and test error)} \emph{The empirical risk on the training data is called training error and on the test data test error.}

\textbf{Definition. (Validation set)} \emph{To tune the hyper parameters for an algorithm, one often randomly divides the given training data into training data (yes: also called training data.) and validation data:}

\begin{itemize}
\tightlist
\item
  \(\mathcal{D}_{n_1}=(X_i,Y_i)_{i=\tau(1),...,\tau(n_1)}\) \emph{(traning data)}
\item
  \(\mathcal{V}_{n_2}=(\tilde{X}_j,\tilde{Y}_j)_{j=\tau(n_1+1),...,\tau(n)}\) \emph{(validation data)\index{validation data}}
\end{itemize}

\emph{where \(\tau\) is a randomly picked permutation of \(\{1,...,n\}\) and \(n_1+n_2=n\) is respectively the size of the training set and the validation set.}

One can now compare different methods via the following simple algorithm:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Split your data into train, validation and test set.
\item
  For a given method and a rich set of hyper parameter configurations train the method on the training set and compare performance via empirical risk on the validation set.
\item
  For every method, pick the hyper parameter with the smallest empirical risk.
\item
  Compare different methods with the chosen hyper parameters on the test set (trained on training+validation set) and pick the method with smallest empirical risk.
\end{enumerate}

Notice that the procedure above is stochastic and has bias and variance both for selecting the optimal hyper parameters and for selecting the optimal method.

\begin{itemize}
\tightlist
\item
  Bias: Bias occurs because the sample sizes used for learning the hyper parameters \(n_1\) are smaller than the actual training size \(n\) and also the full data size \(n+m\).
\item
  Variance: The results are stochastic because the validation and test set are not of infinite size.
\end{itemize}

Variance can be reduced by repeating steps 1-4 several times. The most popular method for doing so is (nested) cross validation.

\hypertarget{estimating-risk}{%
\subsection{Estimating risk}\label{estimating-risk}}

We want to estimate the generalization error of a method \(\hat{m}_{n,\lambda}\) that depends on a fixed hyper parameter \(\lambda\).

\textbf{Definition. (M-fold Cross validation)}\index{M-fold Cross validation} \emph{Given the indices of a data set \(S=\{1,...,n\}\), M-fold cross validation follows the following steps:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Divide the data into \(M\) disjoint sets \(S_1,...,S_M\) of same size. Define \(S_{-l}=\cup_{k\ne l}S_k\) being the complement to \(S_l\). (\(\#S_l=n/M\) and \(\#S_{-l}=(M-1)n/M\))}
\item
  \emph{For each subdivision \(l=1,...,M\) train the algorithm on \(S_{-l}\) and denote the estimator \(\hat{m}_\lambda(S_{-l})\).}
\item
  \emph{Calculate the cross validated empirical risk}
  \[
    CV(\hat{m}_{n,\lambda})=\frac{1}{M}\sum_{l=1}^M\frac{1}{\vert S_{-l}\vert}\sum_{i\in S_{-l}}L\big(Y_i,\hat{m}_\lambda(S_{-l})(X_i)\big)
    \]
\end{enumerate}

It is a non-trivial discussion what \(CV(\hat{m}_{n,\lambda})\) is estimating. Consider the heuristic
\begin{align*}
CV(\hat{m}_{n,\lambda})&=\frac{1}{M}\sum_{l=1}^M\frac{1}{\vert S_{-l}\vert}\sum_{i\in S_{-l}}L\big(Y_i,\hat{m}_\lambda(S_{-l})(X_i)\big)\\
&\approx \frac{1}{M}\sum_{l=1}^MR\big(Y,\hat{m}_\lambda(S_{-l})(X)\big)\\
&\approx \mathbb{E}\left[R\big(Y,\hat{m}_\lambda(S_{-l})(X)\big)\right].
\end{align*}
Where we used the law of large numbers in the first approximation. The last approximation is not so clear because the summands are dependent for \(M>2\).

The bias is minimal for large \(M\) since estimation is based on training the algorithm on \((M-1)n/M\) data points. In the case that \(M=n\), M-fold cross validation is also known as leave-one-our cross validation. It is however often not practical because of the computational cost. In practice, setting \(M=5\) or \(M=10\) is common choices.

When deciding on an optimal hyper parameter we would like to pick

\[
\underset{\lambda \in \Lambda}{\text{argmin}}\ CV(\hat{m}_{n,\lambda}).
\]

But the hyper parameter space \(\Lambda\) is often multi-dimensional and partly continuous. Hence it is infeasible to try out all parameters. Common practice are

\begin{itemize}
\tightlist
\item
  Grid search
\item
  Random search (e.g.~pick 200 parameters uniformly random from the parameter space)
\item
  Advanced optimization techniques (i.e.~techniques that aim to find the minimzer of a function (here: cross validated empirical risk) without the requirement of knowing the analytical form of the function to optimize.
\end{itemize}

Above we have discussed how we can use cross validation to pick an optimal parameter for a given method and data set. But how to choose between different methods? One popular way is nested cross validation comprising an inner loop for hyper parameter selection (tuning) and an outer loop for method comparison. Assume that we want to compare \(J\) methods \(\hat{m}_{n,j}\), \(j=1,...,J\). then we may use nested cross validation.

\textbf{Definition. (Nested \(M_1-M_2\) Cross-validation)}\index{Nested $M_1-M_2$ Cross-validation} \emph{Given the indices of a data set \(S=\{1,...,n\}\), nested \(M_1-M_2\) cross validation follows the following steps:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Divide the data into \(M_1\) disjoint sets \(S_1,...,S_{M_1}\) of same size. Define \(S_{-l}=\cup_{k\ne l}S_k\) being the complement to \(S_l\). (\(\#S_l=n/M_1\) and \(\#S_{-l}=(M_1-1)n/M_1\))}
\item
  \emph{For each \(l=1,...,M_1\), run \(M_2\)-fold cross validation on \(S_{-l}\) for all \(J\) methods, returning optimal hyper parameters \(\hat{\lambda}(j,l)\), \(j=1,...,J\) and \(l=1,...,M_1\). (the one with lowest \(CV\) is choosen for each \((j,l)\))}
\item
  \emph{Calculate the cross validated empirical risk}
  \[
    CV(\hat{m}_{n,j})=\frac{1}{M_1}\sum_{l=1}^{M_1}\frac{1}{\vert S_{-l}\vert}\sum_{i\in S_l}L\big(Y_i,\hat{m}_{\lambda(j,l)}(S_{-l})(X_i)\big)
    \]
\item
  \emph{Pick the method with the smallest risk (and possibly tune again for fitting)}
\end{enumerate}

\hypertarget{linear-models}{%
\section{Linear Models}\label{linear-models}}

We may take the linear model as a case study of the methods introduced in the above chapter. As such we consider the squaed loss \(L(y_1,y_2)=(y_1-y_2)^2\) for which we already know the Bayes rule:

\[
m^*(x)=\underset{m}{\text{argmin}}\ R(m)=\mathbb{E}[Y\ \vert\ X=x].
\]

The linear model has the following assumptions. There exists paramaters \(\beta_0^*,\beta_1^*,...,\beta_p^*\), with

\[
m^*(x)=\beta_0^*+\sum_{j=1}^{p}\beta_j^*x_j.
\]

In other words, we assume that \(m^*\) is a linear function, i.e.,

\[
m^*\in\mathcal{G}=\{f : \mathbb{R}^p\to \mathbb{R}\ \vert\ f(x)=\beta^\top x\}.
\]

Given iid training data \((X_i,Y_i)_{i=1,...,n}\) we have an additive noise model

\[
Y_i=\beta_0^*+\sum_{j=1}^{p}\beta_j^*X_{ij}+\varepsilon_i,
\]

with \(\varepsilon_i=Y_i-m^*(X_i)\) and hence iid with \(\mathbb{E}[\varepsilon_i\ \vert\ X_i]=0\).

Notice, that since we are assuming \(m^*\in\mathcal{G}\) we have by assumption no inductive bias and we therefore only consider estimation error i.e.

\[
R(\hat{m}_n)-r(m^*).
\]

Given the training data we may approximate the coefficients using the following.

\textbf{Lemma. (Coefficients in the linear model)} \emph{Under the Linear model assumption we have for \(j=1,...,p\)}

\[
\beta^*_j=\frac{\text{Cov}\Big(X_{1j},Y_1-\sum_{k\in \{1,...,p\}\setminus \{j\}} \beta_k^*X_{1k}\Big)}{\text{Var}(X_{1j})}
\]

\emph{In particular, if the components of \(X\) are uncorrelated, we have}

\[
\beta_j^*=\frac{\text{Cov}(X_{1j},Y_1)}{\text{Var}(X_{1j})}.
\]

\textbf{Lemma. (Bayes risk in the linear model)} \emph{Under the Linear model assumption we have}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(r(m^*)=\text{Var}(\varepsilon_i)\)
\item
  For \(m(x)=\beta_0+\sum_{j=1}^p \beta_jx_j\),
  \[
    r(m)-r(m^*)=\Vert\Sigma^{1/2}(\beta -\beta^*) \Vert^2_2.
    \]
\end{enumerate}

\hypertarget{least-squares-estimator}{%
\subsection{Least Squares Estimator}\label{least-squares-estimator}}

Moving forward we will assume \(\beta_0^*=0\) since we can always translate the data and make the centered around 0. We will furthermore use the notation:

\[
\mathbf{X}=
\begin{bmatrix}
X_{11} & \cdots & X_{1p}\\
\vdots & \ddots & \vdots\\
X_{n1} & \cdots & X_{np}
\end{bmatrix},\hspace{10pt} \mathbf{Y}=
\begin{pmatrix}
Y_1\\
\vdots\\
Y_n
\end{pmatrix},\hspace{10pt} \varepsilon=
\begin{pmatrix}
\varepsilon_1\\
\vdots\\
\varepsilon_n
\end{pmatrix}.
\]

In this cases the empirical risk takes the form

\[
\hat{R}_n(m)=\frac{1}{n}\Vert\mathbf{Y}-\mathbf{X}\beta \Vert^2_2.
\]

\textbf{Lemma. (Least squares estimator)}\index{Least squares estimator}

\begin{itemize}
\tightlist
\item
  \emph{It holds that \((\mathbf{X}^\top\mathbf{X})\hat{\beta}=\mathbf{X}^\top \mathbf{Y}\),}
\item
  \emph{If \(\mathbf{X}\) has full rank, then}
  \[
    \hat{\beta}_n^{LS}=(\mathbf{X}^\top\mathbf{X})^{-1}\mathbf{X}^\top \mathbf{Y}.
    \]
\end{itemize}

\textbf{Theorem. (Excess risk Least squares estimator)} \emph{If \(\mathbf{X}^\top\mathbf{X}\) is invertible, then}

\[
\mathbb{E}[R(\hat{m}_n^{LS})\ \vert\ \mathbf{X}]-r(m^*)=\frac{\sigma^2}{n}\cdot \text{tr}\left(\Sigma\hat{\Sigma}^{-1}\right)
\]

\emph{with \(\Sigma=\mathbb{E}[\mathbf{X}^\top\mathbf{X}]\) and \(\hat{\Sigma}=\frac{1}{n}\mathbf{X}^\top\mathbf{X}\).}

\textbf{Proof.}

\[
\hat{\beta}^{LS}=\left(\mathbf{X}^T \mathbf{X}\right)^{-1} \mathbf{X}^T \mathbf{Y}=\left(\mathbf{X}^T \mathbf{X}\right)^{-1} \mathbf{X}^T \mathbf{X} \beta^*+\left(\mathbf{X}^T \mathbf{X}\right)^{-1} \mathbf{X}^T \mathbf{\varepsilon}=\beta^*+\left(\mathbf{X}^T \mathbf{X}\right)^{-1} \mathbf{X}^T \mathbf{\mathbf { \varepsilon }}.
\]

Thus
\begin{align*}
R\left(\hat{m}^{LS}\right)-r\left(m^*\right) & =\left\|\Sigma^{1 / 2}\left(\hat{\beta}^{L S}-\beta^*\right)\right\|_2^2=\left\|\Sigma^{1 / 2}\left(\mathbf{X}^T \mathbf{X}\right)^{-1} \mathbf{X}^T \mathbf{\varepsilon}\right\|_2^2=n^{-1}\left\|n^{-1/2}\Sigma^{1 / 2} \hat{\Sigma}^{-1} {\mathbf{X}^T \mathbf{\varepsilon}}\right\|_2^2 \\
& =n^{-1}\|A \mathbf{\varepsilon}\|_2^2,
\end{align*}
where \(\hat \Sigma=n^{-1} \mathbf{{X^T}X}, A:=n^{-1/2}\Sigma^{1 / 2} \hat{\Sigma}^{-1} {\mathbf{X}^T}\). We calculate the excess risk conditional on \(\mathbf{X}\). Note that \(\operatorname{tr}(\cdot)\) is linear and invariant under cyclic permutations. We have
\begin{align*}
\mathbb{E}\left[R\left(\hat{m}^{LS}\right) \mid \mathbf{X}\right]-r\left(m^*\right) & =n^{-1} \mathbb{E}\left[\|A \mathbf{\varepsilon}\|_2^2 \mid \mathbf{X}\right] \\
& =n^{-1} \mathbb{E}\left[\operatorname{tr}\left(A \mathbf{\varepsilon \varepsilon}^T A^T\right) \mid \mathbf{X}\right]=n^{-1} \operatorname{tr}(A \underbrace{\mathbb{E}\left[\mathbf{\varepsilon \varepsilon}^T\right]}_{=\sigma^2 I_{p \times p}} A^T)=\frac{\sigma^2}{n}\|A\|_F^2 \\
& =\frac{\sigma^2}{n} \cdot \operatorname{tr}\left(\Sigma^{1 / 2} \hat{\Sigma}^{-1} \hat{\Sigma} \hat{\Sigma}^{-1} \Sigma^{1 / 2}\right) \\
& =\frac{\sigma^2}{n} \cdot \operatorname{tr}\left(\Sigma \hat{\Sigma}^{-1}\right) .
\end{align*}
as desired. \(\blacksquare\)

From the above it follos that if \(\hat{\Sigma}\approx \Sigma\) then

\[
\mathbb{E}[R(\hat{m}_n^{LS})\ \vert\ \mathbf{X}]-r(m^*)\approx\frac{\sigma^2p}{n}.
\]

This approximation does not take into account the variation of \(X\). Due to the inverse, it is not easily possible to derive an upper bound for the expectation of \(\hat{\Sigma}^{-1}\). Therefore, we only obtain a result for the excess Bayes risk which holds with high probability and under additional assumptions (which could be relaxed but would lead to much more complicated proofs).

\textbf{Theorem. (PAC Least squares estimator)}\index{PAC Least squares estimator} \emph{We do not assume a linear model. Let \(m(x)=E[Y\ \vert\ X=x]\) and assume \(m^*(x)=x\Sigma^{-1}E[YX]\) is the best linear approximation. Assume that \(X\) has bounded support and sub-Gaussian noise, i.e., there exists a \(\sigma\) such that for all \(t\):}

\[
E[e^{tx}\ \vert\ X=x]\le e^{t^2\sigma^2/2},
\]

\emph{then for \(n\) big enough, and \(t>\max\{0,2.6-\log p\}\)}

\[
P\left(r(\hat{m}^{LS})-r(m^*)\ge \frac{2 A}{n}(1+\sqrt{8t})^2+\frac{\sigma^2(p+2\sqrt{pt}+2t)}{n} + o(1/n)\right)\le 3e^{-t}
\]

\emph{where \(A=\mathbb{E}\left[\Vert\Sigma^{1/2}X(m(X)-\beta^\top X) \Vert^2\right]\) is an approximation error.}

Up until now we have assumed that \(\mathbf{X}\) has full rank. This is not very realistic for very large \(p\) (\(p> > n\)). Even if \(\mathbf{X}^\top\mathbf{X}\) is invertible, the variance of the estimation error might be too large. This leads us to penalized models that reduce variance by adding some bias. Other alternatives (not discussed here) are dimension reduction, say via PCA, or feature selection, say forward stepwise regression.

\hypertarget{ridge-regression}{%
\subsection{Ridge Regression}\label{ridge-regression}}

\textbf{Definition. (Ridge regression)}\index{Ridge regression} \emph{Let \(\lambda \geq 0\) and}

\[
J_\lambda(\beta)=\lambda\|\beta\|_2^2=\lambda \sum_{j=1}^p \beta_j^2.
\]

\emph{The Ridge estimator is defined as }
\begin{align*}
\hat{\beta}_\lambda^{\text {ridge }} & =\underset{\beta \in \mathbb{R}^p}{\arg \min }\left\{\hat{R}_n(\beta)+J_\lambda(\beta)\right\} \\
& =\underset{\beta \in \mathbb{R}^p}{\arg \min }\left\{\|\mathbf{Y}-\mathbf{X} \beta\|_2^2+\lambda\|\beta\|_2^2\right\} .
\end{align*}
\emph{The corresponding algorithm is}

\[
\hat{m}_{n, \lambda}^{\text {ridge }}(x)=\sum_{j=1}^p \hat{\beta}^\text{ridge}_{\lambda, j} x_j.
\]

\textbf{Lemma. (Ridge regression solution)} \emph{Let \(\lambda>0\). Then }

\[
\hat{\beta}^\text{ridge}_\lambda=\left(\mathbf{X}^T \mathbf{X}+\lambda n I_{p \times p}\right)^{-1} \mathbf{X}^T \mathbf{Y}
\]

In ridge regression, the matrix \(\mathbf{X}^T \mathbf{X}\) is `made invertible' by adding a positive multiple of the identity matrix. Therefore, the ridge estimator also can be used in the case \(p>n\). The name `ridge' stems from the fact that the optimization problem is equivalent to

\[
\min _{ \beta \in \mathbb{R}^p} \hat{R}_n(X\beta) \quad \text { s.t. } \quad\|\beta\|_2 \leq t
\]

for some suitable \(t>0\).

\textbf{Theorem. (Excess risk for ridge regression estimator)} \emph{Under the linear model, }

\[
\mathbb E[ R\left(\hat{m}^{n,\text{ridge}}_\lambda \right)|X]-r\left(m^*\right)=\frac{\sigma^2}{n} \cdot \operatorname{tr}\left(\Sigma\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \hat{\Sigma}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1}\right)+\lambda^2\left\|\Sigma^{1 / 2}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \beta^*\right\|_2^2.
\]

\emph{Let \(\Sigma=U D U^T\) be the spectral decomposition of \(\Sigma\) with orthogonal matrix \(U\) and diagonal matrix \(D=\operatorname{diag}\left(s_1, \ldots, s_p\right.\) ) (entries are the eigenvalues of \(\Sigma\) ). By assuming \(\hat \Sigma= \Sigma\), the excess risk simplifies to }

\[
\frac{\sigma^2}{n} \sum_{j=1}^p \frac{s_j^2}{\left(s_j+\lambda\right)^2}+\lambda^2 \cdot \sum_{j=1}^p \frac{s_j\left(U^T \beta^*\right)_j^2}{\left(s_j+\lambda\right)^2}.
\]

\textbf{Proof.}

\begin{align*}
\hat{\beta}_\lambda-\beta^* & =-\lambda n\left(\mathbf{X}^T \mathbf{X}+\lambda n I_{p \times p}\right)^{-1} \beta^*+\left(\mathbf{X}^T \mathbf{X}+\lambda n I_{p\times p}\right)^{-1} \mathbf{X}^T \mathbf{\varepsilon} \\
& =-\lambda\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \beta^*+\frac{1}{n}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \mathbf{X}^T \mathbf{\varepsilon}
\end{align*}.
thus

\[
R\left(\hat{\beta}_\lambda\right)-R\left(\beta^*\right)=\left\|B-\frac{1}{\sqrt{n}} A \mathbf{\varepsilon}\right\|_2^2=\|B\|_2^2-\frac{2}{\sqrt{n}}\langle B, A\varepsilon \rangle+\frac{1}{n}\|A \mathbb{\mathbf { \varepsilon }}\|_2^2
\]

where \(A=\Sigma^{1 / 2}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \frac{\mathbf{X}^T}{\sqrt{n}}\) and \(B:=\lambda \Sigma^{1 / 2}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \beta^*\). Since \(\mathbb{E} \mathbf{\varepsilon}=0\), we have
\begin{align*}
\mathbb{E}\left[R\left(\hat{\beta}_\lambda\right) \mid \mathbf{X}\right]-R\left(\beta^*\right) & =\frac{\sigma^2}{n}\|A\|_F^2+\|B\|_2^2 \\
& =\frac{\sigma^2}{n} \cdot \operatorname{tr}\left(\Sigma\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \hat{\Sigma}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1}\right)\\
&+\lambda^2\left\|\Sigma^{1 / 2}\left(\hat{\Sigma}+\lambda I_{p \times p}\right)^{-1} \beta^*\right\|_2^2
\end{align*}
Furthermore, assuming \(\hat \Sigma= \Sigma\) the above expression simplifies to
\begin{align*}
&\frac{\sigma^2}{n} \cdot \operatorname{tr}\left(\Sigma\left(\Sigma+\lambda I_{p \times p}\right)^{-1} \Sigma\left(\Sigma+\lambda I_{p \times p}\right)^{-1}\right)+\lambda^2\left\|\Sigma^{1 / 2}\left(\Sigma+\lambda I_{p \times p}\right)^{-1} \beta^*\right\|_2^2 \\
=&\frac{\sigma^2}{n} \cdot \operatorname{tr}\left(D\left(D+\lambda I_{p \times p}\right)^{-1} D\left(D+\lambda I_{p \times p}\right)^{-1}\right)+\lambda^2\left\|D^{1 / 2}\left(D+\lambda I_{p \times p}\right)^{-1} U^T \beta^*\right\|_2^2 \\
=&\frac{\sigma^2}{n} \sum_{j=1}^p \frac{s_j^2}{\left(s_j+\lambda\right)^2}+\lambda^2 \cdot \sum_{j=1}^p \frac{s_j\left(U^T \beta^*\right)_j^2}{\left(s_j+\lambda\right)^2}
\end{align*}

and the result follows. \(\blacksquare\)

If all eigenvalues are equal, that is, \(s_j=s\) and if additionally \(\left(U^T \beta^*\right)_j=b(j=1, \ldots, p)\), then the expression of the theorem simplifies to

\[
\frac{\sigma^2 p}{n} \cdot \frac{s^2}{(s+\lambda)^2}+\lambda^2 \frac{s b^2 p}{(s+\lambda)^2} \underset{\lambda=\frac{\sigma^2/n}{b^2}}{\stackrel{\min }{\rightarrow}} \frac{\sigma^2 p}{n} \cdot \frac{b^2 s}{\frac{\sigma^2}{n}+b^2 s} \leq \frac{\sigma^2 p}{n} .
\]

We see that for a suitable choice of the penalization parameter \(\lambda\), the excess Bayes risk of the ridge estimator can be smaller than the corresponding upper bound of the LS estimator.

\hypertarget{lasso-regression}{%
\subsection{Lasso Regression}\label{lasso-regression}}

If we believe that some covariates are pure noise, i.e., unrelated to \(Y\), the most obvious choice to penalize \(\beta\) would be of the form \(\|\beta\|_0=\#\{j=\) \(\left.{1, \ldots, p: \beta_j} \neq 0\right\}\). Then, one would simply penalize the number of non-zero entries of \(\beta\). However, this leads to an NP-hard optimization problems whose solutions are not accessible in practice. One therefore uses a different norm which has similar properties but leads to a convex optimization problem.

\textbf{Definition. (Lasso - Least absolute shrinkage and selection operator regression)}\index{Lasso regression} \emph{Let \(\lambda \geq 0\) and }

\[
J_\lambda(\beta)=\lambda \cdot\|\beta\|_1=\lambda \sum_{j=1}^p\left|\beta_j\right| .
\]

\emph{The LASSO estimator is given by }
\begin{align*}
\hat{\beta}_\lambda^{\text {lasso }} & \in \underset{\beta \in \mathbb{R}^p}{\arg \min }\left\{\hat{R}_n(X\beta)+J_\lambda(X\beta)\right\} \\
& =\underset{\beta \in \mathbb{R}^p}{\arg \min }\left\{\frac{1}{n}\|\mathbf{Y}-\mathbf{X} \beta\|_2^2+\lambda \cdot\|\beta\|_1\right\}
\end{align*}
\emph{The corresponding algorithm reads }

\[
\hat{m}_{n, \lambda}^{l a s s o}(x)=\sum_{j=1}^p \hat{\beta}^{\text{lasso}}_{\lambda, j} x_j.
\]

There exists no easy closed-form solution for \(\hat \beta^{\text{lasso}}_{\lambda}\) besides some special cases.

For \(\beta \in \mathbb{R}^p\), define

\[
S(\beta):=\left\{j \in\{1, \ldots, p\}: \beta_j \neq 0\right\}.
\]

For \(S \subset\{1, \ldots, p\}\) and \(v \in \mathbb{R}^p\), put \(v_S:=\left(v_j \mathbb{1}_{\{j \in S\}}\right)_{j=1, \ldots, p}\)

If \(p \ll n\), then \(\hat{\Sigma}\) would usually be invertible and the smallest eigenvalue (Rayleigh quotient) would satisfy

\[
\lambda_{\min }(\hat{\Sigma}):=\inf _{v \in \mathbb{R}^p} \frac{v^T \hat{\Sigma} v}{\|v\|_2^2}>0.
\]

Then \(\hat{\Sigma}\) would be one-to-one (injective) and the linear equation system \(\hat{\Sigma} \beta=\frac{1}{n} \mathbf{X}^T \mathbf{Y}\) would lead to the (unique) least squares estimator.

For \(p \gg n\), one has \(\lambda_{\min }(\hat{\Sigma})=0\).

When employing LASSO, we are usually only interested in estimators \(\hat{\beta}\) whith non-zero entries at the components \(S\left(\beta^*\right)\). This means that in principle we only need injectivity of \(\hat{\Sigma}\) on the set

\[
\tilde{C}=\left\{\beta \in \mathbb{R}^p: S(\beta)=S\left(\beta^*\right)\right\}=\left\{\beta \in \mathbb{R}^p:\left\|\beta_{S\left(\beta^*\right)^ c}\right\|_1=0\right\},
\]

or equivalently, \(\inf _{v \in \tilde{C}} \frac{v^T \hat{\Sigma} v}{\|v\|_2^2}=\inf _{v \in \tilde{C}} \frac{v^T \hat{\Sigma} v}{\left\|v_{S\left(\beta^*\right)}\right\|_2^2}>0 .\)

\textbf{Definition. (Restricted eigenvalue property (REP))}\index{Restricted eigenvalue property (REP)} \emph{We say that the restricted eigenvalue property (REP) is satisfied with \(\alpha>0\) if for}

\[
C:=\left\{\beta \in \mathbb{R}^p:\left\|\beta_{S\left(\beta^*\right)^c}\right\|_1 \leq \alpha \left\|\beta_{S\left(\beta^*\right)}\right\|_1\right\}
\]

\emph{it holds that}

\[
\Lambda_{\min }(\Sigma):=\inf _{v \in C} \frac{v^T \Sigma v}{\left\|v_{S\left(\beta^*\right)}\right\|_2^2}>0,
\]

\textbf{Theorem.} \emph{Let \(\varepsilon \sim N\left(0, \sigma^2\right), X \sim N(0, \Sigma)\) and \(\Sigma_{j j}=1(j=1, \ldots, p)\). Define \(s:=\# S\left(\beta^*\right)\). Then there exist universal constants \(c_1, c_2>0\) such that the condition}

\[
n \geq c_1 \frac{\|\Sigma\|_2}{\Lambda_{\min }(\Sigma)^2} s \log (e p / s)
\]

\emph{implies: For each \(t \geq 0\) and }

\[
\lambda \geq \frac{6 \sqrt{2} \sigma}{\sqrt{n}} \sqrt{\log (p)+t},
\]

\emph{it holds that}

\[
\mathbb{P}\left(R\left(\hat{m}_{n,\lambda}\right)-r\left(\beta^*\right)>16 \lambda^2 \frac{s}{\Lambda_{\min }(\Sigma)}\right) \leq e^{-t}+2 p e^{-c_2 n} .
\]

The upper bound for the convergence rate of the excess risk of the LASSO estimator is minimized for \(\lambda=6 \sqrt{2} \cdot \frac{\sigma}{\sqrt{n}} \sqrt{\log (p)}\). With that choice,

\[
16 \lambda^2 \frac{s}{\Lambda_{\min }(\Sigma)}=\frac{\text {c }}{\Lambda_{\min }(\Sigma)} \cdot \frac{\sigma^2 s}{n} \cdot \log (p)
\]

Interpretation: \(\hat{\beta}_\lambda\) behaves like the LS estimator in a model with \(s\) instead of \(p\) dimensions.

The LASSO estimator \(\hat{\beta}_\lambda\) has to `pay' with a factor \(\log (p)\) for the missing insight which components are non-zero. This is a rather small price to pay even if \(p\) is large.

One can prove similar theoretical statements without the conditions \(\varepsilon \sim N\left(0, \sigma^2\right)\) and \(X \sim N(0, \Sigma)\) and still can preserve the small \(\log (p)\) term.

Regarding the REP: The smallest eigenvalue \(\lambda_{\min }(\Sigma)\) measures how strongly the components of \(X\) are correlated. Note that a strong correlation of \(X\) is a problem for estimation of \(\beta^*\), but not for the excess risk itself: In the extreme case \(X_1=X_2\), it is clear that \(\hat{\beta}\) cannot distinguish the values of \(\beta_1^*\) and \(\beta_2^*\), but it can still provide good predictions through \(X \hat{\beta}\). Unfortunately, the proof technique underlying the theorem transfers the estimation quality of \(\beta^*\) to an upper bound of the excess risk, therefore this fact is not adequately represented in the result.

The assumption \(\Sigma_{j j}=1\) is only to provide an easier result. In practice, this normalization can be obtained by standardizing \(X_1, \ldots, X_n\) before computing the LASSO estimator (that is, center \(X_i\) and divide by the empirical standard deviation).

\textbf{Theorem.} \emph{We do not assume that the linear model holds. Assume that \(X\) and \(Y\) have bounded support (bounded by \(B>0\)). Let }

\[
\beta_*=\underset{\|\beta\|_1 \leq \eta}{\operatorname{argmin}} r(X\beta)
\]

\emph{Then for any \(\xi>0\),}

\[
\mathbb P\left (r(\widehat{\beta})- r\left(\beta_*\right)\geq\sqrt{\frac{2(\eta+1)^4 B^2}{n} \log \left(\frac{2p^2}{\xi}\right)}\right) \leq \xi  .
\]

\textbf{Proof.}

Set \(Z=(Y, X)\) and \(Z_i=\left(Y_i, X_i\right)\), \(\gamma = \gamma(\beta)=(-1, \beta)\). Then

\[
r(X\beta)=\mathbb{E}\left(Y-\beta^T X\right)^2=\gamma^T \Lambda \gamma
\]

where \(\Lambda=\mathbb{E}\left[Z Z^T\right]\). Note that \(\|\gamma\|_1=\|\beta\|_1+1\). Let \(\mathcal{B}=\left\{\beta:\|\beta\|_1 \leq \gamma\right\}\).

\[
\hat{R}_n( X\beta)=\frac{1}{n} \sum_{i=1}^n\left(Y_i-X_i^T \beta\right)^2=\gamma^T \widehat{\Lambda} \gamma
\]

where \(\widehat{\Lambda}=\frac{1}{n} \sum_{i=1}^n Z_i Z_i^T\). For any \(\beta \in \mathcal{B}\)
\begin{align*}
|\hat{R}_n(\mathbf X\beta)-r(X\beta)| & =\left|\gamma^T(\widehat{\Lambda}-\Lambda) \gamma\right| \\
& \leq \sum_{j, k}|\gamma_j||\gamma_k||\widehat{\Lambda}_{j k}-\Lambda_{jk}| \\
& \leq(\eta+1)^2 \max_{jk} |\widehat{\Lambda}_{j k}-\Lambda_{jk}|
\end{align*}
Note that \(|\Lambda_{jk}| \leq B^2\). By Hoeffding's inequality,

\[
\mathbb{P}\left( |\widehat{\Lambda}_{j k}-\Lambda_{jk}|\geq \epsilon\right) \leq 2 e^{-2n \epsilon^2 / B^2}
\]

and so, by the union bound,

\[
\mathbb{P}\left(\max _{j, k}|\widehat{\Lambda}_{j k}-\Lambda_{j k}| \geq \epsilon\right) \leq 2 p^2 e^{-2n \epsilon^2 / B^2}=\xi,
\]

if we choose \(\epsilon=\sqrt{\frac{B^2} {2 n} \log \left(\frac{{2} p^2}{{ \xi}}\right)}\).
Hence, with probability \(1-\xi\) (see slide 14, lecture 1),

\[
r({X \hat\beta}) - r\left(X\beta^*\right)\leq 2(\eta+1)^2 \varepsilon. 
\]

as desired. \(\blacksquare\)

\textbf{Definition.} \emph{If \(P(S(\widehat{\beta})=S(\beta)) \rightarrow 1\) we call \(\hat \beta\) \textbf{sparsistent}\index{sparsistent}.}

\emph{We call \(\hat{\beta}\) weakly \textbf{sparsistent} if, for every \(\beta\) as \(n \rightarrow \infty\) }

\[
P_\beta\left(I\left(\widehat{\beta}_j=1\right) \leq I\left(\beta_j=1\right) \text { for all } j\right) \rightarrow 1
\]

Suppose that \(p\) is fixed. Then the least squares estimator \(\widehat{\beta}_n\) is minimax and satisfies

\[
\sup _\beta E_\beta\left(n\left\|\widehat{\beta}_n-\beta\right\|^2\right)=O(1) .
\]

But sparsistent estimators have larger risk:

\textbf{Theorem.} \emph{We don't assume the linear model. Suppose that the following condiitons hold:}

\begin{itemize}
\tightlist
\item
  \emph{\(p\) is fixed.}
\item
  \emph{The covariariates are nonstochastic and \(n^{-1} \mathbf{X}^T \mathbf{X} \rightarrow \Sigma\) for some positive definite matrix \(\Sigma\).}
\item
  \emph{The errors \(\epsilon_i\) are independent with mean 0, finite variance \(\sigma^2\) and have a density \(f\) satisfying }
  \[
    0<\int\left(\frac{f^{\prime}(x)}{f(x)}\right)^2 f(x) d x<\infty
    \]
\end{itemize}

\emph{If \(\widehat{\beta}\) is weakly sparsistent, then}

\[
\sup _\beta \mathbb E_\beta\left(n\left\|\widehat{\beta}_n-\beta\right\|^2\right) \rightarrow \infty .
\]

\emph{More generally, if \(\ell\) is any loss function \(\ell: \mathbb R \mapsto \mathbb R_{\geq 0}\).then }

\[
\sup _\beta  \mathbb E_\beta\left(\ell\left(n^{1 / 2}\left(\widehat{\beta}_n-\beta\right)\right)\right) \rightarrow \sup _s \ell(s) .
\]

\textbf{Proof.}

Choose any \(s \in \mathbb{R}^d\) and let \(\beta_n=-s / \sqrt{n}\). Then,
\begin{align*}
\sup _\beta \mathbb E_\beta\left(\ell\left(n^{1 / 2}(\widehat{\beta}-\beta)\right)\right. & \geq \mathbb E_{\beta_n}\left(\ell\left(n^{1 / 2}(\widehat{\beta}-\beta)\right) \geq \mathbb E_{\beta_n}\left(\ell\left(n^{1 / 2}(\widehat{\beta}-\beta)\right) I(\widehat{\beta}=0)\right)\right. \\
& =\ell\left(-\sqrt{n} \beta_n\right) \mathbb P_{\beta_n}(\widehat{\beta}=0)=\ell(s) P_{\beta_n}(\widehat{\beta}=0) .
\end{align*}
Now, \(\mathbb P_0(\widehat{\beta}=0) \rightarrow 1\) by assumption. It can be shown (via contiguity) that we also have \(\mathbb P_{\beta_n}(\widehat{\beta}=0) \rightarrow 1 .\) Hence, with probability tending to 1,

\[
\sup _\beta E_\beta\left(\ell\left(n^{1 / 2}(\widehat{\beta}-\beta)\right) \geq \ell(s) .\right.
\]

Since \(s\) was arbitrary the result follows. \(\blacksquare\)

\hypertarget{conclusion}{%
\subsection{Conclusion}\label{conclusion}}

Lasso and Ridge regression aim for different things. Ridge regression reduces variance of the estimator by restricting the function space. Heuristically, the smaller \(||\beta^\ast||_2\) the more helpful is ridge regression. Lasso is useful in sparse setting, i.e, if one wishes to eliminate components/features.

\textbf{Example.} Assume that \(\rm{corr}(X_{1},X_2)=1\) and \(Y=0.5X_1+0.5X_2\). While Lasso will probably estimate \(\beta_1=1, \beta_2=0\), Ridge will probably estimate correctly \(\beta_1=0.5, \beta_2=0.5\).

\textbf{Definition. (Elastic net)}\index{Elastic net} \emph{For \(\lambda>0, \alpha \in (0,1)\), and \(J^{elastic.net}(\beta)= \sum_{j=1}^p \alpha |\beta_j| + (1-\alpha) \beta_j^2\), we call}
\begin{align*}
\hat{\beta}_\lambda^{\text {elastic.net }} & \in \underset{\beta \in \mathbb{R}^d}{\arg \min }\left\{\hat{R}_n(\beta)+J^{elastic.net}_\lambda(\beta)\right\} \\
\end{align*}
\emph{\textbf{elastic net} estimator.}

\hypertarget{nonparametric-regression}{%
\section{Nonparametric Regression}\label{nonparametric-regression}}

Linear models are quite restrictive and one may ask how one can achieve more flexibility. In this chapter we will look at the nonparametric regression problem with squared loss \(L(y_1,y_2)=(y_1-y_2)^2\). We already know that the Bayes-rule is \(m^\ast(x)=\mathbb E[Y|X=x]\).

\textbf{Definition. (k-nearest-neighbor)}\index{k-nearest-neighbor} \emph{The k-nearest-neighbor estimator is }

\[
\hat m^{knn}(x)= \frac 1 k \sum_{i \in \mathcal N_k(x)}Y_i,
\]

\emph{where \(\mathcal N_k(x)\) contains the indices of the \(k\) closest points of \(\{X_1, \dots X_n\}\) to \(x\).}

\textbf{Definition. (Linear Smoother)}\index{Linear Smoother} \emph{An estimator is called linear smoother if it can be written as }

\[
\hat m(x)= \sum_i w_i(x)Y_i,
\]

\emph{where the weight function \(w_i\) can depend on \(\{X_1, \dots, X_n\}\).}

\textbf{Example.} The k-nearest-neighbor estimator is a linear smoother:

\[
\hat m^{knn}(x)= \sum_i^n w_i(x_i) Y_i,
\]

with

\[
w_i(x)=\begin{cases}\frac 1 k & X_i \ \text{belongs to the}\  k \ \text{closest points to}\  x \\ 0 & else\end{cases}
\]

\textbf{Proposition. (MSE k-nearest-neighbor)} \emph{Assume that}

\[
E[Y|X=x]=m^\ast(x)\in \mathcal G_L = \{m: \mathbb R^p \mapsto \mathbb R| m \ \text{is L-Lipschitz continuous}\},
\]

\emph{and \(\textrm{Var}(Y|X=x)=\sigma^2(x)\leq \sigma^2.\) Then }

\[
\mathbb E[(\hat m^{knn}(x)-m^\ast(x))^2]\leq (cL)^2 \left(\frac k n \right)^{2/p}+\frac {\sigma^2}k.
\]

\emph{In particular, for \(k_n=O_p( n^{2/(2+p)})\), we get }

\[
\mathbb E[(\hat m^{knn}(x)-m^\ast(x))^2]=O_p(n^{-2/(2+p)}).
\]

\textbf{Proof.}

Write \(\mathbf X=X_1,\dots, X_n\) and denote by \(Y_i^{(x)}\) the \(i\)th closest \(Y\) to \(x\) among \(Y_1,\dots Y_n\).
\begin{align*}\mathbb E[(\hat m^{knn}(x)-m^\ast(x))^2]& =\mathbb E \Big [{\left(\mathbb{E}[\hat m^{knn}(x)|\mathbf  X]-m^\ast(x)\right)^2}\Big]+{\mathbb{E}\Big[(\hat m^{knn}(x)-\mathbb{E}[\hat m^{knn}(x)|\mathbf  X])^2\Big]}\\
&=\mathbb E\left[ \Big \{\frac{1}{k} \sum_{i \in \mathcal{N}_k(x)}\left(m^\ast\left(X_i\right)-m^\ast(x)\right)\Big \}^2\right] \\ &\quad + \frac 1 {k^2} \mathbb E \left[ \sum_i^k \sum_j^k \{Y_i^{(x)}- \mathbb  E[Y_i^{(x)}| \mathbf X]\}\{Y_j^{(x)}- \mathbb  E[Y_j^{(x)}| \mathbf X]\} \right] \\
& \leq \mathbb  E\left[ \left(\frac{L}{k} \sum_{i \in \mathcal{N}_k(x)}\left\|X_i-x\right\|_2\right)^2 \right]+\frac{\sigma^2}{k} \\
&\leq^{(1)}  L^2 c \left(\frac k n \right)^{2/p}+\frac {\sigma^2}k
\end{align*}

\begin{enumerate}
\def\labelenumi{(\arabic{enumi})}
\tightlist
\item
  \(\mathbb E\left[ \left \{\frac{1}{k} \sum_{i \in \mathcal{N}_k(x)}\left\|X_i-x\right\|_2 \right\}^2 \right]\leq c \left(\frac k n \right)^{2/p}\), see (Gyorfi et al.~2002, vol.~1, chap.~6.3). \(\blacksquare\)
\end{enumerate}

Note that this is slower than the ``parametric'' MSE of \(n^{-1}\). In particular the rate depends on \(p\). Even worse: It grows exponentially in \(p\).

We have learned that the knn estimator can be written as

\[
\hat m^{knn}(x)= \frac 1 k w_i(x_i) Y_i,
\]

Note that \(w_i(x)\) is not smooth as a function of \(x\). This also makes the estimator not smooth. Given that we assume that \(m^\ast\) is smooth, this may not be desirable. An alternative are kernel smoothers.

\textbf{Definition. (Kernel Smoother)}\index{Kernel Smoother} \emph{The kernel smoother a linear smoother with }

\[
\hat m^{ks}(x)=  \sum_i w_i(x_i) Y_i,
\]

\emph{where }

\[
w_i(x)=\frac{K\left(\frac{||x-X_i||}{h}\right)}{\sum_j K\left(\frac{||x-X_j||}{h}\right)}
\]

\emph{Often \(K=\prod_j k_j\), such that \(K\left(\frac{||x-X_i||}{h}\right)=\prod_j k(x-X_{ij})\). The function \(k: \mathbb R \mapsto \mathbb R\) is usually a symmetric density function.}

\textbf{Proposition. (MSE Kernel Smoother)} \emph{Assume that \(E[Y|X=x]=m^\ast(x)\in \mathcal G_L\) with}
\[
\mathcal G_L = \{m: \mathbb R^p \mapsto \mathbb R| m \ \text{is L-Lipschitz continuous}\},
\]

\emph{and \(\textrm{Var}(Y|X=x)=\sigma^2(x)\leq \sigma^2.\) Then }

\[
\mathbb E[(\hat m^{ks}(x)-m^\ast(x))^2]= O_p\left( \frac{1}{nh^p} + h^2 \right)
\]

\emph{In particular, for \(h_n=O_p(n^{-1/(2+p)})\), we get }

\[
\mathbb E[(\hat m^{ks}(x)-m^\ast(x))^2]=O_p(n^{-2/(2+p)}).
\]

\hypertarget{curse-of-dimensionality}{%
\subsection{Curse of dimensionality}\label{curse-of-dimensionality}}

We have seen that under a Lipschitz condition, both kernel smoother and knn have an asymptotic mean squared error of order \(n^{-2/(2+p)}\). One can show that under the assumption that \(m^\ast\) is twice continuously differentiable, the rate for both methods can be improved to

\[
n^{-4/(4+p)}.
\]

But this rate is still exponentially decreasing in \(p\). Furthermore, it has been shown that no method can do better under the given assumptions.

A new observation \(x_0\) will have very few or no observations in its neighborhood. This leads to high variance and high bias when increasing the size of the neighborhood.

Under the model of the previous slide, the setting \(n=50,p=1\) has the same expected amount of observations in a neighborhood as the setting \(n=7.5\times10^{110}, p=100\).

There are two ways to tackle the curse of dimensionality.

\textbf{Sparsity:} Assume that the intrinsic dimension is lower. E.g. Not all variables are relevant. Or feature engineer a few highly predictive variables.

\textbf{Structure:} Interactions are limited and structure can be exploited
e.g.~an additive structure \(m(x)=m_1(x_1)+m_2(x_2).\). Remember that structure is essential for interpretability.

\hypertarget{splines}{%
\subsection{Splines}\label{splines}}

We want to establish a framework to estimate additive regression functions. To this end, assume \(p=1\) until further notice.

\textbf{Definition. (Splines)}\index{Splines} \emph{A \(k\)th-order spline with \(l\) knotpoints \(x_1 <\dots<x_l\)}

\begin{itemize}
\tightlist
\item
  \emph{is a polynomial of degree \(k\) on each interval \((-\infty,x_1],[x_1,x_2]\dots,[x_l,\infty)\)}
\item
  \emph{has continuous derivatives of orders \(0,...,k-1\) on the knotpoints \(x_1 <\dots<x_l\)}
\end{itemize}

\textbf{Example.} A \(k\)th-order spline \(m\) with \(l\) knotpoints can an be uniquely written as

\[
m(x)=\sum_{j=1}^{k+1+l}\theta_jg_j(x)
\]

\begin{itemize}
\tightlist
\item
  truncated power basis

  \begin{itemize}
  \tightlist
  \item
    For \(j=1,\dots, k+1\): \(g_{j}=x^{j-1}\)
  \item
    For \(j=1,\dots,l:\) \(g_{k+1+j}=(x-x_j)^k_+\)

    \begin{itemize}
    \tightlist
    \item
      \((x)_+:= \max(x,0)\)
    \end{itemize}
  \end{itemize}
\item
  B-splines

  \begin{itemize}
  \tightlist
  \item
    more complicated, but computationally more robust and faster to compute.
  \end{itemize}
\end{itemize}

Splines (used for regression, see next slide) have high variance at the boundaries. Solution: Let the piecewise polynomial function have a lower degree at \((-\infty,x_1],[x_l,\infty)\).

\textbf{Definition. (Natural Splines)}\index{Natural Splines} \emph{A \(k\)th-order natural spline (\(k=\) odd number) with knotpoints \(x_1 <\dots<x_l\)}

\begin{itemize}
\tightlist
\item
  \emph{is a polynomial of degree \(k\) on the intervals \([x_1,x_2]\dots,[x_{l-1},x_l)\)}
\item
  \emph{is a polynomial of degree \((k-1)/2\) on \((-\infty,x_1],[x_l,\infty)\)}
\item
  \emph{has continuous derivatives of orders \(0,...,k-1\) on the knotpoints \(x_1 <\dots<x_l\)}
\end{itemize}

Note that natural splines have dimension \(l\) which is in particular independent of the order \(k\) (compare to dimension \(k+l\) for splines). There is also a truncated power basis and a B-splines basis for natural splines.

\textbf{Linear regression with splines.} We still assume the one-dimensional case, \(p=1\). Instead of looking at observations \((X_i,Y_i)_{i=1,\dots,n}\) we can consider a natural splines basis and look at observations \((g_1(X_i), \dots, g_l(X_i), Y_i)_{i=1,\dots,n}.\) By doing so we are able to approximate any natural spline in \(x\) instead of just linear functions in \(x\), while still being in a linear regression framework, i.e.,

\[
\hat \beta = {\arg \min }_\beta \sum_i (Y_i - { G_i^T}\beta )^2= (\mathbf G^T\mathbf  G)^{-1}\mathbf  G^T\mathbf Y
\]

where \(G_i^T=(g_1(X_i), \dots, g_l(X_i))\), the rows of \(\mathbf G\). Problem: How do we choose the number of knotpoints \(l\) and their position? First thought: Cross validation. But that would be quite expensive to run.

Let's look at the following minimization problem:

\[
\hat m= \arg\min_{m} \sum_i (Y_i-m(X_i))^2+\lambda\int_a^b m''(x)^2\mathrm dx,
\]

where minimization runs over all twice times differentiable functions \(m\) and observations \(X_i\) are in \([a,b]\) for all \(i\).

\textbf{Theorem (Smoothing splines)} \emph{If \(m\) is twice differentiable and the solution to }

\[
\arg\min_{m} \sum_i (Y_i-m(X_i))^2+\lambda\int_a^b m''(x)^2\mathrm dx,
\]

\emph{then \(m\) is a natural spline of order 3 (natural cubic spline).}

\textbf{Proof.}

Given a minimizer \(\tilde m\), we construct the unique natural cubic spline \(m\) on \([a,b]\) with knotpoints \(X_1,\dots, X_n\) and \(m(X_i)=\tilde m(X_i)\). We will show that \(\tilde m=m\). Define \(h=\tilde m-m\). Note that \(h(X_j)=0 (j=1,\dots,n)\), \(m'''(x)=0\) for \(x<X_1\) and \(x>X_n\) as well as \(m^{(4)}=0\). Hence by applying integration by parts twice we get
\begin{align*}
\int_a^b m''(x)h''(x)\mathrm dx
&= -\int_{X_1}^{X_n}m'''(x)h'(x)\mathrm dx \\
&= -\sum_{j=1}^{n-1}m'''(x)h(x)\Big|_{X_j}^{X_{j+1}} \\
&=0
\end{align*}
This implies

\[
\int_a^b \tilde m''(x)^2\mathrm dx= \int_a^b \{m''(x)+h(x)\}^2\mathrm dx=\int_a^b m''(x)^2+h(x)^2\mathrm dx.
\]

meaning

\[
\int_a^b m''(x)^2\mathrm dx \leq \int_a^b \tilde m''(x)^2\mathrm dx.
\]

with equality only for \(h''=0\), i.e, \(h\) linear. Since \(h(X_i)=0 (i=1,\dots n)\), we have \(h=0\) and so \(\tilde m=m\). \(\blacksquare\)

We can conclude the following:

\begin{itemize}
\tightlist
\item
  Let \(\mathbf G\) be the matrix with with rows \(G_i=(g_1(X_i), \dots, g_l(X_i))\).

  \begin{itemize}
  \tightlist
  \item
    \(\{g_j\}_{j=1,\dots,l}\) is a basis for natural cubic splines.
  \end{itemize}
\item
  Define
  \[
    \hat \beta  = \arg\min_{\beta} \sum_i (Y_i- G_i^T\beta)^2+\lambda\int_0^1 \left\{{\sum_j \beta_jg_j''}(x)\right\}^2\mathrm dx.
    \]
  Then,
  \[
    \sum_j \hat \beta_j g_j=\arg\min_{m} \sum_i (Y_i-m(X_i))^2+\lambda\int_0^1 m''(x)^2\mathrm dx.
    \]
\end{itemize}

Smoothing splines can be seen as a special case of generalized ridge regression:

\begin{itemize}
\tightlist
\item
  Write \(\mathbf W_{ij}=\int_0^1g_i''(x)g_j''(x)\mathrm dx,\) then
  \begin{align*}
    &\arg\min_{\beta} \sum_i (Y_i- G_i^T\beta)^2+\lambda\int_0^1 \left\{{\sum_j \beta_jg_j''}(x)\right\}^2\mathrm dx\\=
    &\arg\min_{\beta} \sum_i (Y_i- G_i^T\beta)^2+\lambda \beta^T \mathbf W \beta.
    \end{align*}
  Hence,
  \[
    \hat \beta= (\mathbf G^T\mathbf G+\lambda \mathbf W)^{-1}\mathbf G^T\mathbf Y.
    \]
\end{itemize}

It can be shown the smoothing splines are asymptotically equivalent to kernel smoothers with varying bandwidth and a specific choice of kernel, see Silverman (1984) or Wang, Du, and Shen (2013) for a more recent contribution. In general, smoothing splines are more practical since they can be efficiently calculated while kernel smoothers are much easier to analyze theoretically.

We have seen that fully nonparametric methods suffer from the curse of dimensionality: the optimal rate of convergence for twice continuously differentiable functions is \(n^{-4/(4+p)}\). One solution is to restrict oneself to the class of additive functions

\[
\mathcal G=\{m| m(x)=m_1(x_1)+\cdots +m_p(x_p)\}
\]

Stone (1985) showed that the components \(m_k\), if twice continuously differentiable, can be estimated with one-dimensional rate of \(n^{-4/4+1}\). The components \(m_j\) are usually estimated via the so called backfitting algorithm (Hastie and Tibshirani 1990).

Backffitting comprises the following two steps:

\textbf{Definition. (Backfitting Algorithm)}\index{Backfitting Algorithm}

\begin{itemize}
\tightlist
\item
  \emph{Intialize: \(\hat m_j^{[0]}=0, j=1,\dots,p\)}
\item
  \emph{Iterate for \(r=1,\dots\)}

  \begin{enumerate}
  \def\labelenumi{\arabic{enumi}.}
  \tightlist
  \item
    \emph{Residuals: \(r_{ij}^{[r]}=Y_i-\sum_{k < j} \hat{m}_{k}^{[r]}(x_{ik})-\sum_{k > j} \hat{m}_{k}^{[r-1]}(x_{ik})\).}
  \item
    \emph{Smooth: \(\hat{m}_j^{[r]}=\operatorname{Smooth}\left(\left\{X_{ij},r_{ij}^{[r]}\}_{i=1,\dots,n}\right\}\right).\)}
  \item
    \emph{Center: \(\hat{m}_j^{[r]}=\hat{m}_j^{[r]}-\frac{1}{n} \sum_{i=1}^n \hat{m}_j^{[r]}\left(X_{i j}\right)\).}
  \end{enumerate}
\end{itemize}

Note that Smooth is a one-dimensional regression problem. In practice Smooth is most often a smoothing spline.
It has been shown backfitting via smoothing splines achieve optimal rate of \(n^{-4/4+1}\) for each component and \(pn^{-4/4+1}\) for the p-dimensional additive regression function.

Problem: Additive methods are still not optimal in the case of sparsity (i.e.~some features being not relevant) and interactions between features.

\hypertarget{trees-and-forests}{%
\section{Trees and forests}\label{trees-and-forests}}

In this chapter we will look at the nonparametric regression problem with squared loss \(L(y_1,y_2)=(y_1-y_2)^2\) and also the classification problem with Binary loss function \(L(y_1,y_2)=\Bbb 1(y_1\neq y_2)\) or squared loss.

We already know that the Bayes-rule is

\[
m^\ast(x)=\mathbb E[Y|X=x]
\]

for the squared loss and

\[
m^\ast(x)=\underset{k=1,\dots,K}{\operatorname{argmax}} \mathbb P(Y=k|X=x)
\]

for the binary loss.

\textbf{Definition. (Decision trees)}\index{Decision trees} \emph{A decision tree is an estimator, that partition the feature space \(\mathcal X\) into sections \(T=\{R_1,R_2,...,R_k\}\) such that \(R_i\cap R_j=\emptyset\) (pairwise disjoint) for all \(i\ne j\) with \(1\le i,j\le k\) and}

\[
\bigcup_{i=1}^kR_i=\mathcal X
\]

\emph{The algorithm associated with the decision tree is then}

\[
m(T)(x)=\sum_{i=1}^k m_i 1_{R_i}(x).
\]

From the above we notice that the tree estimate is a piecewise constant function. We call the constant areas of the tree estimate \emph{leaves} or \emph{terminal nodes}. The leaves partition the feature space \(\mathcal X\).

Given the data \(\mathcal D_n\) the value within a leave is given by averaging the responses (regression with \(L_2\) loss) or majority vote (classification with binary loss). In particular we have

\[
m_i=\left(\sum_{j=1}^n1_{R_i}(X_j)\right)^{-1}\left(\sum_{j=1}^n1_{R_i}(X_j)X_j\right),\qquad (\text{continuous case})
\]

i.e.~the simple estimated conditional mean \(\mathbb {\hat E}[Y\ \vert\ X\in R_i]\) and

\[
m_i=\underset{y\in \mathcal Y}{\operatorname{argmax}}\left\{\sum_{j=1}^n1_{R_i}(X_j)1_{y}(Y_j)\right\}.\qquad (\text{discrete case})
\]

i.e.~the mode.

Decision trees are popular because the decision making (estimate) is nicely visualizable/interpretable if not too deep. One can easily draw out the subsetting tree starting with the entire feature space \(\mathcal X\) and then spitting in two all the way down to the terminal notes. The interior edges on this representation are called nodes and can also be interpreted as subset of \(\mathcal X\).

Decision trees can be quite efficient in classification tasks where we are interested in 0-1 (binary) decisions. This is the case in many application but is often not the case in insurance since it is imposible and frankly not usefull having a 0/1 estimate of whether a claim may arrive. Instead the insurance company is interested in the probability that a claim may arrive during a timespan.

A decision tree is uniquely defined by its leaves. Given a tree \(T\), we write \(m(T)\) for the corresponding regression or classification function. The naive approach of looking for leaves \(R_1,\dots, R_l\) that minimize a certain loss is practically not feasible because of the computational cost. Instead: top-down greedy approach, called CART (classification and regression trees). We now describe how to construct nodes via the CART algorithm.

\textbf{Definition. (CART)}\index{CART} \emph{Start with \(\mathcal X\) as initial node for splitting.}

\begin{itemize}
\tightlist
\item
  \emph{Input: node \(R\subseteq \mathcal X\) }
\item
  \emph{For every dimension \(j=1,\dots,p\) and every point \(s_j\in \{x_j| \exists\ x_1,\dots,x_{j-1},x_{j+1},\dots,x_p\ \text{with} (x_1,\dots,x_p)\in R\}\) define}
  \[R_1(j,s_j)=\{(x_1,\dots,x_p)\in R| \ x_j \leq s_j\}, \quad R_2(j,s_j)=\{(x_1,\dots,x_p)\in R| \ x_j > s_j\}.\]
\item
  \emph{We pick the minimizer}
  \[
  (j^\ast,s^\ast)= \arg\min_{j,s} Q_n(R_1(j,s_j)) + Q_n(R_2(j,s_j))
  \]
\item
  \emph{Each of the new nodes \((R_1(j^\ast,s^\ast),R_2(j^\ast,s^\ast))\) is further split as long as stopping criterion does not apply.}
\end{itemize}

\textbf{Definition. (CART loss)} F\_or regression the most common loss function is the squared loss:\_

\begin{itemize}
\tightlist
\item
  \emph{Squared loss:} \(Q_n(R_l)= \sum_{i: X_i \in R_l} (Y_i - \overline Y_i(R_l))^2\)

  \begin{itemize}
  \tightlist
  \item
    \(\overline Y_i(R_l)= \frac 1 {|R_l|}\sum_{i: X_i \in R_l}Y_i,\)
    \(|R_j|=\#\{i: X_i\in R_j\}\).
  \end{itemize}
\end{itemize}

\emph{In the classification case, define }
\[
\hat p_{lk}= \frac 1 {|R_l|} \sum_{i: X_i \in R_l}  \mathbb 1(Y_i=k)
\]
\emph{(=the proportion of class \(k\) observation in \(R_l\))}

Common loss functions are:

\begin{itemize}
\tightlist
\item
  Brier score: \(Q_n(R_l)= \sum_{i: X_i \in R_l} (Y_i - \overline Y_i(R_l))^2\) (=squared loss)
\item
  Misclassification error: \(Q_n(R_l)= 1 - \max_{k}\hat p_{lk}\)
\item
  Gini index: \(Q_n(R_l)= \sum_{k=1}^K \hat p_{lk}(1-\hat p_{lk})\)
\item
  Entropy : \(Q_n(R_l)=-\sum_{k=1}^K \hat p_{lk}\log\hat p_{lk}\)
\end{itemize}

Note: In classification, even if binary loss is the ultimate goal, Gini index and entropy might be the better choices for splitting.

The most common stopping criterion is specifying a min-node size, i.e.~stop if \(|R_j|<c\). A common choice is \(c=5\). An alternative stopping criteria is the depth of \(R_j\), i.e., the number of parent nodes of \(R_j\).

The process described so far will probably lead to an overfit. One may think that one way out is to stop growing the tree early enough.n This is not advisable because stopping the growing early because the current split does not lead to great improvement in the loss does not mean that a split afterwards might not turn very effective.

The idea of pruning is to let a tree grow very deep first (= small min node size) and then select a subtree (pruning) as final fit. Idea: We can compare different subtrees via a penalized loss.

\textbf{Definition. (Subtree)} \emph{We call \(T'\) a subtree of \(T\) if the nodes of \(T'\) is a subset of the nodes of \(T\). \(T'\) and \(T\) have the same root. If \(T'\) is a subtree of \(T\), we also write \(T'\subseteq T\).}

We can derive a subtree, by pruning a tree at any non-terminal node (i.e.~by deleting all descendants of that node)

\textbf{Definition. (\(\alpha\)-pruned tree)} \emph{Consider a tree \(\hat T_n\) with corresponding estimator \(\hat m_n(\hat T_n)\). Given a parameter \(\alpha>0\), the \(\alpha\)-pruned tree is}

\[
\hat T_{n,\alpha} := \arg \min_{T\subseteq \hat T_n}\{\hat R_n(\hat m_n) + \alpha |T|\},
\]

\emph{where \(|T|\) is the number of leaves of \(T\).}

How do we find an optimal \(\alpha\) (and also the optimal subtree for a fixed \(\alpha\))? Brute force cross-validation will be too computationally intensive even if we know the answer to the second question. The answer to both questions is the weakest link algorithm.

\textbf{Proposition (weakest link)} \(\hat T_{n,\alpha}\) is unique. Furthermore, there are trees \(T_0\supset \cdots\supset T_l\) with \(\{T_0,\dots, T_l\}=\{\hat T_{n,\alpha} : \alpha>0\}\); in particular the set \(\{\hat T_{n,\alpha} : \alpha>0\}\) is finite.

Let \(\widetilde Q_n\) be the loss function corresponding to \(\hat R_n\).
The trees \(T_0,\dots, T_l\) can be found with the following algorithm

\begin{enumerate}
\def\labelenumi{\arabic{enumi})}
\item
  Let \(t_L,t_R\) be any two terminal nodes in \(\hat T_n\) resulting from a split of the immediate ancestor node t. If \(\widetilde Q_n(t) = \widetilde Q_n(t_L)+\widetilde Q_n(t_R)\), prune off \(t_L\) and \(t_R\). Continue this process until no more pruning is possible. The resulting tree is \(T_0\).
\item
  \(k=0\)
\item
  Go through all non-terminal nodes \(t\) of \(T_k\) and calculate
  \[
  g(t)=\frac{\widetilde Q_n(t)-\widetilde Q_n(T_t)}{|T_t|-1},
  \]
  where \(T_t\) is the tree (branch) with root \(t\) and nodes consisting of \(t\) and the descendants of \(t\) in \(T_k\).
  \(\widetilde Q_n(T_t)=\sum_{t \ \text{leaf of}\  T_t} \widetilde Q_n(t)\).
\item
  \(\alpha= \min_{t \ \text{ non-terminal node of} \ T_k}g(t)\).
\item
  From top to bottom in \(T_k\) prune all non-terminal nodes with \(g(t)=\alpha\) and call the resulting tree \(T_{k+1}\).
\item
  If \(T_{k+1}\) has more than one node, set \(k \leftarrow k+1\) and go to step 3.
\end{enumerate}

Given \(l\) trees \(\{T_0,\dots, T_l\}=\{\hat T_{n,\alpha} : \alpha>0\}\), we can pick the optimal tree via cross validation.

\textbf{Problem with decision trees.} There are (at least) two major problems with decision trees

\begin{itemize}
\tightlist
\item
  Instability: Small variations in the data can lead to a very different tree
\item
  Performance: The performance (measured via test error) is usually much weaker compared to other learning algorithms
\end{itemize}

\textbf{Bagging.} Bagging stands for Bootstrap aggregation. Idea: Generate artificial data via bootstrap, build a decision tree for each data-set and average. Hope: It reduces the variance of decision trees.

\textbf{Definition.} \emph{(Bagging)}

\begin{itemize}
\tightlist
\item
  Given data \({(X_1,Y_1),\dots, (X_n,Y_n)}\), draw \(B\) bootstrap samples \(\tilde {\mathcal D}^{(b)}_n={(\tilde X^{(b)}_1,\tilde Y^{(b)}_1),\dots, (\tilde X^{(b)}_n,\tilde Y^{(b)}_n)}, b=1,\dots, B\), i.e., \(\tilde {\mathcal D}^{(b)}_n\) arises from \(\mathcal D_n\) by drawing \(n\) times with replacement.
\item
  The bagging estimator is defined as

  \begin{itemize}
  \tightlist
  \item
    squared loss \(\rightarrow\) average: \(\hat m^{bagg}_n=\frac 1 B \sum_{b=1}^B \hat m_n(\tilde {\mathcal D}^{(b)}_n)\)
  \item
    binary loss \(\rightarrow\) majority vote: \(\hat m^{bagg}_n(x)=\arg \max_{k\in {1,\dots K}} \#\{b: m_n(\tilde {\mathcal D}^{(b)}_n) (x)=k\}\)
  \end{itemize}
\end{itemize}

Note that \(\hat m^{bagg}_n\) is a stochastic estimator, even given \(\mathcal D_n\). Note: Usually, bagging is applied on non-pruned trees. (See it as an alternative way to reduce variance)

While bagging improves performance of decision trees, interpretability is worsened. If interpretability is not a concern, then bagging is still inferior compared to other learning techniques. Random forests are a modification on bagging estimators.

\textbf{Random Forests.} As bagging random forest are an ensemble of decision trees. They add the following modification to bagging:
- \(\texttt{mtry}\): Each time a node is split it is only done on a subset of size \(\texttt{mtry}\) of viable variables. I.e., each time you want to split a node, turn on a random generator and draw \(1\leq\texttt{mtry}<p\) viable variables from \(\{1,\dots,p\}\). Only those variables drawn are allowed to be considered for the next split.
- We denote the random forest estimator by \(\hat m^{rf}_n\). Note that \(\hat m^{rf}_n\), as \(\hat m^{bagg}_n\), is a stochastic estimator, even given \(\mathcal D_n\).

Why is \(\texttt{mtry}\) so useful? Assume that we are given \(l\) estimators \(m_n(\mathcal D_n, U_1), \dots m_n(\mathcal D_n, U_l)\). Here, \(U_1,\dots, U_l\) are iid variables inducing the additional stochasticity of the estimators (e.g.~through random forest or bagging). Assume that \(\hat m_n(\mathcal D_n, U_1), \dots \hat m_n(\mathcal D_n, U_l)\) have pairwise correlation \(\rho\) and variance \(\sigma^2\). We get
\begin{align*}
\textrm{Var}\left (\frac 1 l \sum_{j=1}^l \hat m_n(\mathcal D_n, U_j)\right)&= \frac 1 {l^2} \sum_{jk} \textrm{Cov}(m_n(\mathcal D_n, U_j),m_n(\mathcal D_n, U_k))\\&=\frac 1 {l^2} \left( l\sigma^2+ (l^2-l)\rho\sigma^2\right)\\&= \rho \sigma^2 + \frac{1-\rho}{l}\sigma^2
\end{align*}
Meaning: Variance of an ensemble of trees is small the smaller the correlation between the trees. The \(\texttt{mtry}\) parameter aims to make trees less alike and hence more uncorrelated.

Random forest are competitive to many state of the art learners. While not having ``best performance'' in terms off accuracy they are not too far behind. Advantages of random forests are

\begin{itemize}
\tightlist
\item
  Default hyperparameters already lead to very strong results (i.e.~without tuning hyperparameter)

  \begin{itemize}
  \tightlist
  \item
    \(\texttt {mtry}=\lfloor \sqrt{p}\rfloor\)
  \item
    min node size= 1 for classification, 5 for regression
  \end{itemize}
\item
  Can be implemented (and is implemented) very fast
\end{itemize}

Random forest (and also trees) don't perform well for additive functions

Decision trees are not good with additive functions (example). Consider \(m^\ast(x) = \sum_j^p \mathbb 1(x_j \leq 0)\) for large \(p\). For a perfect fit, a tree algorithm would have to grow a tree with depth \(p\),
where each leaf is the result of splitting once with respect to each covariate. Hence, we end up with \(2^p\) leaves, which on average contain \(n/(2^p)\) data points. Even if all splits are optimal for \(2^p>n\), the tree will not be able to lead to a perfect decision rule.

While predictions of random forests are relatively smooth, they are not monotonic. e.g.~in car insurance, if everything else is the same, more mileage should lead to higher insurance price. Random forests deal well with sparsity, i.e., when the number of features \(p\) is large, but the number of relevant features is rather small: \(s<<p\).

\hypertarget{gradient-boosting-machines-and-bayesian-additive-regression-trees}{%
\section{Gradient Boosting Machines and Bayesian additive regression trees}\label{gradient-boosting-machines-and-bayesian-additive-regression-trees}}

In the previous section we have discussed that random forests are not good in estimating additive structures. In this section we will see two tree-based estimators that can deal better with additive structures.

\textbf{Gradient Boosting Machines.} The general idea of boosting is to construct an estimator of the form

\[
\hat m_n(x)=\sum_{j=1}^B \hat m_{n,j}(x),
\]

where \(\hat m_{n,b}\) is the result of improving on the estimator \(\hat m_n^{(b-1)}(x)=\sum_{j=1}^{b-1} \hat m_{n,j}(x)\).

\textbf{Definition.} \emph{(Forward Stagewise Additive Modeling)}

The function \(\hat m_n(x)=\sum_{j=1}^B \hat m_{n,j}(x)\) is called Forward Stagewise Additive Modeling estimator if

\begin{itemize}
\item
  \(m_{n,0}(x)=\arg \min_{\eta\in \mathcal G} \sum_{i=1}^N L\left(Y_i, \eta\right)\) and
\item
  for \(b=1,\dots,B\)
  \[\hat m_{n,b} =  \arg \min_{\eta\in \mathcal G} \hat R_n\left( \hat m_n^{(b-1)}(x)+\eta(x)\right),\]
  where \(\hat m_n^{(b-1)}=\sum_{j=1}^{b-1}\hat m_{n,j}.\)
\item
  The set \(\mathcal G\) is chosen to be very restrictive/small.
\item
  The component \(m_{n,b}\) is called weak learner.
\end{itemize}

Problem: Finding the exact minimizer is only feasible (not harder than than the usual minimisation) for very specific loss functions \(\hat R_n\). In the case of squared loss, minimization in step \(b\) boils down to minimizing the empirical squared loss with respect to the residuals \(Y_i- m_n^{(b-1)}(X_i)\).

\[
L\left(Y_i, \hat m_n^{(b-1)}(X_i)+\eta(X_i)\right)=L\left(Y_i-\hat m_n^{(b-1)}(X_i),\eta(X_i)\right)
\]

In the classification case with \(\{-1,1\}\) valued response and an exponential loss \((L(y_1,y_2)=e^{-y_1y_2})\), minimization in step \(b\) boils down to minimizing the weighted empirical exponential loss with observation \(i\) receiving weight \(e^{-Y_im_n^{(b-1)}(X_i)}\).

\[
L\left(Y_i,  \hat m_n^{(b-1)}(X_i)+\eta(X_i)\right)=e^{Y_im_n^{(b-1)}(X_i)}L\left(Y_i,\eta(X_i)\right)
\]

This algorithm is also known as AdaBoost.M1. Adaboost.M1 was introduced in Freund and Schapire (1997) and was only later (J. Friedman, Hastie, and Tibshirani 2000) identified as Forward Stagewise Additive Modeling with exponential loss.

\textbf{Definition.} \emph{(Gradient Boosting Machine v1)} (J. H. Friedman 2001)

\begin{itemize}
\tightlist
\item
  Gradient Boosting approximates Forward Stagewise Additive Modeling.
\item
  Tuning parameters:

  \begin{itemize}
  \tightlist
  \item
    function space \(\mathcal G\)
  \item
    learning rate \(\eta\)
  \end{itemize}
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Initialize \(\hat m_{n}^{(0)}(x)=\arg \min_{m \in \mathcal G} \sum_{i=1}^N L\left(Y_i, m\right)\).
\item
  For \(b=1,\dots,B\) :

  \begin{enumerate}
  \def\labelenumii{(\alph{enumii})}
  \tightlist
  \item
    For \(i=1,2, \ldots, n,\) calculate the gradient:
    \[
    g_{ib}=-\frac{\partial L(Y_i,y)}{\partial y} \Bigr\rvert_{y=m_n^{(b-1)}(X_i)} .
    \]
  \item
    \((\xi_b, \tilde m_{n,b})= \arg \min_{\xi\in \mathbb R_{>0},m \in \mathcal G}\sum_{i=1}^n(g_{ib}-\xi m(X_i))^2\) (\(\xi_b\) is only necessary if \(\mathcal G\) is not closed under multiplication by constants)
  \item
    \(\alpha_b= \arg \min_{\alpha} \hat R_n(m_n^{(b-1)}+\alpha \tilde m_{n,b})\) (line search)
  \item
    \(\hat m_{n,b}(x)= \alpha_b \tilde m_{n,b}(x)\) (weak learner)
  \item
    Update: \(\hat m^{(b)}_n(x)=\hat m^{(b-1)}_n(x)+\eta \hat m_{n,b}(x)\).
  \end{enumerate}
\end{enumerate}

\begin{itemize}
\tightlist
\item
  Tuning parameters:

  \begin{itemize}
  \tightlist
  \item
    max depth \(J\), \(\mathcal G=\{\text{trees of max depth} \ J\}\)
  \item
    learning rate \(\eta\)
  \end{itemize}
\end{itemize}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Initialize \(\hat m_{n}^{(0)}(x)=\arg \min_{m \in \mathcal G} \sum_{i=1}^N L\left(Y_i, m\right)\).
\item
  For \(b=1,\dots,B\) :

  \begin{enumerate}
  \def\labelenumii{(\alph{enumii})}
  \tightlist
  \item
    For \(i=1,2, \ldots, n,\) calculate the gradient:
    \[
    g_{ib}=-\frac{\partial L(Y_i,y)}{\partial y} \Bigr\rvert_{y=m_n^{(b-1)}(X_i)} .
    \]
  \item
    Fit a regression tree with squared loss and max depth \(J\) to the targets \(g_{ib}\). \(\rightarrow\) leaves \(R_{bj}, j=1,2, \ldots, J_b\).
  \item
    For \(j=1,2, \ldots, J_b\) calculate the value for leaf \(R_{bj}\):
    \[
    v_{bj}=\arg \min_{ v_{bj} \in \mathbb R} \sum_{i: X_i \in R_{kj}} L\left(Y_i, m_n^{(b-1)}(X_i)+ v_{bj}\right) .
    \]
  \item
    \(\hat m_{n,b}(x)=\sum_{j=1}^{J_b} v_{bj} 1\left(X_i \in R_{b j}\right)\)
  \item
    Update: \(\hat m^{(b)}_n(x)=\hat m^{(b-1)}_n(x)+ \eta \hat m_{n,b}(x)\).
  \end{enumerate}
\end{enumerate}

The main difference between the tree gradient booster and general gradient boosting is: Least squares problem is not solved directly but greedy step-wise by growing a tree via CART-algorithm. Instead of a line search we minimize the empirical loss in each leaf.

More recently Chen and Guestrin (2016) proposed to optimize a regularized objective in the Forward Stagewise Additive Modeling with the following further changes:
1. Replace \(\hat R_n\) by \(\hat R_{n,\gamma,\lambda}(\hat m_n^{(b-1)}+m_{n,b}) =\hat R_n(\hat m_n^{(b-1)}+m_{n,b}) + J_{\gamma,\lambda}(m_{n,b})\)
- \(J_{\gamma,\lambda}(m_{n,b})= \gamma J_b+ \frac 1 2 \lambda ||v_b||_2^2\)
- \(J_b\)= number of leaves of tree in iteration \(b\)
- \(v_b=\) leaf values of tree in iteration \(b\)
2. Use second order approximation instead of gradient descent (see next slide)
- i.e.~gradient descent in 2b,c is replaced by a Newton-Raphson type approximation

The algorithm is implemented in the \(\texttt{xgboost}\) package. Main hyperparameters:
- Penalties: \(\gamma\), \(\lambda\)
- learning rate: \(\eta\)
- max tree depth

\textbf{Gradient Boosting (Second version)} Use a second order approximation of \(\hat R_{n,\gamma,\lambda}\)
\begin{align}
&\hat R_{n,\gamma,\lambda}(\hat m_n^{(b-1)}(x))+\hat m_{n,b}(x))\\
\\&\approx\sum_{i=1}^n \left\{ L(Y_i,\hat 
m_n^{(b-1)}(X_i))+ g_i\hat m_{n,b}(X_i)+ \frac 1 2 h_i \hat m_{n,b}(X_i)^2\right \}+ J_{\gamma,\lambda}(m_{n,b})\\
&= \sum_{j=1}^{J_b}\left \{ \left[\sum_{i: X_i \in R_{jb}}g_i\right]v_{jb} + \frac 1 2 \left[\sum_{i: X_i \in R_{jb}}h_i+\lambda\right]v_{jb}^2 \right\}+\gamma J_b \quad \text{(ignoring constants)}
\end{align}

with \(g_i= \frac{\partial L(Y_i,y_i)}{\partial y_i} \Bigr\rvert_{y_i=m_n^{(b-1)}(X_i)}\) and \(h_i= \frac{\partial^2 L(Y_i,y_i)}{\partial^2 y_i} \Bigr\rvert_{y_i=m_n^{(b-1)}(X_i)}\). In the last expression, for a fixed tree, the optimal leaf values \(v_{jb}\) are given by

\[
v_{jb}=-\frac{\sum_{i: X_i \in R_{jb}} g_i }{\sum_{i: X_i \in R_{jb}} h_i+\lambda}
\]

This leads to the objective function
\[
-\frac 1 2\sum_{j=1}^{J_b} \frac {(\sum_{i: X_i \in R_{jb}}g_i)^2}{\sum_{i: X_i \in R_{jb}}h_i+\lambda}+\gamma J_b
\]

Hence, in step \(b\), when growing a tree the loss reduction of splitting \(R_{jb}\) in \(R_{jb,L},R_{jb,R}\) is given by

\[
\frac 1 2 \left\{\frac {(\sum_{i: X_i \in R_{jb,L}}g_i)^2}{\sum_{i: X_i \in R_{jb,L}}h_i+\lambda}+\frac {(\sum_{i: X_i \in R_{jb,R}}g_i)^2}{\sum_{i: X_i \in R_{jb,R}}h_i+\lambda}-\frac {(\sum_{i: X_i \in R_{jb}}g_i)^2}{\sum_{i: X_i \in R_{jb}}h_i+\lambda}\right\}-\gamma
\]

In step \(b\) the \(j\)th node is split a dimension and position that maximises the loss reduction, given that the maximising loss reduction is positive and the current node has depth smaller \(J\). Otherwise the node is not further split.

Gradient boosting machines are known to often provide the strongest predictive performance. \(\texttt{xgboost}\) and \(\texttt{lightgbm}\) are popular implementations. They are quite fast, but not as fast as random forests and also more reliant on optimal parameter tuning. The most relevant parameters are tree depth and learning rate

Why are gradient boosting machines so powerful? A contributing factor may be that a small max depth restricts the number of interactions fitted.

\begin{itemize}
\tightlist
\item
  max dept=\(1\) corresponds to an additive model etc\ldots.
  Gradient boosting machines, in contrast to random forests have also, no problem to fit additive functions. Different additive components can be fitted in different iterations \(b\).
\end{itemize}

\textbf{Bayesian additive regression trees.} Another powerful algorithm is BART

\textbf{Definition.} \emph{(Bayesian additive regression trees (BART) (for least squares))} (Chipman, George, and McCulloch 2010)

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Let \(\hat{m}^1(x)=\sum_{k=1}^K \hat{m}_k^1(x)\), \(\hat{m}_1^1(x)=\hat{m}_2^1(x)=\cdots=\hat{m}_K^1(x)=\frac{1}{n K} \sum_{i=1}^n Y_i\).
\item
  For \(b=2, \ldots, B\) :

  \begin{enumerate}
  \def\labelenumii{(\alph{enumii})}
  \tightlist
  \item
    For \(k=1,2, \ldots, K\) :

    \begin{enumerate}
    \def\labelenumiii{\roman{enumiii}.}
    \tightlist
    \item
      For \(i=1, \ldots, n\), calculate residuals
      \(r_i=y_i-\sum_{k^{\prime}<k} \hat{m}_{k^{\prime}}^b\left(X_i\right)-\sum_{k^{\prime}>k} \hat{m}_{k^{\prime}}^{b-1}\left(X_i\right)\)
    \item
      Consider a new tree, \(\hat{m}_k^b\) by making ONE of the following changes to \(\hat{m}_k^{b-1}\) (every change has a fixed probability).

      \begin{itemize}
      \tightlist
      \item
        GROW: split one leaf
      \item
        PRUNE: prune sister leaves
      \item
        CHANGE: change the decision rule of one node
      \item
        SWAP: swap decision rule of two nodes
      \end{itemize}
    \item
      The change is accepted by throwing a coin with the probabilities of the coin given by comparing posterior of old tree and proposed tree. Otherwise, tree is kept: \(\hat{m}_k^{b}=\hat{m}_k^{b-1}\)
    \item
      Update leaf values for \(\hat{m}_k^{b}\) by sampling from a posterior distribution.
    \end{enumerate}
  \item
    Set \(\hat{m}^b(x)=\sum_{k=1}^K \hat{m}_k^b(x)\).
  \end{enumerate}
\item
  Compute the mean after \(L\) burn-in samples,
  \(\hat{m}(x)=\frac{1}{B-L} \sum_{b=L+1}^B \hat{m}^b(x)\)
\end{enumerate}

Only a heuristic of BART is presented here. Many packages differ in the exact implementation. In general BART can be seen as a mix of random forest, boosting, additive models. BART is very expensive to train. But if one is able to tune the hyperparameters, BART has often shown to provide unmatched accuracy.

\hypertarget{some-practical-considerations}{%
\section{Some practical considerations}\label{some-practical-considerations}}

In this lecture we will discuss some practical issues that may help for your projects.

\textbf{Categorical data. }One point often ignored is that in many applications a significant part of features are categorical. All algorithms we have introduced so far implicitly assume, however, that features are numerical. The most ``famous'' ways of dealing with categorical features are one-hot encoding or dummy encoding.

\textbf{Definition.} \emph{(One-hot encoding)} Given a feature with \(X\) that can take \(k\) differen categorical values, one-hot encoding entails transforming the feature into \(k\)
binary features where

\[
X^{(l)}=\mathbb 1(X=l), \quad l=1,\dots,k.
\]

\textbf{Definition.} \emph{(Dummy encoding)} Given a feature with \(X\) that can take \(k\) differen categorical values, dummy encoding entails transforming the feature into \(k-1\)
binary features where, given a reference \(l^\ast\),

\[
X^{(l)}=\mathbb 1(X=l), \quad l=1,\dots,l^\ast-1,l^\ast+1,\dots,k.
\]

Dummy encoding solves the problem of collinearity when one-hot encoding. Both methods can easily make the dimension of the problem rapidly increase if a feature has many categories e.g.~car brand, country, or postcode. Grouping variables with similar effect on the response might reduce variance. This could e.g.~be done via expert knowledge. Trees are an automated alternative.

There are \(B_k = \sum_{j=0}^k \binom k j\) ways to partition a categorical feature with \(k\) values \href{https://en.wikipedia.org/wiki/Bell_number}{(Bell number)}.

\begin{itemize}
\tightlist
\item
  \(B_2=2\), \(B_3=5\), \(B_4=15\), \(B_5=52\), \(B_6=203\), \(B_7=877\), \(B_8=4140\).
\end{itemize}

In a CART algorithm, we would only partition a current node into two child-nodes. In this case there are \(2^{k - 1}-1\) possible partitions. This is still not feasible for large \(k\). It is well known Wright and König (2019) that if optimal partition is with respect to gini index or squared loss, then the optimal partition can be found by considering only \(k-1\) partitions:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Order feature values by mean response.
\item
  The optimal partition is a contiguous partition.
  - Search for optimal partition treating the categorical features as numerical, i.e., split into a left and right partition.
\end{enumerate}

Wright and König (2019) propose to order categorical variables only once when fitting a random forest. This is the default in \(\texttt{ranger}\). \(\texttt{lightgbm}\) and very recently (April 2022) \(\texttt{xgboost}\) offer the option to order variables before every split.

\textbf{Trees with different loss functions.} In many insurance applications it is common to assume that \(Y|X\) has a certain (known) parameterized distribution. In this case the loss function can correspond to the negative log likelihood or deviance. When fitting a tree, leaf values then correspond to the maximum likelihood parameter estimate for observations conditioned on that leaf. One advantage is that if the distribution is chosen well this can lead to more robust/better results and additionally it provides estimates of the full distribution. The disadvantage is that: It leaves room for misspecification. If one is only interested in the mean response, then estimating the distribution first may lead to a biased estimate of the mean. Computational time might be an issue if the likelihood function is too complicated.

\textbf{Example.} \emph{(Poisson loss with given exposure)} Assume that the response \(Y\) given \(X\) is Poisson distributed with mean \(\lambda(X)E\). Given iid observations \((X_i,Y_i,E_i)_{i=1,\dots,n}\), the log likelihood in leaf \(R_1\) is given by

\[
l(\lambda)= \sum_{i: X_i\in R_1} -\lambda E_i+ Y_i\log(\lambda E_i)-log(Y_i!)
\]

The minimzer is given by

\[
\hat \lambda = \frac{\sum_{i: X_i\in R_1}  Y_i}{\sum_{i: X_i\in R_1} ^n E_i}
\]

Which has the same minimizer as when minimizing the empirical risk of the Poisson Deviance
\[
\hat R_n(\lambda E_i)=\sum_{i=1}^n 2\left(Y_i\log {\frac {Y_i}{\lambda E_i }}-Y_i+\lambda E_i \right).
\]

\href{https://github.com/henckr/distRforest}{\(\texttt{distRforest}\)} is a recent attempt to add more distributions to random forest.

In boosting algorithms we don't directly work with the loss function but only with its gradient (boosting v1) or with a second order approximation (boosting v2). Assume \(Y|X\) follows a distributions from an exponential dispersion family, i.e., the density (for fixed \(X=x\)) can be written as

\[
f\left(Y ; \theta, E^{-1} \phi\right)=\exp \left\{ \frac{\theta Y-A(\theta)}{\phi/E}+c\left(Y ; \phi/E\right)\right\}.
\]

\(\phi\) is dispersion parameter. \(E\) is exposure. \(A\) is twice continuously differentiable, gradient of \(A\) one-to-one. We ignore the dispersion parameter \(\phi\) since it does not change point prediction if it does not change over different observations \(i=1,\dots,n\). Then, the negative log likelihood up to additive terms that do not depend on \(\theta\) is

\[
- E\times(\theta Y - A(\theta))
\]

We can translate this to a generalized framework: We could say we wish to estimate the distribution \(\tilde g (\mathbb E[Y])\), given canonical link function \(\tilde g\). \(\Rightarrow \tilde g(\mathbb E(Y))=\theta\). Meaning we wish to minimize the loss \(L(Y,\theta)= - E\times(\theta Y - A(\theta)).\) Hence, when employing a gradient boosting machine algorithm we can use the gradient:

\[
g_i= \frac{\partial  L(Y_i,\theta)}{\partial \theta} \Bigr\rvert_{\theta=m_n^{(b-1)}(X_i)}=-E_i\times \left(Y-  \frac{\partial  A(\theta)}{\partial \theta} \Bigr\rvert_{\theta=m_n^{(b-1)}(X_i)}\right),
\]

and the second derivative:

\[
h_i= \frac{\partial^2  L(Y_i,\theta)}{\partial^2 \theta} \Bigr\rvert_{\theta=m_n^{(b-1)}(X_i)}=E_i\times \left(  \frac{\partial^2  A(\theta)}{\partial^2 \theta} \Bigr\rvert_{\theta=m_n^{(b-1)}(X_i)}\right).
\]

\(\texttt{xboost}\) and \(\texttt{lightgbm}\) come with many pre-configured loss functions.

\textbf{Imbalanced data.} When considering individual insurance claims data, one will find that most policies do not have a claim registered. In other words: The number of observed zeros will be much higher than observations of other numbers when looking at claim frequencies or claim amounts. This can be a problem when modelling under a Poisson assumptions and zero inflated distributions have been suggested. It is usually not problematic when modelling under a Bernoulli assumption (logistic regression). It can be a problem if we are instead interested in 0/1 decisions (e.g.~in fraud detection). In this case, there have been loss modifications suggested that reward more detecting 1s than detecting 0s. A prominent example is focal loss (Lin et al.~2017). In pricing we are rather interested in the probability and not in 0/1 decisions.

Claim amounts are often modeled via a frequency severity approach modelling frequency and severity separately (assuming independence between frequency and severity):

\[
\pi=\mathbb{E}\left(\frac{L}{E}\right) = \mathbb{E}\left(\frac{N\times Y}{E}\right)= \mathbb{E}\left(\frac{N}{E}\right) \times  \mathbb{E}\left(Y\right)=\mathbb{E}(F) \times \mathbb{E}(Y).
\]

where \(\pi\)= technical price, \(L\)= loss, \(E\)= exposure, \(N\)= frequency and \(Y\)= severity. Note that it is important here how to define a claim (is a claim with claim size zero a claim?). If it is is not counted as a claim, then modelling \(E[Y]\) is easier.

\hypertarget{neural-networks}{%
\section{Neural Networks}\label{neural-networks}}

In this lecture we will introduce neural networks. Neural networks with multiple layers are also known as deep learners. We will only consider feed forward neural networks. Usually used for tabular (=unstructrued) data. The recent popularity of neural networks stems mostly from modification more suitable for structured data, like

\begin{itemize}
\tightlist
\item
  Convolutional neural networks for image classification
\item
  Transformers in natural learning processing
\end{itemize}

As usual, we assume that we are given an iid dataset \(\mathcal D_n=\{X_i,Y_i\}_{i=1,\dots,n}\).

\textbf{Single Layer Feed Forward.} We start with a single layer neural network (= 1 hidden layer).

\includegraphics{_main_files/figure-latex/unnamed-chunk-10-1.pdf}

The architecture of a single layer neural network corresponds to
the function class \(\mathcal G\) such that
\(\hat m(D_n)(x)=\hat m_n(x): \mathcal X \mapsto \mathcal Y\) can be written as
\begin{align}
\hat m_n(x)&=g\left(\beta_0 + \sum_{k=1}^{K} \beta_kH_k(x)\right)\\
&= g\left(\beta_0 + \sum_{k=1}^{K} \beta_k\phi\left(w_{k0} + \sum_{j=1}^p w_{kj}x_j\right)\right).
\end{align}
In the the previous slide the illustration showed \(p=3\), \(K=4\). To ease notation we will be ignoring the intercepts, here: \(\beta_0, w_{k0}\). In matrix notation, the hidden layer is \(H(x)=\phi(x^tw)\) and the output is

\[
\hat m_n(x)=g \left( H(x)^T\beta \right)=g\left(\phi(x^Tw)^T\beta\right).
\]

with \(w \in \mathbb R^{p\times K}\), \(\beta \in \mathbb R^{K}\). The functions \(\phi\) and \(g\) are called activation functions and are applied element-wise. The activation functions make the estimator non-linear.

\textbf{Popular activation functions.}

\begin{itemize}
\tightlist
\item
  Sigmoid: \(\phi(z)=\frac{e^z}{1+e^z}\)

  \begin{itemize}
  \tightlist
  \item
    maps to \([0,1]\)
  \end{itemize}
\item
  Hyperbolic tangent: \(\phi(z)=\textrm{tanh}(z)= \frac{e^z-e^{-z}}{e^x+e^{-z}}\)

  \begin{itemize}
  \tightlist
  \item
    maps to \([-1,1]\)
  \end{itemize}
\item
  Rectified Linear Unit (ReLU): \(\phi (z)=\max(z,0)\)

  \begin{itemize}
  \tightlist
  \item
    ``standard'' activation function
  \end{itemize}
\item
  Leaky ReLU: \(\phi (z)=\max(z,0)+ \alpha \min(0,z)\)
\end{itemize}

\textbf{Backpropagation.} Neural networks are fitted via gradient descent with small step sizes. We are hence interested in \(\frac{\partial L(Y_i,m(\beta,w))}{\partial w}, \frac{\partial L(Y_i,m(\beta,w))}{\partial \beta}.\) Calculating the gradient via the chain rule is called backpropagation.

Note that the loss is calculated via the following composition:

\[
X_i \stackrel{w}{\rightarrow } Z_1 \stackrel{\phi}{\rightarrow } H \stackrel{\beta}{\rightarrow }Z_2\stackrel{g}{\rightarrow } m \stackrel{}{\rightarrow } L(Y_i,m)
\]

Hence, by the chain rule we have

\[
\frac{\partial L(Y_i, \partial m)}{\partial \beta}=\frac{\partial L(Y_i,m)}{m}\frac{\partial m}{Z_2}  \frac{\partial Z_2}{\partial \beta},
\]

as well as

\[
\frac{\partial L(Y_i,m)}{\partial w}=\frac{\partial L(Y_i,m)}{\partial m}\frac{\partial m}{\partial Z_2} \frac{\partial Z_2}{\partial H} \frac{\partial H}{\partial Z_1}\frac{\partial Z_1}{\partial w}.
\]

In step \(r\) and given a learning rate \(\gamma\) the weights are updated as
\begin{align*}
\beta^{(r+1)}= \beta^{(r)} -\gamma \frac 1 n \sum_{i=1}^n\frac{\partial L(Y_i,\hat m_n^{(r)}(X_i))}{\partial \beta^{(r)}},  \\
w^{(r+1)}= w^{(r)} -\gamma  \frac 1 n \sum_{i=1}^n \frac{\partial L(Y_i,\hat m_n^{(r)}(X_i))}{\partial w^{(r)}}. 
\end{align*}

\textbf{Feed foreward Neural Network.} Usually one works with multiple hidden layers and possibly mutlipe outputs.

\includegraphics{_main_files/figure-latex/unnamed-chunk-11-1.pdf}

the \(l\)th hidden layer arises from the \(l-1\)th hidden layer from (ignoring intercepts)

\[
H^{(l)}=\phi_l(H^{(l-1)}w^{(l)}).
\]

The fitting is analogue to the single layer case. To avoid overfitting one can imploy penalty terms, e.g.~lasso and/or ridge. In the machine learning community this is also known as weight decay. Especially ridge penalty is popular. Ridge penalty means penalizing every entry of \(\beta, w\) by its square.

\textbf{Stochastic Gradient Descent and Early Stopping.} In ``deterministic'' gradient descent, weights are updated via

\[
\beta^{(r+1)}= \beta^{(r)} -\gamma \sum_{i=1}^n\frac{\partial L(Y_i,\hat m_n^{(r)}(X_i))}{\partial \beta^{(r)}},  \quad
w^{(r+1)}= w^{(r)} -\gamma  \sum_{i=1}^n \frac{\partial L(Y_i,\hat m_n^{(r)}(X_i))}{\partial w^{(r)}}.
\]

For large data sets this may not be computationally feasible/too expensive and an alternative is Stochastic Gradient Descent (SGD).

\textbf{Definition.} \emph{Stochastic Gradient Descent (SGD)}

Input: \(\texttt{batch-size}\), early stopping criteria (most often whether improvement is better than some treshold on the validation set)

\begin{itemize}
\tightlist
\item
  For \(j=1,\dots\)STOP (=epochs)

  \begin{enumerate}
  \def\labelenumi{\arabic{enumi}.}
  \tightlist
  \item
    For \(k=1,\dots, n/\texttt{batch-size}\)
  \item
    Sample without replacement \(\texttt{batch-size}\) from \(\{1,\dots,n\}\setminus \cup_{l=1}^{k-1}B_j^j\), resulting in the \(k\)th batch, \(B_k^j\).
  \item
    Perform gradient descent with using only observations \(i \in B_k^j\)
  \end{enumerate}
\end{itemize}

\textbf{Dropout learning.} An alternative/additional way to perform regularization is dropout, introduced in Srivastava et al.~(2014). It is an analogue to random forest, but the obvious idea of averaging the outputs of many separately trained nets is prohibitively expensive. Instead: In every mini-batch, for every \(i\), randomly remove a fraction \(p\) of the units in a layer when calculating the gradient. The surviving units get an additional weight of \(1/(1 − p)\). I.e. in epoch \(j\) and mini-batch \(k\), for individual \(i\) and current unit \(H(j,k)\),

\[
\widetilde H(j,k,i)=\begin{cases}0 & \text{with probability}\  p \\ H(k,j)/(1 − p) &\text{else}\end{cases}
\]

Note: \(\mathbb E[\widetilde H(j,k,i)]=H(k,j)\). The heuristic is that many thinned networks are trained in parallel.

\textbf{More Hyperparameters.} An alterantive to a ridge penalty is max-norm regularization, with parameter \(c\). I.e. in every learning step enforce \(||\beta||^2_2, ||w||^2_2\leq c\), where \(||\cdot||^2_2\) denotes the squared sum of all entries.

Instead of standard SGD, alternative updates can be performed, e.g., momentum:

\[
w^{(r+1)}=w^{(r)} +\alpha \Delta w^{(r)}  - \gamma  \sum_{i=1}^n \frac{\partial L(Y_i,\hat m_n^{(r)}(X_i))}{\partial w^{(r)}}
\]

\[
\Delta w^{(r)}= w^{(r)}-w^{(r-1)}
\]

or Adam.

\textbf{Further comments.} The size of the learning rate can depend on the current epoch, also known as learning rate decay. Initial weights, i.e, starting values for \(w, \beta\), do effect the outcome. Covariates are often standardized via minmax scaling.

\[
\tilde x = \frac{x- \min(x)}{\max(x)-\min(x)} \in [0,1]
\]

In R, implementation of neural network is provided via keras/tensorflow \url{https://tensorflow.rstudio.com/}. Given the many options to configure, initialize and stop training a neural network, training a neural network is often seen as ``art''.

For tabular (=unstructured) data tree-based algorithms usually outpeform neural networks with respect to test error. Neural networks are however unchallenged for structured data (especially when also extending the feed forward network accounting for the structure)

\hypertarget{local-explanations}{%
\section{Local explanations}\label{local-explanations}}

In this lecture we shift the perspective and we wish to understand what a predictor \(\hat m_n(x)\) is actually doing.

\hypertarget{interpretability}{%
\subsection{Interpretability}\label{interpretability}}

Regression: \(Y_i=m(X_i)+\varepsilon_i\)

\[
X\qquad \rightarrow \qquad  \widehat m (X)  \qquad \rightarrow  \qquad   m (X)\quad \text{or}\quad Y\ \vert\ X
\]

Interpretability is understanding the relationship between \(X\) and \(\widehat m (X)\). This is different to understanding the relationship between \(X\) and \(Y\).

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.4493}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.2754}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.2754}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
Quality
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Linear Models
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Machine Learning
\end{minipage} \\
\midrule()
\endhead
interpretable & ✔ & ✘ \\
interactions manually & ✔ & ✔ \\
interactions & ✘ & ✔ \\
variable selection/sparsity & ✔ & ✔ \\
non-linearity & ✘ & ✔ \\
\bottomrule()
\end{longtable}

Current machine learning algorithms are often highly flexible and
can deal with interaction, non-linearity, sparsity and variable selection;
but they are not interpretable.

\textbf{Local explanations.} Fix a value \(x_0 \in \mathbb R^p\). A local approximation at \(x_0\) of the function \(\hat m_n\) is given by

\[
\hat m\left(x_0\right)=\phi_{0}+\sum_{k=1}^{p} \phi_k(x_0),
\]

where \(\phi_0,\phi_1(x_0),\dots,\phi_p(x_0)\) are constants. Note: the right hand-side is not identified. Local explanations add constraints such that \(\phi_k(x_0)\) is uniquely identified and best reflects the local contribution of feature \(k\) to \(\hat m_n\left(x_0\right)\).

\textbf{Definition.} \emph{(Additive Value functions)} A value function \(v\) assigns a real value
\(v(S)\) to each subset \(S \subseteq \{1,\dots p\}\).

\textbf{Definition.} \emph{(Shapley Axioms)}

Given a vaue function \(v_{x_0}\) with \(v_{x_0}(\{1,\dots,p\})=m(x_0)\). The four Shapley axioms are

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Efficiency} \(m\left(x_0\right)=\phi_{0}+\sum_{k=1}^{p} \phi_k(x_0)\), \(\phi_{0}=v(\emptyset)\).
\item
  \textbf{Symmetry}: Fix any \(k,l \in \{1,\dots,p\}, k\neq l\).
  If \(v_{x_0}(S\cup k)=v_{x_0}(S\cup l)\), for all \(S \subseteq \{1,\dots p\}\setminus \{k,l\}\), then \(\phi_k(x_0)=\phi_l(x_0).\)
\item
  \textbf{Dummy} For \(k=1,\dots,p\): If \(v_{x_0}(S\cup k)=v_{x_0}(S)\), for all \(S \subseteq \{1,\dots p\}\setminus \{k\}\), then \(\phi_k=0.\)
\item
  \textbf{Linearity} For \(k=1,\dots,p\): If \(m(x_0)=m^1(x_0)+m^2(x_0)\), then \(\phi_k(x_0)=\phi^1_k(x_0)+\phi^2_k(x_0)\), where \(\phi^l\) is the explanation corresponding to the function \(m^l\).
\end{enumerate}

\textbf{Theorem.} \emph{(Shapley Axioms)} Given a value function \(v_{x_0}\), there exist unique constants \(\phi_0,\phi_1(x_0),\dots,\phi_p(x_0)\) such that the four Shapley axioms are satisfied. They are given by
\begin{align}
\phi_{k}(x_0)&=\frac{1}{p !} \sum_{\pi \in \Pi_p} \Delta_{v_{x_0}}\left(k, \{\pi(1),\dots,\pi(k-1)\}\right)\\
&=\frac 1 {p!}\sum_{S: S \subseteq \{1,\dots,p\} \setminus\{k\}} {|S| !(p -|S|-1) !}\Delta_{v_{x_0}}(k, S),
\end{align}
where \(\Delta_{v_{x_0}}(k, S)=v_{x_0}(S \cup k)-v_{x_0}(S)\) and \(\Pi_p\) is the set of permutations of \(\{1,\dots,p\}\).

\textbf{Proof.}

For \(R\subseteq\{1,\dots,p\}\), and a value fucntion \(v\), define the value function

\[
v_R(S)=\begin{cases}m(x_0) & \text{if}\  R\subseteq S \\ 0 & \text{else} \end{cases}
\]

\begin{itemize}
\tightlist
\item
  By the symmetry axiom, if \(j,k\in R\), then \(\phi_j(v_R)=\phi_k(v_R).\)
\item
  By the dummy axiom, if \(k\notin R\), then \(\phi_k(v_R)=0\).
\end{itemize}

Hence, by the efficiency axiom \((v_R(\{1,\dots,p\})=m(x_0))\), for \(k\in R\),

\[
\phi_k(v_R)= \frac{m(x_0)}{|R|}.
\]

We will (later) show that

\[
\tag{1}
v(U)=\sum_{T: T\subseteq\{1,\dots,p\}}\sum_{S: S\subseteq T} (-1)^{|T-S|}\frac{v(S)}{m(x_0)}v_T(U).
\]

Then, by the linearity axiom
\begin{align}
\phi_k(v)&=\sum_{T: T\subseteq\{1,\dots,p\}}\sum_{S: S\subseteq T} (-1)^{|T-S|} \frac{v(S)}{m(x_0)} \phi_k(v_T)\\
&=\sum_{T: T\subseteq\{1,\dots,p\}, k \in T}\sum_{S: S\subseteq T} (-1)^{|T-S|} \frac{v(S)}{|T|}\\
&=\sum_{S: S\subseteq\{1,\dots,p\}}\sum_{T: S \cup \{k\} \subseteq T} (-1)^{|T-S|} \frac{v(S)}{|T|} .
\end{align}
We can write

\[
\phi_k(v)=\sum_{S: S\subseteq\{1,\dots,p\}}\gamma_i(S) v(S)  , \quad  \gamma_k(S)=\sum_{T: S\cup \{k\}\subseteq T} (-1)^{|T-S|} \frac{1}{|T|}
\]

Observe that for \(S_1\neq S_2, S_2=S_1\cup\{k\}\), \(\gamma_k(S_1)=-\gamma_k(S_2)\). Hence,
\begin{align}
\phi_k(v)&=\sum_{S: S\subseteq\{1,\dots,p\}}\gamma_k(S) v(S) \\
&= \sum_{S: S\subseteq\{1,\dots,p\}, k\in S}\gamma_k(S) v(S) +\sum_{S: S\subseteq\{1,\dots,p\}, k\notin S}\gamma_k(S) v(S) \\
&= \sum_{S: S\subseteq\{1,\dots,p\}, k\notin S}-\gamma_k(S) v(S\cup\{k\}) +\sum_{S: S\subseteq\{1,\dots,p\}, k\notin S}\gamma_k(S) v(S) \\
&= \sum_{S: S\subseteq\{1,\dots,p\}, k\notin S}-\gamma_k(S) \left [ v(S\cup\{k\})  - v(S) \right]
\end{align}
The proof follows by showing that

\[ 
\tag{2}
\gamma_k(S)=-\frac{|S|!(p-|S|-1)!}{p!}, \qquad k \notin S,
\]

as well as equation (1).

We first show \((2)\). We will use that

\[
\frac 1 l = \int_0^1 x^{l-1}\mathrm dx.
\]

Such that for \(k \notin S\), we have
\begin{align}
\gamma_k(S)&= \sum_{l=0}^{p-|S|-1} (-1)^{l+1}\binom{p-|S|-1}{l}\frac 1 {|S|+1+l} \\
&= -\int_0^1x^{|S|}\sum_{l=0}^{p-|S|-1} (-1)^{l}\binom{p-|S|-1}{l}x^{l}\mathrm dx.
\end{align}
By the binomial theorem, this simplifies to
\begin{align}
\gamma_k(S)&=  - \int_0^1x^{|S|}(1-x)^{p-|S|-1}\mathrm dx \\
&= -\frac{|S|!(p-|S|-1)!}{p!}.
\end{align}
The last equality follows from

\[
\int_0^1 x^a (1-x)^b\mathrm dx= \frac{a!b!}{(a+b+1)!}, \qquad a,b\geq0
\]

which can be proven by induction over \(b\).
It remains to show (1). We have
\begin{align}
& \quad \sum_{T: T\subseteq\{1,\dots,p\}}\sum_{S: S\subseteq T} (-1)^{|T-S|}\frac{v(S)}{m(x_0)}v_T(U) \\
&=\sum_{T: T\subseteq U}\sum_{S: S\subseteq T} (-1)^{|T-S|}v(S)\\
&= \sum_{S: S\subseteq U}\left[\sum_{D: D \subseteq \{U\setminus S\}} (-1)^{|D|} \right]v(S)\\
&= v(U),
\end{align}
where the last equation follows because the expression in the square bracket is zero for \(U\neq S\). That is because a non-empty set has an equal number of subsets with an odd number of elements as subsets with an even number of elements.

Note that we will slightly abuse notation by ignoring ordering in the input of the functions below. Lundberg and Lee (2017) proposed to use Shapley values with value function

\[
v(S)=\mathbb E[ \hat m_n(X_S,X_{-S})| X_S=x_S] = \int \hat m_n(x_1,\dots,x_p) p_X(x_S,X_{-S}) \mathrm dx_{-S}
\]

for model explanation. And called it SHAP (SHapley Additive exPlanations). To simplify calculations, Lundberg and Lee (2017) proposed to calculate

\[
v(S)= \mathbb E[\hat m_n(x_S,X_{-S})]= \int \hat m_n(x_1,\dots,x_p) p_{X_{-S}}(X_{-S}) \mathrm dx_{-S}
\]

Janzing, Minorics, and Blöbaum (2020) argue that the latter value function should actually be the preffered value function. Chen et al.~(2020) coin it interventional SHAP (and the original SHAP above observational SHAP). In the next, we give an example why interventional SHAP values might be preferred compared to observational SHAP values.

\textbf{Example.} \emph{(Observational SHAP vs Interventional SHAP)} Assume

\[
\hat m_n(x_1,x_2)=x_1
\]

Let \(X_1\), \(X_2\) be binary with

\[
p(x_1,x_2)=
\begin{cases}
\frac 1 2 & \text{if} \ x_1=x_2 \\
0 & \text{else}
\end{cases}
\]

For observational SHAP, we have

\begin{itemize}
\tightlist
\item
  \(v_x (\emptyset)=\mathbb E[\hat m_n(X_1,X_2) ]=0.5\)
\item
  \(v_x (\{1\})=\mathbb E[\hat m_n(X_1,X_2) |X_1=x_1 ]=x_1\)
\item
  \(v_x (\{2\})=\mathbb E[\hat m_n(X_1,X_2) |X_2=x_2 ]=x_2\)
\item
  \(v_x (\{1,2\})=\hat m_n(x_1,x_2) =x_1\)
\end{itemize}

Hence,

\begin{itemize}
\tightlist
\item
  \(\Delta(2,\emptyset)= v_x (\{2\})-v_x (\emptyset)=x_1-0.5\)
\item
  \(\Delta(2,\{1\})= v_x (\{1,2\})-v_x (\{1\})=x_1-x_1=0\)
\end{itemize}

Such that

\begin{itemize}
\tightlist
\item
  \(\phi_2= \frac 1 2 (x_1-0.5)\neq 0\)
\end{itemize}

For interventional SHAP, we have

\begin{itemize}
\tightlist
\item
  \(v_x (\emptyset)=\mathbb E[\hat m_n(X_1,X_2) ]=0.5\)
\item
  \(v_x (\{1\})=\mathbb E[\hat m_n(x_1,X_2) ]=x_1\)
\item
  \(v_x (\{2\})=\mathbb E[\hat m_n(X_1,x_2) ]=0.5\)
\item
  \(v_x (\{1,2\})=[\hat m_n(x_1,x_2) =x_1\)
\end{itemize}

Hence,

\begin{itemize}
\tightlist
\item
  \(\Delta(2,\emptyset)= v_x (\{2\})-v_x (\emptyset)=0\)
\item
  \(\Delta(2,\{1\})= v_x (\{1,2\})-v_x (\{1\})=0\)
\end{itemize}

Such that

\begin{itemize}
\tightlist
\item
  \(\phi_2= 0\)
\end{itemize}

We conclude, that if one uses observational SHAP for model explanation, then the contribution of a feature is a combination of its own contribution and the contribution of features it is correlated with.

\textbf{Discussion Point.} If \(\mathbb P(X_1=X_2)\), then \(\tilde m_n(x)=x_2\) is as good in estimating the response as \(\hat m_n(x)=x_2\). In particular the Bayes rule is not unique. With that regard, it could make sense to attribute \(x_1\) and \(x_2\) the same importance. An argument against assigning \(x_2\) any importance is that if \(\phi\) is to explain the behaviour of \(\hat m_n(x)=x_2\), then it is not directly affected by \(x_2\).

We will later see that observational SHAP has one further issue: One may need to extrapolate in order to calculate it.

\textbf{How do we calculate/estimate Shapley values?} Rember, Shapley values are:
\begin{align}
\phi_{k}(x_0)&=\frac{1}{p !} \sum_{\pi \in \Pi_p} \Delta_{v_{x_0}}\left(k, \{\pi(1),\dots,\pi(k-1)\}\right)\\
&=\frac 1 {p!}\sum_{S: S \subseteq \{1,\dots,p\} \setminus\{k\}} {|S| !(p -|S|-1) !}\Delta_{v_{x_0}}(k, S),
\end{align}
To calculate Shapley values exact, one would need to evaluate \(p!\) or (second equation) \(2^p\) summands. For large \(p\) that may be infeasible.

\textbf{Definition.} \emph{(Estimate Shapley values via permutation sampling)}

The Shapley value \(\phi_k\) can be approximated by the following algorithm:

For \(r=1,\dots\),

\begin{itemize}
\tightlist
\item
  Sample a permutation \(\pi\) of \(\{1,\dots,p\}\)
\item
  Approximate \(\Delta_{v_{x_0}}\left(k, \{\pi(1),\dots,\pi(k-1)\}\right)\) (call the result \(\Delta^{(r)}\))

  \begin{itemize}
  \tightlist
  \item
    I.e approximate \(v(\{\pi(1),\dots,\pi(k-1)\}\cup \{k\})\) and \(v(\{\pi(1),\dots,\pi(k-1)\})\)

    \begin{itemize}
    \tightlist
    \item
      \(\Delta^{(r)}\) is the difference
    \end{itemize}
  \item
    If \(v(S)=\mathbb E[ \hat m_n(X_S,X_{-S})| X_S=x_S]\), (observational SHAP)

    \begin{itemize}
    \tightlist
    \item
      Not clear what to do. One would need to estimate the distribution of \(X\) first.

      \begin{itemize}
      \tightlist
      \item
        Which is a high dimensional problem\ldots{}
      \end{itemize}
    \end{itemize}
  \item
    If \(v(S)=\mathbb E[ \hat m_n(x_S,X_{-S})]\) (interventional SHAP)

    \begin{itemize}
    \tightlist
    \item
      Draw \(m\) individuals from \(\{1,\dots,n\}\), say \(I\subseteq n\),
    \item
      \(v(S)\approx \frac 1 I \sum_{i \in I} \hat m_n(x_S,x_{i,-S})\)
    \end{itemize}
  \end{itemize}
\end{itemize}

\(\hat \phi_k\) is the average of all \(\Delta^{(r)}\)

Problem: many samples needed to get accurate approximation. Hence, slow.

Charnes et al.~(1988) discussed that Shapley values can be re-written as the solution of the following constraint minimisation problem:

\[
(\phi(x_0))_{0,\dots,p} = \arg\min_{(\phi_k)_{k=1,\dots,p}} \mu(S) \sum_{S: S\subseteq\{1,\dots,p\}} \left(v_{x_0}(S)-  \left [\phi_0 + \sum_{k \in S} \phi_k\right]\right)^2,
\]
\[ 
\mu(S) =\frac{p-1} {\binom{p}{|S|} |S| (p-|S|)}.
\]

Note that \(\mu(\emptyset)=\mu(\{1,\dots,p\})=\infty\) and so the minimisation is not well defined. The infinite weight practically enforces \(\phi_0=v_{x_0}(\emptyset)\), \(\sum_{k=0}^p \phi_k=v_{x_0}(\{1,\dots,p\})\). One can hence, exclude the two sets \((\emptyset, \{1,\dots,p\})\) from the minimisation and add the two constraints, \(\phi_0=v_{x_0}(\emptyset)\), \(\sum_{k=0}^p \phi_k =v_{x_0}(\{1,\dots,p\})\), to the minimisation.

This is a quadratic programing problem (good), but estimating \(v_{x_0}(S)\) for all \(2^p\) subsets might economically not be feasible.

Introduced in Lundberg and Lee (2017), Covert and Lee (2021) give a detailed explanation on how Kernel SHAP is implemented. Instead of estimating \(v_{x_0}(S)\) for all \(2^p\) subsets they only evaluate \(n\) subsets. The \(m\) subsets are drawn from the set of all subsets of \(\{1,\dots,p\}\) minus the empty set and the full set, where the probability of drawing set \(S\) is proportional to \(\mu(S)\)

Hence the final minimisation reads
\begin{align}
\min_{(\phi_k)_{k=1,\dots,p}}  \frac 1 m  \sum_{i=1}^m \left(v_{x_0}(S_i)-  \left [v_{x_0}(\emptyset)+ \sum_{k \in S_i} \phi_k\right]\right)^2, \\ \text{subject to} \sum_{k=1}^p  \phi_k =v_{x_0}(\{1,\dots,p\})-v_{x_0}(\emptyset),
\end{align}
where \(S_i\) is the subset from draw \(i\). The value function used in Kernel SHAP is interventional SHAP, i.e., \(v_{x_0}(S)=\mathbb E[\hat m_n(x_S,X_{-S})]\).

Lundberg and Lee (2017) propose a method to estimate interventional SHAP that is fast and exact (exact in the sense that it calculates the exact plug-in estimates). It is specific for tree based algoirthms. The algorithm is called TreeSHAP and it makes use of the binary tree structures that leads to a partitioning of the feature space. For calculating \(\mathbb E[\hat m_n(x_S,X_{-S})]\), TreeSHAP recursively follows the decision path for \(x_0\) if the split feature is in \(S\), and takes the weighted average of both branches if the split feature is not in \(S\). For efficient caulculation, TreeSHAP does not go down the tree for every \(S\) separately but only once and while doing so keeps track of all possible \(S\).

\hypertarget{causality}{%
\section{Causality}\label{causality}}

This lecture covers a selected topic on causaliy leading to the so called adjustment formula. We mostly follow Peters, Janzing, and Schölkopf (2017).

\textbf{Definition.} \emph{(Graph Terminology)}

\begin{itemize}
\item
  We are given a random variables \(X = (X_1,...,X_p)\) with index set \(V := \{1,...,p\}\).
\item
  A graph \(G = (V,\mathcal E)\) consists of

  \begin{itemize}
  \tightlist
  \item
    nodes or vertices \(V\) and
  \item
    edges \(\mathcal E \subseteq V^2\) with \((v, v) \notin \mathcal E\) for any \(v \in V\).
  \end{itemize}
\item
  A node \(k\) is called a

  \begin{itemize}
  \tightlist
  \item
    parent of \(j\) if \((k,j)\in \mathcal E\) and \((j,k)\notin \mathcal E\)

    \begin{itemize}
    \tightlist
    \item
      The set of parents of \(k\) is denoted by \(pa_G(k)\)
    \end{itemize}
  \item
    a child if \((j,k) \in \mathcal E\) and \((k, j) \notin\mathcal E\).

    \begin{itemize}
    \tightlist
    \item
      The set of childrens of \(k\) is denoted by \(ch_G(k)\)
    \end{itemize}
  \end{itemize}
\item
  Two nodes \(k\) and \(j\) are adjacent if either \((k,j)\in \mathcal E\) or \((j,k) \in \mathcal E\).
\item
  We say that there is an undirected edge between two adjacent nodes \(k\) and \(j\) if \((k, j) \in \mathcal E\) and \(( j, k) \in \mathcal E\).
\item
  An edge between two adjacent nodes \((k,j)\) is directed if \((k,j)\in \mathcal E\) and \((j,k) \notin \mathcal E\) or vice versa.

  \begin{itemize}
  \tightlist
  \item
    We write \(k \rightarrow j\) for \((k, j) \in \mathcal E\), \((j, k) \notin \mathcal E\) and \(j \rightarrow k\) for \((j, k) \in \mathcal E\), \((k, j) \notin \mathcal E\)
  \end{itemize}
\item
  \(G\) is called directed if all its edges are directed.
\item
  A path in \(G\) is a sequence of (at least two) distinct vertices \(k_1,\dots ,k_m\), such that there is an edge between \(k_l\) and \(k_{l+1}\) for all \(l = 1,\dots ,m − 1\).

  \begin{itemize}
  \item
    If \(k_{l-1} \rightarrow k_l\) and \(k_{l+1} \rightarrow k_l\) (\(k_{l-1} \rightarrow k_l\leftarrow k_{l+1}\)), \(k_l\) is called a collider relative to this path.
  \item
    If \(k_l \rightarrow k_{l+1}\) for all \(l\), we speak of a directed path from \(k_1\) to \(k_m\)

    \begin{itemize}
    \tightlist
    \item
      In this case, We call \(k_1\) an ancestor of \(k_m\) and
    \item
      \(k_m\) a descendant of \(k_1\).
    \end{itemize}
  \end{itemize}
\item
  \(G\) is called a directed acyclic graph (DAG) if all edges are directed
  and there is no pair \((j,k)\) with directed paths from \(j\) to \(k\) and from \(k\) to \(j\).
\end{itemize}

\textbf{Definition.} \emph{(Pearl's d-separation)}

In a DAG \(G\), a path between nodes \(k_1\) and \(k_m\) is blocked by a set \(S\) (with neither \(k_1\) nor \(k_m\) in \(S\) ) if there is a node \(k_l\) fulfilling one of the two points:

\begin{enumerate}
\def\labelenumi{(\alph{enumi})}
\tightlist
\item
  \(k_l \in S\) and
  \begin{align}
    k_{l-1} & \rightarrow k_l \rightarrow k_{l+1} \\
    \text { or } \ k_{l-1} & \leftarrow k_l \leftarrow k_{l+1} \\
    \text { or }\  k_{l-1} & \leftarrow k_l \rightarrow k_{l+1}
    \end{align}
\item
  neither \(k_l\) nor any of its descendants is in \(S\), and
  \[
    k_{l-1} \rightarrow k_l \leftarrow k_{l+1}
    \]
\end{enumerate}

In a DAG \(G\), we say that two disjoint subsets of vertices \(A\) and \(B\) are \(d\)-separated by a third (also disjoint) subset \(S\) if every path between nodes in \(A\) and \(B\) is blocked by \(S\).\\
- We then write
\[
    A \perp\!\!\!\!\perp_G B \mid S
    \]

\textbf{Definition.} \emph{(Structural causal models)} A structural causal model (SCM) \(\mathfrak{C}:=\left(S, P_N\right)\) consists of a collection \(S\) of \(p\) (structural) assignments

\[
X_j:=f_j\left(pa(j), N_j\right), \quad j=1, \ldots, p,
\]

and a distribution \(P_N=\bigtimes_{j=1}^p P_{N_j}\) of jontly independent noise variables \(N_1\dots,N_p\).

Note: An SCM \(\mathfrak{C}\) defines a unique graph \(G\) and a unique distribution, \(P^{\mathfrak{C}}_X\), over the variables \(X_1,...,X_p\). The reverse is not true.

\textbf{Example.} \emph{(Structural causal models with acyclic graph structure)}
\begin{align*}
& X_1:=f_1\left(X_3, N_1\right) \\
& X_2:=f_2\left(X_1, N_2\right) \\
& X_3:=f_3\left(N_3\right) \\
& X_4:=f_4\left(X_2, X_3, N_4\right)
\end{align*}
\(N_1, \ldots, N_4\) jointly independent

\textbf{Definition.} \emph{(Interventional distribution/ do-operator)}

\begin{itemize}
\item
  Consider an SCM \(\mathfrak C := (S,P_N)\) and its entailed distribution \(P^{\mathfrak C}_X\).
\item
  We deifine a new SCM, \(\tilde {\mathfrak C}\), by replacing the assignment for \(X_k\) by
  \[ 
  X_k = \tilde f(\tilde {pa}(k), \tilde N_k).
  \]
  The resulting entailed distribution of the new SCM is called interventional distribution.
  We write short:
  \[
  do(X_k = \tilde f(\tilde {pa}(k), \tilde N_k)), \quad P_X^{\tilde {\mathfrak C}}=P^{\mathfrak C, do(X_k = \tilde f(\tilde {pa}(k), \tilde N_k))}_X
  \]
\item
  An intervention can also simply assign a fixed value \(a\) (i.e., \(\tilde N_k=a\) (deterministic) and the set of parents is empty).

  \begin{itemize}
  \tightlist
  \item
    This is called an atomic or deterministic intervention and can be denoted by \(do(X_k = a)\).
  \end{itemize}
\end{itemize}

\textbf{Definition.} \emph{(Total causal effect)} Given an SCM \(\mathfrak{C}\), we say there is a total causal effect from \(X\) to \(Y\) if

\[
X \perp\!\!\!\!\perp Y \quad \text { in } P_{{X}}^{\mathfrak{C} ; d o\left(X=\tilde{N}_X\right)}
\]

for some random variable \(\tilde{N}_X\).

Note: A directed path from \(X\) to \(Y\) is a necessary but not sufficient condition for a total causal effect (effects can cancel out). In contrast, a directed path from \(X\) to \(Y\) or \(Y\) to \(X\) is NOT necessary
for \(X\) and \(Y\) to be correlated.

\textbf{Definition.} \emph{(Markov property)} Given a DAG \(G\) and an entailed joint absolutely continuous distribution \(P_{{X}}\), this distribution is said to satisfy

\begin{enumerate}
\def\labelenumi{(\roman{enumi})}
\tightlist
\item
  the global Markov property with respect to the DAG \(G\) if
  \[
  {A} {\perp\!\!\!\!\perp }_{\mathcal{G}} {B}|{C} \Rightarrow {A} {\perp\!\!\!\!\perp } {B}| {C}
  \]
  for all disjoint sets of nodes \({A}, {B}, {C}\).
\item
  the local Markov property with respect to the DAG \({G}\) if each variable is independent of its non-descendants given its parents, and
\item
  the Markov factorization property with respect to the DAG \({G}\) if
  \[
  p({x})=p\left(x_1, \ldots, x_d\right)=\prod_{j=1}^d p\left(x_j \mid {pa}(j)\right).
  \]
\end{enumerate}

\textbf{Theorem.} \emph{(Equivalence of Markov properties, see e.g.~Lauritzen (1996))} If \(P_X\) is absolutely continuous, then all three Markov properties above are equivalent.

\textbf{Remark (SCM induced Graph is Markov):} Note that every SCM induced Graph satisfies the markovian properties.

\textbf{Proposition.} \emph{(Adjustment formula)} Consider an SCM over variables \({V}\) with \(X, Y \in {X}\) and \(Y \notin {pa(X)}\).

\begin{itemize}
\item
  \(Z\) is called valid adjustment set if it fulfills one of the three following conditions

  \begin{enumerate}
  \def\labelenumi{\arabic{enumi}.}
  \tightlist
  \item
    ``parent adjustment'':
    \[
      {Z}=pa(X)
      \]
  \item
    ``backdoor criterion'': \({Z} \subseteq {V} \backslash\{X, Y\}\) with

    \begin{enumerate}
    \def\labelenumii{(\roman{enumii})}
    \tightlist
    \item
      \({Z}\) contains no descendant of \(X\) AND
    \item
      \({Z}\) blocks all paths from \(X\) to \(Y\) entering \(X\) through the backdoor \((X \leftarrow \ldots)\).
    \end{enumerate}
  \item
    ``toward necessity'': \({Z} \subseteq {V} \backslash\{X, Y\}\) with

    \begin{enumerate}
    \def\labelenumii{(\roman{enumii})}
    \tightlist
    \item
      \({Z}\) contains no descendant of any node on a directed path from \(X\) to \(Y\) (except for descendants of \(X\) that are not on a directed path from \(X\) to \(Y\) ) AND
    \item
      \({Z}\) blocks all non-directed paths from \(X\) to \(Y\)
    \end{enumerate}
  \end{enumerate}
\item
  If \(Z\) is a valid adjustment set, then
  \[
    p^{\mathfrak{C}, d o(X=x)}(y)=\int  p^{\mathfrak{C}}(y \mid x, {z}) p^{\mathfrak{C}}({z}) \mathrm dz.
    \]
\end{itemize}

\textbf{Proof.}

We only proof ``parent adjustment'' and ``backdoor criterion''. ``towards necessity'' can be looked up in Shpitser, VanderWeele, and Robins (2010)

We call the interventional density \(\tilde p\) and the original density \(p\).

For the parent adjustment, \(Z=pa(X)\), note that\\
\begin{align}
\tilde p (y|z)&= \tilde p (y|x,z)= p (y|x,z) \\
\tilde p(z)&= p(z)
\end{align}
Hence,
\[
p(y|do(X=x))= \tilde p(y)= \int \tilde p(y|z) \tilde p(z) \mathrm dz = \int  p(y|x,z)  p(z) \mathrm dz
\]
- For the backdoor adjustment, let \(Z\) fulfill (i) and (ii) and let \(S=pa(X)\). We have
\begin{align}
p(y|do(X=x))&\stackrel{\text{parent adjustment}}{=} \int  p(y|x,s)  p(s) \mathrm ds\\
&=\int p(s)\int   p(y,z|x,s) \mathrm ds \mathrm dz \\
&\stackrel{\text{Bayes formula}}{=}\int p(s)\int   p(y|x,s,z) p(z|x,s) \mathrm ds \mathrm dz \\
&\stackrel{\text{(ii):} Y {\perp\!\!\!\!\perp } {S}| {X,Z}}{=}\int p(s)\int   p(y|x,z) p(z|x,s) \mathrm ds \mathrm dz \\
&\stackrel{\text{(i):} X {\perp\!\!\!\!\perp } {Z}| {S}}{=}\int p(s)\int   p(y|x,z) p(z|s) \mathrm ds \mathrm dz \\
&\stackrel{p(z)= \int p(s)p(z|s) \mathrm ds}{=}\int   p(y|x,z)   \mathrm dz 
\end{align}

Intuition behind backdoor criterion: Backdoor paths carry spurious associations from \(X\) to \(Y\). Blocking all backdoor paths ensures that measured assoziation is causal. We don't include descendants of \(𝑋\) that are also ancestors of \(𝑌\) because this would block a causal path. We don't include descendants of \(𝑋\) that are also descendants of \(𝑌\) because this would introduce collider bias.

\textbf{Questions.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  Do we need to observe \(Z_1\) to be able to calculate \(P(Y|do(X=x))\)?
\item
  What are all valid adjustment sets for calculating \(P(Y|do(X=x))\)?
\end{enumerate}

\textbf{Solution.} All valid adjustment sets are
\[
\{Z_1,Z_3\},\{Z_2,Z_3\},\{Z_1,Z_2,Z_3\}.
\]
In particular, \(Z_1\) is not needed need to calculate \(P(Y\vert do(X=x))\).

\textbf{Measuring Total causal effect.} How can we calculate \(\mathbb E[Y\vert do(X =x)]-\mathbb E[Y]\), i.e.~the total causal effect of \(X=x\) on \(Y\). If we have a valid adjustment set \(Z\), then
\begin{align}
E[Y\vert do(X =x)]&= \int y p^{d o(X=x)}(y) \ dy \\
&= \int \int  y p(y\vert x,z)p(z) \ dy \ dz \\
&= \int p(z)   \int y p(y\vert x,z)\ dy \ dz \\
&= \int p(z)  \mathbb E[  Y\vert X=x,Z=z]\ dz .
\end{align}
Which can be estimated from iid observations of \((X,Z,Y)\).

\textbf{Counterfactual fairness.} Assume \(U\) is a set of protected features. For example \(U=\{\text{gender, ethnicity}\}\). Let \(U \cup V=\{1,\dots, p\}, U\cap V=\emptyset\). Can we debias an algorithm predicting \(\mathbb E[Y\vert X=x]\) such that it does not use information contained in \(X_U\); neither directly nor indirectly. Kusner et al.~(2017) introduced the notion of counterfactual fairness. We here present a sufficient condition: Given a structural causal model of \((X,Y)\), an estimator is counterfactual fair if it is a function of the non-descendents of \(X_U\). A counterfactual estimator is in particular given by \(\hat m_n^{debiased}(x_v)=E[\hat m_n(X)\vert do(X_v =x_v)]\)

\hypertarget{local-and-global-explanations}{%
\section{Local and Global Explanations}\label{local-and-global-explanations}}

In this lecture we will introduce some global explanations and see how they are connected to local explanations. We will also see how these explanations can be used for de-biasing.

\hypertarget{interpretability-1}{%
\subsection{Interpretability}\label{interpretability-1}}

Reminder: Why interpretability.

\begin{itemize}
\tightlist
\item
  Algorithmic accountability

  \begin{itemize}
  \tightlist
  \item
    Are risk estimates transparent?
  \item
    EU regulation

    \begin{itemize}
    \tightlist
    \item
      GDPR: ``Individuals have the right to an explanation of the logic behind the decision.''
    \item
      EU AI Act
    \end{itemize}
  \end{itemize}
\item
  If process of decision making is transparent

  \begin{itemize}
  \tightlist
  \item
    \(\rightarrow\) Biases easier to detect
  \item
    \(\rightarrow\) more robustness a

    \begin{itemize}
    \tightlist
    \item
      unmeasured confounders can hunt you later under distributional shifts
    \end{itemize}
  \end{itemize}
\end{itemize}

\hypertarget{partial-dependence-plots}{%
\subsection{Partial dependence plots}\label{partial-dependence-plots}}

Partial dependence plots are popular post-hoc global explanations

\textbf{Definition.} \emph{(Partial dependence plots Friedman 2001)} Given an estimator \(\hat m_n\) and a target subset \(S\subset \{1,\dots,p\}\), the partial dependence plot \citep{}, \(\xi_S\), is defined as

\[
\xi_S(x_S)= \int \hat m_n(x) \hat p_{-S}(x_{-S})\mathrm dx_{-S}.
\]

In particular, a partial dependence plot for feature \(k\) is

\[
\xi_k(x_k)= \int \hat m_n(x) p_{-k}(x_{-k})\mathrm dx_{-k}.
\]

Partial dependence can be misleading because they ignore interaction effects. Approximation is highly non-trivial and can be very unstable trough extrapolatio.

\hypertarget{a-functional-decomposition}{%
\subsection{A functional decomposition}\label{a-functional-decomposition}}

Assume a data set with \(p\) features. Also assume that we can approximate the regression function \(m\) by a \(q-th\) order functional decomposition:

\[m(x) \approx  m_0+\sum_{k=1}^p  m_k(x_{k}) + \sum_{k_1<k_2}  m_{k_1k_2}(x_{k_1},x_{k_2}) + \cdots +\sum_{k_1<\cdots <k_q}  m_{k_1,\dots,k_q} (x_{k_1},\dots,x_{k_q}).\]

Optimal rates of convergence under the assumption that \(m\) has
two continuous partial derivatives:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2500}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2500}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2500}}
  >{\raggedright\arraybackslash}p{(\columnwidth - 6\tabcolsep) * \real{0.2500}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
\textbf{Model general}
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{general }\(p\)
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\(p=6\)
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
\textbf{Comparable sample sizes for p=6}
\end{minipage} \\
\midrule()
\endhead
Full model & \(O_p(n^{-2/(p+4)})\) & \(O_p(n^{-1/5})\) & 1 000 000 \\
Interaction (q) & \(O_p(n^{-2/(p+4)})\) & \(O_p(n^{-2/(p+4)})\) & 1 000 - 1 000 000 \\
Interaction (q=2) & \(O_p(n^{-1/3})\) & \(O_p(n^{-1/3})\) & 4 000 \\
Additive (q=1) & \(O_p(n^{-2/5})\) & \(O_p(n^{-2/5})\) & 1 000 \\
\bottomrule()
\end{longtable}

Generalized ANOVA is probably the most considered functional decomposition identification.

\textbf{Generalized ANOVA}: For every\(S\subseteq \{1,\dots,d\}\) and \(k\in S\),

\[
\int m_{S}\left(x_{S}\right) \int w(x) \mathrm dx_{-S} \ \mathrm d x_{k}=0
\]

Common choices for \(w\) are

\begin{itemize}
\tightlist
\item
  \(w \equiv 1\)
\item
  \(w(x)=p(x),\ \) \(p=\) density of \(X\).
\item
  \(w(x)=\prod p_j(x_j),\ \) \(p_j=\) density of \(X_j\).
\end{itemize}

Generalized ANOVA, however, has drawbacks for interpretability

\begin{itemize}
\tightlist
\item
  \(w=1\) ignores the distribution of \(X\)
\item
  \(w=p\) uses the correlation structure (analog to observational SHAP)
\item
  \(w=\prod p_j\) Assumes that features are independent
\end{itemize}

\textbf{Definition.} \emph{(Marginal Identification)} For every \(S\subseteq \{1,\dots,d\}\),
\[
\sum_{T: T \cap S \neq \emptyset} \int  \hat m_T(x_T)  p_{S}(x_{S}) \mathrm dx_S=0.
\]

\textbf{Theorem.} Given any initial estimator \(\hat m^{(0)}=\{\hat m^{(0)}_S | S\subseteq \{1,\dots,d\}\}\),
there exists exactly one set of functions \(\hat m^\ast=\{\hat m^\ast_S | S\subseteq \{1,\dots,d\}\}\) satisfying the marginal identification with \(\sum_S \hat m^\ast_S = \sum_S \hat m^{(0)}_S\).
The functions are given by

\[
\hat m^\ast_S (x_S)=  \sum_{T \supseteq S} \sum_{T\setminus S \subseteq U\subseteq  T}(-1)^{|S|-|T\setminus U|} \times \int \hat m^{(0)}_T(x_T) \hat p_U(x_U)\mathrm dx_U. \notag
\]

In particular \(\hat m^\ast\) does not depend on the particular identification of \(\hat m^{(0)}\).

The are three reasons why the marginal identification is particularly interesting

\begin{itemize}
\tightlist
\item
  Partial dependence plots
\item
  Interventional SHAP values
\item
  Fairness/ discrimination-free pricing
\end{itemize}

Remember: partial dependence plot, \(\xi_S\), is defined as
\[\xi_k(x_S)= \int \hat m(x) p_{-S}(x_{-S})\mathrm dx_{-S}.\]

\textbf{Corollary.} If \(\hat m^{\ast}\) satisfies the marginal identification, then

\[
\xi_S=\sum_{U \subseteq S} \hat m_U^{\ast}.
\]

In particular if \(S\) is only one feature, i.e., \(S=\{k\}\), we have

\[
\xi_k(x_k)= \hat m_0^{\ast} + \hat m_k^\ast(x_k).
\]

\textbf{Theorem.}

\begin{itemize}
\tightlist
\item
  \(\hat m^{\ast}\) satisfies the marginal identification
\item
  Then, interventional SHAP values are weighted averages components

  \begin{itemize}
  \tightlist
  \item
    interaction component is equally split between involved features:
  \end{itemize}
\end{itemize}

\[
\phi_k(x)= \hat m^{\ast}_k(x_k)+ \frac 1 2 \sum_j  \hat m^{\ast}_{kj}(x_{kj}) + \cdots + \frac 1 d \hat m^{\ast}_{1,\dots,d}(x_{1,\dots,d}).
\]

Assume \(U\) is a set of protected features. For example \(U=\{\text{gender, ethnicity}\}\). Let \(U \cup V=\{1,\dots, d\}, U\cap V=\emptyset\). \(E[m(X) |\  do(X_V=x_V))\) does not use information contained in \(X_U\); neither directly nor indirectly. Under the assumed causal structure we have

\[
E[m(X) |\ do(X_V=x_V)]= \int m(x) p_U(x_U) dx_U.
\]

Under marginal identifiaction:

\[
\int \hat m_n^\ast(x) \hat p_U(x_U) dx_U= \sum_{S \subseteq V} \hat {m}^\ast_S(x_S),
\]

i.e., a ``de-biased'' estimator can be extracted from \(\hat m_n\) by dropping all components that include features in \(U\).

\textbf{Summary (Identification)} If \(m\) is identified via martginal identification,

\[
\hat m_n(x)=\hat m_0^\ast + \sum_j \hat m_j ^\ast (x_j) + \sum_{j<k} \hat m_{j,k} ^\ast (x_j,x_k)+ \cdots
\]

then

\begin{itemize}
\tightlist
\item
  \textbf{Interventional SHAP values} are:
  \[
    \phi_k(x)= \hat m^{\ast}_k(x_k)+ \frac 1 2 \sum_j  \hat m^{\ast}_{kj}(x_{kj}) + \cdots 
    \]
\item
  \textbf{Partial dependence plots} are:
  \[
    \xi_k(x_k)= \hat m_0^{\ast} + \hat m_k^\ast(x_k).
    \]
\item
  \textbf{Fairness/Discrimination-free pricing:} If \(S\) are protected variables and all components that contain a subset of \(S\) are dropped,we derive a de-biased estimator.
\end{itemize}

\textbf{What does discrimination free pricing actually mean?}

Average claim Size

\begin{longtable}[]{@{}lll@{}}
\toprule()
Car & Male & Female \\
\midrule()
\endhead
Male Car Type & \$1 & \$2 \\
Female Car Type & \$2 & \$1 \\
\bottomrule()
\end{longtable}

Proportions in population \((p_{X,D})\)

\begin{longtable}[]{@{}lll@{}}
\toprule()
Car & Male & Female \\
\midrule()
\endhead
Male Car Type & 0.45 & 0.05 \\
Female Car Type & 0.05 & 0.45 \\
\bottomrule()
\end{longtable}

If we use \(p_D(d) = 0.5\) for pricing, then the price for Male Car Type 1 and Female Car Type would be \$1.50 each.

\textbf{Problem:} The prices are \textbf{not calibrated} now: The insurance company is charging more than the \emph{expected average claim size of \$1.10 }. (We ignore risk loading) We could multiply the price by \(\frac{1.10}{1.50}\approx 0.7333\). Hence charge everyone \(\$1.10\).

Problem: Is the price still discrimination free? Note that \$1.10 is also the price if we would ignore gender completely, \(\mathbb E[Y|X=x]\) (i.e.~allow for indirect discrimination). The answer will most likely be around the question why we wanted to de-bias for gender in the first place; what are the risk-factors we want to use, and what are unmeasured confounders.

\hypertarget{quantative-risk-management}{%
\chapter{Quantative Risk Management}\label{quantative-risk-management}}

\hypertarget{the-loss-variable}{%
\section{The Loss Variable}\label{the-loss-variable}}

We describe the financial risk with random variables defined on a filtered probability space \(\left(\Omega,\mathcal{F},P,\left\{\mathcal{F}_t\right\}_{t\in \mathbb{R}_+}\right)\). We assume that \emph{the value process} \(V_t\), denoting the market value of the portfolio at time \(t\), is adapted to the filtration i.e.~may be determined at time \(t\) or from information available at time \(t\). We will be considering discrete time jumps of size \(\Delta t\) for simplicity and assume that

\begin{itemize}
\tightlist
\item
  the portfolio remains fixed over the time horizon \([t,t+\Delta t)\),
\item
  there are no income or payments made during the time period.
\end{itemize}

This means in particular that the value

\[
\Delta V_{t+\Delta t}=V_{t+\Delta t}-V_t,
\]

only depends on the valuation of the components in the portfolio. We will henceforth be using the notation \(t\) and \(t+1\) and so forth denoting the intervals \([t+n\Delta t,t+(n+1)\Delta t)\) i.e.~\(t\) may be any time and the integer representing how many time jumps of size \(\Delta t\) has been made since \(t\).

Under the assumptions above it is reasonable to assume that \(V_t\) is Markovian in the sense that there exist \(d\ge 1\) random sources \(\mathbf{Z}_t=(Z_{t,1},...,Z_{t,d})^\top\) such that

\[
V_t=f(t,\mathbf{Z}_t)\tag{2.2}
\]

for some measurable function \(f : \mathbb{R}_+\times \mathbb{R}^d\to\mathbb{R}\). We will call \(\mathbf{Z}_t\) the \emph{risk factors} associated with the portfolio. The could be for instance the stockprice of a stock held in the portfolio. We may now define the \emph{loss variable} as \(L_{t+1}:=-(V_{t+1}-V_t)\) and \emph{risk-factor changes} as \(\mathbf{X}_{t+1}:=\mathbf{Z}_{t+1}-\mathbf{Z}_t\) and see that

\[
L_{t+1}=-\left(f(t+1,\mathbf{Z}_t+\mathbf{X}_{t+1})-f(t,\mathbf{Z}_t)\right),\tag{2.3}
\]

if one assume differentiability of \(f\) we may approximate \(L_{t+1}\) as

\[
L_{t+1}^\Delta:=-\left(\frac{\partial f}{\partial t}(t,\mathbf{Z}_t)+\sum_{i=1}^d \frac{\partial f}{\partial z_i}(t,\mathbf{Z}_t)\mathbf{X}_{t+1,i}\right).\tag{2.4}
\]

This is obviously a nice linear but the approximation error may be large if \(\Delta t\) is large. We are interested in the the distribution of \(L_{t+1}\) such that we may determine sufficiently capital holding in realtion to the risk associated with the assets and liabilities held on the firm's balance sheet.

\hypertarget{risk-measures}{%
\subsection{Risk measures}\label{risk-measures}}

In the general sense, a \emph{risk measure} is simply a measurable function \(\rho : \mathbb{L} \to\mathbb{R}\) taking a loss variable \(L\in \mathbb{L}\) as input and associating a number \(\rho(L)\) as output. In this setting we let \(\mathbb{L}\) be the set of all real-valued random variables. We may interpret this as the riskyness of the portfolio with associated loss variable \(L\). That is say we have two loss variable from the value processes \(V\) and \(V'\) i.e.~\(L\) and \(L'\) we say that \(V\) is riskier than \(V'\) if and only if \(\rho(L)\ge \rho(L')\).

We may now consider the fundamental definition of a coherent risk measures as in \href{https://www.researchgate.net/publication/227614132_Coherent_Measures_of_Risk}{\emph{Coherent Measures of Risk}} by Artzner, Delbean, Eber and Heath (1999), by first stating the definition of a risk measure.

\textbf{Definition.} \textbf{(Risk Measure)} \emph{Let \(\mathbb{L}\) be the set of all real valued random variable i.e.}

\[
\mathbb{L}=\left\{X\ \vert \ X : (\Omega,P,\mathcal{F})\to (\mathbb{R},\mathbb{B})\right\}
\]

\emph{Any mapping \(\rho : \mathbb{L} \to\mathbb{R}\) is called a measure of risk.}

We now want some properties to be satisfied by the mapping \(\rho\) such that it is a sensable measure of risk. To this we define four axioms as.

\textbf{Definition.} \textbf{(Coherent Risk Measure)} \emph{Let \(\rho\) be a measure of risk. We say that \(\rho\) is a coherent risk measure if and only if \(\rho\) satisfies the axioms below.}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Translation invariance:} \emph{Let \(\alpha\in\mathbb{R}\) and \(r\) be a predictable process we have \(\rho(X+\alpha\cdot r)=\rho(X)+\alpha\).}
\item
  \textbf{Subadditivity:} \emph{Let \(X_1,X_2\in\mathbb{L}\), then \(\rho(X_1+X_2)\le \rho(X_1)+\rho(X_2)\).}
\item
  \textbf{Positive homogeneity:} \emph{Let \(c>0\), then \(\rho(cX)=c\rho(X)\).}
\item
  \textbf{Monotonicity:} \emph{Let \(X,Y\in\mathbb{L}\) such that \(X\le Y\) \(P\)-a.s., then \(\rho(X)\le \rho(Y)\).}
\end{enumerate}

\emph{Remark:} We see that axiom (1) gives the equation \(\rho(X+\rho(X)\cdot r)=0\) i.e.~we may hedge the risk by holding \(\rho(X)\) in a asset with rate of return \(r\). The axiom (2) ensures that we take into account the correlation of multiple assets i.e.~we will in general not experience the maximal loss of two sources at the same time (although this is possible). If \(X_1\) and \(X_2\) satisfies \(\text{Corr}(X_1,X_2)=1\) then \(\rho(X_1+X_2)= \rho(X_1)+\rho(X_2)\).

There exist alot of different tangible measures of risk, some being coherent others non-coherent. The most well studied include Value at Risk VaR and Expected Shortfall ES. These two measures are in the realm of the loss distribution approach, however before studying these we introduce a few other worthy mentions: Factor sensitivity measures and scenario based risk measures:

\textbf{Factor sensitivity measures} are measures on the form \(\rho=g(\nabla L)\) where \(g\) is some \(d\)-dimensional measurable function. In this \(\nabla L\) is the gradient i.e.

\[
\nabla L=\nabla \Big(f(t,\mathbf{Z}_t)-f(t+1,\mathbf{Z}_{t+1})\Big)=\left(\frac{\partial L}{\partial z_1},...,\frac{\partial L}{\partial z_d}\right).
\]

\textbf{Scenario based risk measures} are measures where one assume that a collection \(\mathbf{x}=(x_1,...,x_N)\) of events \(x_i\in \Omega\) such that \(\sum_{i=1}^N P(x_i)=1-\varepsilon\) for some small \(\varepsilon>0\). We may then associate the measures \(\psi\) as

\[
\psi(L)=\max\left\{w_1L(x_1),...,w_NL(x_N)\right\},
\]

with \(\mathbf{w}\ge 0\) and \(\sum_{i=1}^Nw_i=1\) being weights. That is \(\psi\) gives the largest weighted loss. A natural way of choosing \(w_i\) is such that \(w_i\approx P(x_i)\), but one may also weight certain events with a larger weight for a more prudent measure. Notice also that the criteria \(\sum_{i=1}^N P(x_i)=1-\varepsilon\) does not necessarily have to be satisfied when considering the worst possible outcomes.

\hypertarget{value-at-risk}{%
\subsubsection{Value at Risk}\label{value-at-risk}}

The Value at Risk, henceforth VaR, is a quantile measure of the loss distribution \(F_L\) associated with \(L\). We define VaR as such:

\textbf{Definition 2.8. (McNeil)} \textbf{(Value-at-Risk)} \emph{Let \(\alpha\in (0,1)\) (\(\alpha\) being large) we define the VaR of a portfolio with loss variable \(L\) at the confidence level \(\alpha\) is a given by}
\begin{align*}
\text{VaR}_\alpha(L)&=\inf\left\{ l\in\mathbb{R}\ :\ P(L>l)\le 1-\alpha \right\}\\
&=\inf\left\{ l\in\mathbb{R}\ :\ F_L(l)\ge \alpha \right\}\\
&=F^{\leftarrow}_L(\alpha),
\end{align*}
\emph{where \(F^{\leftarrow}_L\) is the generalized inverse of \(F_L\).}

\begin{wrapfigure}{r}{0.5\textwidth}
  \begin{center}
    \includegraphics[width=0.48\textwidth]{figures/VaR_ES.png}
  \end{center}
\end{wrapfigure}

There exist alot of different tangible measures of risk, some being coherent others non-coherent. The most well studied include Value at Risk VaR and Expected Shortfall ES. These two measures are in the realm of the loss distribution approach, however before studying these we introduce a few other worthy mentions: Factor sensitivity measures and scenario based risk measures:

\hypertarget{measure-theory}{%
\chapter{Measure theory}\label{measure-theory}}

\hypertarget{axioms-of-probability}{%
\section{Axioms of Probability}\label{axioms-of-probability}}

Som udgangspunkt betragtes rummet \((\Omega,\mathcal{A})\) udstyret med en brolægning \(\mathcal{A}\subseteq 2^\Omega\), hvor \(2^\Omega=\mathcal{P}(\Omega)\) er mængden af alle delmængder af \(\Omega\). Typisk anvendes brolægningerne 1) en algebra eller 2) en \(\sigma\)-algebra.

\textbf{Definition 2.1. (Protter)} \textbf{(Algebra)} \emph{En brolægning \(\mathcal{A}\subseteq 2^\Omega\) kaldes en algebra, hvis}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(\Omega\subseteq\mathcal{A}\),
\item
  \(\forall A\in\mathcal{A} \Rightarrow A^c=\Omega\setminus A\in\mathcal{A}\) \emph{(lukket under komplementer),}
\item
  \(A_1,A_2,...,A_n\in\mathcal{A}\Rightarrow \cup_{i=1}^n A_i\in\mathcal{A}\) \emph{(lukket under endelige foreninger).}
\end{enumerate}

\textbf{Definition 2.2. (Protter)} \textbf{(\(\mathit{\sigma}\)-algebra)} \emph{En brolægning \(\mathcal{A}\subseteq 2^\Omega\) kaldes en \(\sigma\)-algebra, hvis}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(\Omega\subseteq\mathcal{A}\),
\item
  \(\forall A\in\mathcal{A} \Rightarrow A^c\in\mathcal{A}\) \emph{(lukket under komplementer),}
\item
  \((A_n)_{n\in\mathbb{N}}\subset\mathcal{A}\Rightarrow \cup_{i\in\mathbb{N}} A_i\in\mathcal{A}\) \emph{(lukket under tællelige foreninger).}
\end{enumerate}

\emph{Egenskaber for en \(\sigma\)-algebra}: 1) \(\emptyset\in\mathcal{A}\), 2) \(A,B\in\mathcal{A}\Rightarrow A \cup B\in\mathcal{A}\), og 3) \((A_i)_{i\in\mathbb{N}}\subseteq\mathcal{A}\Rightarrow\cap_{i\in\mathbb{A}}A_i\in\mathcal{A}\).

\emph{Eksempel:} Borel-sigma-algebraen \(\mathcal{B}(\mathbb{R}^n)=\sigma(\mathcal{C})\), hvor \(\mathcal{C}\) kan være en af følgende frembrigersystem. (\(\sigma(\mathcal{C})\) benævner den mindste \(\sigma\)-algebra på \(\Omega\), hvor \(\mathcal{C}\in\mathcal{A}\)).

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  De åbne mængder dvs. \(\mathcal{C}=\mathcal{O}^n\)
\item
  De lukkede mængder dvs. \(\mathcal{C}=\{A^c : A\in\mathcal{O}^n\}\)
\item
  Halvåbne mængder/bokse
\item
  Uendelige intervaller som \(\mathcal{C}=\{(-\infty,a] : a\in\mathbb{R}\}\)
\end{enumerate}

\textbf{Definition 2.2. (Protter)} \textbf{(Sandsynlighedsmål)} \emph{Lad \(\mathcal{A}\subseteq2^\Omega\) være en \(\sigma\)-algebra. \(P : \mathcal{A}\to[0,1]\) kaldes et sandsynlighedsmål hvis}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(P(\Omega)=1\),
\item
  \emph{For \((A_n)_{n\in\mathbb{N}}\) af parvist disjunkte delmængder af \(\Omega\) gælder \(P\left(\bigcup_{n\in\mathbb{N}}A_n\right)=\sum_{n\in\mathbb{N}}P(A_n)\).}
\end{enumerate}

\emph{Bemærkning:} Husk et mål \(\mu : \mathcal{A}\to [0,\infty)\) på \(\mathcal{A}\) opfylder at 1) \(\mu(\emptyset)=0\) og 2) for en parvis disjunkt familie \((A_n)_{n\in\mathbb{N}}\) gælder \(\mu\left(\mathop{\dot{\bigcup}}_{n\in\mathbb{N}}A_n\right)=\sum_{n\in\mathbb{N}}\mu(A_n)\).

\emph{Konsekvenser:} Umildbare konsekvenser ved definition 2.3 er følgende

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \(\sum_{i=1}^n P(A_i)=P\left(\bigcup_{i=1}^nA_i\right)\), hvis alle \(A_i\) er pavist disjunkte
\item
  \(0\le P(A)\le 1\), for alle \(A\in\mathcal{A}\)
\item
  \(P(A^c)=1-P(A)\), for alle \(A\in\mathcal{A}\)
\item
  \(P(A)\le P(B)\) hvis \(A\subseteq B\)
\end{enumerate}

\textbf{Theorem 2.3. (Protter)} \textbf{(Opad- og nedadkontinuitet)} \emph{Lad \(P : \mathcal{A}\to[0,1]\) være et ssh. mål på \((\Omega,\mathcal{A})\). Da gælder}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  \emph{\(P(A_n)\uparrow P(A)\) hvis \(A_n\uparrow A\),}
\item
  \emph{\(P(A_n)\downarrow P(A)\) hvis \(A_n\downarrow A\)}
\end{enumerate}

\hypertarget{conditional-probability-and-independence}{%
\section{Conditional Probability and Independence}\label{conditional-probability-and-independence}}

\textbf{Definition 3.1. (Protter)} \textbf{(Uafhængighed)} \emph{Lad \((\Omega,\mathcal{A},P)\) være et ssh. rum.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Lad \(A,B\in\mathcal{A}\) være to hændelser. \(A\) og \(B\) kaldes uafhængige hvis \(P(A\cap B)=P(A)P(B)\).}
\item
  \emph{Lad \(A_i\in\mathcal{A}\) for en indeksmængde \(i\in I\) (ikke et krav om endelighed eller tællelig). Hændelserne \(A_i\) kaldes uafhængige hvis \(P(\cap_{i\in J}A_i)=\prod P(A_i)\) for et \(J\subseteq I\) med \(\# J< +\infty\).}
\end{enumerate}

\emph{Bemærkning.} Der gælder at 1) \(\emptyset\) og \(\Omega\) er uafhængige af alle \(A\in\mathcal{A}\) samt \(A\in\mathcal{A}\) er uafhængig med sig selv hvis og kun hvis \(P(A)=\{0,1\}\).

\textbf{Theorem 3.1. (Protter)} \emph{Lad \((\Omega,\mathcal{A},P)\) være et ssh. rum. Antag \(A,B\in\mathcal{A}\) være uafhængige, så er følgende par uafhængige: \((A^c,B),(A,B^c)\) og \((A^c,B^c)\).}

\textbf{Definition 3.2. (Protter)} \textbf{(Betinget sandsynlighed)} \emph{Lad \(A,B\in\mathcal{A}\) være hændelser og \(P(B)>0\). Den betingede sandsynlighed \(A\) givet \(B\) er \(P(A\vert B)=P(A\cap B)/P(B)\).}

\textbf{Theorem 3.2. (Protter)} \emph{Lad \(A,B\in\mathcal{A}\) være hændelser og \(P(B)>0\).}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{\(A\) og \(B\) er uafhængige hvis og kun hvis \(P(A\vert B)=P(A)\).}
\item
  \emph{Funktionen \(P(\cdot \vert B) : \mathcal{A} \to [0,1]\) definerer et nyt ssh. mål på \(\mathcal{A}\), kaldet \textbf{den betingede sandsynlighed givet \(B\)}.}
\end{enumerate}

Andet kan tilføjes f.eks. Bayes'.

\hypertarget{probabilities-on-a-finite-or-countable-space}{%
\section{Probabilities on a Finite or Countable Space}\label{probabilities-on-a-finite-or-countable-space}}

Lad \(\Omega\) være et endelig eller tællelig mængde og lad \(\sigma\)-algebraen \(\mathcal{A}=2^\Omega\).

\textbf{Theorem 4.1. (Protter)} \textbf{(Punktsandsynligheder)} \emph{Lad \(A,B\in\mathcal{A}\) være hændelser og \(P(B)>0\).}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{En sandsynlighed på en tællelig eller endelig mængde \(\Omega\) er givet ved sandsynlighederne for hvert atom \(p_\omega=P(\{\omega\})\), \(\omega\in\Omega\).}
\item
  \emph{Hvis en følge af reelle tal \((p_\omega)_{\omega\in\Omega}\) indiceret over elementerne i \(\Omega\) opfylder at \(p_\omega\ge0\) og \(\sum_{k\in\Omega}p_k=1\), så eksisterer et unikt sandsynlighedsmål \(P\) givet ved \(P(\{\omega\})=p_\omega\).}
\end{enumerate}

\textbf{Bemærkning.} Alle sandsynlighedsmål på endelige eller tællelige mængder \(\Omega\) kan således karakteriseres ved punktsandsynlighederne \(p_\omega\). Dvs. et sandsynligedsmål \(P : 2^\Omega \to [0,1]\) er givet ved summen af punktsandsynligheder

\[
P(A)=\sum_{k\in A}p_k,\ A\subseteq\Omega
\]

\textbf{Definition 4.1. (Protter)} \emph{En ssh. \(P\) på en endelig mængde \(\Omega\) er uniform hvis \(p_\omega\) afhænger af \(\omega\).}

\textbf{Eksempler:}

\emph{(Den uniforme fordeling.)} Det følger direkte af definition 4.1, at den uniforme fordeling er givet ved

\[
P(A)=\frac{\#A}{\#\Omega}
\]

\emph{(Binomialfordelingen)} Lad \(\Omega=\{0,1,2,...,n\}\) og \(\mathcal{A}=2^\Omega\). Givet et \(q\in[0,1]\) defineres binomialfordelingen ved
\[
p_k={n\choose k}q^k(1-q)^{n-k},\ k\in\Omega
\]
\emph{(Geometriske fordeling)} Lad \(\Omega=\mathbb{N}_0=\{0,1,2,...\}\) og \(\mathcal{A}=2^{\mathbb{N}_0}\). Givet et \(q\in[0,1]\) er den geometriske fordeling givet ved

\[
p_k=(1-q)^kq,\ k\in\Omega
\]

\emph{(Hypergeometrisk fordeling)} Lad \(N,M\in\mathbb{N}\) være givet.

\emph{(Poisson fordelingen)} Lad \(\Omega=\mathbb{N}_0\) og \(\mathcal{A}=2^{\mathbb{N}_0}\). Givet et parameter \(\lambda>0\) er poissonfordelingen gived ved

\[
p_n=e^{-\lambda}\frac{\lambda^n}{n!},\ n\in\Omega
\]

Desuden er \(K(n,k)={n\choose k}\) givet ved

\[
{n\choose k}=\frac{n!}{k!(n-k)!}.
\]

\hypertarget{construction-of-a-probability-measure-on-mathbb-r}{%
\section{\texorpdfstring{Construction of a Probability Measure on \(\mathbb R\)}{Construction of a Probability Measure on \textbackslash mathbb R}}\label{construction-of-a-probability-measure-on-mathbb-r}}

\textbf{Sandsynlighedsmålet} kan indledelsesvis indføres på følgende vis: Lad \((\Omega, \mathcal{A},\mu)\) være et målrum og lad \(f : (\Omega,\mathcal{A}) \to [0,\infty]\) være \(\mathcal{A}/\mathcal{B}\)-målelig. Definer nu målet \(\nu : \mathcal{A} \to [0,\infty]\) ved

\[
V(A)=\int_A f d\mu=\int 1_A fd\mu=\int 1_A(x)f(x)d\mu(x)=\int1_A(x)f(x)\mu(dx),\ A\in\mathcal{A}
\]

I situationen hvor \(V(\Omega)=1\) er \(\nu\) et ssh. mål. Især er vi interesseret i målrummet \((\mathbb{R}^n,\mathcal{B}_n)\). Notationen \(\nu =f\cdot \mu\) bruges og betyder ``\(\nu\) har tæthed \(f\) mht. \(\mu\)''.

\textbf{Eksempler.} \emph{(Lebesguemålet)} Lad \((\Omega,\mathcal{A},\mu)=(\mathbb{R},\mathcal{B},m)\) været et målrum, hvor \(m\) er lebesgue-målet. Lad \(f : \mathbb{R}\to (0,1/\sqrt{2\pi}]\) være givet ved

\[
f(x)=\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}x^2},\ x\in\mathbb{R},
\]

da er \(f\) målelig, da \(f\) er kontinuer for alle \(x\in\mathbb{R}\). Da er \(\nu : \mathcal{B} \to [0,1]\), også kaldet \emph{normalfordelingen}, et ssh. mål givet ved

\[
\nu(A)=\int_A f(x) dm(x),\hspace{20pt} \nu(\mathbb{R})=\int_{\mathbb{R}}\frac{1}{\sqrt{2\pi}}e^{-\frac{1}{2}x^2}dm(x)=1
\]

\emph{(Tællemålet)} Lad \((\mathbb{N}_0,2^{\mathbb{N}_0},\mu)\) været et målrum og lad \(\mu\) være tællemålet. Lad \(f : \mathbb{N}_0 \to [0,\infty]\) være en vilkårlig målelig funktion. Da er \(\nu\) givet ved

\[
\nu(A)=\int_A fd\mu=\sum_{x\in A}f(x)
\]

hvis \(\nu(\mathbb{N}_0)=\sum_{x\in\mathbb{N}_0}f(x)=1\) er \(\nu\) et ssh. mål på \((\mathbb{N}_0,2^{\mathbb{N}_0})\).

\textbf{Definition 7.1. (Protter)} \textbf{(Fordelingsfunktionen/distribution function)} \emph{Lad \(P\) være et ssh. mål på \((\mathbb{R},\mathcal{B})\), da er fordelingsfunktionen \(F : \mathbb{R}\to [0,1]\) defineret ved.}

\[
F(x)=P((-\infty,x]).
\]

\textbf{Theorem 7.1. (Protter)} \textbf{(Entydighed)} \emph{Fordelingsfunktionen \(F\) karakteriserer \(P\) og er unik.}

\textbf{Corollary 7.1. (Protter)} \emph{Lad \(F\) være en fordelingsfunktion for \(P\) på \(\mathbb{R}\). Definer da \(F(x-):=\lim_{u\uparrow x}F(u)\). For vilkårlige \(x,y\in\mathbb{R}\) gælder}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \(P((x,y])=F(y)-F(x)\)
\item
  \(P([x,y])=F(y)-F(x-)\)
\item
  \(P(\{x\})=F(x)-F(x-)\)
\end{enumerate}

\textbf{Theorem 7.2. (Protter)} \textbf{(Egenskaber for fordelingsfunktionen)} \emph{\(F : \mathbb{R} \to [0,1]\) er en fordelingsfunktion for et unikt sandsynlighedsmål \(P\) på \((\mathbb{R},\mathcal{B})\), hvis}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \emph{\(F\) er ikke-aftagende dvs. \(F(x)\le F(y)\), for \(x\le y\)}
\item
  \emph{\(F\) er højre kontinuer dvs. \(F(u)\downarrow F(x)\) for \(u\downarrow x\).}
\item
  \emph{\(F(x)\to 1\) når \(x\to \infty\), \(F(x)\to 0\) når \(x\to -\infty\).}
\end{enumerate}

\emph{Bemærkning.} Teorem 7.2 kan fungere som et værktøj til konstruktion af et sandsynligedsmål givet en fordelingsfunktion.

\hypertarget{random-variables}{%
\section{Random Variables}\label{random-variables}}

Indledelsesvis genopfriskes målbare rum. For to rum \((E,\mathcal{E})\) og \((F,\mathcal{F})\), hvor \(\mathcal{E}\) og \(\mathcal{F}\) er \(\sigma\)-algebraer på de respektive rum. Da kaldes en en afbildning \(X : (E,\mathcal{E})\to(F,\mathcal{F})\) for en målelig afbildning, hvis og kun hvis for alle delmængder \(A\in\mathcal{F}\) er \(X^{-1}(A)\in\mathcal{E}\). Med andre ord for enhver billedmængde, kan vi måle urbilledet, hvorfra funktionsværdierne på billedmængden kunne være kommet fra.

\textbf{Definition.} \textbf{(Stokastisk variabel)} \emph{En målelig afbildning udstyret med et sandsynlighed mål på domænet dvs. \(X : (\Omega,\mathcal{A},P) \to (F,\mathcal{F})\), kaldes en stokastisk variabel (stochastic/random variable).}

\textbf{Bemærkning.} Oftest betragtes \(F=\mathbb{R}^n\) og \(\mathcal{F}=\mathcal{B}_n\) især når \(n=1\).

\textbf{Corollary 8.1. (Protter)} \textbf{(Urbilleder)} \emph{Lad \(X\) være en stokastisk variabel er \(X^{-1}(A):=\{\omega\in\Omega \vert X(\omega)\in A\}:=\{X\in A\}\). Hertil gælde specielt for eksempelvis \(A=(-\infty,x]\) og \(A=(x,\infty)\) følgende urbilleder \(X^{-1}(A)=\{X\le x\}\) og \(X^{-1}(A)=\{X> x\}\).}

\textbf{Definition.} \textbf{(Billedmål)} \emph{For en målbar funktion \(X : (\Omega,\mathcal{A},\mu) \to (F,\mathcal{F})\), hvor \(\mu\) er et mål på \(\mathcal{A}\) defineres \(\mu^X(A)=\mu(X^{-1}(A))\) som billedmålet af \(A\).}

\textbf{Theorem 8.5. (Protter)} \textbf{(Billedmål for stokastiske variable)} \emph{Lad \(X : (\Omega,\mathcal{A},P) \to (F,\mathcal{F})\) være en stokastisk variabel, så gælder for alle \(A\in\mathcal{F}\) at \(P^X(A)=X(P)(A)=P(X^{-1}(A))=P(X\in A)\), hvor \(P^X\) kaldes fordelingen af \(X\) (distribution of \(X\)). \textbf{Specielt er \(P^X\) et sandsynlighedsmål}..}

\textbf{Bemærkning.} Fordelingsfunktionen \(F_X: \mathbb{R}\to [0,1]\) for \(X\) er givet ved \(F_X(x)=P^X((-\infty,x])=P(X\in (-\infty,x])=P(X\le x)\).

\textbf{Definition.} \textbf{(Næsten sikker)} \emph{For en stokasitsk variabel \(X:(\Omega,\mathcal{A},P) \to (F,\mathcal{F})\) og en delmængde \(A\in \mathcal{F}\) siges at}

\[
X\in A\hspace{10pt} P\text{-n.s}\hspace{10pt}\Leftrightarrow\hspace{10pt} X\in A\hspace{10pt} P\text{-a.s}\hspace{10pt}\Leftrightarrow\hspace{10pt} X\in A\hspace{10pt} P\text{-a.e}
\]

\emph{gælde hvis \(P(X\in A)=1\) dvs. ækvivalent \(P(X\in A^c)=P(X\in F\setminus A)=0\).}

Ovenstående udtales n.s (næsten sikker), a.s (almost surely) og a.e (almost everywhere).

\hypertarget{integration-with-respect-to-a-probability-measure}{%
\section{Integration with Respect to a Probability Measure}\label{integration-with-respect-to-a-probability-measure}}

\textbf{Definition 9.1.} \textbf{(Forventet værdi)} \emph{Lad \(X : (\Omega, \mathcal{A}, P) \to (F,\mathcal{F})\) være en stokastisk variabel. Da defineres forventningen af \(X\) som følgende integrale, når dette er veldefineret.}

\[
E(X)=E\{X\}=\int X dP=\int_\Omega X dP=\int_\Omega X(\omega)dP(\omega)=\int_\Omega X(\omega)P(d\omega).
\]

\textbf{Bemærkning.} Integralet ovenfor er veldefineret hvis 1) \(X\ge 0\) P-n.s dvs \(P(X\ge 0)=1\) eller, hvis 2) \emph{(definition 9.2)} \(X=X^+-X^-\) er \(E(X)=E(X^+)-E(X^-)\), hvis blot \(E(X^+),E(X^-)<+\infty\) (kun en nødvendig).

\textbf{Eksempler.} Hvis \(\Omega\) er tællelig, er \(P\) en simpel funktion, givet ved singelton mængder. Derved bestemmes \(E(X)\) ved

\[
E(X)=\sum_{\omega\in\Omega} X(\omega)P(\{\omega\})
\]

\textbf{Theorem 9.1. (Protter)} \textbf{(Sætninger fra An2)} \emph{Husk \(\mathcal{L}^p\) defineres som mængden af \(\mathcal{A}/\mathcal{B}\) målelige funktioner \(f\), hvor \(\vert f\vert ^p\) er integrabel. Det vil sige i konteksten af forventet værdi arbejder vi med mængden}

\[
\mathcal{L}^p=\{X : (\Omega,\mathcal{A},P)\to(\mathbb{R},\mathcal{B})\ \vert\ E\vert X\vert^p< +\infty\}.
\]

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{\(\mathcal{L}^p\) er et lineært vektorrum dvs. for \(X\in \mathcal{L}^p\Rightarrow aX\in\mathcal{L}^p\), \(a\in\mathbb{R}\) og for \(X,Y\in\mathcal{L}^p\Rightarrow X+Y\in\mathcal{L}^p\). Desuden for \(0\le X\le Y\) og \(Y\in\mathcal{L}^1\), så er \(X\in\mathcal{L}^1\) og \(E(X)\le E(Y)\).}
\item
  \emph{For \(X\in\mathcal{L}^p\) er \(E(X)\le E\vert X\vert\).}
\item
  \emph{Hvis \(X=Y\) \(P-n.s\) og \(X\in\mathcal{L}^p\), så er \(Y\in\mathcal{L}^p\) og \(E(X)=E(Y)\) samt \(E\vert X-Y\vert^p=0\).}
\item
  \textbf{(Monotom konvergens teorem)} \emph{Hvis \(X_n\uparrow X\) og \(X_n\) gælder \(\lim_{n\to \infty} E(X_n)=E(X)\).}
\item
  \textbf{(Fatou's lemma)} \emph{Hvis \(X_n\ge Y\) \(P-n.s.\) (\(Y\in\mathcal{L}^p\)) eller \(X_n\ge 0\) \(P-n.s.\) for alle \(n\), så er \(E(\liminf_{n\to\infty}X_n)\le \liminf_{n\to \infty} E(X_n)\).}
\item
  \textbf{(Lebesgue's domineret konvergens teorem)} \emph{Hvis \(X_n\uparrow X\) \(P-n.s.\) og hvis \(\vert X_n\vert \le Y\in\mathcal{L}^1\) \(P-n.s.\), så er \(X_n,X\in\mathcal{L}^1\) og \(E(X_n)\to E(X)\).}
\end{enumerate}

\textbf{Theorem 9.2. (Protter)} \emph{Lad \(X_n : (\Omega,\mathcal{A},P)\to(F,\mathcal{F})\) være en følge af stokastiske variable.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Hvis \(X_n\ge0\), så gælder \(E\left(\sum_{n=1}^\infty X_n\right)=\sum_{n=1}^\infty E(X_n)\) (begge enten uendelige eller endelige)}
\item
  \emph{Hvis \(\sum_{n=1}^\infty E\vert X_n\vert <+\infty\), så konvergerer \(\sum_{n=1}^\infty X_n\) \(P-n.s.\) og er integrabel. Desuden holder ovenstående lighed.}
\end{enumerate}

\textbf{Theorem 9.3. (Protter)} \textbf{(Cauchy-Schwarz ulighed)} \emph{Lad \(L^p=\{X : (\Omega,\mathcal{A},P)\to(\mathbb{R},\mathcal{B})\ \vert\ E(X^p)< +\infty\}\) dvs. mængden af \(p\)-potens integrable stokastiske variable.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Hvis \(X,Y\in L^2\), så er \(XY\in L^1\) og følgende ulighed gælder}
  \[
    \vert E(XY)\vert \le \sqrt{E(X^2)E(Y^2)}.
    \]
\item
  \emph{Der gælder \(L^2\subset L^1\) og hvis \(X\in L^2\), så \(E(X)^2\le E(X^2)\).}
\item
  \emph{Rummmet \(L^2\) er et lineært vektor rum.}
\end{enumerate}

\textbf{Theorem 9.4. (Protter)} \textbf{(Chebyshev's/Markov's/Bienaymé-Chebyshev's ulighed)} \emph{For en stokastisk variabel \(X\) gælder}

\[
P(\vert X\vert \ge a)\le \frac{E(X^2)}{a^2},\frac{E\vert X\vert}{a} \hspace{20pt} P\{\vert X-E\{X\}\vert\ge a\}\le \frac{\sigma^2 E\{X^2\}}{a^2}
\]

\textbf{Theorem 9.5. (Protter)} \textbf{(Forventnings reglen)} \emph{Lad \(X\in \mathbb{R}\) være en stokastisk variabel, så \(X : (\Omega, \mathcal{A}, P)\to (E,\mathcal{E})\) og med fordeling \(P^X\). Lad \(h : (E,\mathcal{E})\to(\mathbb{R},\mathcal{B})\) være en målelig funktion.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Der gælder \(h(X)\in\mathcal{L}^1(\Omega, \mathcal{A}, P)\iff h\in\mathcal{L}^1(E, \mathcal{E}, P^X)\)}
\item
  \emph{Hvis (a) er opfyldt eller \(h\ge 0\), så er}
  \[
    E(H(X))=\int h(x)P^X(dx)=\int h(x)dP^X(x)
    \]
\end{enumerate}

\hypertarget{independent-random-variables}{%
\section{Independent Random Variables}\label{independent-random-variables}}

\textbf{Definition 10.1. (Protter)} \textbf{(Uafhængige Stokastiske Variable)}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Brolægninger \((\mathcal{A}_i)_{i\in I}\subseteq \mathcal{A}\) kaldes uafhængige hvis for alle endelige \(J\subseteq I\) og alle \(A_i\in\mathcal{A}_i\) er}
  \[
    P(\cap_{i\in J} A_i)=\prod_{i\in J}P(A_i)
    \]
  \emph{dvs. for alle brolægning er alle hændelser uafhængige.}
\item
  \emph{tokastiske Variable \((X_i)_{i\in I}\), hvor \(X_i : (\Omega, \mathcal{A})\to (E_i,\mathcal{E}_i)\), kaldes uafhængige, hvis brolægningerne i familien givet ved \(\sigma(X_i^{-1}(\mathcal{E}_i))\subseteq \mathcal{A}\) er uafhængige.}
\end{enumerate}

\textbf{Theorem 10.1. (Protter)} \textbf{(Ækvivalensudsagn)} \emph{For to stokastiske variable \(X : (\Omega, \mathcal{A})\to (E,\mathcal{E})\) og \(Y : (\Omega, \mathcal{A})\to (F,\mathcal{F})\) er følgende udsagn ækvivalente.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\setcounter{enumi}{14}
\tightlist
\item
  \emph{\(X\) og \(Y\) er uafhængige.}
\item
  \emph{\(P(X\in A, Y\in B)=P(X\in A)P(Y\in B)\) for alle \(A\in \mathcal{E}\) og \(B\in\mathcal{F}\).}
\item
  \emph{\(P(X\in A, Y\in B)=P(X\in A)P(Y\in B)\) for alle \(A\in \mathcal{C}\) og \(B\in\mathcal{D}\). Hvor \(\mathcal{C}\) og \(\mathcal{D}\) er fællesmængdestabile mængdesystemer (brolægning) der frembringer hhv. \(\mathcal{E}\) og \(\mathcal{F}\).}
\item
  \emph{\(f(X)\) og \(g(Y)\) er uafhængige for alle par \((f,g)\) målbare funktioner.}
\item
  \emph{\(E(f(X)g(Y))=E(f(X))E(g(Y))\) for alle par \((f,g)\) begrænsede og målbar eller positive og målbare funktioner.}
\item
  \emph{Hvis \(E\) og \(F\) er metriske rum med respektive Borel \(\sigma\)-algebraer \(\mathcal{E}\) og \(\mathcal{F}\). \(E(f(X)g(Y))=E(f(X))E(g(Y))\) for alle par \((f,g)\) begrænsede og kontinuere funktioner. }
\end{enumerate}

\textbf{Notation.} Ofte ønskes at betragte funktioner af flere variable, hvor domænerummet ønskes konstrueret fra to rum hvorpå \(x\) og \(y\) lever hhv. \((E,\mathcal{E},P)\) og \((F,\mathcal{F},Q)\). Vi kan da konstruere et målrum givet ved \((E\times F, \sigma(\mathcal{E}\times\mathcal{F}))\), hvor vi lader \(\mathcal{E}\otimes \mathcal{F}=\sigma(\mathcal{E}\times\mathcal{F})\). Tilsvarende kan vi konstruere produktmålet \(P\otimes Q(A)=P(A)Q(A)\) på \((E\times F, \mathcal{E}\otimes \mathcal{F},P\otimes Q)\).

\textbf{Theorem 10.2. (Protter)} \emph{Lad \(f : (E \times F, \mathcal{E} \otimes \mathcal{F}) \to (\mathbb{R}, \mathcal{R})\) være målbar. For hvert \(x \in E\) og \(y \in F\), er de respektive ``sektionerne'' \(y \to f(x,y)\) og \(x \to f(x,y)\) henholdsvis \(\mathcal{F}\)- og \(\mathcal{E}\) målbare funktioner.}

\textbf{Notation.} Det kan ønskes at betragte mål med faste \(x,y\) og hvordan disse opfører sig. Teoremet fortæller, at man kan vælge tilfældige \(x \in E\) og \(y \in F\) således, at man kan betragte henholdsvis \(\mathcal{F}\)- og \(\mathcal{E}\) målbare funktioner i én variable (enten \(x\) eller \(y\)) for sig selv.

\textbf{Theorem 10.3. (Protter)} \textbf{(Tonelli-Fubini)} \emph{Lad \((E,\mathcal{E},P)\) og \((F,\mathcal{F},Q)\) være sandsynlighedsrum.}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Lad \(P\otimes Q(A\times B)=P(A)Q(B)\). Dette er et unikt ssh mål, som udvider til sandsynlighedsrummet \((E\times F,\mathcal{E}\otimes \mathcal{F},P\otimes Q)\).}
\item
  \emph{Lad \(f : (E\times F,\mathcal{E}\otimes \mathcal{F},P\otimes Q) \to (\mathbb{R}, \mathcal{R})\) være en målbar, positiv eller integrabel mht. \(P\otimes Q\). Da er \(x\mapsto \int f(x,y)Q(dy)\) en \(\mathcal{E}\)-målelig funktion og \(y\mapsto \int f(x,y)P(dy)\) en \(\mathcal{F}\)-målelig funktion. Specielt er}
  \[
    \int f d P\otimes Q=\int\left\{\int f(x,y) Q(dy)\right\}P(dx)=\int\left\{\int f(x,y) P(dx)\right\}Q(dy)
    \]
\end{enumerate}

\hypertarget{probability-distributions-on-mathbb-r}{%
\section{\texorpdfstring{Probability Distributions on \(\mathbb R\)}{Probability Distributions on \textbackslash mathbb R}}\label{probability-distributions-on-mathbb-r}}

Dette kapitel undersøger egenskaberne ved sandsynlighedsmål \(P\) på \((\mathbb{R},\mathcal{B})\), hvor fordelingsfunktionen er karakteriseret ved \(F(x)=P((-\infty,x])\).

\textbf{Definition 11.1. (Protter)} \emph{Lebesguemålet er mængdefunktion \(m: \mathcal{B} \to[0,\infty0]\), der opfylder:}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \emph{For \(A_1,A_2,A_3,...\in\mathcal{B}\) parvist disjunkte mængder gælder \(m(\cup_{i=1}^\infty A_i)=\sum_{i=1}^\infty m(A_i)\),}
\item
  \emph{hvis \(a<b\) og \(a,b\in\mathbb{R}\), så \(m((a,b])=b-a\).}
\end{enumerate}

\textbf{Theorem 11.1. (Protter)} \emph{Lebesguemålet er unikt.}

\textbf{Theorem 11.2. (Protter)} \emph{Lebesguemålet eksisterer.}

\textbf{Definition 11.2. (Protter)} \emph{Tætheden af et sandsynlighedsmål \(P\) på \((\mathbb{R},\mathcal{B})\) er en positiv Borel målelig funktion \(f\) der opfylder for alle \(x\in\mathbb{R}\):}

\[
F(x)=P((-\infty,x])=\int_{-\infty}^x f(y)dy=\int f(y)1_{(-\infty,x]}(y)dm(y)
\]

\emph{I tilfældet \(P=P^X\) (husk thm 8.5. \(P^X(A)=P(X\in A)\)), dvs \(P\) er fordelingsmålet af en s.v.~\(X\), så siger vi at \(f\) er tætheden af \(X\).}

\textbf{Theorem 11.3. (Protter)} \emph{Lad \(f\in \mathcal{M}_{\mathbb{R}}^+\). Da gælder (\(f\) karakteriseret fuldkomment tætheden for et sandsynlighedsmål \(P\) på \((\mathbb{R},\mathcal{B})\)) \(\Longleftrightarrow\) (\(\int f dm(x)=1\)). Desuden gælder hvis \(f'\) opfylder \(m(f\ne f')=0\) (\(f=f'\) \(m\)-\(n.o.\)), så er \(f'\) og en tæthed for samme sandsynlighedsmål. Omvendt bestemmer et sandsynlighedsmål også den tæthed, når denne eksisterer.}

\textbf{Remark 11.1.} \(F\) er differentiabel \(m\)-\(n.o.\) uafhængig af \(f\) og med \(f=0\) ellers.

\textbf{Corollary 11.1. (Protter)} \textbf{(Forventningsreglen)} \emph{Lad \(X\) være en \(\mathbb{R}\)-værdi stokastisk variabel med tæthed \(f\). Lad \(g\in\mathcal{M}_{\mathbb{R}}\). Så er \(g\) integrabel mht. \(P^X\), hvis og kun hvis \(fg\) er integrabel mht. \(m\). Hvis da er}

\[
E[g(X)]=\int g(x)P^X(dx)=\int g(x)f(x) dm(x)
\]

\textbf{Theorem 11.4. (Protter)} \emph{Lad \(X\) have tæthed \(f_X\) og lad \(g\in\mathcal{M}_{\mathbb{R}}\). Lad \(Y=g(X)\). Så er}

\[
F_Y(y)=P(Y\le y)=P(G(X)\le y)=\int_{A_y} f_X(u)dm(u),
\]

\emph{hvor \(A_y=\{u : g(u)\le y\}\).}

\textbf{Corollary 11.2. (Protter)} \emph{Lad \(X\) have en kontinuer tæthed \(f_X\). Lad \(g: \mathbb{R}\to \mathbb{R}\) være \(C^1\) og strengt monotom. Lad \(h(y)=g^{-1}(y)\) være \(g\) inverse også \(C^1\). Så har \(Y=g(X)\) tæthed}

\[
f_Y(y)=f_X(h(y))|h'(y)|.
\]

\textbf{Corollary 11.3. (Protter)} \emph{Lad \(X\) have en kontinuer tæthed \(f_X\). Lad \(g: \mathbb{R}\to \mathbb{R}\) være stykkevis \(C^1\) og strengt monotom på intervallerne \(I_1,I_2,...,I_n\) med \(\cup_{i\in I}I_i=\mathbb{R}\) (\(g\) skal kun være \(C^1\) og strengt monotom på det indre af \(I_i\)). Lad \(h_i(y)=g^{-1}(y)\) for \(g: I_i\to \mathbb{R}\). Så har \(Y=g(X)\) tæthed}

\[
f_Y(y)=\sum_{i=1}^n f_X(h_i(y))|h_i'(y)| 1_{g(I_i)}(y).
\]

\hypertarget{probability-distributions-on-mathbb-rn}{%
\section{\texorpdfstring{Probability Distributions on \(\mathbb R^n\)}{Probability Distributions on \textbackslash mathbb R\^{}n}}\label{probability-distributions-on-mathbb-rn}}

Dette kapitel undersøger fordelinger for stokatiske variable på \((\mathbb{R}^n,\mathcal{B}^n)\) for \(n=2,3,...\). Særligt vil vi have interesse for særtilfældet \(n=2\). Mange sætninger i dette kapitler har en analog i kapitel 11.

\textbf{Definition 12.1. (Protter)} \emph{Lebesgue målet på \((\mathbb{R}^n,\mathcal{B}^n)\) er defineret for det kartesiske produkt \(A_1\times A_2\times ...\times A_n\) ved \(m_n(\prod_{i=1}^n A_i)=\prod_{i=1}^n m(A_i)\). Dermed også \(m_n(\prod_{i=1}^n (a_i,b_i])=\prod_{i=1}^n m((a_i,b_i])\).}

\textbf{Definition 12.2. (Protter)} \emph{Et sandsynlighedsmål \(P\) på \((\mathbb{R}^n,\mathcal{B}^n)\) har tæthed \(f\) hvis \(f\) er en ikke negativ Borelmålelig funktion på \(\mathbb{R}^n\), der opfylder}

\[
P(A)=\int_A f(x)dm_n(x)=\int f(x_1,x_2,...,x_n)1_A(x_1,x_2,...,x_n)dm_n(x_1,x_2,...,x_n),\hspace{10pt} \forall A\in\mathcal{B}^n.
\]

\textbf{Theorem 12.1. (Protter)} \emph{En \(f\in\mathcal{M}_{R^n}^+\) er en tæthed for et sandsynlighedsmål \(P\) på \((\mathbb{R}^n,\mathcal{B}^n)\) hvis og kun hvis \(\int f(x)dm_n(x)=1\). I det tilfælde karakterer \(f\) fuldkomment målet \(P\) og for alle \(f'\in\mathcal{M}_{R^n}^+\) med \(m_n(f\ne f')=0\) er denne også tæthed for målet \(P\). Omvendt bestemmer målet \(P\) også en tæthed \(f\) op til enhver ikke Lebesgue nulmængde.}

\textbf{Theorem 12.2. (Protter)} \emph{Antag \(X=(Y,Z)\) har tæthed \(f=f_X=f_{Y,Z}\) på \(\mathbb{R}^2\). Så gælder}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  \emph{Begge \(Y\) og \(Z\) har tætheder på \((\mathbb{R},\mathcal{B})\) givet ved}
  \[
    f_Y(y)=\int_{\mathbb{R}}f(y,z)dm(z),\hspace{15pt}f_Z(z)=\int_{\mathbb{R}}f(y,z)dm(y)
    \]
\item
  \emph{\(Y\) og \(Z\) er uafhængige hvis og kun hvis \(f(y,z)=f_Y(y)f_Z(z)\) \(m_2\)-n.s. dvs. \(m_2(f(y,z)\ne f_Y(y)f_Z(z)=0\).}
\item
  \emph{Følgende bestemmer en fjerde tæthed på \(\mathbb{R}\) for alle \(y\in\mathbb{R}\) sådan at \(f_Y(y)\ne 0\): \(f_{Y=y}(z)=\frac{f(y,z)}{f_Y(y)}\).}
\end{enumerate}

\textbf{Definition 12.3. (Protter)} \emph{Lad \(X,Y\) være to reelle stokastiske variable begge med endelig varians. Covariansen af \(X,Y\) er defineret ved \(\text{Cov}(X,Y)=E[(X-E(X))(Y-E(Y))]=E[XY]-E[X]E[Y]\). Varians er dermed også givet ved \(\text{Cov}(X,X)=Var(X)=\sigma ^2(X)\).}

\textbf{Theorem 12.3. (Protter)} \emph{Hvis \(X\) og \(Y\) er uafhængige så er \(\text{Cov}(X,Y)=0\).}

\textbf{Definition 12.4. (Protter)} \emph{Lad \(X\) og \(Y\) være stokastiske variable begge med endelig varians. Korrelationskoefficienten af \(X\) og \(Y\) er tallet \(\rho_{X,Y}=\text{Cov}(X,Y)/(\sigma(X)\sigma(Y))\).}

\textbf{Definition 12.5. (Protter)} \emph{Lad \(X=(X_1,...,X_n)\) være en \(\mathbb{R}^n\) stokastisk variabel. Covariansmatricen for \(X\) er en \(n\times n\) matrice med indgange \(c_{ij}=\text{Cov}(X_i,X_j)\).}

\textbf{Theorem 12.4. (Protter)} \emph{En covarians matrice er positiv semidefinit dvs. den er symmetrisk (\(c_{ij}=c_{ji}\)) og \(\sum a_ia_jc_{ij}>0\) for alle \(\mathbf{a}\in\mathbb{R}^n\).}

\textbf{Theorem 12.5. (Protter)} \emph{Lad \(X\) være en \(\mathbb{R}^n\) stokastisk variabel med covarians matrice \(C\). Lad \(A\) være en \(m\times n\) matrice og set \(Y=AX\). Så er \(Y\) en \(\mathbb{R}^m\) stokastisk variabel med covarians matrice \(C'=ACA^*\), hvor \(A^*\) er den transponerede matrice til \(A\).}

\textbf{Theorem 12.6. (Protter)} \textbf{(Jacobi's transformations formel)} \emph{Lad \(G\subseteq \mathbb{R}^n\) være åben og lad \(g : G \to \mathbb{R}^n\) være kontinuer og differentiabel. Antag \(g\) er injektiv på \(G\) og \(J_g(x)\ne0\) for alle \(x\in G\). For en funktion \(f\in\mathcal{M}\) med \(f1_{g(G)}\) positiv eller integrabel mht. Lebesguemålet gælder: \(\int_{g(G)}f(y)dm_n(y)=\int_G f(g(x))\vert \det(J_g(x))\vert dm_n(x)\), hvor \(g(G)\) er mængden \(\{y\in\mathbb{R}^n : \exists x\in G, g(x)=y\}\).}

\textbf{Theorem 12.7. (Protter)} \emph{Lad \(X=(X_1,...,X_n)\) have simultan tæthed \(f\) og lad \(g : \mathbb{R}^n\to\mathbb{R}^n\) være en kontinuer, diffenrentiabel, injektiv funktion med \(J_g(x)\ne 0\). Så har \(Y=g(X)\) tæthed}

\[
f_Y(y)=f_X(g^{-1}(y))\vert \det J_{g^{-1}}(y)\vert 1_{g(\mathbb{R}^n)}(y)
\]

\textbf{Corollary 12.1. (Protter)} \emph{Lad \(S\in\mathcal{B}^n\) være inddelt af et endeligt indeks \(I=\{0,1,...,m\}\), så \(\cup_{i=0}^m S_i=S\), \(S_i\) parvist disjunkte, og med \(m_n(S_0)=0\) og funktionen \(g : S_i \to\mathbb{R}^n\) være kontinuer, differentiabel, injektiv og \(J_{g_i^{-1}}(x)\ne 0\) for alle \(i\in I\). Lad \(X\) være giver som i teorem 12.7. Da har den stokastiske variabel \(Y=g(X)\) tæthed}

\[
f_Y(y)=\sum_{i=1}^m f_X(g_i^{-1}(y))\vert\det J_{g_i^{-1}}(y)\vert1_{g_i(S_i)}(y).
\]

\hypertarget{equivalent-probability-measures}{%
\section{Equivalent Probability Measures}\label{equivalent-probability-measures}}

\hypertarget{the-radon-nikodym-theorem}{%
\subsection{The Radon-Nikodym Theorem}\label{the-radon-nikodym-theorem}}

\textbf{Definition A.50. (Bjork)} \emph{Consider a measurable space \((X,\mathcal{F})\) on which there are defined two seperate measures \(\mu\) and \(\nu\):}

\begin{itemize}
\item
  \emph{If, for all \(A\in \mathcal{F}\), it holds that}
  \[
    \mu(A)=0\ \Rightarrow\ \nu(A)=0,\tag{A.7}
    \]
  t\_hen \(\nu\) is said to be \textbf{absolutely continuous}\index{absolutely continuous} with respect to \(\mu\) on \(\mathcal{F}\) and we write this as \(\nu < < \mu\).\_
\item
  \emph{If we have both \(\mu << \nu\) and \(\nu << \mu\), then \(\mu\) and \(\nu\) said to be \textbf{equivalent}\index{equivalent measures} and we write \(\mu\sim \nu\).}
\item
  \emph{If there exists two events, \(A\) and \(B\) such that:}

  \begin{itemize}
  \tightlist
  \item
    \(A\cup B=X\),
  \item
    \(A\cap B=\emptyset\),
  \item
    \(\mu(B)=0\), and \(\nu(A)=0\),
  \end{itemize}

  \emph{then \(\nu\) and \(\mu\) are said to be mutually \textbf{singular}\index{singular}, and we write \(\mu\ \bot\ \nu\).}
\end{itemize}

\textbf{Theorem A.52. (Bjork)} \textbf{(The Radon-Nikodym Theorem)}\index{Radon-Nikodym Theorem} \emph{Consider the measure space \((X,\mathcal{F},\mu)\), where we assume that \(\mu\) is finite, i.e.~that \(\mu(X)<\infty\). Let \(\nu\) be a measure on \((X,\mathcal{F})\) such that \(\nu <<\mu\) on \(\mathcal{F}\). Then there exists a non-negative function \(f : X\to \mathbb{R}\) such that:}
\begin{align*}
&f\ \text{is}\ \mathcal{F}\text{-measurable}\tag{A.9}\\
&\int_X f(x)\ d\mu(x)<\infty,\tag{A.10}\\
&\nu(A)=\int_Af(x)\ d\mu(x),\ \text{for all}\ A\in \mathcal{F}.\tag{A.11}
\end{align*}
\emph{The function \(f\) is called the \textbf{Radon-Nikodym derivative}\index{Radon-Nikodym derivative} of \(\nu\) w.r.t. \(\mu\). It is uniquely determined \(\mu\)-a.e. and we write}

\[
f(x)=\frac{d\nu(x)}{d\mu(x)},\tag{A.12}
\]

\emph{or alternatively}

\[
d\nu(x)=f(x)\ d\mu(x).\tag{A.13}
\]

\hypertarget{equivalent-probability-measures-1}{%
\subsection{Equivalent Probability Measures}\label{equivalent-probability-measures-1}}

\textbf{Lemma B.38. (Bjork)} \emph{For two probability measures \(P\) and \(Q\), the relation \(P\sim Q\) on \(\mathcal{F}\) holds if and only if \(P(A)=1\) if and only if \(Q(A)=1\) for all \(A\in\mathcal{F}\).}

\textbf{Proposition B.39. (Bjork)} \emph{Assume that \(Q << P\) on \(\mathcal{F}\) and that \(\mathcal{G}\subseteq \mathcal{F}\). Then the Radon-Nikodym derivatives \(L^{\mathcal{F}}\) and \(L^{\mathcal{G}}\) are related by}

\[
L^{\mathcal{G}}=E^P[L^{\mathcal{F}}\ \vert\ \mathcal{G}].\tag{B.17}
\]

\textbf{Proposition B.41. (Bjork)} \textbf{(Bayes' Theorem)}\index{Bayes' Theorem} \emph{Assume that \(X\) is a random variable on \((\Omega, \mathcal{F},P)\), and let \(Q\) be another probability measure on \((\Omega,\mathcal{F})\) the Radon-Nikodym derivative}

\[
L=\frac{d Q}{dP}
\]

\emph{on \(\mathcal{F}\). Assume that \(X\in L^1(\Omega,\mathcal{F},Q)\) and \(\mathcal{G}\) is a sigma-algebra with \(\mathcal{G}\subseteq \mathcal{F}\).\index{equivalent probability measures} Then}

\[
E^Q[X\ \vert\ \mathcal{G}]=\frac{E^P[L\cdot X\ \vert\ \mathcal{G}]}{E^P[L\ \vert\ \mathcal{G}]},\ Q-a.s.\tag{B.18}
\]

\hypertarget{likelihood-processes}{%
\subsection{Likelihood processes}\label{likelihood-processes}}

\textbf{Proposition C.12. (Bjork)} \emph{Consider a filtered probability space \((\Omega, \mathcal{F},P,\mathcal{F}_t)\) on a compact interval \([0,T]\). Suppose \(L_T\) is some non-negative integrable random variable in \(\mathcal{F}_T\). We can then define a new measure \(Q\) on \(\mathcal{F}_T\) by setting}

\[
dQ=L_T\ dP
\]

\emph{on \(\mathcal{F}_T\) and if \(E^P[L_T]=1\) the measure \(Q\) will also be a probability measure. The likelihood process\index{likelihood process} \(L\), defined by}

\[
L_t=\frac{dQ}{dP},\ on\ \mathcal{F}_t,\tag{C.8}
\]

\emph{is a \((P,\mathcal{F}_t)\)-martingale.}

\textbf{Proposition C.13. (Bjork)} \emph{A process \(M\) is a \(Q\)-martingale if and only if the process \(L\cdot M\) is a \(P\)-martingale.}

\hypertarget{random-variables-1}{%
\chapter{Random Variables}\label{random-variables-1}}

\hypertarget{introduction-1}{%
\section{Introduction}\label{introduction-1}}

\textbf{Definition 1.1. (Hansen)} \emph{A \textbf{real-valued random variable}\index{random variable} \(X\) on a probability space \((\Omega, \mathbb{F},P)\) is a measurable map \(X : (\Omega,\mathbb{F})\to (\mathbb{R},\mathbb{B})\).}

We never specify the background space \((\Omega, \mathbb{F},P)\) however we always assume \(X\) is \(\mathbb{F}-\mathbb{B}\) measurable. This assumption implies \((X\in A)\in \mathbb{F}\) for every \(A\in \mathbb{B}\). We may want to show measurability for constructed variables and so it surfises to show measurability for generaters for \(\mathbb{B}\) such as checking \((X\le a)\in\mathbb{F}\) for every \(a\in\mathbb{R}\).

\textbf{Definition 1.2. (Hansen)} \emph{The \textbf{distribution}\index{distribution} of a real-valued random variable \(X\), defined on a probability space \((\Omega,\mathbb{F},P)\), is the collection of probability values}
\begin{align*}
    P(X\in A)\hspace{15pt}\text{for}\ A\in \mathbb{B}.\tag{1.3}
\end{align*}
\emph{In other words: the distribution of \(X\) is the image measure \(X(P)\) on \((\mathbb{R},\mathbb{B})\).}

\textbf{Lemma 1.3. (Hansen)} \emph{Let \(X\) and \(X'\) be two real-valued random variables on a probability space \((\Omega,\mathbb{F},P)\). If}
\begin{align*}
    P(X=X')=1
\end{align*}
\emph{then \(X\) and \(X'\) has the same distribution.}

An often used way of summarizing the distribution is through the \textbf{distribution function}\index{distribution function} \(F(x)=P(X\le x)\) for some \(x\in\mathbb{R}\).

\textbf{Definition 1.4. (Hansen)} \emph{A real-valued random variable \(X\) has a \textbf{discrete} distribution\index{discrete distribution} if there is a countable set \(S\subset\mathbb{R}\) such that \(P(X\in S)=1\).}

Usually \(S\) is one of \(\mathbb{N},\mathbb{Z},\mathbb{Q}\) or a subset of these. We may in the discrete case define the distribution by the point probabilities \(P(X=x)=p(x)\) for \(x\in S\).

\textbf{Definition 1.5. (Hansen)} \emph{A real-valued random variable \(X\) has a distribution with \textbf{density}\index{density} \(f : \mathbb{R}\to [0,\infty)\) if}
\begin{align*}
    P(X\in A)=\int_Af(x)dx\hspace{15pt}\text{for}\ A\in \mathbb{B}.\tag{1.5}
\end{align*}
\emph{If this is the case we will write \(X(P)=f\cdot m\) or \(X\sim f\cdot m\).}

\textbf{Definition 1.6. (Hansen)} \emph{A real-valued random variable \(X\) defined on a probability space \((\Omega, \mathbb{F},P)\) is said to have \(p\)'th moment for som \(p>0\) if}
\begin{align*}
    E\vert X\vert^p<\infty\tag{1.12}
\end{align*}
\emph{The collection of all variables that satisfies (1.12) is denoted by \(\mathcal{L}^p(\Omega,\mathbb{F},P)\).}

Recall the definition of the \textbf{expectation}\index{expectation} of \(X\) by
\begin{align*}
    E\, X=\int XdP \in R\cup \{-\infty,+\infty\}.\tag{1.11}
\end{align*}
We recall that for any measurable function \(f : \mathbb{R}\to \mathbb{R}\) that are continuous on a set \(A\in\mathbb{B}\) such that \(P(X\in A)=1\) we may change variable simply by computing
\begin{align*}
    E\, f(X)=\int f\circ XdP=\int f(x)dX(P)(x).
\end{align*}

\textbf{Lemma 1.7. (Hansen)} \emph{(Markov's inequality)\index{Markov's inequality} Let \(X\) be a non-negative random variable. For any \(c>0\) it holds that}
\begin{align*}
    P(X\ge c)\le \frac{E\, X}{c}\left(\le \frac{E\ X^n}{c^n}\text{ or }\le \frac{E\left(\varphi(X)\right)}{\varphi(c)}\right).\tag{1.14}
\end{align*}
\emph{for some \(\varphi\) non-negative monotome increasing function.}

Some other versions of Markov's inequality can be found in the form of \textbf{Chebyshev's inequality}, \textbf{Chebyshev-Cantelli's inequality} or \textbf{Jensen's inequality}\index{Chebyshev's inequality}\index{Chebyshev-Cantelli's inequality}\index{Jensen's inequality} repectively: Let \(X\) be a real-valued random variable in \(\mathcal{L}^2(\Omega,\mathbb{F},P)\) it holds for any \(\varepsilon>0\).
\begin{align*}
    P\left(\vert X-E\, X\vert \ge \varepsilon\right)&\le \frac{V\, X}{\varepsilon^2}\tag{1.15}\\
    P\left( X-E\, X \ge \varepsilon\right)&\le \frac{V\, X}{V\, X+\varepsilon^2}\tag{prob: 1.13(c)}\\
    \varphi\left(E\ X\right)&\le E\left( \varphi(X)\right)
\end{align*}
for some convex function \(\varphi\).

\textbf{Lemma 1.8. (Hansen)} \emph{Let \(X\) be a non-negative random variable. It holds that}
\begin{align*}
    E\, X=\int_0^\infty P(X>t)dt.\tag{1.16}
\end{align*}
\emph{where the integral on the right hand side is with respect to Lebesgue measure.}

\textbf{Definition 1.9. (Hansen)} \emph{The \textbf{joint distribution}\index{joint distribution} of real-valued random variables \(X_1,...,X_k\), defined on a probability space \((\Omega, \mathbb{F},P)\), is the collection of probability values}
\begin{align*}
    P(\mathbf{X}\in A)\hspace{15pt}\text{for}\ A\in\mathbb{B}_k.\tag{1.21}
\end{align*}
\emph{In other words: the joint distribution of \(X_1,...,X_k\) (or simply: the distribution of \(\mathbf{X}\)) is the image measure \(\mathbf{X}(P)\) on \(\left(\mathbb{R}^k,\mathbb{B}_k\right)\).}

\textbf{Definition 1.11. (Hansen)} \emph{Real-valued random variables \(X_1,...,X_k\), defined on a probability space \((\Omega, \mathbb{F},P)\), are \textbf{jointly independent}\index{independent, jointly} if}
\begin{align*}
    P\left(X_1\in A_1,...,X_k\in A_k\right)=\prod_{i=1}^kP(X_i\in A_i)\hspace{15pt}\text{for}\ A_1,...,A_k\in\mathbb{B}.\tag{1.23}
\end{align*}
\emph{In other words: the variables are independent if the joint distribution \(\mathbf{X}(P)\) equals the product measure \(X_1(P)\otimes ... \otimes X_k(P)\).}

\textbf{Theorem 1.12. (Hansen)} \emph{Let \(X_1,...,X_k\) be real-valued random variables defined on a probability space \((\Omega, \mathbb{F},P)\). If the variables are independent and if \(E\vert X_i\vert<\infty\) for \(i=1,...,k\), then the product \(X_1\cdot ...\cdot X_k\) has first moment and}
\begin{align*}
    E\left(X_1\cdot ... \cdot X_k\right)=\prod_{i=1}^kE\, X_i\tag{1.24}
\end{align*}

The equality only holds for two independent variables. However the \textbf{Cauchy-Schwarz inequality}\index{Cauchy-Schwarz inequality} which closely resembles (1.24) holds wether or not \(X\) or \(Y\) are independent:
\begin{align*}
    \left(E\vert XY\vert\right)^2\le E\, X^2\, E\, Y^2\text{ or }E\vert XY\vert \le \sqrt{E\ X^2}\sqrt{E\ Y^2}.\tag{1.25}
\end{align*}
Furthermore the theorem give rise to a measure for dependence i.e.~the \textbf{covariance}\index{covariance} between two variables \(X\) and \(Y\)
\begin{align*}
    \text{Cov}(X,Y)=E\left((X-E\,X)(Y-E\,Y)\right)=E(XY)-(E\, X)(E\, Y)\tag{1.26}
\end{align*}
with Cov\((X,Y)\ne 0\) if and only if \(X\) and \(Y\) are dependent. With Cov\((X,Y)=0\) the test is inconlusive. However independence implies Cov\((X,Y)=0\).

\newpage

\hypertarget{conditional-expectation}{%
\section{Conditional expectation}\label{conditional-expectation}}

The theory of conditional expectation is well-known from courses on the bachelor. Because of this we will only summarise the most important results.

We consider a background space \((\Omega,\mathcal{F},P)\) and a sub-sigma algebra \(\mathcal{G}\subseteq \mathcal{F}\). We assume that some stochastic variable is \(\mathcal{F}\)-measurable, that is the mapping \(X : (\Omega,\mathcal{F},P) \to (\mathbb{R},\mathbb{B},m)\) is \(\mathcal{F}-\mathbb{B}\)-measurable i.e.~\(\forall B\in\mathbb{B} : \{X\in B\}\in\mathcal{F}\). For some random variable \(Z\) defined on the subspace \((\Omega,\mathcal{G},P)\), we say that \(Z\) is the conditional expectation of \(X\) given \(\mathcal{G}\) if

\[
\forall G\in\mathcal{G} : \int_G Z(\omega)\ dP(\omega)=\int_G X(\omega)\ dP(\omega).
\]

This fact is summed up in the definition below.

\textbf{Definition B.27. (Bjork)} \textbf{(Conditional expectation)} \emph{Let \((\Omega,\mathcal{F},P)\) be a probability space and \(X\) a random variable in \(L^1(\Omega,\mathcal{F},P)\) (\(\vert X\vert\) is integrable). Let furthermore \(\mathcal{G}\) be a sigma-algebra such that \(\mathcal{G}\subseteq \mathcal{F}\). If \(Z\) is a random variable with the properties that:}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \emph{\(Z\) is \(\mathcal{G}\)-measurable.}
\item
  \emph{For every \(G\in\mathcal{G}\) it holds that}
  \[\int_G Z(\omega)\ dP(\omega)=\int_G X(\omega)\ dP(\omega).\tag{B.5}\]
\end{enumerate}

\emph{Then we say that \(Z\) is the \textbf{conditional expectation of \(X\) given the sigma-algebra \(\mathcal{G}\)}. In that case we denote \(Z\) by the symbol \(E[X\ \vert\ \mathcal{G}]\).}

We see that from the above it always holds that \(X\) satisfies (ii). It does not, however, always hold that \(X\) is \(\mathcal{G}\)-measurable. Given this fact it is not trivial that a random variable \(E[X\ \vert\ \mathcal{G}]\) even exists. This nontriviality is fortunatly resolved by the Radon-Nikodym theorem.

\textbf{Theorem B.28. (Bjork)} \textbf{(Existance and uniqueness of Conditional expectation)} \emph{Let \((\Omega,\mathcal{F},P)\), \(X\) and \(\mathcal{G}\) be given as in the definition above. Then the following holds:}

\begin{itemize}
\tightlist
\item
  \emph{There will always exist a random variable \(Z\) satisfying conditions (i)-(ii) above.}
\item
  \emph{The variable \(Z\) is unique, i.e.~if both \(Y\) and \(Z\) satisfy (i)-(ii) then \(Y=Z\) \(P\)-a.s.}
\end{itemize}

This result ensures that we may condition on any sigma-algebra for instance \(\mathcal{G}=\sigma(Y)\) in that case we (pure notation) write

\[
E[X\ \vert\ \sigma(Y)]=E[X\ \vert\ Y],\hspace{20pt}\sigma(Y)=\sigma\left(\left\{ Y\in A,\ A\in\mathbb{B}\right\}\right).
\]

In the above \(\sigma(Y)\) is simply the smallest sigma-algebra containing all the pre-images of \(Y\), that is the smallest sigma-algebra making \(Y\) measurable! Giving this foundation there are a few properties conditional expectation have which is rather useful (for instance the tower property).

Below we assume: Let \((\Omega,\mathcal{F},P)\) be a probability space and \(X,Y\) be random variables in \(L^1(\Omega,\mathcal{F},P)\).

\textbf{Proposition B.29.} \textbf{(Monotinicity/Linearity of Conditional expectation)} \emph{The following holds:}

\[X\le Y\ \Rightarrow\ E[X\ \vert\ \mathcal{G}]\le E[Y\ \vert\ \mathcal{G}],\hspace{20pt}P-\text{a.s.}\tag{B.6}\]
\[E[\alpha X + \beta Y\ \vert\ \mathcal{G}]=\alpha E[X\ \vert\ \mathcal{G}]+ \beta E[Y\ \vert\ \mathcal{G}],\hspace{20pt}\forall \alpha,\beta\in\mathbb{R}.\tag{B.7}\]

\textbf{Proposition B.30. (Bjork)} \textbf{(Tower property)} \emph{Assume that it holds that \(\mathcal{H}\subseteq\mathcal{G}\subseteq\mathcal{F}\). Then the following hold:}

\[E[E[X\vert \mathcal{G}]\vert\mathcal{H}]=E[X\vert \mathcal{H}],\tag{B.8}\]
\[E[X]=E[E[X\vert \mathcal{G}]].\tag{B.9}\]

\textbf{Proposition B.31. (Bjork)} \emph{Assume \(X\) is \(\mathcal{G}\) and that both \(X,Y\) and \(XY\) are in \(L^1\) (only assuming \(Y\) is \(\mathcal{F}\)-measurable), then}

\[E[X\vert\mathcal{G}]=X,\hspace{20pt}P-\text{a.s.}\tag{B.11}\]
\[E[XY\vert\mathcal{G}]=XE[Y\vert\mathcal{G}],\hspace{20pt}P-\text{a.s.}\tag{B.12}\]

\textbf{Proposition B.32. (Bjork)} \textbf{(Jensen inequality)} \emph{Let \(f:\mathbb{R}\to\mathbb{R}\) be a convex (measurable) function and assume \(f(X)\) is in \(L^1\). Then}

\[f(E[X\vert\mathcal{G}])\le E[f(X)\vert\mathcal{G}],\hspace{20pt}P-\text{a.s.}\]

\textbf{Proposition B.37. (Bjork)} \emph{Let \((\Omega,\mathcal{F},P)\) be a given probability space, let \(\mathcal{G}\) be a sub-sigma-algebra of \(\mathcal{F}\), and let \(X\) be a square integrable random variable.
Consider the problem of minimizing}

\[E\left[(X-Z)^2\right]\]

\emph{where \(Z\) is allowed to vary over the class of all square integrable \(\mathcal{G}\) measurable random variables. The optimal solution \(\hat{Z}\) is then given by.}

\[\hat{Z}=E[X\vert\mathcal{G}].\]

\noindent\makebox[\linewidth]{\rule{\textwidth}{0.4pt}}

\textbf{Proof.}

Let \(X\in L^2(\Omega,\mathcal{F},P)\) be a random variable. Now consider an arbitrary \(Z\in L^2(\Omega,\mathcal{G},P)\). Recall that \(\mathcal{G}\subset \mathcal{F}\) and so \(X\) is also in \(Z\in L^2(\Omega,\mathcal{G},P)\), as it is bothe square integrable and \(\mathcal{G}\)-measurable. Then

\[E\left[Z\cdot(X-E[X\vert\mathcal{G}])\right]=E\left[Z\cdot X\right]-E\left[Z\cdot E[X\vert\mathcal{G}]\right].\]

Then by using the law of total expectation and secondly that \(Z\) is \(\mathcal{G}\)-measurable we have that

\[E\left[Z\cdot X\right]=E\left[E[Z\cdot X\vert\mathcal{G}]\right]=E\left[Z\cdot E[ X\vert\mathcal{G}]\right].\]

Combining the two equations gives the desired result. Obviously, we have that

\[X-Z=X-Z+E[X\vert\mathcal{G}]-E[X\vert\mathcal{G}]=(X-E[X\vert\mathcal{G}])+(E[X\vert\mathcal{G}]-Z).\]

Then squaring the terms gives

\[(X-Z)^2=(X-E[X\vert\mathcal{G}])^2+(E[X\vert\mathcal{G}]-Z)^2+2(X-E[X\vert\mathcal{G}])(E[X\vert\mathcal{G}]-Z)\]

Taking expectation on each side and using linearity of the expectation we have that

\[E[(X-Z)^2]=E\left[(X-E[X\vert\mathcal{G}])^2\right]+E\left[(E[X\vert\mathcal{G}]-Z)^2\right]+2E\left[(X-E[X\vert\mathcal{G}])(E[X\vert\mathcal{G}]-Z)\right].\]

We can now use that \(E[X\vert\mathcal{G}]-Z\) is \(\mathcal{G}\)-measurable with the above result on the last term.

\[E[(X-Z)^2]=E\left[(X-E[X\vert\mathcal{G}])^2\right]+E\left[(E[X\vert\mathcal{G}]-Z)^2\right].\]

Now since \(X\) is given the term \(E\left[(X-E[X\vert\mathcal{G}])^2\right]\) is simply a constant not depending on the choice og \(Z\). The optimal choice of \(Z\) is then \(E[X\vert\mathcal{G}]\) since this minimizes the second term. The statement is then proved.

\newpage

\hypertarget{independence}{%
\section{Independence}\label{independence}}

\textbf{Definition 3.1. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space. Two events \(A,B\in\mathbb{F}\) are \textbf{independent}\index{independent} if}
\begin{align*}
    P(A\cap B)=P(A)P(B)\tag{3.1}
\end{align*}

\textbf{Definition 3.4. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space and let \(\mathbb{G},\mathbb{H}\subset \mathbb{F}\) be two classes of measurable sets. We sat that \(\mathbb{G}\) and \(\mathbb{H}\) are independent, written \(\mathbb{G}\perp \!\!\! \perp\mathbb{H}\), if}
\begin{align*}
    P(A\cap B)=P(A)P(B)\hspace{15pt}\text{for all}\ A\in\mathbb{G},B\in\mathbb{H}.\tag{3.2}
\end{align*}

\textbf{Lemma 3.5. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space and let \(\mathbb{G},\mathbb{H}\subset \mathbb{F}\) be two classes of measurable sets. Let \(\mathbb{G}_1\subset \mathbb{G}\) and \(\mathbb{H}_1\subset\mathbb{H}\) be two subclasses. If \(\mathbb{G}\perp \!\!\! \perp \mathbb{H}\) then it holds that \(\mathbb{G}_1\perp \!\!\! \perp \mathbb{H}_1\).}

\textbf{Definition 3.6. (Hansen)} \emph{A class \(\mathbb{H}\) of subsets of \(\Omega\) is a \textbf{Dynkin class}\index{Dynkin class} if}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(\Omega \in\mathbb{H}\),
\item
  \(A,B\in\mathbb{H},A\subset B\hspace{15pt}\Rightarrow\hspace{15pt}B\setminus A\in\mathbb{H}\),
\item
  \(A_1,A_2,...\in\mathbb{H},A_1\subset A_2\subset ...\hspace{15pt}\Rightarrow\hspace{15pt}\bigcup_{n=1}^\infty A_n\in\mathbb{H}\).
\end{enumerate}

\textbf{Lemma 3.7. (Hansen)} \emph{(Dynkin) Let \(\mathbb{D}\subset \mathbb{H}_0\subset \mathbb{H}\) be three nested classes of subsets of \(\Omega\). if}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(\sigma(\mathbb{D})=\mathbb{H}\),
\item
  \(A,B\in\mathbb{D}\hspace{10pt}\Rightarrow\hspace{10pt}A\cap B\in\mathbb{D}\)
\item
  \(\mathbb{H}_0\) \emph{is a Dynkin class.}
\end{enumerate}

\emph{then it holds that \(\mathbb{H}_0=\mathbb{H}\).}

\textbf{Lemma 3.8. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(A\in\mathbb{F}\) be a fixed event. The class}
\begin{align*}
    \mathbb{H}=\{B\in \mathbb{F}\ \vert\ A\perp \!\!\! \perp B\}
\end{align*}
\emph{is a Dynkin class.}

\textbf{Theorem 3.9. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,\mathbb{G}_2\subset \mathbb{F}\) be two sigma-algebras. Let \(\mathbb{D}_1\) and \(\mathbb{D}_2\) be two classes such that \(\sigma(\mathbb{D}_i)=\mathbb{G}_i\) for \(i=1,2\).}
\emph{If both \(\mathbb{D}_1\) and \(\mathbb{D}_2\) are \(\cap\)-stable then it holds that}
\begin{align*}
    \mathbb{D}_1\perp \!\!\! \perp\mathbb{D}_2\hspace{10pt}\Rightarrow \hspace{10pt} \mathbb{G}_1\perp \!\!\! \perp\mathbb{G}_2.
\end{align*}

\textbf{Definition 3.10. (Hansen)} \emph{Two real-valued random variable \(X\) and \(Y\) on a background space \((\Omega,\mathbb{F},P)\) are \textbf{independent}, written \(X\perp \!\!\! \perp Y\), if the corresponding sigma-algebras \(\sigma(X)\) and \(\sigma(Y)\) are independent.}

\textbf{Definition 3.15. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,...,\mathbb{G}_n\subset \mathbb{F}\) be finitely many classes of measurable sets. We say that \(\mathbb{G}_1,...,\mathbb{G}_n\) are \textbf{jointly independent}\index{jointly independent}, written \(\mathbb{G}_1\perp \!\!\! \perp...\perp \!\!\! \perp\mathbb{G}_n\), if}
\begin{align*}
    P(A_1\cap ...\cap A_n=\prod_{i=1}^nP(A_i)\hspace{15pt}\text{for }A_1\in\mathbb{G}_1,...,A_n\in\mathbb{G}_n.\tag{3.8}
\end{align*}

\textbf{Lemma 3.16. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,...,\mathbb{G}_n\subset \mathbb{F}\) be finitely many classes of measurable sets. It holds that}
\begin{align*}
    \mathbb{G}_1\perp \!\!\! \perp...\perp \!\!\! \perp\mathbb{G}_n\hspace{10pt}\Rightarrow \hspace{10pt} \mathbb{G}_1\perp \!\!\! \perp...\perp \!\!\! \perp\mathbb{G}_{n-1}
\end{align*}
\emph{provided that \(\Omega\in\mathbb{G}_n\).}

\textbf{Theorem 3.17. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,...,\mathbb{G}_n\subset \mathbb{F}\) be sigma-algebras. Let \(\mathbb{D}_1,...,\mathbb{D}_n\) be classes such that \(\sigma(\mathbb{D}_i)=\mathbb{G}_1\) for \(i=1,...,n\). Suppose that for all lengths \(k=2,...,n\) an all choices of indices \(\le j_1<...<j_k\le n\) it holds that}
\begin{align*}
    \mathbb{D}_{j_1}\perp \!\!\! \perp ... \perp \!\!\! \perp \mathbb{D}_{j_k}\tag{3.9}
\end{align*}
\emph{If all the generators \(\mathbb{D}_i\) are \(\cap\)-stable, then it holds that \(\mathbb{G}_1\perp \!\!\! \perp ... \perp \!\!\! \perp \mathbb{G}_n\).}

\textbf{Lemma 3.18. (Hansen)} \emph{(Grouping) Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,...,\mathbb{G}_n\subset \mathbb{F}\) be sigma-algebras. It holds that}
\begin{align*}
    \mathbb{G}_1\perp \!\!\! \perp ... \perp \!\!\! \perp \mathbb{G}_n \hspace{10pt}\Rightarrow \hspace{10pt} \mathbb{G}_1\perp \!\!\! \perp ... \perp \!\!\! \perp \mathbb{G}_{n-2}\perp \!\!\! \perp\sigma(\mathbb{G}_{n-1},\mathbb{G}_n).
\end{align*}

\textbf{Definition 3.19. (Hansen)} \emph{The real-valued random variables \(X_1,...,X_n\) on a background space \((\Omega,\mathbb{F},P)\) are \textbf{jointly independent}, written \(X_1\perp \!\!\! \perp ... \perp \!\!\! \perp X_n\), if the corresponding sigma-algebras \(\sigma(X_1),...,\sigma(X_n)\) are jointly independent.}

\textbf{Definition 3.20. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \((\mathbb{G}_i)_{i\in I}\) be a family of classes of measurable sets. We say that the family \((\mathbb{G}_i)_{i\in I}\) is \textbf{jointly independent} if any finite subfamily is jointly independent.}

\textbf{Theorem 3.21. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,\mathbb{G}_2,...\subset \mathbb{F}\) be sigma-algebras. Let \(\mathbb{D}_1,\mathbb{D}_2,...\) be classes such that \(\sigma(\mathbb{D}_n)=\mathbb{G}_n\) for all \(n\in\mathbb{N}\). Suppose that for all lengths \(k\in\mathbb{N}\) and all choices of indices \(1\le j_1< ... < j_k\) it holds that}
\begin{align*}
    \mathbb{D}_{j_1}\perp \!\!\! \perp ... \perp \!\!\! \perp \mathbb{D}_{j_k}.\tag{3.14}
\end{align*}
\emph{If all the generators \(\mathbb{D}_n\) are \(\cap\)-stable, then it holds that \(\mathbb{G}_1\perp \!\!\! \perp \mathbb{G}_2 \perp \!\!\! \perp ...\).}

\textbf{Lemma 3.22. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(\mathbb{G}_1,\mathbb{G}_2,...\subset \mathbb{F}\) be sigma-algebras. It holds that}
\begin{align*}
    \mathbb{G}_1\perp \!\!\! \perp \mathbb{G}_2 \perp \!\!\! \perp ... \hspace{10pt}\Rightarrow \hspace{10pt} \mathbb{G}_1\perp \!\!\! \perp ... \perp \!\!\! \perp \mathbb{G}_n \perp \!\!\! \perp \sigma(\mathbb{G}_{n+1},\mathbb{G}_{n+2}, ... ).
\end{align*}

\textbf{Definition 3.23. (Hansen)} \emph{The real-valued random variables \((X_i)_{i\in I}\) on a background space \((\Omega,\mathbb{F},P)\) are \textbf{jointly independent} if the corresponding sigma-algebras \((\sigma(X_i))_{i\in I}\) are jointly independent.}

\textbf{Definition 3.28. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space. A sigma-algebra \(\mathbb{G}\subset \mathbb{F}\) satisfies a \textbf{zero-one law}\index{zero-one law} if}
\begin{align*}
    P(A)\in\{0,1\}\hspace{15pt}\text{for all}\ A\in\mathbb{G}.
\end{align*}

\textbf{Theorem 3.29. (Hansen)} \emph{Let \((\Omega,\mathbb{F},P)\) be a probability space and let \(\mathbb{G}\subset \mathbb{F}\) be a sigma-algebra. The following three conditions are equivalent:}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{For any sigma-algebra \(\mathbb{H}\subset \mathbb{F}\) it holds that \(\mathbb{G} \perp \!\!\! \perp \mathbb{H}\),}
\item
  \emph{It holds that \(\mathbb{G}\perp \!\!\! \perp\mathbb{G}\),}
\item
  \emph{\(\mathbb{G}\) satisfies a 0-1 law.}
\end{enumerate}

\textbf{Definition 3.30. (Hansen)} \emph{Let \(X_1,X_2,...\) be real-valued random variables on a background space \((\Omega,\mathbb{F},P)\). The \textbf{tail sigma-algebra}\index{tail sigma-algebra} of the process is defined as}
\begin{align*}
    \mathbb{J}(X_1,X_2,...)=\bigcap_{n=1}^\infty \sigma(X_n,X_{n+1}, ... ).
\end{align*}

\textbf{Theorem 3.32. (Hansen)} \emph{(Kolmogorov's zero-one law)\index{Kolmogorov's zero-one law} Let \(X_1,X_2,...\) be real-valued random variables on a background space \((\Omega,\mathbb{F},P)\). If \(X_1 \perp \!\!\! \perp X_2 \perp \!\!\! \perp ...\) then the tail-algebra \(\mathbb{J}(X_1,X_2,...)\) satisfies a 0-1 law.}

\textbf{Lemma 3.35. (Hansen)} \emph{(2nd half of Borel-Cantelli)\index{Borel-Cantelli, 2nd half} Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(A_1,A_2,...\) be a sequence of \(\mathbb{F}\)-measurable sets. If \(A_1 \perp \!\!\! \perp A_2 \perp \!\!\! \perp ...\) then it holds that}
\begin{align*}
    \sum_{n=1}^\infty P(A_n)<\infty \iff P(A_n\text{ i.o.})=0.
\end{align*}

\newpage

\hypertarget{moment-generating-function}{%
\section{Moment generating function}\label{moment-generating-function}}

Let \(X\) be a random variable with distribution function \(F(x)=P(X\le x)\) and \(Y\) be a random variable with distribution function \(G(y)=P(Y\le y)\).

\textbf{Definition. (Ex. FinKont)} \emph{The moment generating function or Laplace transform of \(X\) is}

\[\psi_X(\lambda)=E\left[e^{\lambda X}\right]=\int_{-\infty}^\infty e^{\lambda x}dF(x)\]

\emph{provided the expectation is finite for \(\vert\lambda\vert<h\) for some \(h>0\).}

The MGF uniquely determine the distribution of a random variable, due to the following result.

\textbf{Theorem. (Ex. FinKont)} \textbf{(Uniqueness)} \emph{If \(\psi_X(\lambda)=\psi_Y(\lambda)\) when \(\vert\lambda\vert<h\) for some \(h>0\), then \(X\) and \(Y\) has the same distribution, that is, \(F=G\).}

There is also the following result of independence for Moment generating functions.

\textbf{Theorem. (Ex. FinKont)} \textbf{(Independence)} \emph{If}

\[E\left[e^{\lambda_1X+\lambda_2Y}\right]=\psi_X(\lambda_1)\psi_Y(\lambda_2)\]

\emph{for \(\vert\lambda_i\vert<h\) for \(i=1,2\) for some \(h>0\), then \(X\) and \(Y\) are independent random variables.}

\newpage

\hypertarget{standard-distributions}{%
\section{Standard distributions}\label{standard-distributions}}

\hypertarget{normal-disribution}{%
\subsection{Normal disribution}\label{normal-disribution}}

The following gives a comprehensive table of the standard some properties.\index{Normal disribution}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.3056}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.1667}}
  >{\centering\arraybackslash}p{(\columnwidth - 4\tabcolsep) * \real{0.5278}}@{}}
\toprule()
\begin{minipage}[b]{\linewidth}\raggedright
Description
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Symbol
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Normal distribution
\end{minipage} \\
\midrule()
\endhead
Definition & \(\sim\) & \(X\sim\mathcal{N}(\mu,\sigma^2)\) \\
Parameters & \(\theta\in \Theta\) & \(\theta=(\mu,\sigma^2)\in \mathbb{R}\times \mathbb{R}_+\) \\
Support & \(\text{Im}(X)\) & \(x\in \mathbb{R}\) \\
Density & \(f\) & \(\frac{1}{\sqrt{2\pi\sigma^2}}e^{-\left(\frac{x-\mu}{\sqrt{2\sigma^2}}\right)^2}\) \\
Distribution & \(F\) & \(\frac{1}{2}\left(1+N\left(\frac{x-\mu}{\sqrt{2\sigma^2}}\right)\right)\) \\
Mean value & \(E[X]\) & \(\mu\) \\
Variance & \(\text{Var}(X)\) & \(\sigma^2\) \\
MGF* & \(\psi_X=E[e^{\lambda X}]\) & \(e^{\mu \lambda+\frac{1}{2}\lambda^2\sigma^2}\) \\
Characteristic function & \(\varphi_X(t)=E[e^{itX}]\) & \(e^{it\mu-\frac{1}{2}\sigma^2 t^2}\) \\
\bottomrule()
\end{longtable}

In the table above we used the abbreviations: *MGF = Moment Generating function.

We also used the shorthand: \(N\) being the distribution of a standard normal distributed variable \(\mathcal{N}(0,1)\).

\hypertarget{discrete-time-stochastic-processes}{%
\chapter{Discrete Time Stochastic Processes}\label{discrete-time-stochastic-processes}}

\hypertarget{convergence-concepts}{%
\section{Convergence concepts}\label{convergence-concepts}}

We start this chapter by refering to a sequence \(X_1,X_2,...\) of real-valued random variables as a \textbf{proces}. Consider the event \((X_n\to X)=\left\{\omega\in\Omega\ \vert\ X_m(\omega)\to X(\omega)\ \text{for}\ n\to \infty\right\}\). We want to study such convergence in detail. However first we check measurability. Consider a family \((A_i)_{i\in I}\subset \Omega\) and observe that
\begin{align*}
    \Big\{\omega\in \Omega\ \vert\ \forall i\in I : \omega \in A_i\Big\}=\bigcap_{i\in I} A_i,\tag{2.1}\\
    \Big\{\omega\in \Omega\ \vert\ \exists i\in I : \omega \in A_i\Big\}=\bigcup_{i\in I} A_i.\tag{2.2}
\end{align*}
From the standard \(N,\varepsilon\) definition of a convergent sequence \((x_n)_{n\in \mathbb{N}}\) we may formulate this convergens in the stochastic setting:
\begin{align*}
    (X_n\to X)&=\Big\{\omega\in \Omega\ \vert\ \forall\varepsilon>0 \exists N\in \mathbb{N} \forall n\ge N : \vert X_n(\omega)-X(\omega)\vert <\varepsilon\Big\}\\
    &=\Big(\forall\varepsilon>0 \exists N\in \mathbb{N} \forall n\ge N : \vert X_n-X\vert <\varepsilon\Big)\\
    &=\bigcap_{\epsilon\in \mathbb{R}^+}\Big(\exists N\in \mathbb{N} \forall n\ge N : \vert X_n-X\vert<\varepsilon\Big)\\
    &=\bigcap_{\epsilon\in \mathbb{R}^+}\bigcup_{N=1}^\infty\Big( \forall n\ge N : \vert X_n-X\vert<\varepsilon\Big)\\
    &=\bigcap_{\epsilon\in \mathbb{R}^+}\bigcup_{N=1}^\infty\bigcap_{n=N}^\infty\Big(  \vert X_n-X\vert<\varepsilon\Big)\in \mathbb{F}\hspace{15pt}\text{for all}\ \varepsilon>0.
\end{align*}
Hence \((X_n\to X)\) lies in \(\mathbb{F}\) since \((\vert X_n-X\vert <\varepsilon)\) lies in \(\mathbb{F}\) since \(X_n-X\) is measurable.

\textbf{Lemma 2.1. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables on \((\Omega, \mathbb{F},P)\). It holds that}
\begin{align*}
    (X_n\to X)\in \mathbb{F}.
\end{align*}

\textbf{Definition 2.2. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). We say that \(X_n\) \textbf{converges} to \(X\) \textbf{almost surely}\index{almost surely convergence}\index{convergence almost surely}, written \(X_n\stackrel{\text{a.s.}}{\to}X\), if}
\begin{align*}
    P(X_n\to X)=1.\tag{2.6}
\end{align*}

\textbf{Lemma 2.3. (Hansen)} \emph{Let \(X,X',X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). If \(X_n\stackrel{\text{a.s.}}{\to}X\) and \(X_n\stackrel{\text{a.s.}}{\to}X'\) then \(X=X'\) almost surely.}

\textbf{Lemma 2.7. (Hansen)} \emph{Let \(X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). Then}
\begin{align*}
    \Big((X_n)\text{ is Cauchy}\Big)\in \mathbb{F}.
\end{align*}

\textbf{Lemma 2.8. (Hansen)} \emph{Let \(X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). If \(P\Big((X_n)\text{ is Cauchy}\Big)=1\) then there exists and \(\mathbb{F}\)-measurable real-valued random variable \(X\) such that \(X_n\stackrel{\text{a.s.}}{\to}X\).}

\textbf{Theorem 2.10. (Hansen)} \emph{Let \(X_1,X_2,...\) and \(Y_1,Y_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). Assume that the \(X\)-process and the \(Y\)-process have the same distribution in the sense that \((X_1,...,X_n)\) has the same distribution ad \((Y_1,...,Y_n)\) for all \(n\in\mathbb{N}\).}
\emph{If \(X_n\stackrel{\text{a.s.}}{\to}X\) for som limit variable \(X\), there is a limit variable \(Y\) such that \(Y_n\stackrel{\text{a.s.}}{\to}Y\).}

\textbf{Definition 2.11. (Hansen)} \emph{Let \(\mathbf{X},\mathbf{X}_1,\mathbf{X}_2,...\) be \(\mathbb{R}^k\) valued random variables on \((\Omega, \mathbb{F},P)\). We say that \(\mathbf{X}_n\) converges to \(\mathbf{X}\) \textbf{almost surely}, written \(\mathbf{X}_n\stackrel{\text{a.s.}}{\to}\mathbf{X}\), if}
\begin{align*}
    \vert\mathbf{X}_n-\mathbf{X}\vert \stackrel{\text{a.s.}}{\to} 0.\tag{2.15}
\end{align*}

\textbf{Lemma 2.12. (Hansen)} \emph{Let \(\mathbf{X},\mathbf{X}_1,\mathbf{X}_2,...\) be \(\mathbb{R}^k\) valued random variables on \((\Omega, \mathbb{F},P)\) such that \(\mathbf{X}_n\stackrel{\text{a.s.}}{\to}\mathbf{X}\). Let \(f : \mathbb{R}^k\to\mathbb{R}^m\) be a measurable map.}
\emph{Assume that there is a set \(A\in \mathbb{B}_k\) such that \(f\) is continuous on \(A\) and such that \(P(\mathbf{X}\in A)=1\). Then it holds that \(f(\mathbf{X}_n)\stackrel{\text{a.s.}}{\to} f(\mathbf{X})\).}

\textbf{Definition 2.13. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). We say that \(X_n\) \textbf{converges} to \(X\) \textbf{in probability}\index{convergence in probability}, written \(X_n\stackrel{\text{P}}{\to} X\), if}
\begin{align*}
    \forall \varepsilon>0 :\hspace{10pt} P\big(\vert X_n-X\vert\ge \varepsilon\big)\to 0\hspace{10pt}\text{for}\ n\to \infty.\tag{2.17}
\end{align*}

\textbf{Lemma 2.14. (Hansen)} \emph{Let \(X,X',X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). If \(X_n\stackrel{\text{P}}{\to} X\) and \(X_n\stackrel{\text{P}}{\to} X'\) then \(X=X'\) almost surely.}

\textbf{Lemma 2.14. (Hansen)} \emph{Let \(X,X',X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). If \(X_n\stackrel{\text{a.s.}}{\to} X\), then \(X_n\stackrel{\text{P}}{\to} X\).}

\textbf{Definition 2.17. (Hansen)} \emph{Let \(\mathbf{X},\mathbf{X}_1,\mathbf{X}_2,...\) be \(\mathbb{R}^k\) valued random variables on \((\Omega, \mathbb{F},P)\). We say that \(\mathbf{X}_n\) converges to \(\mathbf{X}\) \textbf{in probability}, written \(\mathbf{X}_n\stackrel{\text{P}}{\to} \mathbb{X}\), if}
\begin{align*}
    \vert \mathbf{X}_n-\mathbf{X}\vert \stackrel{\text{P}}{\to} 0.\tag{2.23}
\end{align*}

\textbf{Lemma 2.18. (Hansen)} \emph{Let \(X,Y,X_1,Y_1,X_2,Y_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). It holds that}
\begin{align*}
    \begin{pmatrix}
    X_n\\Y_n
    \end{pmatrix}\stackrel{\text{P}}{\to} \begin{pmatrix}
    X\\Y
    \end{pmatrix}\hspace{15pt}\iff \hspace{15pt} X_n\stackrel{\text{P}}{\to} X\text{ and }Y_n\stackrel{\text{P}}{\to} Y.\tag{2.24}
\end{align*}

\textbf{Definition 2.19. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables in \(\mathcal{L}^p(\Omega,\mathbb{F},P)\) for some \(p\ge 1\). We say that \(X_n\) \textbf{converges} to \(X\) \textbf{in} \(\mathcal{L}^p\)\index{convergence in L-p}, written \(X_n\stackrel{\mathcal{L}^p}{\to} X\), if}
\begin{align*}
    \Vert X_n - X\Vert_p\to 0.\tag{2.27}
\end{align*}
\emph{Where the \(p\)'th norm is defined as the mapping \(\Vert \cdot \Vert_p : \Omega\to [0,\infty)\) given by \(X\mapsto \left(\int_\Omega \vert X\vert ^p\ dP\right)^{1/p}\).}

One might also define convergence in \(\mathcal{L}^p\) by simply saying if \(X_n\stackrel{\mathcal{L}^p}{\to} X\) then \(E\,\Vert X_n-X\Vert_p\to 0\).

\textbf{Lemma 2.20. (Hansen)} \emph{(Extended Cauchy-Schwarz inequality) Let \(X,Y\in\mathcal{L}^p(\Omega,\mathbb{F},P)\) for some \(p\ge 1\). For any \(a\in[0,p]\) it holds that}
\begin{align*}
    E\, \vert X\vert^a\vert Y\vert^{p-a}\le \Big(E\, \vert X\vert^p\Big)^{\frac{a}{p}}\Big(E\, \vert Y\vert^p\Big)^{\frac{p-a}{p}}.\tag{2.29}
\end{align*}

\textbf{Theorem 2.21. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables in \(\mathcal{L}^p(\Omega,\mathbb{F},P)\) for some \(p\in\mathbb{N}\). If \(X_n\stackrel{\mathcal{L}^p}{\to} X\), then it holds that \(E\, X_n^p\to E\, X^p\).}

\textbf{Lemma 2.22. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables in \(\mathcal{L}^p(\Omega,\mathbb{F},P)\) for some \(p\ge 1\). If \(X_n\stackrel{\mathcal{L}^p}{\to} X\), then \(X_n\stackrel{\text{P}}{\to} X\).}

\textbf{Lemma 2.25. (Hansen)} \emph{(Borel-Cantelli) Let \((\Omega,\mathbb{F},P)\) be a probability space, and let \(A_1,A_2,...\) be a sequence of \(\mathbb{F}\)-measurable sets. It holds that}
\begin{align*}
    \sum_{n=1}^\infty P(A_n)<\infty\hspace{10pt}\Rightarrow\hspace{10pt}P(A_n\ \text{i.o.})=0.
\end{align*}

Let \(A_1,A_2,...\) be a sequence of subsets of \(\Omega\). We define
\begin{align*}
    (A_n\ \text{i.o.})=\bigcap_{n=1}^\infty\bigcup_{m=n}^\infty A_m,\hspace{10pt}(A_n\ \text{evt.})=\bigcup_{n=1}^\infty\bigcap_{m=n}^\infty A_m.
\end{align*}
One might also define \(Y=\sum_{n=1}^\infty 1_{A_n}\) and realise that \((A_n\ \text{i.o.})=(Y=\infty)\) and \((A_n\ \text{evt.})=(Y<\infty)\). Also by de Morgan's law it follows that \((A_n\ \text{evt.})^c=(A_n^c\ \text{i.o.})\).

\textbf{Theorem 2.26. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). If}
\begin{align*}
    \forall \varepsilon>0:\hspace{10pt}\sum_{n=1}^\infty P(\vert X_n-X\vert \ge \varepsilon)<\infty,\tag{2.32}
\end{align*}
\emph{then it holds that \(X_n\stackrel{\text{a.s.}}{\to} X\).}

\textbf{Theorem 2.27. (Hansen)} \emph{Let \(X,X_1,X_2,...\) be real-valued random variables on \((\Omega,\mathbb{F},P)\). If \(X_n\stackrel{\text{P}}{\to} X\), then there is a subsequence \(X_{n_1},X_{n_2},...\) such that \(X_{n_k}\stackrel{\text{a.s.}}{\to} X\) for \(k\to \infty\).}

\textbf{Lemma 2.28. (Hansen)} \emph{Let \(\mathbf{X},\mathbf{X}_1,\mathbf{X}_2,...\) be \(\mathbb{R}^k\)-valued random variables on \((\Omega,\mathbb{F},P)\) such that \(\mathbf{X}_n\stackrel{\text{P}}{\to} \mathbf{X}\). Let \(f : \mathbb{R}^k\to \mathbb{R}^m\) be a measurable map.}
\emph{Assume that there is a set \(A\in\mathbb{B}_k\) such that \(f\) is continuous on \(A\) and such that \(P(\mathbf{X}\in A)=1\). Then it holds that \(f(\mathbf{X}_n)\stackrel{\text{P}}{\to} f(\mathbf{X})\).}

\textbf{Lemma.} \emph{(Fatou's Lemma) \index{Fatou's Lemma}Let \((\Omega,\mathbb{F},P)\) be a measure space (here probability space). Let \(f_n : \mathcal{X} \to [0,\infty]\), with \(\mathcal{X}\in\mathbb{F}\), be a sequence of non-negative measurable functions. Assume \(f_n\) converge pointwise to \(f : \mathcal{X}\to [0,\infty)\). Then}
\begin{align*}
    \int_{\mathcal{X}} \liminf_{n\to\infty} f_n\ dP\le \liminf_{n\to\infty} \int_{\mathcal{X}} f_n\ dP.
\end{align*}

\textbf{Lemma.} \emph{(Holder's Inequality) \index{Holder's Inequality} Let \((\Omega,\mathbb{F},P)\) be a measure space (here probability space). Let \(f\) and \(g\) be real-valued (or complex-valued) functions defined on \(\Omega\). Assume \(f\) and \(g\) are measurable. For any \(p,q\ge 1\) such that \(\frac{1}{p}+\frac{1}{q}=1\) it holds that }
\begin{align*}
    \left(\int_\Omega \vert fg\vert^1\ dP\right)^1\le \left(\int_\Omega \vert f\vert^p\ dP\right)^{1/p}\left(\int_\Omega \vert g\vert^q\ dP\right)^{1/q}
\end{align*}

\pagebreak

\hypertarget{sums-and-average-processes}{%
\subsection{Sums and average processes}\label{sums-and-average-processes}}

\textbf{Lemma 4.1. (Hansen)} \emph{Let \(X_1,...,X_n\) be independent real-valued random variables with \(E\, X_i^4<\infty\) for all \(i\). If \(E\, X_i=0\) for all \(i\) then it holds that}
\begin{align*}
    E\left(\sum_{i=1}^n X_i\right)^4=\sum_{i=1}^n E\, X_i^4+6\sum_{i=1}^{n-1}\sum_{j=i+1}^n E\, X_i^2\,E\,X_j^2.
\end{align*}

\textbf{Theorem 4.2. (Hansen)} \emph{(SLLN, weak form)\index{SLLN, weak form} Let \(X_1,X_2,...\) be a sequence of independent and identically distributed real-valued random variables. If \(E\, X_1^4<\infty\) it holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=1}^n X_i \hspace{10pt}\stackrel{\text{a.s.}}{\to} \hspace{10pt}E\, X_1.\tag{4.3}
\end{align*}

\textbf{Theorem 4.10. (Hansen)} \emph{(Etemadi's maximal inequality)\index{Etemadi's maximal inequality} Let \(X_1,...,X_n\) be independent real-valued random variables. Consider the cumulative sums}
\begin{align*}
    S_k=\sum_{i=1}^kX_i\hspace{10pt}\text{for}\ k=1,..., n.
\end{align*}
\emph{For any \(\alpha >0\) it holds that}
\begin{align*}
    P\left(\max_{j=1,...,n}\ \vert S_j\vert\ge 3\alpha\right)\le 3\ \max_{j=1,...,n}\ P(\vert S_j\vert \ge \alpha).\tag{4.11}
\end{align*}

\textbf{Theorem 4.11. (Hansen)} \emph{(Levy's maximal inequality)\index{Levy's maximal inequality} Let \(X_1,...,X_n\) be independent real-valued random variables, each with a symmetric distribution. Consider the cumulative sums}
\begin{align*}
    S_k=\sum_{i=1}^kX_i\hspace{10pt}\text{for}\ k=1,..., n.
\end{align*}
\emph{For any \(\alpha>0\) it holds that}
\begin{align*}
    P\left(\max_{j=1,...,n}\ S_j\ge \alpha\right)\le 2 P(S_j\ge \alpha).\tag{4.13}
\end{align*}

\textbf{Corollary 4.12. (Hansen)} \emph{Let \(X_1,...,X_n\) be independent real-valued random variables, each with a symmetric distribution. Consider the cumulative sums}
\begin{align*}
    S_k=\sum_{i=1}^kX_i\hspace{10pt}\text{for}\ k=1,..., n.
\end{align*}
\emph{For any \(\alpha>0\) it holds that}
\begin{align*}
    P\left(\max_{j=1,...,n}\ \vert S_j\vert\ge \alpha\right)\le 2 P(\vert S_j\vert\ge \alpha).\tag{4.14}
\end{align*}

\textbf{Theorem 4.13. (Hansen)} \emph{(Skorokhod)\index{Skorokhod} Let \(X_1,X_2,...\) be a sequence of independent real-valued random variables, and consider the cumulative sums \(S_k=\sum_{i=1}^kX_i\). Let \(S\) be a potential limit variable. It holds that}
\begin{align*}
    S_n \stackrel{\text{P}}{\to} S\hspace{10pt}\Rightarrow\hspace{10pt} S_n\stackrel{\text{a.s.}}{\to} S.
\end{align*}

\textbf{Corollary 4.14. (Hansen)} \emph{(Khintchine-Kolmogorov)\index{Khintchine-Kolmogorov} Let \(X_1,X_2,...\) be a sequence of independent real-valued random variables. Assume \(E\, X_n^2<\infty\) and that \(E\, X_n=0\) for every \(n\in\mathbb{N}\). Consider the cumulative sums \(S_k=\sum_{i=1}^kX_i\). If}
\begin{align*}
    \sum_{n=1}^\infty E\, X_n^2<\infty\tag{4.18}
\end{align*}
\emph{then there exist a limit variable \(S\) such that \(S_n\to S\) almost surely and in \(\mathcal{L}^2\). The limit variable satisfies that}
\begin{align*}
    E\, S=0\hspace{10pt}\text{and}\hspace{10pt}V\, S=\sum_{n=1}^\infty V\, X_n.
\end{align*}

\textbf{Theorem 4.17. (Hansen)} \emph{Let \(X_1,X_2,...\) be a sequence of independent real-valued random variables, and consider the cumulative sums \(S_k=\sum_{i=1}^kX_i\). Let \(S\) be a potential limit variable. Assume that there is a constant \(c>0\) such that \(P(\vert X_n\vert \le c)=1\) for all \(n\), and assume that \(E\, X_n=0\) for all \(n\). The the three statements}
1. \(S_n\stackrel{\text{P}}{\to} S\),
2. \(S_n\stackrel{\text{a.s.}}{\to} S\)
3. \(S_n\stackrel{\mathcal{L}^2}{\to} S\)
\emph{are equivalent.}

\textbf{Lemma 4.18. (Hansen)} \emph{Let \(X_1,X_2,...\) be a sequence of independent real-valued random variables. Assume that there is a constant \(c>0\) such that \(P(\vert X_n\vert \le c)=1\) for all \(n\). If the associated random walk \(S_n=\sum_{i=1}^n X_i\) satisfies that \(S_n\to S\) almost surely for some limit variable then it holds that}
\begin{align}
    \text{1)}\hspace{10pt}& \sum_{n=1}^NE\, X_n\hspace{5pt}\text{converges in }\mathbb{R}\hspace{5pt}\text{for}\ N\to \infty,\\
    \text{2)}\hspace{10pt}&\sum_{n=1}^\infty V(X_n)<\infty.
\end{align}

\textbf{Theorem 4.19. (Hansen)} \emph{(Kolmogorov's 3-series theorem)\index{Kolmogorov's 3-series theorem} Let \(X_1,X_2,...\) be a sequence of independent real-valued random variables. Consider the assoiciated random walk \(S_n=\sum_{i=1}^n X_i\). If there is a cut-off value \(c>0\) such that the capped variables \(\tilde{X}_n=1_{\vert X_n\vert \le c}X_n\) satisfies that}
\begin{align*}
    \text{1)}\hspace{10pt}& \sum_{n=1}^\infty P(X_n\ne \tilde{X}_n)<\infty,\\
    \text{2)}\hspace{10pt}& \sum_{n=1}^N E\, \tilde{X}_n\ \text{converges in }\mathbb{R}\ \text{for}\ N\to \infty,\\
    \text{3)}\hspace{10pt}& \sum_{n=1}^\infty V(\tilde{X}_n)<\infty,
\end{align*}
\emph{then there is a real-valued limit variable \(S\) such that \(S_n\to S\) almost surely.}
\emph{Conversely, if \((S_n)_{n\in\mathbb{N}}\) is almost surely convergent, then the three series above converge for \textbf{any} cut-off value \(c>0\).}

\textbf{Lemma 4.20. (Hansen)} \emph{Let \((x_n)_{n\in\mathbb{N}}\) be a real-valued sequence, and let \(c\) be a real number. It holds that}
\begin{align*}
    x_n\to c\ \text{for}\ n\to \infty \hspace{10pt}\Rightarrow\hspace{10pt} \frac{1}{n}\sum_{i=1}^nx_i\to x\ \text{for}\ n\to\infty.
\end{align*}

\textbf{Lemma 4.21. (Hansen)} \emph{(Kronecker)\index{Kronecker} Let \((x_n)_{n\in\mathbb{N}}\) be real-valued sequence, and let \(c\) be a real number. It holds that}
\begin{align*}
    \sum_{i=1}^n\frac{x_i}{i}\to c \hspace{10pt}\Rightarrow\hspace{10pt} \frac{1}{n}\sum_{i=1}^nx_i\to 0
\end{align*}
\emph{for \(n\to \infty\).}

\textbf{Lemma 4.23. (Hansen)} \emph{Let \(X_1,X_2,...\) be a sequence of identically distributed real-valued random variables, and let \(\tilde{X}_n=1_{(\vert X_n\vert \le n}X_n\). If \(E\vert X_1\vert<\infty\) it holds that}
\begin{align*}
    \sum_{n=1}^\infty\frac{E\ \tilde{X}_n^2}{n^2}<\infty.
\end{align*}

\textbf{Theorem 4.24. (Hansen)} \emph{(SLLN, strong version)\index{SLLN, strong version} Let \(X_1,X_2,...\) be sequence of independent and identically distributed real-valued random variables. If \(E\vert X_1\vert <\infty\) it holds that}
\begin{align*}
    \frac{1}{n}\sum_{n=1}^\infty X_i\stackrel{\text{a.s.}}{\to} E\ X_1.\tag{4.24}
\end{align*}

\textbf{Theorem 4.25. (Hansen)} \emph{(SLLN, \(\mathcal{L}^p\)-version)\index{SLLN, $\mathcal{L}^p$-version} Let \(X_1,X_2,...\) be sequence of independent and identically distributed real-valued random variables. If \(E\vert X_1\vert^p <\infty\) for some \(p\ge 1\), then it holds that}
\begin{align*}
\frac{1}{n}\sum_{n=1}^\infty \stackrel{\mathcal{L}^p}{\to} E\ X_1.\tag{4.26}    
\end{align*}

\textbf{Lemma 4.26. (Hansen)} \emph{Let \(X_1,X_2,...\) be a sequence of pairwise independent, identically distributed real-valued random variables with \(E\vert X_1\vert <\infty\). Let \(n_1<n_2<...\) be a sequence of natural numbers. If there are constants \(C_1,C_2>0\) and \(\alpha>1\) such that}
\begin{align*}
    C_1\alpha^k\le n_k\le C_2\alpha^k\hspace{15pt}\text{for}\ k\to\infty\tag{4.27}
\end{align*}
\emph{then it holds that}
\begin{align*}
    \frac{1}{n_k}\sum_{i=1}^{n_k}X_i\stackrel{\text{a.s.}}{\to} E\ X_1\hspace{15pt}\text{for}\ k\to \infty.
\end{align*}

\textbf{Theorem 4.27. (Hansen)} \emph{(Etemahdi's version)\index{Etemahdi's version} Let \(X_1,X_2,...\) be a sequence of pairwise independent, identically distributed real-valued random variables. If \(E\vert X_1\vert<\infty\) it holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=1}^nX_i\stackrel{\text{a.s.}}{\to} E\ X_1.\tag{4.30}
\end{align*}

\hypertarget{ergodic-theory}{%
\subsection{Ergodic Theory}\label{ergodic-theory}}

\textbf{Definition 5.3. (Hansen)} \emph{Let \((\mathcal{X},\mathbb{E})\) be a measurable space and let \(T : \mathcal{X}\to \mathcal{X}\) be measurable. A probability measure \(\mu\) on \((\mathcal{X},\mathbb{E})\) is \textbf{invariant}\index{invariant measure} under \(T\) if}
\begin{align*}
    \mu\big(T^{-1}(A)\big)=\mu(A)\hspace{10pt}\text{for all}\ A\in\mathbb{E}\tag{5.5}
\end{align*}
\emph{In this case we call the quadruple \((\mathcal{X},\mathbb{E},\mu,T)\) a \textbf{measure-preserving dynamical system}\index{measure-preserving dynamical system}.}

We say that a set \(A\in\mathbb{E}\) is an \textbf{invariant set} if \(T^{-1}(A)=A\) i.e.~the orbit of all \(x\in A\) stays in \(A\).

\textbf{Definition 5.5. (Hansen)} \emph{A measure-preserving dynamical system \((\mathcal{X},\mathbb{E},\mu,T)\) is \textbf{ergodic}\index{ergodic} if}
\begin{align*}
    T^{-1}(A)=A,\ A\in\mathbb{E} \hspace{10pt}\Rightarrow\hspace{10pt} \mu(A)\in\{0,1\}.\tag{5.7}
\end{align*}

\textbf{Definition 5.6. (Hansen)} \emph{A measure-preserving dynamical system \((\mathcal{X},\mathbb{E},\mu,T)\) is \textbf{mixing}\index{mixing} if}
\begin{align*}
    \mu(A\cap T^{-n}(B))\to \mu(A)\mu(B)\hspace{10pt}\text{for all}\ A,B\in\mathbb{E}.\tag{5.8}
\end{align*}

\textbf{Lemma 5.7. (Hansen)} \emph{If a measure-preserving dynamical system \((\mathcal{X},\mathbb{E},\mu,T)\) is mixing then it is also ergodic.}

\textbf{Lemma 5.8. (Hansen)} \emph{Let \((\mathcal{X},\mathbb{E},\mu,T)\) be a measure-preserving dynamical system. Let \(\mathbb{D}\) be an \(\cap\)-stable generator for \(\mathbb{E}\). If}
\begin{align*}
        \mu(A\cap T^{-n}(B))\to \mu(A)\mu(B)\hspace{10pt}\text{for all}\ A,B\in\mathbb{D}.\tag{5.10}
\end{align*}
\emph{then the system is mixing. (and ergodic)}

\textbf{Lemma 5.9. (Hansen)} \emph{Let \((\mathcal{X},\mathbb{E},\mu)\) be a probability space, and let \(T : \mathcal{X}\to \mathcal{X}\) be a measure-preserving map. Let \((\mathcal{Y},\mathbb{G})\) be another measurable space, and let \(S : \mathcal{Y} \to \mathcal{Y}\) be a measurable map.}
\emph{Suppose there is a measurable map \(\gamma : \mathcal{X}\to \mathcal{Y}\) such that the following diagram commutes:}

\begin{center}\includegraphics[width=0.25\linewidth]{_main_files/figure-latex/unnamed-chunk-15-1} \end{center}

\emph{Then \((\mathcal{Y},\mathbb{G},\gamma(\mu),S)\) is a measure-preserving dynamical system.}

\textbf{Lemma 5.10. (Hansen)} \emph{Let \((\mathcal{X},\mathbb{E},\mu,T)\) and \((\mathcal{Y},\mathbb{G},\nu,S)\) be two measure-preserving dynamical systems. Suppose there is a measurable map \(\gamma : \mathcal{X}\to\mathcal{Y}\) such that \(\nu =\gamma(\mu)\) and such that the diagram in lemma 5.9 commutes.}
\emph{If \((\mathcal{X},\mathbb{E},\mu,T)\) is ergodic then \((\mathcal{Y},\mathbb{G},\nu,S)\) is also ergodic.}

\textbf{Lemma 5.11. (Hansen)} \emph{(Maximal Ergodic Lemma)\index{Maximal Ergodic Lemma} Let \((\mathcal{X},\mathbb{E},\mu,T)\) be a measure-preserving dynamical system, and let \(f : \mathcal{X}\to \mathbb{R}\) be Borel measurable. If \(f\in \mathcal{L}^1(\mu)\) then it holds that}
\begin{align*}
    \int_{(M_n>0)}f\ d\mu\ge 0\tag{5.14}
\end{align*}
\emph{where \(M_n=\max\{0,S_1,S_2,...,S_n\}\) from the sequence}
\begin{align*}
    \Big(f(x), f\circ T(x),f\circ T^2(x),f\circ T^3(x),...\Big)\hspace{10pt}\text{with}\hspace{10pt}S_n=\sum_{i=0}^{n-1}f\circ T^i.
\end{align*}

\textbf{Theorem 5.12. (Hansen)} \emph{(Birkhoff's ergodic theorem)\index{Birkhoff's ergodic theorem} Let \((\mathcal{X},\mathbb{E},\mu,T)\) be an ergodic system. For \(f\in \mathcal{L}^1(\mu)\) it holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=0}^{n-1}f\circ T^i\stackrel{\text{a.s.}}{\to} \int f\ d\mu.\tag{5.16}
\end{align*}

\textbf{Theorem 5.13. (Hansen)} \emph{(Ergodic theorem, \(\mathcal{L}^p\)-version)\index{Ergodic theorem, $\mathcal{L}^p$-version} Let \((\mathcal{X},\mathbb{E},\mu,T)\) be an ergodic system. If \(f\in \mathcal{L}^p(\mu)\) for some \(p\ge 1\) then it holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=0}^{n-1}f\circ T^i\stackrel{\mathcal{L}^p}{\to}\int f\ d\mu.\tag{5.21}
\end{align*}

\textbf{Lemma 5.14. (Hansen)} \emph{Let \((\mathcal{X},\mathbb{E})\) be a measurable space. The measurable finite dimensional product sets in \(\mathcal{X}^{\mathbb{N}}\) form an \(\cap\)-stable generator for} \({\mathbb{E}}^{\otimes\mathbb{N}}\).

An element of the space \(\mathcal{X}^{\mathbb{N}}\) is a countable set of coordinates \(x_n\) for \(n\in\mathcal{N}\) with \(x_n\in\mathcal{X}\). A \textbf{finite dimensional product set}\index{finite dimensional product set} in \(\mathcal{X}^{\mathbb{N}}\) is set on the form
\begin{align*}
    A_1\times ... \times A_k\times \mathcal{X}\times \mathcal{X}\times ...
\end{align*}
where \(A_1,...,A_k\subset \mathcal{X}\). We also define the \textbf{projection sigma-algebra}\index{projection sigma-algebra} \(\mathbb{E}^{\otimes \mathbb{N}}\) as \(\sigma\left(\big(\hat{X}_n(\mathcal{X}^n)\big)_{n\in\mathbb{N}}\right)\) where \(\hat{X}_n(x_1,...,x_n)=x_n\).

\textbf{Definition 5.15. (Hansen)} \emph{Let \(X_1,X_2,...\) be a sequence of \((\mathcal{X},\mathbb{E})\)-valued random variable, defined on a background space \((\Omega,\mathbb{F},P)\), and let \(\mathbb{X}=(X_1,X_2,...)\) be their bundling. The \textbf{distribution} of the process is the image measure \(\mathbb{X}(P)\) on} \((\mathcal{X}^{\mathbb{N}},{\mathbb{E}}^{\otimes \mathbb{N}})\).

\textbf{Lemma 5.16. (Hansen)} \emph{Let \(\mathbb{X}=(X_1,X_2,...)\) and \(\mathbb{Y}=(Y_1,Y_2,...)\) be two \((\mathcal{X},\mathbb{E})\)-valued stochastic process, defined on a common background space . The two processes \(\mathbb{X}\) and \(\mathbb{Y}\) have the same distribution if and only if the have the same fidis.}
\emph{This can be checked by showing that}
\begin{align*}
    P(X_1\in A_i,...,X_k\in A_k)=P(Y_1\in A_1,...,Y_k\in A_k)\tag{5.25}
\end{align*}
\emph{for any \(k\in\mathbb{N}\) and any choice of \(A_1,...,A_k\in\mathbb{E}\).}

\textbf{Definition 5.18. (Hansen)} \emph{Let \(X_1,X_2,...\) be a sequence of \((\mathcal{X},\mathbb{E})\)-valued random variable, defined on a background space \((\Omega,\mathbb{F},P)\), and let \(\mathbb{X}=(X_1,X_2,...)\) be their bundling. Then we define:}
1. \emph{The proces \(\mathbb{X}\) is \textbf{stationary}\index{stationary} if the distrbution \(\mathbb{X}(P)\) is an \(S\)-invariant probability on} \(\Big(\mathbb{R}^{\mathbb{N}},\mathbb{B}^{\otimes \mathbb{N}}\Big)\),
2. \emph{The proces \(\mathbb{X}\) is \textbf{ergodic} if it is stationary and if the dynamical system} \(\Big(\mathbb{R}^{\mathbb{N}},\mathbb{B}^{\otimes \mathbb{N}},\mathbb{X}(P),S\Big)\) \emph{is ergodic.}
3. \emph{The proces \(\mathbb{X}\) is \textbf{mixing} if it is stationary and if the dynamical system} \(\Big(\mathbb{R}^{\mathbb{N}},\mathbb{B}^{\otimes \mathbb{N}},\mathbb{X}(P),S\Big)\) \emph{is mixing.}
\emph{with \(S\) being the \textbf{shift} map defined as \(S(x_1,x_2,...)=(x_2,x_3,...)\).}

\textbf{Theorem 5.20. (Hansen)} \emph{(Khintchine's ergodic theorem)\index{Khintchine's ergodic theorem} Let \(X_1,X_2,...\) be a stationary and ergodic sequence of real-valued random variables. If \(E\vert X_1\vert <\infty\) it holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=1}^nX_i\stackrel{\text{a.s.}}{\to} E\ X_1.\tag{5.27}
\end{align*}
\emph{If \(E\vert X_1\vert ^p<\infty\) for some \(p\ge 1\), the convergence is also in \(\mathcal{L}^p\).}

\textbf{Theorem 5.21. (Hansen)} \emph{(Ergodic transformation theorem)\index{Ergodic transformation theorem} Let \(X_1,X_2,...\) be a sequence of real-valued random variables. For a measurable function} \(\phi : \big(\mathbb{R}^{\mathbb{N}},\mathbb{B}^{\otimes\mathbb{N}}\big)\to (\mathbb{R},\mathbb{B})\) \emph{we define new real-valued random variables}
\begin{align*}
    Y_n=\phi(X_n,X_{n+1},...)=\phi\circ S^{n-1}(\mathbb{X})\hspace{15pt}\text{for}\ n\in\mathbb{N}.
\end{align*}
\emph{If \(X_1,X_2,...\) is stationary and ergodic then \(Y_1,Y_2,...\) is also stationary and ergodic.}

\textbf{Definition 5.23. (Hansen)} \emph{Let \((X_n)_{n\in\mathbb{Z}}\) be a two-sided sequence of real-valued random variables, defined on a background space \((\Omega,\mathbb{F},P)\), and let \(\mathbb{X}\) be their bundling.}
1. \emph{The proces \(\mathbb{X}\) is \textbf{stationary} if the distrbution \(\mathbb{X}(P)\) is an \(S\)-invariant probability on} \(\Big(\mathbb{R}^{\mathbb{Z}},\mathbb{B}^{\otimes \mathbb{Z}}\Big)\),
2. \emph{The proces \(\mathbb{X}\) is \textbf{ergodic} if it is stationary and if the dynamical system} \(\Big(\mathbb{R}^{\mathbb{Z}},\mathbb{B}^{\otimes \mathbb{Z}},\mathbb{X}(P),S\Big)\) \emph{is ergodic.}
3. \emph{The proces \(\mathbb{X}\) is \textbf{mixing} if it is stationary and if the dynamical system} \(\Big(\mathbb{R}^{\mathbb{Z}},\mathbb{B}^{\otimes \mathbb{Z}},\mathbb{X}(P),S\Big)\) \emph{is mixing.}

\textbf{Theorem 5.25. (Hansen)} \emph{(Khintchine's ergodic theorem, two-sided version)\index{Khintchine's ergodic theorem, two-sided version} Let \((X_n)_{n\in\mathbb{Z}}\) be a two-sided sequence of real-valued random variables. If the sequence is stationary and ergodic and if \(E\vert X_1\vert <\infty\) then it holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=1}^nX_i\stackrel{\text{a.s.}}{\to} E\ X_1.\tag{5.30}
\end{align*}
\emph{If \(E\vert X_1\vert^p<\infty\) for some \(p\ge 1\), the convergence is also in \(\mathcal{L}^p\).}

\textbf{Theorem 5.26. (Hansen)} \emph{(Ergodic transformation theorem)\index{Ergodic transformation theorem} Let \((X_n)_{n\in\mathbb{Z}}\) be a two-sided sequence of real-valued random variables. For a measurable function} \(\phi : \big(\mathbb{R}^{\mathbb{Z}},\mathbb{B}^{\otimes\mathbb{Z}}\big)\to (\mathbb{R},\mathbb{B})\) \emph{we define new real-valued random variables}
\begin{align*}
    Y_n=\phi\circ S^{n}(\mathbb{X})\hspace{15pt}\text{for}\ n\in\mathbb{Z}.
\end{align*}
\emph{If \((X_n)_{n\in\mathbb{Z}}\) is stationary and ergodic then \((Y_n)_{n\in\mathbb{Z}}\) is also stationary and ergodic.}

\hypertarget{weak-convergence}{%
\subsection{Weak Convergence}\label{weak-convergence}}

\textbf{Definition 6.1. (Hansen)} \emph{A sequence of probability measures \(\nu_1,\nu_2,...\) on \((\mathbb{R},\mathbb{B})\) is said to \textbf{converge weakly}\index{weakly convergence} to a limit probability measure \(\nu\) if}
\begin{align*}
    \int f\ d\nu_n\to \int f\ d\nu\hspace{15pt}\text{for every}\ f\in C_b(\mathbb{R})\tag{6.2}
\end{align*}
\emph{We write \(\nu_n\stackrel{\text{wk}}{\to} \nu\) to denote weak convergence.}

\textbf{Theorem 6.4. (Hansen)} \emph{(Scheffe's)\index{Scheffe's} Let \(\nu_1,\nu_2,...\) and \(\nu\) be probability measures on \((\mathbb{R},\mathbb{B})\). Assume that for some choice of basic measure \(\mu\) it holds that \(\nu_n=f_n\cdot \mu\) for every \(n\) and \(\nu = f\cdot \mu\) for suitable density functions \(f_n\) and \(f\). If}
\begin{align*}
    f_n(x)\to f(x)\hspace{15pt}\mu\text{-almost surely}
\end{align*}
\emph{then it holds that \(\nu_n\stackrel{\text{wk}}{\to} \nu\).}

\textbf{Lemma 6.8. (Hansen)} \emph{Let \(\mu\) and \(\nu\) be two probability measures on \((\mathbb{R},\mathbb{B})\). If}
\begin{align*}
    \int f\ d\mu=\int f\ d\nu\hspace{15pt}\text{for all}\ f\in C_b(\mathbb{R})\tag{6.7}
\end{align*}
\emph{then it holds that \(\mu=\nu\).}

\textbf{Theorem 6.9. (Hansen)} \emph{Let \(\nu_1,\nu_2,...\) be a sequence of probability measures on \((\mathbb{R},\mathbb{B})\) and let \(\mu\) and \(\nu\) be two extra probability measures. If}
\begin{align*}
    \nu_n\stackrel{\text{wk}}{\to} \mu\hspace{15pt}\text{and}\hspace{15pt}\nu_n\stackrel{\text{wk}}{\to} \nu
\end{align*}
\emph{then \(\mu=\nu\).}

\textbf{Definition 6.10. (Hansen)} \emph{A sequence of real-valued variables \(X_1,X_2,...\), defined on a common background space \((\Omega,\mathbb{F},P)\) is said to \textbf{converge in distrbution}\index{convergence in distribution} to a limit variable \(X\) if}
\begin{align*}
    \int f(X_n)\ dP\to \int f(X)\ dP\hspace{15pt}\text{for every}\ f\in C_b(\mathbb{R}).\tag{6.9}
\end{align*}
We will write \(X_n\stackrel{\mathcal{D}}{\to} X\) to denote convergence in distribution.

\textbf{Lemma 6.11. (Hansen)} \emph{Let \(X_1,X_2,...\) and \(X\) be real-valued random variables. It holds that}
\begin{align*}
    X_n\stackrel{\text{P}}{\to} X\hspace{10pt}\Rightarrow\hspace{10pt} X_n\stackrel{\mathcal{D}}{\to} X.
\end{align*}

\textbf{Lemma 6.12. (Hansen)} \emph{Let \(X_1,X_2,...\) be real-valued random variable and let \(x_0\in\mathbb{R}\). It holds that}
\begin{align*}
    X_n\stackrel{\mathcal{D}}{\to} x_0\hspace{10pt}\Rightarrow\hspace{10pt} X_n\stackrel{\text{P}}{\to} x_0.
\end{align*}

\textbf{Theorem 6.13. (Hansen)} \emph{Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\). Let \(\mathcal{H}\) be a class of bounded, non-negative and measurable functions with the following approximation property: For \(f\in C_b(\mathbb{R})\) with \(f\ge 0\) there is a sequence \(h_1,h_2,...\) of \(\mathcal{H}\)-functions such that \(h_n\nearrow f\). If}
\begin{align*}
    \int h\ d\nu_n\to \int h\ d\nu\hspace{15pt}\text{for all}\ h\in\mathcal{H}.\tag{6.11}
\end{align*}
\emph{then it holds that \(\nu_n\stackrel{\text{wk}}{\to} \nu\).}

\textbf{Theorem 6.14. (Hansen)} \emph{Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\). If}
\begin{align*}
    \int f\ d\nu_n\to \int f\ d\nu\hspace{15pt}\text{for all}\ f\in C_c(\mathbb{R})\tag{6.13}
\end{align*}
\emph{then it holds that \(\nu_n\stackrel{\text{wk}}{\to} \nu\).}

The class \(C_c(\mathbb{R})\) is denoted as the set of all continuous real-valued functions with compact support i.e.~there exist a \(M>0\) such that \(f(x)=0\) for all \(\vert x\vert>M\).

\textbf{Lemma 6.15. (Hansen)} \emph{Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\), and let \(F,F_1,F_2,...\) be the corresponding distribution functions. If \(\nu_n\stackrel{\text{wk}}{\to}\nu\) then it holds that}
\begin{align*}
    F_n(x_0)\to F(x_0),
\end{align*}
\emph{whenever \(x_0\) is a point of continuity for \(F\).}

\textbf{Theorem 6.17. (Hansen)} \emph{(Helly-Bray) Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\), and let \(F,F_1,F_2,...\) be the corresponding distribution functions. It holds that \(\nu_n\stackrel{\text{wk}}{\to}\nu\) if and only if there is a dense subset \(A\subset\mathbb{R}\) such that}
\begin{align*}
    F_n(x)\to F(x)\hspace{15pt}\text{for every}\ x\in A.\tag{6.16}
\end{align*}

\textbf{Theorem 6.18. (Hansen)} \emph{Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\). Let \(F,F_1,F_2,...\) be the corresponding distribution functions, and let \(q,q_1,q_2,...\) be the corresponding quantile functions. If \(\nu_n\stackrel{\text{wk}}{\to}\nu\) then it holds that}
\begin{align*}
    q_n(p)\to q(p)
\end{align*}
\emph{for any \(p\in(0,1)\) such that the equation \(F(x)=p\) hast at most one solution.}

\textbf{Theorem 6.19. (Hansen)} \emph{(Skorokhod's representation theorem)\index{Skorokhod's representation theorem} Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\). If \(\nu_n\stackrel{\text{wk}}{\to} \nu\) then it is possible to find random variables \(X,X_1,X_2,...\) on a background space \((\Omega,\mathbb{F},P)\) such that}
\begin{align*}
    X(P)=\nu,\ X_1(P)=\nu_1,\ X_2(P)=\nu_2, ...
\end{align*}
\emph{and such that \(X_n\stackrel{\text{a.s.}}{\to} X\).}

\textbf{Corollary 6.20. (Hansen)} \emph{Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\) such that \(\nu_n\stackrel{\text{wk}}{\to}\nu\). Let \(h : \mathbb{R}\to\mathbb{R}\) be a bounded and measurable function. If there is a Boral-measurable set \(C\subset \mathbb{R}\) such that \(h\) is continuous in every point of \(C\) and such that \(\nu(C)=1\), then it holds that}
\begin{align*}
    \int h\ d\nu_n\to \int h\ d\nu.\tag{6.20}
\end{align*}

\textbf{Corollary 6.21. (Hansen)} \emph{(Portmanteau's lemma)\index{Portmanteau's lemma} Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\) such that \(\nu_n\stackrel{\text{wk}}{\to}\nu\). For any open set \(G\subset \mathbb{R}\) it holds that}
\begin{align*}
    \liminf{\nu_n(G)}\ge \nu(G)\tag{6.21}
\end{align*}

\textbf{Definition 6.22. (Hansen)} \emph{The \textbf{characteristic function}\index{characteristic function} for a probability measure \(\nu\) on \((\mathbb{R},\mathbb{B})\) is the function \(\phi : \mathbb{R}\to \mathbb{C}\) given by}
\begin{align*}
    \phi(\theta)=\int e^{ix\theta}\ d\nu(x).\hspace{15pt}\text{for}\ \theta\in\mathbb{R}.\tag{6.23}
\end{align*}

Some useful observations include \(\vert e^{ix\theta}\vert = 1\) hence \(\phi(\theta)\le 1\) for all \(\theta\in\mathbb{R}\). We may also split the \(\phi\) into an imaginary part and a real part with Euler's cartesian form
\begin{align*}
    \phi(\theta)=\int \cos (x\theta)\ d\nu(x)+i\int \sin (x\theta)\ d\nu(x)\tag{6.24}
\end{align*}
And lastly we have the implication
\begin{align*}
    \nu_n\stackrel{\text{wk}}{\to} \nu \hspace{10pt}\Rightarrow\hspace{10pt} \phi_n(\theta)\to \phi(\theta)\hspace{10pt}\text{for all}\ \theta\in\mathbb{R}.
\end{align*}
Furthermore, if \(Y=\xi+\sigma X\) and \(X\sim \mathcal{N}(0,1)\) we have
\begin{align*}
    \phi_Y(\theta)=e^{i\xi\theta}e^{-\sigma^2\theta^2/2}.
\end{align*}

\textbf{Theorem 6.28. (Hansen)} \emph{The characteristic function for any probability measure \(\nu\) on \((\mathbb{R},\mathbb{B})\) is uniformly continuous.}

\textbf{Theorem 6.29. (Hansen)} \emph{Let \(\nu\) be a probability measure on \((\mathbb{R},\mathbb{B})\). If}
\begin{align*}
    \int \vert x\vert^k\ d\nu(x)<\infty
\end{align*}
\emph{for some \(k\in\mathbb{N}\), then the characteristic function \(\phi\) is \(C^k\) and it holds that}
\begin{align*}
    \phi^{(k)}(\theta)=i^k\int x^ke^{i\theta x}\ d\nu(x)\hspace{15pt}\text{for}\ \theta\in\mathbb{R}.\tag{6.31}
\end{align*}

\textbf{Definition 6.30. (Hansen)} \emph{The \textbf{convolution}\index{convolution} of two probability measures \(\nu\) and \(\xi\) on \((\mathbb{R},\mathbb{B})\) is the image measure}
\begin{align*}
    \nu * \xi=\kappa (\nu\otimes\xi)\tag{6.33}
\end{align*}
\emph{where \(\kappa : \mathbb{R}^2\to\mathbb{R}\) is the addition map \(\kappa(x,y)=x+y\).}

\textbf{Theorem 6.31. (Hansen)} \emph{Let \(\nu\) and \(\xi\) be two probability measures on \(\mathbb{R}\). If \(\xi=f\cdot m\), then the convolution \(\nu*\xi\) will have a density with respect to \(m\). The density is given as}
\begin{align*}
    g(x)=\int f(x-y)\ d\nu(y)\hspace{15pt}\text{for}\ x\in\mathbb{R}.\tag{6.35}
\end{align*}

\textbf{Lemma 6.31. (Hansen)} \emph{Let \(\nu_1\) and \(\nu_2\) be two probability measures on \((\mathbb{R},\mathbb{B})\) with characteristic functions \(\phi_1\) and \(\phi_2\). The convolution \(\nu_1*\nu_2\) has characteristic function \(\gamma\) given by}
\begin{align*}
    \gamma(\theta)=\phi_1(\theta)\phi_2(\theta)\hspace{15pt}\text{for}\ \theta\in\mathbb{R}.\tag{6.37}
\end{align*}

\textbf{Theorem 6.34. (Hansen)} \emph{Let \(\xi,\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\). It holds that}
\begin{align*}
    \nu_n\stackrel{\text{wk}}{\to} \nu\hspace{10pt}\Rightarrow\hspace{10pt} \nu_n*\xi\stackrel{\text{wk}}{\to} \nu *\xi.
\end{align*}

\textbf{Definition 6.35. (Hansen)} \emph{A probability measure \(\nu=f\cdot m\) on \((\mathbb{R},\mathbb{B})\) with density \(f\) with respect to Lebesgue measure is of \textbf{Polya class}\index{Polya class} if \(f\in C_b(\mathbb{R})\) and if the Fourier transform \(\hat{f}\) is \(m\)-integrable.}

\textbf{Lemma 6.39. (Hansen)} \emph{Let \(\nu\) and \(\xi\) be two probability measures on \(\mathbb{R}\). If \(\xi\) is of Polya class then the convolution \(\nu *\xi\) is also of Polya class.}

\textbf{Theorem 6.40. (Hansen)} \emph{(Inversion theorem)\index{Inversion theorem} Let \(\nu=f\cdot m\) be a probability measure on \((\mathbb{R},\mathbb{B})\) of Polya class. It holds that}
\begin{align*}
    f(x)=\frac{1}{2\pi}\int_{-\infty}^\infty e^{-i\theta x}\hat{f}(\theta)\ d\theta,\ x\in\mathbb{R}.\tag{6.39}
\end{align*}

\textbf{Theorem 6.41. (Hansen)} \emph{Let \(\nu_1\) and \(\nu_2\) be two probability measures on \((\mathbb{R},\mathbb{B})\) with characteristic functions \(\phi_1\) and \(\phi_2\). If}
\begin{align*}
    \phi_1(\theta)=\phi_2(\theta),\ \forall \theta \in\mathbb{R}
\end{align*}
\emph{then \(\nu_1=\nu_2\).}

\textbf{Lemma 6.42. (Hansen)} \emph{Let \(f : \mathbb{R}\to\mathbb{R}\) be bounded and uniformly continuous. For every \(\varepsilon>0\) there is a probability measure \(\xi\) of Polya class with the property that}
\begin{align*}
    \Big\vert f(x)-\int f(x+y)\ d\xi(y)\Big\vert<\varepsilon,\ \forall x\in\mathbb{R}.\tag{6.43}
\end{align*}

\textbf{Theorem 6.43. (Hansen)} \emph{(Continuity theorem)\index{Continuity theorem} Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \((\mathbb{R},\mathbb{B})\) with characteristic functions \(\phi,\phi_1,\phi_2,...\). If}
\begin{align*}
    \phi_n(\theta)\to \phi(\theta),\ \theta\in\mathbb{R},\tag{6.45}
\end{align*}
\emph{then it holds that \(\nu_n\stackrel{\text{wk}}{\to}\nu\).}

\textbf{Definition 6.44. (Hansen)} \emph{A sequence of probability measures \(\nu_1,\nu_2,...\) on \(\big(\mathbb{R}^k,\mathbb{B}_k\big)\) is said to \textbf{converge weakly} to a limit probability measure \(\nu\) if}
\begin{align*}
    \int f(x)\ d\nu_n(x)\to\int f(x)\ d\nu(x), \forall f\in C_b(\mathbb{R}^k).\tag{6.46}
\end{align*}
\emph{We will write \(\nu_n\stackrel{\text{wk}}{\to}\nu\) to denote weak convergence.}

\textbf{Theorem 6.45. (Hansen)} \emph{(Continuity theorem)\index{Continuity theorem} Let \(\nu,\nu_1,\nu_2,...\) be probability measures on \(\big(\mathbb{R}^k,\mathbb{B}_k\big)\) with characteristic functions \(\phi,\phi_1,\phi_2,...\). If}
\begin{align*}
    \phi_n(\theta)\to \phi(\theta),\ \theta\in\mathbb{R}^k,\tag{6.47}
\end{align*}
\emph{then it holds that \(\nu_n\stackrel{\text{wk}}{\to}\nu\).}

\textbf{Lemma 6.46. (Hansen)} \emph{Let \(\mathbf{X}\) be an \(\mathbb{R}^k\)-valued random variable with characteristic function \(\phi_\mathbf{X}\), and let \(\mathbf{Y}\) be an \(\mathbb{R}^m\)-valued random variable with characteristic function \(\phi_\mathbf{Y}\). If \(\mathbf{X} \perp \!\!\! \perp \mathbf{Y}\) then the bundle \((\mathbf{X},\mathbf{Y})\) is an \(\mathbb{R}^{k+m}\)-valued random variable with}
\begin{align*}
    \phi_{(\mathbf{X},\mathbf{Y})}(\theta_1,\theta_2)=\phi_\mathbf{X}(\theta_1)\phi_\mathbf{Y}(\theta_2),\ \theta_1\in\mathbb{R}^k,\theta_2\in\mathbb{R}^m.\tag{6.49}
\end{align*}

\textbf{Theorem 6.47. (Hansen)} \emph{(Continuous mapping theorem)\index{Continuity mapping theorem} Let \(\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{X}\) be random variables with values in \(\mathbb{R}^k\), and let \(h : \mathbb{R}^k\to\mathbb{R}^m\) be continuous. If \(\mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{X}\), then it holds that \(h(\mathbf{X}_n)\stackrel{\mathcal{D}}{\to} h(\mathbf{X})\).}

\textbf{Theorem 6.48. (Hansen)} \emph{(Cramer-Wold's device)\index{Cramer-Wold's device} Let \(\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{X}\) be random variables with values in \(\mathbb{R}^k\). If}
\begin{align*}
    \mathbf{v}^\top\mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{v}^\top\mathbf{X},\tag{6.51}
\end{align*}
\emph{for any fixed vector \(\mathbf{v}\in\mathbb{R}^k\), then it holds that \(\mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{X}\).}

\textbf{Lemma 6.49. (Hansen)} \emph{Let \(\mathbf{X},\mathbf{X}_1,\mathbf{X}_2,...\) be random variables with values in \(\mathbb{R}^k\), let \(\mathbf{Y}_1,\mathbf{Y}_2,...\) be random variables in \(\mathbb{R}^m\), and let \(\mathbf{y}\) be a vector in \(\mathbb{R}^m\). If it holds that}
\begin{align*}
    \mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{X},\hspace{15pt}\mathbf{Y}_n\stackrel{\text{P}}{\to} \mathbf{y}
\end{align*}
\emph{then the bundle \((\mathbf{X}_n,\mathbf{Y}_n)\) in \(\mathbb{R}^{k+m}\) will satisfy that}
\begin{align*}
    (\mathbf{X}_n,\mathbf{Y}_n)\stackrel{\mathcal{D}}{\to} (\mathbf{X},\mathbf{y}).
\end{align*}

\textbf{Corollary 6.50. (Hansen)} \emph{(Slutsky's lemma)\index{Slutsky's lemma} Let \(\mathbf{X},\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{Y}_1,\mathbf{Y}_2,...\) be random variables with values in \(\mathbb{R}^k\). It holds that}
\begin{align*}
    \mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{X},\hspace{10pt}\mathbf{Y}_n\stackrel{\text{P}}{\to} \mathbf{0}\hspace{10pt}\Rightarrow\hspace{10pt} \mathbf{X}_n+\mathbf{Y}_n\stackrel{\mathcal{D}}{\to}\mathbf{X}.
\end{align*}

\textbf{Corollary 6.51. (Hansen)} \emph{Let \(\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{X}\) be random variables with values in \(\mathbb{R}^k\) and let \(Y_1,Y_2,...\) be real-valued random variables. It holds that}
\begin{align*}
    \mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{X},\hspace{10pt}Y_n\stackrel{\text{P}}{\to} 1\hspace{10pt}\Rightarrow\hspace{10pt} Y_n\mathbf{X}_n\stackrel{\mathcal{D}}{\to}\mathbf{X}.
\end{align*}

\textbf{Corollary 6.52. (Hansen)} \emph{Let \(\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{X}\) be random variables with values in \(\mathbb{R}^k\) and let \(Y_1,Y_2,...\) be real-valued random variables. If}
\begin{align*}
    \mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{X},\hspace{10pt}Y_n\stackrel{\text{P}}{\to} 0\hspace{10pt}\Rightarrow\hspace{10pt} Y_n\mathbf{X}_n\stackrel{\text{P}}{\to} \mathbf{0}.
\end{align*}

\textbf{Definition 6.53. (Hansen)} \emph{The \(\mathbb{R}^k\)-valued random variable \(\mathbf{Z}=(Z_1,...,Z_k)\) has a \textbf{multivariate Gaussian distribution}\index{multivariate Gaussian distribution} if and only if the real-valued random variable \(\sum_{j=1}^kc_jZ_j\) has a one-dimensional Gaussian distribution for every choice of \(c_1,...,c_k\in\mathbb{R}\).}

\textbf{Theorem 6.54. (Hansen)} \emph{Let \(\mathbf{Z}=(Z_1,...,Z_k)\) have a multivariate Gaussian distribution with \(E\ \mathbf{Z}=\xi\) and \(V\ \mathbf{Z}=\Sigma\). Then the characteristic function is}
\begin{align*}
    \phi_\mathbf{Z}(\theta)=e^{i\theta^\top\xi}\exp\left(-\frac{1}{2}\theta^\top\Sigma\theta\right),\ \theta\in\mathbb{R}^k.\tag{6.53}
\end{align*}
\emph{Conversly, if \(\mathbf{Z}\) has characteristic function given by (6.53) for some \(\xi\in\mathbb{R}^k\) and some symmetric, positive semi-definite \(k\times k\) matrix \(\Sigma\) then \(\mathbf{Z}\) has a multivariate Gaussian distribution with \(E\ \mathbf{Z}=\xi\) and \(V\ \mathbf{Z}=\Sigma\).}

\textbf{Corollary 6.55. (Hansen)} \emph{Let \(\mathbf{Z}\) be an \(\mathbb{R}^k\)-valued random variable, let \(\mathbf{a}\in\mathbb{R}^m\) and let \(B\) be an \(m\times k\) matrix. It holds that}
\begin{align*}
    \mathbf{Z}\sim \mathcal{N}(\xi,\Sigma)\hspace{10pt}\Rightarrow\hspace{10pt} \mathbf{a}+B\mathbf{Z}\sim \mathcal{N}\left(\mathbf{a}+B\xi,B\Sigma B^\top\right).
\end{align*}

\textbf{Lemma 6.56. (Hansen)} \emph{Let \(\mathbf{X}=(X_1,...,X_k)\) and \(\mathbf{Y}=(Y_1,...,Y_m)\) be random variables with values in \(\mathbb{R}^k\) respectively \(\mathbb{R}^m\). If both \(\mathbf{X}\) and \(\mathbf{Y}\) have multivariate Gaussian distributions and if \(\mathbf{X}\) and \(\mathbf{Y}\) are independent, then the \(\mathbb{R}^{k+m}\)-valued bundle \((\mathbf{X},\mathbf{Y})\) has a multivariate Gaussian distribution.}

\textbf{Lemma 6.58. (Hansen)} \emph{Let \(\mathbf{X}=(X_1,...,X_k)\) and \(\mathbf{Y}=(Y_1,...,Y_m)\) be random variables with values in \(\mathbb{R}^k\) respectively \(\mathbb{R}^m\). If the \(\mathbb{R}^{k+m}\)-valued bundle \((\mathbf{X},\mathbf{Y})\) has a multivariate Gaussian distribution, and if}
\begin{align*}
    \text{Cov}(X_j,Y_l)=0,\ \forall j\text{ and }l
\end{align*}
\emph{then \(\mathbf{X}\perp \!\!\! \perp\mathbf{Y}\).}

\textbf{Definition 6.59. (Hansen)} \emph{Let \(\mathbf{X}_1,\mathbf{X}_2,...\) be \(\mathbb{R}^k\)-valued random variables. Let \(\xi\in\mathbb{R}^k\) be a vector and let \(\Sigma\) be a symmetric, positive semi-definite \(k\times k\) matrix.}
\emph{We sat that \(\mathbf{X}_n\) has an \textbf{asymptotic normal distribution}\index{asymptotic normal distribution} with parameters \(\big(\xi,\frac{1}{n}\Sigma\big)\), written}
\begin{align*}
    \mathbf{X}_n\stackrel{\text{a.s.}}{\sim}\mathcal{N}\left(\xi,\frac{1}{n}\Sigma\right),
\end{align*}
\emph{if it holds that}
\begin{align*}
    \sqrt{n}(\mathbf{X}_n-\xi)\stackrel{\mathcal{D}}{\to} \mathcal{N}(0,\Sigma).
\end{align*}

\textbf{Lemma 6.60. (Hansen)} \emph{Let \(\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{Y}\) be random variables with values in \(\mathbb{R}^k\). If it holds that \(\mathbf{X}_n\stackrel{\text{a.s.}}{\sim} \mathcal{N}(\xi,\frac{1}{n}\Sigma)\) then it follows that \(\mathbf{X}_n\stackrel{\text{P}}{\to}\xi\).}

\textbf{Lemma 6.61. (Hansen)} \emph{Let \(\mathbf{X}_1,\mathbf{X}_2,...\) and \(\mathbf{Y}\) be \(\mathbb{R}^k\)-valued random variables, and assume that \(\sqrt{n}\mathbf{X}_n\stackrel{\mathcal{D}}{\to} \mathbf{Y}\). Let \(g : \mathbb{R}^k\to \mathbb{R}^m\) be a measurable map. Assume that \(g(\mathbf{0})=\mathbf{0}\) and that \(g\) is differentiable in \(\mathbf{0}\) with deriviate \(Dg(\mathbf{0})=A\). Then it holds that}
\begin{align*}
    \sqrt{n}g(\mathbf{X}_n)\stackrel{\mathcal{D}}{\to} A\ \mathbf{Y}.
\end{align*}

\textbf{Lemma 6.62. (Hansen)} \emph{(Delta method)\index{Delta method} Let \(\mathbf{X}_1,\mathbf{X}_2,...\) be \(\mathbb{R}^k\)-valued random variables, and let \(f : \mathbb{R}^k\to \mathbb{R}^m\) be measurable. If \(f\) is differentiable in \(\xi\), then it holds that}
\begin{align*}
    \mathbf{X}_n\stackrel{\text{a.s.}}{\sim} \mathcal{N}\left(\xi,\frac{1}{n}\Sigma\right)\hspace{10pt}\Rightarrow\hspace{10pt} f(\mathbf{X}_n)\stackrel{\text{a.s.}}{\sim} \mathcal{N}\left(f(\xi),\frac{1}{n}Df(\xi)\Sigma Df(\xi)^\top\right).
\end{align*}

\hypertarget{central-limit-theorems}{%
\subsection{Central Limit Theorems}\label{central-limit-theorems}}

\textbf{Lemma 7.1. (Hansen)} \emph{Let \(z_1,...,z_n\) and \(w_1,...,w_n\) be complex numbers. If \(\vert z_i\vert \le 1\) and \(\vert w_i\vert\le 1\) for all \(i=1,...,n\) then it holds that}
\begin{align*}
    \left\vert\prod_{i=1}^n z_i-\prod_{i=1}^n w_i\right\vert\le \sum_{i=1}^n \vert z_i-w_i\vert.\tag{7.1 }
\end{align*}

\textbf{Theorem 7.2. (Hansen)} \emph{(Basic CLT)\index{Basic CLT} Let \(X_1,X_2,...\) be independent and identically distributed real-valued random variables. Assume that \(E\ X_1=0\) and \(E\ X_1^2=1\). Then it holds that}
\begin{align*}
    \frac{1}{\sqrt{n}}\sum_{i=1}^nX_i\stackrel{\mathcal{D}}{\to} \mathcal{N}(0,1)\tag{7.3}
\end{align*}

\textbf{Theorem 7.3. (Hansen)} \emph{(Laplace's CLT)\index{Laplace's CLT} Let \(X_1,X_2,...\) be independent and identically distributed real-valued random variables with \(E\ X_1^2<\infty\). It holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=1}^nX_i\stackrel{\mathcal{D}}{\to} \mathcal{N}\left(E\ X_1,\frac{V\ X_1}{n}\right)\tag{7.4}
\end{align*}

\textbf{Theorem 7.7. (Hansen)} \emph{(Laplace's CLT, multivariate version)\index{Laplace's CLT, multivariate version} Let \(\mathbf{X}_1,\mathbf{X}_2,...\) be independent and identically distributed random variables with values in \(\mathbb{R}^k\). Assume that \(E\vert \mathbf{X}_1\vert^2<\infty\). It holds that}
\begin{align*}
    \frac{1}{n}\sum_{i=1}^n\mathbf{X}_i\stackrel{\mathcal{D}}{\to} \mathcal{N}\left(E\ \mathbf{X}_1,\frac{1}{n}V\ \mathbf{X}_1\right)\tag{7.7}
\end{align*}

\textbf{Definition 7.10. (Hansen)} \emph{Let \((X_{nm})\) be a centralized array of real-valued random variables.}
a. \emph{The array satisfies the \textbf{vanishing variance condition}\index{vanishing variance condition} if}
\begin{align*}
      \max_{m=1,...,n}E\ X_{nm}^2\to 0.\tag{7.8}
  \end{align*}
b. \emph{The array satisfies \textbf{Lindeberg's condition}\index{Lindeberg's condition} if}
\begin{align*}
      \forall c>0:\hspace{15pt}\sum_{m=1}^n\int_{(\vert X_{nm}\vert>c)}X_{nm}^2\ dP\to 0.\tag{7.9}
  \end{align*}
c.~\emph{The array satisfies \textbf{Lyapounov's condition}\index{Lyapounov's condition} of order \(\alpha>2\) if}
\begin{align*}
      \sum_{m=1}^nE\ \vert X_{nm}\vert ^\alpha\to 0.\tag{7.10}
  \end{align*}

\textbf{Lemma 7.11. (Hansen)} \emph{Lyapounov's condition of order \(\alpha>2\) implies Lindeberg's condition.}

\textbf{Lemma 7.12. (Hansen)} \emph{Lindeberg's condition implies the vanishing variance condition.}

\textbf{Theorem 7.14. (Hansen)} \emph{(Lindeberg's CLT)\index{Lindeberg's CLT} Let \((X_{nm})\) be a centralized array of real-valued random variables with \(E\ X_{nm}^2<\infty\). Assume that the array satisfies that}
\begin{align*}
    E\ X_{nm}=0,\ \forall n,m,
\end{align*}
\emph{and that}
\begin{align*}
    \sum_{m=1}^n E\ X^2_{nm}=1.\tag{7.13}
\end{align*}
\emph{Assume that the array has independence within rows i.e.~\(X_{i1}\perp \!\!\! \perp ... \perp \!\!\! \perp X_{ii}\) for all \(i=1,...,n\) and satisfies Lindeberg's condition. Then it holds that}
\begin{align*}
    \sum_{m=1}^nX_{nm}\stackrel{\mathcal{D}}{\to} \mathcal{N}(0,1).
\end{align*}

\textbf{Theorem 7.19. (Hansen)} \emph{(Lindeberg's CLT, multivariate version)\index{Lindeberg's CLT, multivariate version} Let \((\mathbf{X}_{nm})\) be a triangular array of random variables with values in \(\mathbb{R}^k\) with \(E\ \vert \mathbf{X}_{nm}\vert^2<\infty\) for all \(n\), \(m\). Assume that}
\begin{align*}
    E\ \mathbf{X}_{nm}=\mathbf{0},\ \forall n,m
\end{align*}
\emph{and}
\begin{align*}
    \sum_{m=1}^n V\ \mathbf{X}_{nm}\to \Sigma
\end{align*}
\emph{for a fixed \(k\times k\) matrix \(\Sigma\). Assume that the array has independence within rows, and assume that the associated real-valued array \((\vert\mathbf{X}_{nm}\vert )\) satisfies Lindeberg's condition. Then it holds that}
\begin{align*}
    \sum_{m=1}^n\mathbf{X}_{nm}\stackrel{\mathcal{D}}{\to} \mathcal{N}(\mathbf{0},\Sigma)
\end{align*}

\hypertarget{markov-chains}{%
\chapter{Markov Chains}\label{markov-chains}}

\hypertarget{definition-of-a-markov-chain}{%
\section{Definition of a Markov Chain}\label{definition-of-a-markov-chain}}

\textbf{Transitionsdiagram.} Et diagram, hvor der fremgår ssh. for et system overgår til et nyt stadie.

\begin{center}\includegraphics[width=0.4\linewidth]{_main_files/figure-latex/unnamed-chunk-16-1} \end{center}

\textbf{Definition.} \textbf{(Stokastisk process i diskret tid)} \emph{Lad \(\mathcal{X}=(\mathcal{X}_n)_{n\in\mathbb{N}_0}\) være en familie af stokastiske variable og \(\mathcal{S}\) et udfaldsrum . Da er \(\mathcal{X}\) en funktion der opfylder \(\mathcal{X} : \mathbb{N}_0\times \Omega \to \mathcal{S}\) med \((n,w) \mapsto \mathcal{X}_n(w)\).}

\textbf{Bemærkning.}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \(\mathbb{N}_0\) er tidsvariablen senere \([0,\infty)\)
\item
  \(\mathcal{S}\) er højst tællelig
\end{enumerate}

\textbf{Definition.} \textbf{(Markov kæder i diskret tid)} \emph{En stokastisk proces i diskret tid \((X_n)_{n\in\mathbb{N}_0}\) har \textit{Markov egenskaben} hvis for alle stadier \(i_0,...,i_n\in\mathcal{S}\) opfylder}

\[
\mathbb{P}(\mathcal{X}_n=i_n\vert \mathcal{X}_0,...,\mathcal{X}_{n-1}=i_{n-1})=\mathbb{P}(\mathcal{X}_n=i_n \vert \mathcal{X}_{n-1}=i_{n-1}).
\]

\emph{Da kaldes denne stokastiske proces en Markov kæde. Dvs. For hvert \(n\) er det næste udfald kun afhængig af dette forrige udfald.}

\textbf{Definition.} \textbf{(Initial fordeling)} \emph{For alle \(i\in\mathcal{S}\) tilhører en initial sandsynlighed for at starte i stadiet \(i\) givet ved}

\[
\phi(i):=\mathbb{P}(\mathcal{X}_0=i),
\]

\emph{hvor familien \(\overline{\phi}=(\phi(i))_{i\in\mathcal{S}}\) er initial fordelingen i.e.~\(\phi\) er en vektor over alle mulige startsudfald og deres tilhørende ssh. Hvis \(\mathcal{S}\) er endelig er \(\overline{\phi}\) blot en rækkevektor.}

\textbf{Definition.} \textbf{(Transitionsmatricen)} \emph{For to stadier \(i,j\in\mathcal{S}\) og et tidspunkt \(n\) er transitionssandsynligheden for at flytte fra \(i\) til \(j\) er}

\[
P_{ij}(n)=\mathbb{P}(\mathcal{X}_{n+1}=j \vert \mathcal{X}_n=i).
\]

\emph{Hvis \(P_{ij}(n)=P_{ij}(m)\) for alle \(n,m\in\mathbb{N}_0\) så kaldes \((\mathcal{X}_n)_{n\in\mathbb{N}_0}\) \textbf{tidshomogent (definition 1)}. Den tilhørende matrice \(P=(P_{ij})_{i,j\in\mathcal{S}}\) er kaldet transitionsmatricen.}

\textbf{Bemærkning.} En transitionsmatrice karrakteriserer et transitions diagram og omvendt. \textit{Eksempel til figur 1}

\[
P=\begin{pmatrix}
2/3 & 1/3\\
1/2 & 1/2
\end{pmatrix}.
\]

\textbf{Theorem 2.} \textbf{(Fordeling af \(\mathcal{X}_n\))} \emph{For en Markov kæde på \(\mathcal{S}\) med initial fordeling \(\phi\) og transitionsmatrix \(P\) er}

\[
(\mathbb{P}(X_n=i))_{i\in\mathcal{S}}=\overline{\phi} P^n
\]

\hypertarget{classification-of-states}{%
\section{Classification of states}\label{classification-of-states}}

\textbf{Definition 4.} \textbf{(Communication classes)} \emph{Lad \(i,j\in\mathcal{S}\) være to stadier. Vi definere \(i\longrightarrow j\) dvs. \(j\) er \textbf{accesible} fra \(i\), hvis der eksisterer et \(n\in\mathbb{N}\) så \(P_{ij}^n>0\). Samt \(i\longleftrightarrow j\) dvs. \(i\) og \(j\) kommunikerer, hvis både \(i\longrightarrow j\) og \(j\longrightarrow i\).}

\textbf{Bemærkning.} ``\(i\longleftrightarrow j\)'' er en ækvivalens relation. Derfor sepererer denne relation \(\mathcal{S}\) ind i to disjunkte ækvivalens klasser, hvad vi definerer som \emph{communication classes}.

\textbf{Definition 6.} \textbf{(Lukket kommunikations klasser)} \emph{En kommunikations klasse \(e\subseteq \mathcal{S}\) kaldes lukket, hvis for alle \(i\in e\) gælder \(\sum_{i\in e}P_{ij}=1\) (den \(i\)'te søjlesummen sum er lig 1 eller ssh. for at forblive i klassen er 1).}

\textbf{Definition.} \textbf{(Ikke reducibel Markov kæde)} \emph{En Markov kæde kaldes irreducible, hvis der eksisterer kun en kommunikations klasse. Ellers er den reducible.}

\textbf{Definition.} \textbf{(Hitting time)} \emph{Tiden for at ramme \(i\in \mathcal{S}\) er givet ved \(T_i:=\inf\{n>0 \vert X_n=i\}\). Hvis \(X_0=i\) kaldes denne tid \textbf{return/recurrence} tiden.}

\textbf{Definition 9.} \textbf{(Recurrance/transients)} \emph{For en Markov kæde \((X_n)_{n\in\mathbb{N}}\) på \(\mathcal{S}\) er et stadie \(i\in\mathcal{S}\) kaldet \textbf{recurrent} hvis \(\mathbb{P}(T_i<\infty \vert X_0=i)=1\). Ellers kaldes \(i\) \textbf{transient}.}

\textbf{Bemærkning.} Det kan vises at \(\mathbb{P}(T_i<\infty \vert X_0=i)=1\) er ensbetydende med at \(\mathbb{P}(N_i=+\infty \vert X_0=i)=1\). (se Thm 14 i noterne)

\textbf{Theorem 11.} \textbf{(Recurrence criterium 1)} \emph{For en Markov kæde på \(\mathcal{S}\) med transistionsmatrice \(P\), da er følgende ækvivalent. Det holder at \(\sum_{n=1}^\infty (P^n)_{ii}=+\infty\) og \(i\) er recurrent.}

\textbf{Theorem 12.} \textbf{(Recurrence som klasseegenskab)} \emph{Alle stadier i en kommunikations klasse er enten recurrent eller transient dvs. hvis blot en af stadierne \(i\in e\) er recurrent er alle recurrent og ligeledes med transient.}

\textbf{Theorem 13.} \textbf{(Antal af besøg)} \emph{Antal af besøg er givet ved den stokastiske variabel \(N_i:=\sum_{n=1}^\infty 1(X_n=i)\). Hvis \(i\) er recurrent er \(\mathbb{P}(N_i=+\infty)=1\), hvis \(i\) er transient er \(N_i\sim Geo(q)\) på \(N_0\) dvs. \(\mathbb{P}(N_i=k)=(1-q)^kq\) for \(k\in\mathbb{N}_0\) og \(q=P(T_i=+\infty\vert X(0)=i)\).}

\textbf{Theorem 14.} \emph{For en endelig kommunikationsklasse \(C\subseteq S\) gælder: (\(C\) er recurrent) \(\Leftrightarrow\) (\(C\) er lukket.)}

\textbf{Theorem 16.} \textbf{(Recurrence criterium 2)} \emph{For en irreducibel Markov Kæde på \(S\) gælder (\(i\in S\) er recurrent) \(\Leftrightarrow\) (For ligningssystemmet \(\alpha(j)=\sum_{k\ne i}P_{j,k}\alpha(k)\) gælder \(\alpha(j)=0\) for alle \(j\ne i\) er den eneste endelige løsning).}

\textbf{Generaliseret matrix multiplikation.} For \(\underline{\phi}=(\phi_i)_{i\in\mathcal{S}},\underline{\psi}=(\psi_i)_{i\in\mathcal{S}}\) \emph{(vektorer)} og \(P=(P_{ij})_{i,j\in\mathcal{S}},Q=(Q_{ij})_{i,j\in\mathcal{S}}\) \emph{(matricer)} kan følgende produkter udregnes ved

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \((\underline{\phi}\cdot \underline{\psi}^T):=\sum_{i\in\mathcal{S}}\phi_i\psi_i\)
\item
  \((\underline{\phi}\cdot P)_j:=\left(\sum_{i\in\mathcal{S}}\phi_i P_{ij}\right)_j\)
\item
  \((P\cdot Q)_{ij}:=\sum_{k,l\in\mathcal{S}}P_{i,k}Q_{l,j}\)
\end{enumerate}

\hypertarget{limit-results-and-invariant-probabilities}{%
\section{Limit results and invariant probabilities}\label{limit-results-and-invariant-probabilities}}

\textbf{Sidenote.} For en vektor \(\overline{\phi}=(\phi_i)_{i\in \mathcal{S}}\) kaldes en fordeling, hvis for alle \(i\in\mathcal{S}\) er \(\phi_i\ge0\) og \(\sum_{i\in\mathcal{S}}\phi_i=1\) og et mål hvis kun \(\phi_i\ge 0\).

\textbf{Definition 18.} \textbf{(Løkker og perioder)} \emph{For en Markov kæde i diskret tid er en mulig løkke af længde \(n\) er en følge af stadier \(i_0,i_1,i_2,...,i_n\in\mathcal{S}\) med \(i_0=i_n\) hvor}

\[
P_{i_0,i_1}\cdots P_{i_{n-1},i_n}>0
\]

\emph{Perioden af et stadie \(i\in\mathcal{S}\) er den største fælles divisor af}

\[
D_i=\{n\in\mathbb{N}\ \vert\ \exists \text{a possible loop of length $n$ med $i_0=i_n=i$}\},
\]

\emph{dvs. \(\text{per}(i)=GCD(D_i)\). Hvis perioden er 1 kaldes stadiet \textbf{aperiodisk}.}

\textbf{Theorem 19.} \emph{Alle stadier i en kommunikations klasse har samme periode.}

\textbf{Theorem 21.} \emph{For en irreducibel, recurrent og ikkeperiodisk Markov kæde på \(\mathcal{S}\) gælder for alle \(i\in\mathcal{S}\) at}

\[
\lim_{n\to\infty}P(X_n=i)=\frac{1}{E[T_i \vert X_0=i]}
\]

\emph{Hvis \(E[T_i \vert X_0=i]=\infty\) defineres \(\lim_{n\to\infty}P(X_n=i):=0\).}

\textbf{Bemærkning.} 1) Kun hvis Markov kæden er recurrent og dermed at \(P(T_i=\infty \vert X_i=0)=0\) er \(E[T_i \vert X_0=i]=\sum_{n=1}^\infty nP(T_i=n\vert X_0=i)\) eller er \(E[T_i \vert X_0=i]=+\infty\). 2) Hvis \(E[T_i \vert X_0=i]=\infty\) så er grænsen ikke en fordeling.

\textbf{Definition 22.} \emph{Et recurrent stadie \(i\in\mathcal{S}\) kaldes positivt recurrent hvis og kun hvis \(E[T_i \vert X_0=i]<\infty\). Ellers kaldes stadiet nul-recurrent.}

\textbf{Definition.} \textbf{(Invariant fordeling og mål)} \emph{En ikke negativ vektor \(\overline{\pi}=(\pi_j)_{j\in S}\) kaldes et invariant mål, hvis \(\overline{\pi}=\overline{\pi}P\) og en invariant fordeling, hvis \(\vert\overline{\pi}\vert\).}

\textbf{Theorem 23.} \emph{For en irreducibel og recurrent Markov kæde på \(\mathcal{S}\) findes et invariant mål \(\nu\) der opfylder \(\nu =\nu P\). Specielt gælder for alle fixed \(i\in\mathcal{S}\) holder det at}

\[
\nu_j=E\left[\sum_{n=0}^{T_i-1}1(X_n=j \vert X_0=i)\right] \text{for alle } j\in\mathcal{S}
\]

\emph{er et invariant mål. Hvis og kun hvis Markov kæden er positiv recurrent kan ovenstående nomaliseres til en invariant fordeling.}

\textbf{Bemærkning.} 1) \(i\in\mathcal{S}\) er abitrær, 2) \(\nu(i)=1\) og 3) for irreducible MC gælder (Positiv recurrent) \(\Leftrightarrow\) (Eksisterer unik invariant fordeling)

\textbf{Theorem 24.} \emph{or en irreducibel, aperiodisk og positiv recurrent Markov kæde gælder \(\lim_{n\to\infty}P(X_n=j)=\pi_j=1/E[T_j\vert X_0=j]\). Hvor \(\overline{\pi}=(\pi_j)_{j\in S}\) er en invariant fordeling.}

\textbf{Theorem 25 og 26.} \textbf{(Grænseresultat for nul-recurrance og tranience)} \emph{For et nul-recurrent (THM 25) eller transient (THM 26) stadie \(j\in S\) gælder \(\lim_{n\to\infty}P(X_n=j)=0\) for alle valg af initialfordeling \(\overline{\phi}\).}

\textbf{Theorem 27.} \textbf{(Grænseresultat for periodiske stadier)} \emph{For en irreducibel Markov kæde med periode \(d>1\) findes grænsen \(\lim_{n\to \infty}P(X_n=i)\) ikke. Men gennemsnittet for en periode gør dvs}

\[
\nu_j=\lim_{n\to\infty}\frac{P(X_n=i)+P(X_{n+1}=i)+...+P(X_{n+d-1}=i)}{d}
\]

\emph{\(\nu=(\nu_j)_{j\in S}\) er et invariant mål og en invariant fordeling hvis \(\vert\nu\vert=1\).}

\hypertarget{absorbing-probabilities}{%
\section{Absorbing probabilities}\label{absorbing-probabilities}}

\textbf{Theorem 29.} \textbf{(Absorberende sandsynlighed - endelige udfaldsrum)} \emph{Lad en endelig Markov kæde være givet ved transistionsmatricen \(P\). Antaget at transtionsmatricen kan inddeles efter kummunikations klasser så}

\[
P=
\left[
\begin{array}{c|c}
\tilde{P} & 0 \\
\hline
     S & Q
\end{array}
\right],
\]

\emph{hvor \(\tilde{P}\) er transistionsmatricen indeholdende kun recurrent stadier. Dertil er \(Q\) og \(S\) sub-matricer af \(P\), hvor \(Q\) indeholder de transient stadier og \(S\) beskriver sandsynlighederne for overgangen fra et transient til et recurrent stadie. Matricen 0 repræsenterer sandsynligheden for at gå fra en recurrent til transient stadie, hvad er umuligt.}

Definer dertil matricerne \(M=(I-Q)^{-1}\) og \(A=(I-Q)^{-1}S\). Tallet \(M_{i,j}\) repræsenterer \(E[N_j\vert X_0=i]\) for transient stadier \(i,j\). Tallet \(A_{i,j}\) repræsenterer sandsynligheden for at \(j\) er det første recurrent stadie, der besøger hvis \(X_0=i\) for et transient stadie \(i\).

\textbf{Theorem 31.} \textbf{(Absorberende sandsynlighed - tællelige udfaldsrum)} \emph{For en Markov kæde på \(S\) lad \(C\subseteq S\) være en recurrent klasse og \(C'\in S\setminus C\) være en transient klasse. Absorberingssandsynligheden \((\alpha_j)_{j\in C'}\) givet ved \(\alpha_j=P(X_n\in C \vert X_0=j)\) løser ligningssystemet}

\[
\alpha_i=\sum_{l\in S\setminus C}P_{i,l}\alpha_l+\sum_{l\in C}P_{i,l}
\]

\emph{Der findes en endelig løsning hvis og kun hvis \(\lim_{n\to\infty}P(X_n\in C'\vert X_o\in C')=0\).}

\hypertarget{markov-chains-in-continuous-times}{%
\section{Markov Chains in Continuous Times}\label{markov-chains-in-continuous-times}}

\textbf{Definition.} \textbf{(Stokastisk process i kontinuer tid)} \emph{En stokastisk proces i kontinuer tid er en familie \(X=(X_t)_{t\in[0,\infty)}\) af stokastiske variable.}

\textbf{Eksempel 33.} \emph{(Poisson processen)} Lad \((W_i)_{i\in\mathbb{N}}\) være en følge af uafhængige stokastiske variable, hvor \(W_i\sim Exp(\lambda)\) dvs. \(W_i\) har tæthed \(f(x)=\lambda \exp(-\lambda x)\). Betragt \(W_i\) som ventetiden indtil en begivenhed af interesse indtræffer. Lad \(\tau_n:=W_1+...+W_n\) være tiden indtil den \(n\)'te begivenhed indtræffer. Den stokastiske variabel \(N_t=\sum_{n=1}^\infty 1(\tau_n\le t)\) der tæller antal begivenheder indtil tidspunkt \(t\) definerer en stokastisk proces i kontinuer tid dvs. processen \((N_t)_{t\ge 0}\). Vi kalder denne proces \emph{Poisson processen}.

\textbf{Definition 34.} \textbf{(Homogen Markov kæde i kontinuer tid)} \emph{En kontinuer Markov kæde på en højst tællelig mængde \(S\) er en familie af stokastiske variable \((X_t)_{t\ge0}\) på sandsynlighedsrummet \((\Omega, \mathcal{F},P)\) der opfylder}
\begin{align*}
    &P(X(t_{n+1})=j\vert X(t_n)=i, X(t_{n-1})=i_{n-1},...,X(t_0)=i_0)\\
    =\ &P(X(t_{n+1})=j\vert X(t_n)=i)=P_{i,j}(t_{n+1}-t_n)
\end{align*}
\emph{for \(j,i,i_{n-1},...,i_0\in S\) og \(t_{n+1}>t_n>...>t_0\ge0\). Fordelingen af Markov kæden er givet ved initialfordelingen \(\overline{\phi}=(P(X_0=i))_{i\in S}\) og transistionssandsynlighederne \(P_{i,j}(t)=P(X(t+s)=j\vert X(s)=i)\) og identiteten}
\begin{align*}
    &P(X(t_{n+1})=j, X(t_n)=i, X(t_{n-1})=i_{n-1},...,X(t_0)=i_0)\\
    =\ &P_{i,j}(t_{n+1}-t_n)\cdot ...\cdot P_{i_0,i_1}(t_1-t_0)\phi(i_0)
\end{align*}

\textbf{Definition 35.} \textbf{(Minimal konstruktion)} \emph{Lad \(\overline{\phi}=(\phi_i)_{i\in S}\) være en sandsynlighedsvektor og lad \(Q=(q_{i,j})_{i,j\in S}\) være en intensitetsmatrice dvs. \(q_{i,j}\) er reelle tal med egenskaberne 1) alle ikke diagonal indgange er ikke negative dvs. \(q_{i,j}\ge 0\) for alle \(i,j\in S\) og \(i\ne j\) og 2) diagonal er negativ lig rækkesummen dvs. \(q_{i,i}=-\sum_{j\ne i}q_{i,j}\).}

Givet \(\overline{\phi}\) og \(Q\) kan en tids-homogen Markov kæde konstrueres ved følgende fem trin. Matricen \(Q\) kaldes transistionsintensiteten for den stokastiske proces \((X_t)_{t\ge 0}\).

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Vælg \(\gamma(0)\) ud fra initialfordelingen, så \(P(\gamma(0)=i)=\phi(i)\).
\item
  givet \(\gamma(0)\) sæt \(\tau_1:=W_1\sim Exp(q_{\gamma(0)})\) og definer \(X(t)=\gamma(0),t\in[0,W_1)\)
\item
  givet \(\gamma(0)\) og \(W_1\) vælg \(\gamma(1)\) sådan at \(P(\gamma(1)\vert \gamma (0))=\frac{q_{\gamma(0),i}}{q_{\gamma(0)}},i\ne \gamma(0)\)
\item
  recursivt givet \(\gamma(0),...,\gamma(n),W_1,...,W_n\) vælg \(W_{n+1}\sim Exp(q_{\gamma(n)}\). Lad \(\tau_{n+1}=\tau_n+W_{n+1}\) og definer \(X(t)=\gamma(n),t\in[\tau_n,\tau_{n+1})\)
\item
  vælg \(\gamma(n+1)\) sådan at \(P(\gamma(n+1)\vert \gamma(0),...,\gamma(n),W_1,...,W_n)=\frac{q_{\gamma(n),i}}{q_{\gamma(n)}},i\ne Y(n)\).
\end{enumerate}

\textbf{Definition 37.} \textbf{(Absorbering)} \emph{Hvis Markov kæden givet ved minimal konstruktion på tidspunkt \(\tau_n\) hopper til stadie \(\gamma(n)=i\) med \(q_i=0\) så lader vi \(X(t)=\gamma(n)\) for \(t\ge \tau_n\) og vi siger at Markov kæden er absorberet på stadie \(i\).}

\textbf{Definition 38.} \textbf{(Eksplosion)} \emph{Hvis Markov kæden hopper uendeligt mange gange på et endeligt interval dvs. \(\tau_\infty :=\lim_{n\to\infty}\tau_n<+\infty\) og dermed \(P(\tau_\infty<+\infty)>0\). Lader vi \(X(t)=\Delta\) for \(t\ge \tau_\infty\). Vi kalder tidspunktet \(\tau_\infty\) for eksplosionstidspunktet.}

\textbf{Theorem 39.} \textbf{(Embedded Markov Chain of jumps)} \emph{For en markov kæde i kontinuert tid med transitions intensiteter (intensitetsmatrice) \(Q = (q_{i,j})_{i,j\in s}\) givet ved den minimale konstruktion fra definition 35, er følgen \((\Gamma(n))_{n \in \mathbb{N}_0}\) af besøgte stadier en markov kæde i diskret tid med transitionsmatricen \(P\) givet ved}
\begin{align*}
    \left\{\begin{array}{cc}
        -\frac{q_{i,j}}{q_{i,i}} = \frac{q_{i,j}}{q_i} & i \in S \setminus A, j \notin \{i,\Delta\}  \\
        0 & i \in S \setminus A, j \in \{i, \Delta\} \\
        0 & i \in A, j \ne i \\
        1 & i \in A, j = i
    \end{array}\right.
\end{align*}
\emph{Hvor \(A = \{i \in S \vert q_i = 0\}\) er delmængden af absorberende stadier.}

\textbf{Bemærkning:} Det er klart, at de enkelte indgange \((P_{i,j}(t))_{i,j \in S}\) (\(t\ge0\)) i transistionsmatricen må være ikke negative. Endvidere er rækkesummerne, for en markov kæde hvor eksplosion ikke er mulig, lig 1. Specielt er transitionssandsynlighederne for et valgt \(t \ge 0\) i overenstemmelse med dem som vi har set i kapitel 2. For skift i tid, kræves næste teorem.

\hypertarget{properties-of-transitionsprobabilities}{%
\section{Properties of transitionsprobabilities}\label{properties-of-transitionsprobabilities}}

\textbf{Theorem 42.} \textbf{(Chapman-Kolmogorov ligninger)} \emph{Transitionssandsynlighederne for en homogen markov kæde i kontinuert tid opfylder Chapman-Kolmogorov ligningerne }

\[
\forall s,t \ge 0, \forall i,j \in S : P_{i,j}(t+s) = \sum_{l\in S}P_{i,l}(t) \cdot P_{l,j}(s)
\]
\emph{Hvis state space er endeligt, så kan \(P(t) = (P_{i,j}(t))_{i,j\in S}\) ses som en matrice for hvilket som helst valgt \(T \ge 0\) og så kan Chapman-Kolmogorov ligningerne skrives som matrice ligningen}

\[
P(t+s) = P(t)P(s)
\]

\textbf{Theorem 43.} \textbf{(Infinitesimal generatoren af en markov kæde)} \emph{For en markov kæde i kontinuert tid, kan transitionsintensiteterne udledes fra transitionssandsynlighederne som grænserne}
\begin{align*}
    \lim_{t\to0+}\frac{P_{i,i}-1}{t} = -q_i \\ 
    \lim_{t\to0+}\frac{P_{i,j}}{t} = q_{i,j}, \hspace{5pt} i \ne j
\end{align*}

\textbf{Theorem 44.} \textbf{(Backward differential equations)} \emph{For en markov kæde i kontinuert tid holder det altid, at }

\[
DP_{i,j}(t) = P_{i,j}'(t) = -q_iP_{i,j}(t) + \sum_{k\ne i}q_{i,k}P_{k,j}(t)
\]

\textbf{Theorem 45.} \textbf{(Forward differential and integral equations)} \emph{For en markov kæde i kontinuert tid, holder det, at }

\[
P_{i,j}(t) = \delta_{i,j}\exp(-q_jt)+\int^t_0\sum_{l\ne j}P_{i,l}(u)q_{l,j}\exp(-q_j(t-u))du
\]

\emph{og at }

\[
DP_{i,j}(t) = -P_{i,j}(t)q_j+\sum_{l \ne j}P_{i,l}(t)q_{l,j}.
\]

\textbf{Theorem 47.} \textbf{(Transitionssandssynlighederne for et endeligt state space)} \emph{For en markov kæde i kontinuert tid med endeligt state space, kan den ``backward differential equation'' udtrykkes i matrice form som }

\[
DP(t) = P'(t) = QP(t)
\]

\emph{Hvor \(P(t) = (P_{i,j}(t))_{i,j \in S}\) Ved at bruge startbetingelsen \(P(0) = I\), kan transistionssandsynlighederne udtrykkes på formen af eksponentiel matricen}

\[
P(t) = \exp(Qt), \hspace{5pt} t \ge 0.
\]

\hypertarget{invariant-probabilies-and-absorption}{%
\section{Invariant probabilies and absorption}\label{invariant-probabilies-and-absorption}}

\textbf{Definition 49.} \textbf{(Kommunikationsklasser og ``irreducibility'')} \emph{To stadier \(i,j \in S\) siges at kommunikere, hvis der findes \(s,t > 0\) således at}

\[
P_{i,j}(s) > 0 \text{ og } P_{j,i}(t) > 0.
\]

\emph{Denne definition inddeler \(S\) i disjunkte kommunikationsklasser, ligesom vi har set i kapitel 2. En markov kæde i kontinuert tid siges at være ``irreducible'' hvis der kun findes én kommunikationsklasse.}

\textbf{Bemærkning:} Man kan anvende, at to stadier \(i,j \in S\), hvor \(i \ne j\) kommunikerer, hvis og kun hvis, der eksisterer en følge af stadier \(i_1, i_2, ..., i_n \in S\) (som indeholder stadie \(j\)) således, at \(q_{i,i_1}\cdot q_{i_1,i_2}\cdot...\cdot q_{i_{n-1},i_n}\cdot q_{i_n,i} > 0\). (Er der en mulig sti frem og tilbage mellem \(i\) og \(j\)?)

\textbf{Definition 50.} \textbf{(Recurrence og transience)}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{En irreducible markov kæde i kontinuert tid er recurrent, hvis og kun hvis, den embedded markov kæde (se teorem. 39) er recurrent. Den er transient, hvis og kun hvis, den embedded markov kæde er transient.}
\item
  \emph{Stadiet \(i\) er transient, hvis og kun hvis, den totale tid tilbragt i stadiet \(i\)}
  \[
    V_i = \int^\infty_01_{X(t) = i}dt
    \]
  \emph{er endelig med sandsynlighed 1, altså \(P(V_i < +\infty \vert X(0) = i) = 1\). Tilsvarende er stadiet \(i\) recurrent hvis \(P(V_i = +\infty \vert X(0) = i) = 1\).}
\end{enumerate}

\textbf{Bemærkning:} Denne definition kan anvendes på de enkelte kommunikationsklasser. Specielt er et absorberende stadie altid recurrent.

\textbf{Definition 51.} \textbf{(Invariant fordeling)} \emph{En sandsynlighedsvektor \(\overline{\pi} = (\pi(i))_{i \in S}\) er en invariant (eller stationær) fordeling for en markov kæde i kontinuert tid, hvis for alle \(t \ge 0\) og \(j \in S\)}

\[
\pi(j) = \sum_{i \in S}\pi(i)P_{i,j}(t).
\]

\textbf{Theorem 52.} \textbf{(Entydigheden af den invariante fordeling)} \emph{Overvej en markov kæde i kontinuert tid. En invariant fordeling er unik, hvis den eksisterer. Hvis der for et \(t_0 > 0\) findes en sandsynlighed \(\overline{\pi}=(\pi(i))_{i\in S}\) sådan, at}

\[
\forall j \in S : \pi(j) = \sum_{i \in S}\pi(i)P_{i,j}(t_0)
\]

\emph{kan vi konkludere, at}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(\forall i \in S : \pi(i) > 0\)
\item
  \emph{\(P(t_0)\) er en overgangssandsynlighed, dvs.}
  \[
    \forall i \in S : \sum_{j \in S}\pi(i)P_{i,j}(t_0) = 1
    \]
\item
  \emph{\(\overline{\pi}\) er en invariant fordeling for markov kæden, dvs.}
  \[
    \forall t \ge 0, \forall j \in S : \pi(j) = \sum_{j \in S}P_{i,j}(t_0) = 1
    \]
\end{enumerate}

\textbf{Bemærkning:} Det følger af (3), at hvis vi kan finde en invariant fordeling for et bestemt \(t_0 > 0\), så gælder denne for alle \(t > 0\). Det følger også, som resultat af dette, at alle rækkesummerne \(\sum_{j \in S}P_{i,j}(h) = 1\) for alle \(h \ge 0\), hvor en invariant fordeling kan findes.

\textbf{Theorem 53.} \textbf{(Grænseresultater for overganssandsynligheder)} \emph{For en irreducible markov kæde i kontinuert tid, med en invariant fordeling \(\overline{\pi}\), gælder det for alle \(i,j \in S\), at }

\[
\lim_{t \to \infty}P_{i,j}(t) = \pi(j).
\]
\emph{Endvidere gælder det for enhver initial fordeling \(\overline{\phi}\), at}

\[
\lim_{t \to \infty}P(X(t) = j) = \pi(j).
\]

\emph{Hvis der ikke findes en invariant fordeling, så gælder der}

\[
\lim_{t \to \infty}P_{i,j}(t) = 0.
\]

\textbf{Theorem 55.} \textbf{(Nødvendig betingelse for invariant fordeling)} \emph{For en markov kæde i kontinuert tid, er det nødvendigt, at den invariante fordeling \(\overline{\pi}\) passer med ligningsystemet}

\[
\forall j \in s : \sum_{i \in S}\pi(i)q_{i,j} = 0
\]

\emph{Eller tilsvarende}

\[
\forall j \in S : \sum_{i\ne j}\pi(i)q_{i,j} = \pi(j)(-q_{j,j}) = \pi(j)q_j
\]

\emph{Tænker man på \(\overline{\pi}\) som en række vektor og \(Q\) som en matrice, har ligningssystemet en mere kompakt formulering }

\[
\overline{\pi}Q = 0.
\]

\textbf{Theorem 56.} \textbf{(Tilstrækkelig betingelse for en invariant fordeling)} \emph{Hvis \(\overline{\pi}\) overholder betingelsen i teorem 55 og endvidere overholder }

\[
\sum_{j \in S}\pi(j)q_j < \infty
\]

\emph{Så er \(\overline{\pi}\) en unik invariant fordeling for en irreducible markov kæde.}

\textbf{Theorem 58.} \emph{En irreducible markov kæde i kontinuert tid har en invariant fordeling, hvis og kun hvis, den indlejrede (embedded) markov kæde er recurrent og der ekstisterer en sandsynlighedsvektor \(\overline{\pi}\) således, at teorem 55 er overholdt. (\(\overline{\pi}Q = 0\))}

\textbf{Theorem 60.} \textbf{(Tids-invariant vs.~hændelses-invariant fordeling)} \emph{Antag, at der for en irreducible markov kæde i kontinuert tid findes en invariant fordeling \(\overline{\nu}\). Hvis vi også har bekræftet eksistensen af en invariant fordeling for den indlejrede markov kæde, så gælder følgende forhold mellem dem. }

\[
\pi(i) = \frac{\nu(i)q_i}{\sum_{j \in S}\nu(j)q_j}, \hspace{5pt} i \in S.
\]

\textbf{Theorem 61.} \textbf{(Eksistens af invariant fordeling og positive recurrence)} \emph{For en irreducible og recurrent markov kæde i kontinuert tid definerer vi ``escape time'' fra stadiet \(i\) som}

\[
W_i=\inf\{t > 0 \vert X(t) \ne i\}
\]

\emph{Og ``return time'' til stadiet \(i\) som}

\[
R_i = \inf\{t > W_i \vert X(t) = i\}
\]

\emph{Og der gælder, at }

\[
\pi(i) = \frac{E[W_i \vert X(0) = i]}{E[R_i \vert X(0) = i]} = \frac{1}{q_iE[R_i \vert X(0) = i]}
\]

\emph{Vi siger så, at en kommunikationsklasse er ``positive recurrent'' hvis}

\[
E[R_i \vert X(0) = i] < +\infty
\]

\textbf{Bemærkning:} Positive recurrence er en klasseegenskab.

\textbf{Theorem 62.} \textbf{(Tid tilbragt i stadiet j før absorbering)} \emph{For en markov kæde i kontinuert tid findes det gennemsnitlige antal af besøg til stadiet \(j\) før det absorberende stadie \(i\) rammes, ved at betragte overgangssandsynlighederne af den indlejrede markov kæde. For et endeligt state space, kan man bruge teorem 29, mens man kan bruge teorem 31 for tælleligt uendelige state spaces.}

\emph{Hvis \(N_j\) er middelværdien af antal besøg til stadiet \(j\) før absorbering i stadiet \(i\), så er middelværdien af tid tilbragt i stadiet j lig \(\frac{N_j}{q_j}\).}

\textbf{Side note:} Eksempel 63 har været meget brugbar til at forstå kapitel 3.3.

\hypertarget{birth-death-processes}{%
\section{Birth-death processes}\label{birth-death-processes}}

\textbf{Definition.} \textbf{(Birth-and-death process)} \emph{En birth-and-death proces er en markov kæde på \(S = \mathbb{N}_0\) som kun tillader hop (op eller ned) af størrelset ét. Dvs, at for overgangsintesiterne, gælder \(q_{i,j} = 0, i,j \in \mathbb{N}_0, |i-j| > 1\), mens de eneste ikke-nul indgange (udover diagonalen) er lig}
\begin{align*}
    q_{i,i+1} = \beta_i, i \in \mathbb{N}_0 \rightarrow \text{ birth intensitet} \\
    q_{i,i+1} = \delta_i, i \in \mathbb{N} \rightarrow \text{ death intensitet}
\end{align*}
\emph{Adfærden af sådan en proces er meget simpelt at beskrive. Hvis man befinder sig i stadiet \(i\), så er ventetiden til det næste hop eksponentiel fordelt med parametren \(\beta_i+\delta_i\) og med gennemsnitstiden \(\frac{1}{\beta_i+\delta_i}\). Når kæden hopper, kan den hoppe op med sandsynlighed \(\frac{\beta_i}{\beta_i + \delta_i}\) eller hoppe ned med sandsynlighed \(\frac{\delta_i}{\beta_i+\delta_i}\).}

\textbf{Side note:} Meget af kapitel 3.4 er eksempler på birth-and-death processer.

\textbf{Theorem 66.} \textbf{(Birth-and-death processer: recurrence)} \emph{En birth-and-death proces er recurrent, hvis og kun hvis,}

\[
\sum_{i=1}^\infty\frac{\delta_i\cdot...\cdot \delta_1}{\beta_i\cdot...\cdot \beta_1} = \infty.
\]

\emph{Ækvivalent er en birth-and-death proces transient, hvis og kun hvis,}

\[
\sum_{i=1}^\infty\frac{\delta_i\cdot...\cdot \delta_1}{\beta_i\cdot...\cdot \beta_1} < \infty.
\]

\textbf{Theorem 67.} \textbf{(Birth-and-death processer: positive recurrence)} \emph{En birth-and-death proces er positive recurrent, hvis og kun hvis,}

\[
\sum_{i=1}^\infty\frac{\beta_{i-1}\cdot...\cdot \beta_0}{\delta_i\cdot...\cdot \delta_1} < \infty \hspace{10pt} \text{og} \hspace{10pt} \sum_{i=1}^\infty\frac{\delta_i\cdot...\cdot \delta_1}{\beta_i\cdot...\cdot \beta_1} = \infty
\]

\textbf{Theorem 68.} \textbf{(Eksplosion for en birth-and-death proces)} \emph{For en birth-and-death proces med intensiteterne}

\[
q_{i,i+1} = \beta_i, \hspace{10pt} q_{i+1,i}=\delta_{i+1}, \hspace{10pt} q_{i+1,i+1} = -(\delta_{i+1}+\beta_{i+1})
\]

\emph{og med \(q_{i,j} = 0\) ellers, \(i,j \in \mathbb{N}_0\), så er eksplosion muligt, hvis og kun hvis,}

\[
\sum_{i=1}^\infty\left(\frac{1}{\beta_i}+\frac{\delta_i}{\beta_i\beta_{i-1}}+...+\frac{\delta_i\cdot...\cdot \delta_1}{\beta_i\cdot...\cdot \beta_0}\right)<\infty
\]

\hypertarget{continuous-time-stochastic-processes}{%
\chapter{Continuous Time Stochastic Processes}\label{continuous-time-stochastic-processes}}

\hypertarget{brownian-motion}{%
\section{Brownian Motion}\label{brownian-motion}}

\textbf{Definition 4.1. (Bjork)} \emph{A stochastic process \(W\) is called a \textbf{Brownian motion}\index{Brownian motion} or \textbf{Wiener process}\index{Wiener process} if the following conditions hold}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(W_0=0\).
\item
  \emph{The process \(W\) has independent increments, i.e.~if \(r<s\le t< u\) then \(W_u-W_t\) and \(W_s-W_r\) are independent random variables.}
\item
  \emph{For \(s<t\) the random variable \(W_t-W_s\) has the Gaussian distribution \(\mathcal{N}(0,t-s)\).}
\item
  \emph{\(W\) has continuous trajectories i.e.~\(s\mapsto W(s;\omega)\) i continuous for all \(\omega \in\Omega\).}
\end{enumerate}

\begin{figure}[H]
  \begin{center}
    \includegraphics[width=0.75\textwidth]{figures/BM_sim.png}
  \end{center}
\end{figure}

As one can see from the simulated sample path on the right, the Brownian motion is rather irratic. In fact, the process varies infinitely on any interval with length greater than 0. This gives some of the characteristics of the process including that: \(W\) is continuous and \(W\) is non-differential everywhere. This irratic behaviour is summed up in the theorem.

\textbf{Theorem 4.2. (Bjork)} \emph{A Brownian motions trajectory \(t\mapsto W_t\) is with probability one nowhere differential, and it has locally infinite total variation.}

\newpage

\hypertarget{filtration}{%
\section{Filtration}\label{filtration}}

Filtrations\index{Filtration} is widely used in stochastic processes, as they allow for the concept of knowledge/information. This is useful when considering mean-values of future states but in an increasing information setting. For this we introduce the term adapted processes.

\textbf{Definition B.17. (Bjork)} \textbf{(Adapted process)}\index{Adapted process} \emph{Let \((\mathcal{F}_t)_{t\ge 0}\) be a filtration on the probability space \((\mathcal{F}_t)_{t\ge 0}\). Furthermore, let \((X_t)_{t\ge 0}\) be a stochastic process on the same space. We say that \(X_t\) is adapted to the filtration \(\mathbf{F}\) if}

\[X_t\ \text{ is }\ \mathcal{F}_t-\text{measurable},\hspace{20pt}\forall t\ge 0.\]

Obviously, we may introduce the \textbf{natural filtration}\index{natural filtration} \(\mathcal{F}^X_t\) given by the tragetory of the process \(X_t\):

\[\mathcal{F}^X_t=\sigma(\{X_s,\ s\le t\}).\]

Indeed, \(X_t\) is adapted to this filtration.

\newpage

\hypertarget{martingale}{%
\section{Martingale}\label{martingale}}

\textbf{Definition.} \emph{Let \(M_t\) be a stochastic process defined on a background space \((\Omega,\mathcal{F},P)\). Let \((\mathcal{F}_t)_{t\ge 0}\) be a filtration. If \(M_t\) is adapted to the filtration \(\mathcal{F}_t\), \(E\vert M_t\vert <\infty\) and}

\[E[M_t\vert \mathcal{F}_s]=M_s,\hspace{20pt}P-\text{a.s.}\]

\emph{holds for any \(t>s\) we say that \(M_t\) is a martingale\index{martingale} (\(\mathbf{F}\)-martingale). If the above has \(\le\) or \(\ge\) we say that \(M_t\) is either a \textbf{submartingale}\index{submartingale} or \textbf{supermartingale}\index{supermartingale} respectively.}

Naturally, this defintions may easily be extended to discrete models and we have the trivial equality:

\[E[M_t-M_s\ \vert\ \mathcal{F}_s]=0.\]

Martingales is useful, when proofing probalistic statements as the posses tractable properties. A useful technique often include the construction of the martingale

\[M_t=E[X\ \vert\ \mathcal{F}_t].\]

\hypertarget{stochastic-calculus}{%
\chapter{Stochastic calculus}\label{stochastic-calculus}}

\hypertarget{stochastic-integrals}{%
\section{Stochastic Integrals}\label{stochastic-integrals}}

We want to formulate financial markets in continuous time and the most elegant theory is obtained from processes that can be defined in terms of \textbf{stochastic differential equations}\index{stochastic differential equations, SDE} or in other words by their dynamics. We may call them \textbf{diffusion processes}\index{diffusion processes}, as they may be approximated by a stochastic difference equation:

\[
X_{t+\Delta t}-X_t=\mu(t,X_t)\Delta t+\sigma(t,X_t)Z_t.\tag{4.1}
\]

Above \(Z_t\) is a normally distributed random variable (a disturbance). In this formulation we say that \(S_t\) is driven by two forces: on one hand a locally deterministic velocity or drift \(\mu(t,X_t)\) and on the other hand a Gaussian term amplified by the deterministic factor \(\sigma(t,X_t)\).

\hypertarget{information}{%
\subsection{Information}\label{information}}

We consider a primary process \(X_t\) and we introduce the notion of information generated by \(X_t\) in terms of the natural filtration. The idea can be summed up in the following definition.

\textbf{Definition 4.3. (Bjork)} \emph{The symbol \(\mathcal{F}^X_t\subseteq\mathcal{F}\) denotes ``the information generated by \(X_t\) on the interval \([0,t]\)'', or alternatively ``what has happened to \(X_t\) over ther interval \([0,t]\)''.}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{If, based upon observations of the trajectory \(\{X_s;\ 0\le s\le t\}\), it is possible to decide whether a given event \(A\) has occurred or not, then we write this as}
  \[
    A\in\mathcal{F}^X_t
    \]
  \emph{or say that ``\(A\) is \(\mathcal{F}^X_t\)-measurable''.}
\item
  \emph{If the value of a given random variable \(Z\) can be completely determined given observations of the tragectory \(\{X_s;\ 0\le s\le t\}\), then we also write}
  \[
    Z\in\mathcal{F}^X_t.\ \text{(}Z\text{ is }\mathcal{F}^X_t\text{-measurable)}
    \]
  3.\_ If \(Y\) is a stochastic process such that we have\_
  \[
    Y_t\in\mathcal{F}^X_t
    \]
  \emph{for all \(t\ge0\) then we say that \(Y_t\) is \textbf{adapted} to the \textbf{filtration} \(\{\mathcal{F}^X_t\}_{t\ge 0}\). For brevity of notation, we will sometimes write the filtration as \(\{\mathcal{F}^X_t\}_{t\ge 0}=\mathbf{F}\).}
\end{enumerate}

\hypertarget{stochastic-integrals-1}{%
\subsection{Stochastic Integrals}\label{stochastic-integrals-1}}

We will now formulate the theory of stochastic integrals, that is, processes written in terms of stochastic processes with stochastic integrator and/or stochastic integrant. We will consider some given standard Brownian motion \(W_t\) and another stochastic process \(X_t\). We need som integrability condition on \(X_t\) in order to do the calculations. We therefore determine a selection of suitable stochastic processes \(X\) must be contained in.

\textbf{Definition 4.4. (Bjork)} \emph{Let \(X_t\) be a stochastic process, then}

\begin{enumerate}
\def\labelenumi{\roman{enumi}.}
\tightlist
\item
  \emph{We say that \(X_t\) belongs to the class \(\mathcal{L}^2[a,b]\) if \(X_t\) is adapted to the filtration \(\mathcal{F}^X_t\) and the following holds}
  \[\int_a^bE[X_s^2]\ ds<\infty\]
\item
  \emph{We say that \(X_t\) belongs to the class \(\mathcal{L}^2\) if} \(X_t\in\mathcal{L}^2[0,t]\) for all \(t>0\).
\end{enumerate}

We now want to define what we mean by

\[
\int_a^bX_t\ dW_s
\]

for some process \(X_t\in\mathcal{L}^2\). We see that a way to go about this problem is to start by defining the concept for a simple stochastic process \(X_t\). By \emph{simple} we mean a process \(X_t\) that is constant on between some deterministic points in time \(a=t_0<t_1<\cdots<t_n=b\). In that case we may define the integral as

\[
\int_a^bX_s\ dW_s = \sum_{k=0}^{n-1}X_{t_k}[W_{t_{k+1}}-W_{t_k}].\tag{4.8}
\]

In the more general setting we may follow the following approach:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Approximate \(X\) with a sequence \(\{X^n\}_{n\in\mathbb{N}}\) of simple processes such that the following convergence criteria hold
\end{enumerate}

\[
  \int_a^bE[(X_s^n-X_s)^2]\ ds\to 0,\ n\to\infty
  \]

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  For each \(n\) the integral \(\int_a^b X_s^n\ dW_s:=Z^n\) is well defined and it is possible to prove, using DCT, that a variable \(Z\) exists such that \(Z^n\to Z\) that is in \(L^2\).
\item
  We now define the stochastic integral by the limit
\end{enumerate}

\[
  \int_a^b X_s\ dW_s=\lim_{n\to \infty}\int_a^b X_s^n\ dW_s.\tag{4.9}
  \]

Obviously the hardest step is finding the processes \(X^n\). This stochastic har some properties we will use.

\textbf{Proposition 4.5. (Bjork)} \emph{Let \(X_t\in\mathcal{L}^2\), then}
\begin{align*}
&E\left[\int_a^b X_s\ dW_s\right]=0.\tag{4.12}\\
&E\left[\left(\int_a^b X_s\ dW_s\right)^2\right]=\int_a^b E[ X_s^2]\ dW_s.\tag{4.13}\\
&\int_a^b X_s\ dW_s\ \text{ is }\mathcal{F}_b^W\text{-measurable.}\tag{4.14}
\end{align*}

\hypertarget{martingales}{%
\subsection{Martingales}\label{martingales}}

\textbf{Definition 4.7. (Bjork)} \emph{Let \(M_t\) be a stochastic process defined on a background space \((\Omega,\mathcal{F},P)\). Let \((\mathcal{F}_t)_{t\ge 0}\) be a filtration. If \(M_t\) is adapted to the filtration \(\mathcal{F}_t\), \(E\vert M_t\vert <\infty\) and}

\[E[M_t\vert \mathcal{F}_s]=M_s,\hspace{20pt}P-\text{a.s.}\]

\emph{holds for any \(t>s\) we say that \(M_t\) is a martingale (\(\mathbf{F}\)-martingale). If the above has \(\ge\) or \(\le\) we say that \(M_t\) is either a \textbf{submartingale} or \textbf{supermartingale} respectively.}

\textbf{Proposition 4.8. (Bjork)} \emph{For any process \(X_t\in\mathcal{L}^2[s,t]\) the following hold:}

\[
E\left[\left.\int_s^t X_s\ dW_s\right\vert\mathcal{F}_s^W\right]=0
\]

\textbf{Corollary 4.9. (Bjork)} \emph{For any process \(X_t\in\mathcal{L}^2\) the process}

\[
M_t=\int_s^t X_s\ dW_s,
\]

\emph{is an \((\mathcal{F}_t^W)\)-martingale. In other words, modulo an integrability condition, \textbf{every stochastic integral is a martingale}.}

\textbf{Lemma 4.10. (Bjork)} \emph{Let \(M_t\) be a stochastic process with stochastic differential, then \(M_t\) is a martingale if and only if the stochastic differential has the form \(dM_t=X_t\ dW_t\) i.e.~\(M_t\) as no \(dt\)-term.}

\hypertarget{stochastic-calculus-and-the-ito-formula}{%
\subsection{Stochastic Calculus and the Ito Formula}\label{stochastic-calculus-and-the-ito-formula}}

Given this breif introduction to stochastic integrals we may formulate som simple calculus revolving around Ito's formula. We consider the stochastic process \(X_t\) and we suppose that there exist a real number \(X_0\) and adapted processes \(\mu\) and \(\sigma\) wrt. \(\mathcal{F}_t^W\) such that for all \(t\ge0\) we have

\[
X_t=X_0+\int_0^t\mu_s\ ds+\int_0^t\sigma_s\ dW_s,\tag{4.16}
\]

where \(W_t\) is a standard Brownian motion. We know from earlier courses that the above may be written in terms of the dynamics (pure notation):

\[
\left\{\begin{matrix}dX_t=\mu_t\ dt+\sigma_t\ dW_t,\tag{4.17/18}\\ X_0=X_0.\end{matrix}\right.
\]

Here we intepret the above as \(X_t\) has boundary condition \(X_0\) and evolves with a drift \(\mu_t\ dt\) amplified and distorted by the drift \(\sigma_t\ dW_t\). We say that \(X_t\) has \textbf{stochastic differential}\index{stochastic differential} \(dX_t\) and initial condition \(X_0\).

We want to understand how transformation of such an integral behaves and therefore we introduce some calculus which will tell how for instance \(f(t,X_t)\) (for some \(C^{1,2}\)-function) behaves. This insight is given by the important Ito's formula.

\textbf{Thoerem 4.11. (Bjork)} \textbf{(Ito's formula, one-dimensional)}\index{Ito's formula} \emph{Assume that the process \(X\) has a stochastic differential form given by}

\[
dX_t=\mu_t\ dt + \sigma_t\ dW_t,\tag{4.28}
\]

\emph{where \(\mu\) and \(\sigma\) are adapted processes, and let \(f:\mathbb{R}_+\times\mathbb{R}\to\mathbb{R}\) be a \(C^{1,2}\)-function. Define the process \(Z\) by \(Z_t=f(t,X_t)\). Then \(Z\) has stochastic differential given by}

\[
df(t,X_t)=\left(\frac{\partial f}{\partial t}(t,X_t) + \mu_t\frac{\partial f}{\partial x}(t,X_t) + \frac{1}{2}\sigma^2_t\frac{\partial^2 f}{\partial x^2}(t,X_t)\right)\ dt+\sigma_t\frac{\partial f}{\partial x}(t,X_t)\ dW_t.\tag{4.29}
\]

\textbf{Proposition 4.12. (Bjork)} \textbf{(Ito's formula, one-dimensional)} \emph{With assumptions as in theorem 4.11, \(df\) is given by}

\[
df=\frac{\partial f}{\partial t}\ dt + \frac{\partial f}{\partial x}\ dX_t + \frac{1}{2}\frac{\partial^2 f}{\partial x^2}\ (dX_t)^2,\tag{4.31}
\]

\emph{where we use the following table}

\[
\left\{\begin{matrix}(dt)^2=0,\\ dt\cdot dW_t=0,\\ (dW_t)^2=dt.\end{matrix}\right.
\]

\textbf{Lemma 4.18. (Bjork)} \emph{Let \(\sigma(t)\) be deterministic function of time and define the process \(X\) by}

\[
X_t=\int_0^t \sigma(s)\ dW_s.\tag{4.37}
\]

\emph{Then}

\[
X_t\sim\mathcal{N}\left(0,\int_0^t\sigma^2(s)\ ds\right).
\]

\hypertarget{the-multidimensional-ito-formula}{%
\subsection{The multidimensional Ito Formula}\label{the-multidimensional-ito-formula}}

Consider a vector process \(X=(X^1,...,X^n)^\top\) where each component \(X^i\) has stochastic differential

\[
d X_t^i=\mu_t^i\ dt+\sum_{j=1}^d\sigma^{ij}_t\ dW_t^j
\]

where \(W^1,...,W^d\) is independent Brownian motions. Then we have respectively the drift vector process \(\mu_t\) in \(n\) dimensions, the vector Brownian motion in \(d\) dimensions and a \(n\times d\)-dimensional \textbf{diffusion matrix} \(\sigma_t\) given as below

\[
\mu_t=\begin{bmatrix}\mu^1_t\\ \vdots\\ \mu^n_t\end{bmatrix},\hspace{10pt}W_t=\begin{bmatrix}W^1_t\\ \vdots\\ W^d_t\end{bmatrix},\hspace{10pt}\sigma_t=\begin{bmatrix}\sigma^{11}_t & \cdots & \sigma^{1d}_t \\ \vdots & \ddots & \vdots\\ \sigma^{n1}_t &\cdots& \sigma^{nd}_t\end{bmatrix}.
\]

Given this we may write the dynamics of \(X\) as

\[
d X_t=\mu_t\ dt+\sigma_t\ dW_t\in\mathbb{R}^n.
\]

Consider now a function \(f:\mathbb{R}_+\times \mathbb{R}^n\to\mathbb{R}\) which is a \(C^{1,2}\)-mapping. We want to study the dynamics of the process

\[
Z_t=f(t,X_t).
\]

The dynamics is given in the multidimensional version of Ito's formula.

\textbf{Thoerem 4.19. (Bjork)} \textbf{(Ito's formula, multi-dimensional)}\index{Ito's formula, multi-dimensional} \emph{Let \(X\) be given as above. Then the following holds:}

\begin{itemize}
\tightlist
\item
  \emph{The process \(f(t,X_t)\) has the stochastisc differential given by}
  \[
    df(t,X_t)=\left(\frac{\partial f}{\partial t}(t,X_t) + \sum_{i=1}^n\mu^i_t\frac{\partial f}{\partial x^i}(t,X_t) + \frac{1}{2}\sum_{i,j=1}^nC_t^{ij}\frac{\partial^2 f}{\partial x^i\partial x^j}(t,X_t)\right)\ dt+\sum_{i=1}^n\sigma^i_t\frac{\partial f}{\partial x^i}(t,X_t)\ dW_t.
    \]
  \emph{Here the row vector \(\sigma^i_t\) is the \(i\)'th row of the matrix \(\sigma_t\) and the matrix \(C\) is defined by \(C=\sigma\sigma^\top\).}
\item
  \emph{Alternatively, the differential is given by the formula}
  \[
    df(t,X_t)=\frac{\partial f}{\partial t}(t,X_t)\ dt + \sum_{i=1}^n\frac{\partial f}{\partial x^i}(t,X_t)\ dX^i_t + \frac{1}{2}\sum_{i,j=1}^n\frac{\partial^2 f}{\partial x^i\partial x^j}(t,X_t)\ dX^i_tdX^j_t,
    \]
  \emph{with the formal multiplication table}
  \[
    \left\{\begin{matrix}(dt)^2=0,\\  dt\cdot dW_t^i=0, & i = 1,...,d,\\ (dW_t^i)^2=dt, & i=1,...,d, \\ dW_t^i\cdot dW_t^i =0, & i\ne j.\end{matrix}\right.
    \]
\end{itemize}

Obviously, one can write the differential in Ito's formula in many other ways including a matrix-wise version using the Hessian matrix \(H_{ij}=\frac{\partial^2 f}{\partial x^i\partial x^j}\).

\hypertarget{correlated-brownian-motions}{%
\subsection{Correlated Brownian motions}\label{correlated-brownian-motions}}

In the previous section the \(d\)-dimensional Brownian was assumed to have independent Brownian motions. However we may instead consider a variation where we have some dependence between the Brownian motions.

This section has not been finished.
\pagebreak

\hypertarget{discrete-stochastic-integrals}{%
\section{Discrete Stochastic Integrals}\label{discrete-stochastic-integrals}}

This section has not been finished.
\pagebreak

\hypertarget{stochastic-differential-equations}{%
\section{Stochastic Differential Equations}\label{stochastic-differential-equations}}

We start the chapter by formalising some used objects. We consider the following objects.

\begin{itemize}
\tightlist
\item
  \(M(n,d)\) denotes the class of \(n\times d\)-matrices.
\item
  \(W\) is a \(d\)-dimensional Brownian motion
\item
  \(\mu\) is a \(\mathbb{R}^n\)-valued function with arguments \((t,X_t)\) with \(X_t\) being a \(n\)-dimensional stochastic process.
\item
  \(\sigma\) a \(M(n,d)\)-valued function with arguments as in \(\mu\).
\item
  \(x_0\) a \(\mathbb{R}^n\)-valued vector.
\end{itemize}

We want then to understand when the following has a solution

\[
dX_t=\mu(t,X_t)\ dt + \sigma(t,X_t)\ dW_t,\ \ X_0=x_0.\tag{5.1/2}
\]

We call such an equation the \textbf{stochastic differential equation}\index{stochastic differential equation, SDE} or simply SDE. We know that the above is loosely notation for the integral form as

\[
X_t=x_0+\int_0^t\mu(s,X_s)\ ds +\int_0^t\sigma(s,X_s)\ dW_s,\tag{5.3}
\]

for all \(t\ge 0\). The following proposition tells us when an solution exist to the problem above. In the below \(\Vert \cdot \Vert\) is usual euclidian norm

\[
\Vert x\Vert=\sqrt{\sum_{i=1}^nx_i^2}.
\]

\textbf{Proposition 5.1. (Bjork)} \emph{Suppose that there existis a constant \(K\) such that the following conditions are satisfied for all \(x,y\) and \(t\).}
\begin{align*}
\Vert \mu(t,x) - \mu(t,y) \Vert &\le K\Vert x-y\Vert,\tag{5.6}\\
\Vert \sigma(t,x) - \sigma(t,y) \Vert &\le K\Vert x-y\Vert,\tag{5.7}\\
\Vert \mu(t,x) \Vert +\Vert \sigma(t,x) \Vert&\le K(1+\Vert x\Vert).\tag{5.8}
\end{align*}
\emph{Then there exists a unique solution to the SDE above. Furthermore, the solution has the properties}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{\(X\) is \(\mathcal{F}_t^W\)-adapted.}
\item
  \emph{\(X\) has continuous trajectories.}
\item
  \emph{\(X\) is a Markov process.}
\item
  \emph{There exists a constant \(C\) such that}
  \[
    E[\Vert X_t\Vert^2]\le Ce^{Ct}(1+\Vert x_0\Vert^2).\tag{5.9}
    \]
\end{enumerate}

In genereal the solution to an SDE is so complicated, that it in practical terms is unsolvable and may only be approximated on a finely subdividet grid as jumps. There does however exist som nontrivial cases where we may infer a analytical solution. One is the rather important \textbf{Geometric Brownian motion}\index{Geometric Brownian motion}.

\textbf{Proposition 5.2. (Bjork)} \emph{Consider the SDE}

\[
dX_t=\alpha X_t\ dt+\sigma X_t\ dW_t,\tag{5.13}
\]

\emph{with \(X_0=x_0\). Then the solution is given as}

\[
X_t=x_0\cdot \exp\left\{\left(\alpha- \frac{\sigma^2}{2}\right)t+\sigma W_t\right\}.\tag{5.15}
\]

\emph{The expected value of \(X\) is given as \(E[X_t]=x_0e^{\alpha t}\) (eq. 5.16).}

One other generalisation that is analytically solvable is the Linear SDE\index{Linear SDE}.

\textbf{Proposition 5.3. (Bjork)} \emph{Consider the SDE}

\[
dX_t=(A X_t + b_t)\ dt+ \sigma_t\ dW_t,\tag{5.19}
\]

\emph{with \(X_0=x_0\) and \(A\in M(n,n)\) and \(b_t\) being a real-valued function. Then the solution is given as}

\[
X_t=e^{At}x_0+\int_0^te^{A(t-s)}b_s\ ds+\int_0^te^{A(t-s)}\sigma_s\ dW_s.\tag{5.20}
\]

\emph{Where we define the exponential of a matrix as below}

\[
e^{At}=\sum_{k=0}^\infty A^k\frac{1}{k!}t^k.
\]

In general with the SDE we have a partial differential operator \(\mathcal{A}\) called the \textbf{infinitesimal operator}\index{infinitesimal operator} of \(X\) which has some interesting analytical properties regarding \(X\).

\textbf{Definition 5.4. (Bjork)} \emph{Consider the SDE}

\[
dX_t=\mu(t,X_t)\ dt+\sigma(t,X_t)\ dW_t.\tag{5.21}
\]

\emph{The partial differential operator \(\mathcal{A}\) is defined, for any function \(h\in C^2(\mathbb{R}^n)\), by}

\[
\mathcal{A}h(t,x)=\sum_{i=1}^n\mu_i(t,x)\frac{\partial h}{\partial x_i}(x) + \frac{1}{2}\sum_{i,j=1}^n (\sigma(t,x)\sigma(t,x)^\top)_{ij}\frac{\partial^2h}{\partial x_i\partial x_j}(x).
\]

We see that in terms of Ito's formula the operator is included as such

\[
df(t,X_t)=\left\{\frac{\partial f}{\partial t}(t,X_t)+\mathcal{A}f(t,x)\right\}\ dt+[\nabla_xf](t,X_t)\sigma(t,X_t)\ dW_t,
\]

where \(\nabla_x\) is the gradient for function \(h\in C^1(\mathbb{R}^n)\) as

\[
\nabla_xh(x)=\left[\frac{\partial h}{\partial x_1}(x),...,\frac{\partial h}{\partial x_n}(x)\right].
\]

\hypertarget{partial-differential-equations}{%
\section{Partial differential equations}\label{partial-differential-equations}}

\textbf{Proposition 5.5. (Bjork)} \textbf{(Feynmann-Kac)}\index{Feynmann-Kac} \emph{Assume that \(F\) is a solution to the boundary value problem}

\[
\frac{\partial F}{\partial t}(t,x)+\mu(t,x)\frac{\partial F}{\partial x}(x,t)+\frac{1}{2}\sigma^2(t,x)\frac{\partial^2 F}{\partial x^2}(t,x)=0,
\]

\emph{with boundary condition \(F(T,x)=\Phi(x)\). Assume furthermore that the process}

\[
\sigma(s,X_s)\frac{\partial F}{\partial x}(s,X_s) \in \mathcal{L}^2
\]

\emph{as per definition 4.4, where \(X\) is defined below. Then \(F\) has the representation}

\[
F(t,x)=E_{t,x}[\Phi(X_T)]=E[\Phi(X_T)\ \vert\ X_t=x],\tag{5.29}
\]

\emph{where \(X\) satisfies the SDE}

\[
dX_s=\mu(s,X_s)\ ds+\sigma(s,X_s)\ dW_s,\tag{5.30}
\]

\emph{with boundary condition \(X_t=x\).}

\textbf{Proposition 5.6. (Bjork)} \textbf{(Feynmann-Kac)} \emph{Assume that \(F\) is a solution to the boundary value problem}

\[
\frac{\partial F}{\partial t}(t,x)+\mu(t,x)\frac{\partial F}{\partial x}(x,t)+\frac{1}{2}\sigma^2(t,x)\frac{\partial^2 F}{\partial x^2}(t,x)-rF(t,x)=0,\tag{5.34}
\]

\emph{with boundary condition \(F(T,x)=\Phi(x)\). Assume furthermore that the process}

\[
e^{-rs}\sigma(s,X_s)\frac{\partial F}{\partial x}(s,X_s) \in \mathcal{L}^2
\]

\emph{as per definition 4.4, where \(X\) is defined below. Then \(F\) has the representation}

\[
F(t,x)=e^{-r(T-t)}E_{t,x}[\Phi(X_T)]=e^{-r(T-t)}E[\Phi(X_T)\ \vert\ X_t=x],\tag{5.36}
\]

\emph{where \(X\) satisfies the SDE}

\[
dX_s=\mu(s,X_s)\ ds+\sigma(s,X_s)\ dW_s,\tag{5.37}
\]

\emph{with boundary condition \(X_t=x\).}

\textbf{Proposition 5.8. (Bjork)} \textbf{(Feynmann-Kac)} \emph{Assume that \(F\) is a solution to the boundary value problem}

\[
\frac{\partial F}{\partial t}(t,x)+\sum_{i=1}^n\mu_i(t,x)\frac{\partial F}{\partial x}(x,t)+\frac{1}{2}\sum_{i,j=1}^n C_{ij}(t,x)\frac{\partial^2 F}{\partial x^2}(t,x)-rF(t,x)=0,
\]

\emph{with boundary condition \(F(T,x)=\Phi(x)\) and \(C_{ij}=\sigma \sigma^\top\). Assume furthermore that the process}

\[
e^{-rs}\sum_{i=1}^n\sigma_i(s,X_s)\frac{\partial F}{\partial x}(s,X_s) \in \mathcal{L}^2
\]

\emph{as per definition 4.4, where \(X\) is defined below. Then \(F\) has the representation}

\[
F(t,x)=e^{-r(T-t)}E_{t,x}[\Phi(X_T)],\tag{5.39}
\]

\emph{where \(X\) satisfies the SDE}

\[
dX_s=\mu(s,X_s)\ ds+\sigma(s,X_s)\ dW_s,\tag{5.40}
\]

\emph{with boundary condition \(X_t=x\).}

\textbf{Proposition 5.9. (Bjork)} \emph{Consider as given a vector process \(X\) with generator \(\mathcal{A}\), and a function \(F(t,x)\). Then, modulo some integrability condition, the following hold:}

\begin{itemize}
\tightlist
\item
  \emph{The process \(F(t,X_t)\) is a martingale relative to the filtration \(\mathcal{F}^X\) if and only if \(F\) satisfies the PDE}
  \[
    \frac{\partial F}{\partial t}+\mathcal{A}F=0.
    \]
\item
  \emph{The process \(F(t,X_t)\) is a martingale relative to the filtration \(\mathcal{F}^X\) if and only if, for every \((t,x)\) and \(T\ge t\), we have}
  \[
    F(t,x)=E_{t,x}[F(T,X_T)].
    \]
\end{itemize}

\hypertarget{the-product-integral}{%
\section{The Product Integral}\label{the-product-integral}}

Consider the (stochastic) function \(Y : \mathbb{R} \to \mathbb{R}^{n\times n}\), where \(\mathbb{R}^{n\times n}\) is the set of all \(n\times n\) real-valued matrices, that is \(Y\) has the matrix-representation

\[
Y(t)=\begin{bmatrix}
Y_{11}(t) & \cdots & Y_{1n}(t)\\
Y_{21}(t) & \cdots & Y_{2n}(t)\\
\vdots & \ddots & \vdots \\
Y_{n1}(t) & \cdots & Y_{nn}(t)
\end{bmatrix}.
\]

Assume furthermore that for each coordinate function \(Y_{ij}(t)\) the equation

\[
\frac{dY_{ij}}{dt}(t)=Y_{i1}(t)A_{1j}(t)+\cdots+Y_{in}(t)A_{nj}(t),\hspace{15pt}Y_{ij}(s)=C_{ij},
\]

is satisfied. That is on matrix form the linear system of differential equation

\[
\frac{dY}{dt}(t)=Y(t)A(t),\hspace{15pt}Y(s)=C,
\]

for some function \(A : \mathbb{R}\to\mathbb{R}^{n\times n}\) and initial condition \(C\in \mathbb{R}^{n\times n}\). If \(A\) is continuous we know that \(Y\) is well-defined and absolutely continuous. We may then state the following theorem regarding uniqueness and existence of such a function above.

\textbf{Theorem 1.1. (Bladt)} \textbf{(Uniqueness)}\index{solution to linear differential equation system, uniqueness} \emph{Consider the homogeneous system of linear differential equations}

\[
\mathbf{Y}'(t)=\mathbf{Y}(t)\mathbf{A}(t),\hspace{15pt} \mathbf{Y}(s)=\mathbf{C},\tag{1}
\]

\emph{where \(\mathbf{Y}(t)\), \(\mathbf{A}(t)\) and \(\mathbf{C}\) are \(n\times n\)-matrices and \(\mathbf{A}(t)\) is continuous on \([s,t]\). Then (1) has at most one solution.}

\textbf{Theorem 1.2. (Bladt)} \textbf{(Existence)}\index{solution to linear differential equation system, existence} \emph{The matrix function}

\[
\mathbf{Y}(t)=\sum_{k=0}^\infty \mathbf{Y}_k(t),\tag{3}
\]

\emph{converges uniformly and absolutely on finite intervals, and solves the differential equation}

\[
\mathbf{Y}'(t)=\mathbf{Y}(t)\mathbf{A}(t),\hspace{15pt} \mathbf{Y}(s)=\mathbf{C}.
\]

Now, we know that for any system as in (1) with a continuous function \(\mathbf{A}(t)\) we can always construct the solution as some converging series as per theorem 1.2 then theorem 1.1 gives that the solution is unique. We can then with a piece of mind define a symbol for such a solution, without care for the \emph{exact} solution.

\textbf{Definition 1.3. (Bladt)} \textbf{(The Product Integral)}\index{Product Integral} \emph{For any continuous matrix function \(\mathbf{A}(t)\) we define the product integral as}

\[
\prod_{s}^t(\mathbf{I}+\mathbf{A}(x)\ dx)
\]

\emph{as the unique solution \(\mathbf{Y}(t)\) to}

\[
\mathbf{Y}'(t)=\mathbf{Y}(t)\mathbf{A}(t),\hspace{15pt} \mathbf{Y}(s)=\mathbf{I}.
\]

From a simple integral argument we may construct \emph{a} converging series not containing \(\mathbf{Y}\) itself. We see that
\begin{align*}
\prod_{s}^t(\mathbf{I}+\mathbf{A}(x)\ dx)&=\mathbf{I}+\int_s^t\mathbf{Y}'(x)\ dx=\mathbf{I}+\int_s^t\mathbf{Y}(x)\mathbf{A}(x)\ dx\\
&=\mathbf{I}+\int_s^t\left[ \mathbf{I}+\int_s^{x_1}\mathbf{Y}'(x_2)\ dx_2\right]\mathbf{A}(x_1)\ dx_1\\
&=\mathbf{I}+\int_s^t\left[ \mathbf{I}+\int_s^{x_1}\mathbf{Y}(x_2)\mathbf{A}(x_2)\ dx_2\right]\mathbf{A}(x_1)\ dx_1\\
&=\mathbf{I}+\int_s^t\mathbf{A}(x_1)\ dx_1+\int_s^t\int_s^{x_1}\mathbf{Y}(x_2)\mathbf{A}(x_2)\mathbf{A}(x_1)\ dx_2\ dx_1.
\end{align*}
One can continue indefinitely and see that we have the following representation.

\textbf{Corollary 1.4. (Bladt)} \textbf{(Peano Representation)}\index{Peano Representation} \emph{The prduct integral has series representation given by}
\begin{align*}
\prod_{s}^t(\mathbf{I}+\mathbf{A}(x)\ dx)&=\mathbf{I}+\sum_{i=1}^\infty\int_s^t\int_s^{x_1}\cdots\int_s^{x_n}A(x_n)\cdots\mathbf{A}(x_2)\mathbf{A}(x_1)\ dx_n\cdots dx_2\ dx_1\\
&=\mathbf{I}+\int_s^t\mathbf{A}(x_1)\ dx_1+\sum_{i=2}^\infty\int_s^t\int_s^{x_1}\cdots\int_s^{x_n}A(x_n)\cdots\mathbf{A}(x_2)\mathbf{A}(x_1)\ dx_n\cdots dx_2\ dx_1.
\end{align*}

\hypertarget{properties-of-the-product-integral}{%
\subsection{Properties of the Product Integral}\label{properties-of-the-product-integral}}

The product integral is the fundamental solution in the sense that if

\[
\mathbf{Y}'(t)=\mathbf{Y}(t)\mathbf{A}(t),\hspace{15pt}\mathbf{Y}(s)=\mathbf{C},
\]

then

\[
\mathbf{Y}(t)=\mathbf{C}\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big).
\]

We furthermore have for any \(s,t,u\) have

\[
\mathbf{Y}(t)=\mathbf{Y}(s)\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\prod_{u}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big).
\]

From uniqueness we then get the following theorem.

\textbf{Theorem 1.5. (Bladt)} \emph{For any \(s,t,u\) we have that}

\[
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)=\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\prod_{u}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big).
\]

By choosing \(u=t\) in the above we get the following corollary.

\textbf{Corollary 1.6. (Bladt)} \emph{The inverse of the product integral is}

\[
\left[\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\right]^{-1}=\prod_{t}^s\big(\mathbf{I}+\mathbf{A}(x)\ dx\big).
\]

\textbf{Theorem 1.7. (Bladt)} \emph{If \(\mathbf{A}(x)\) commutes withall \(\mathbf{B}(x=\) i.e.~\(\mathbf{A}(x)\mathbf{B}(x)=\mathbf{B}(x)\mathbf{A}(x)\), then}

\[
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\prod_{s}^t\big(\mathbf{I}+\mathbf{B}(x)\ dx\big)=\prod_{s}^t\big(\mathbf{I}+\left(\mathbf{A}(x)+\mathbf{B}(x)\right)\ dx\big).
\]

\textbf{Corollary 1.8. (Bladt)} \emph{Let \(r\) be a real-valued function, then}

\[
\exp\left(-\int_s^t r(x)\ dx\right)\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)=\prod_{s}^t\big(\mathbf{I}+\left(\mathbf{A}(x)-r(x)\mathbf{I}\right)\ dx\big).
\]

\textbf{Theorem 1.9. (Bladt)} \emph{If \(\mathbf{A}(x)\) commutes for all \(x\) i.e.~\(\mathbf{A}(y)\mathbf{A}(x)=\mathbf{A}(x)\mathbf{A}(y)\), then}

\[
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)=e^{\int_s^t\mathbf{A}(x)\ dx}.
\]

\emph{In particular, if \(\mathbf{A}(x)=\mathbf{A}\lambda(x)\) for some real-valued function \(\lambda\) and a \(n\times n\) matrix \(\mathbf{A}\) then}

\[
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)=e^{\mathbf{A}\int_s^t\lambda(x)\ dx}.
\]

Taking the function \(\lambda=1\) we have that \(\int_s^t\lambda(x)\ dx=(t-s)\) and so we get the result.

\textbf{Theorem 1.10. (Bladt)} \emph{If \(\mathbf{A}(x)=\mathbf{A}\) is constant then}

\[
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)=e^{\mathbf{A}(t-s)}.
\]

\textbf{Theorem 1.11. (Bladt)} \emph{The product integral satisfies}

\[
\frac{\partial}{\partial s}\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)=-\mathbf{A}(s)\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big).
\]

\emph{On the other hand, the solution to the system of differential equations}

\[
\frac{\partial}{\partial s}\mathbf{X}(s)=-\mathbf{A}(s)\mathbf{X}(s)
\]

\emph{with initial condition \(\mathbf{X}(t)=\mathbf{I}\) is the function}

\[
s\mapsto\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)
\]

We have a very useful result for insurance mathematics and markov chains given by the Van Loan's theorem giving the product integral of a block matrix with zero lower left block.

\textbf{Theorem 1.12. (Bladt)} \emph{Let \(\mathbf{A}(x)\), \(\mathbf{B}(x)\) and \(\mathbf{C}(x)\) be continuous matrix functions such that}

\[
\mathbf{D}(x)=\begin{bmatrix}
\mathbf{A}(x) & \mathbf{B}(x)\\
\mathbf{0} & \mathbf{C}(x)
\end{bmatrix},
\]

\emph{is a square matrix. Then the product integral of \(\mathbf{D}\) is}

\[
\prod_{s}^t\big(\mathbf{I}+\mathbf{D}(x)\ dx\big)=
\begin{bmatrix}
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big) & \int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\\
\mathbf{0} & \prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)
\end{bmatrix}.
\]

\textbf{Proof.}

Start by defining \(\mathbf{X}(t)\) as below
\begin{align*}
\mathbf{X}(t)&=
\begin{bmatrix}
\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big) & \int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\\
\mathbf{0} & \prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)
\end{bmatrix}\\
&:=\begin{bmatrix}
\mathbf{X}_{11}(t) & \mathbf{X}_{12}(t)\\
\mathbf{X}_{21}(t) & \mathbf{X}_{22}(t)
\end{bmatrix}.
\end{align*}
The derivative is then
\begin{align*}
\frac{d}{dt}\mathbf{X}(t)&=
\begin{bmatrix}
\frac{d}{dt}\mathbf{X}_{11}(t) & \frac{d}{dt}\mathbf{X}_{12}(t)\\
\frac{d}{dt}\mathbf{X}_{21}(t) & \frac{d}{dt}\mathbf{X}_{22}(t)
\end{bmatrix}.
\end{align*}
with
\begin{align*}
\frac{d}{dt}\mathbf{X}_{11}(t)&=\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{A}(t),\\
\frac{d}{dt}\mathbf{X}_{12}(t)&= \frac{d}{dt}\int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du,\\
\frac{d}{dt}\mathbf{X}_{21}(t)&=\mathbf{0},\\
\frac{d}{dt}\mathbf{X}_{22}(t)&=\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\mathbf{C}(t).
\end{align*}
Consider that
\begin{align*}
\prod_{u}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)&=\prod_{u}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\underbrace{\prod_{t}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)}_{=\mathbf{I}}\\
&=\prod_{u}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big),
\end{align*}
hence using af Riemann approximation of the integral \(\mathbf{X}_{12}(t)\) we may write
\begin{align*}
\mathbf{X}_{12}(t)&=\int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\\
&=\int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\\
&=\lim_{n\to \infty}\frac{t-s}{n}\sum_{i=0}^n\prod_{s}^{s+(t-s)i/n}\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(s+(t-s)i/n)\prod_{s+(t-s)i/n}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\\
&\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\\
&=\left\{\lim_{n\to \infty}\frac{t-s}{n}\sum_{i=0}^n\prod_{s}^{s+(t-s)i/n}\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(s+(t-s)i/n)\prod_{s+(t-s)i/n}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\right\}\\
&\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\\
&=\left\{\int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\right\}\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big).
\end{align*}
We then get that
\begin{align*}
\frac{d}{dt}\mathbf{X}_{12}(t)&=\frac{d}{dt}\left\{\int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\right\}\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\\
&=\left\{\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(t)\prod_{t}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\right\}\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\\
&+\left\{\int_s^t\prod_{s}^u\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(u)\prod_{u}^s\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\ du\right\}\prod_{s}^t\big(\mathbf{I}+\mathbf{C}(x)\ dx\big)\mathbf{C}(t)\\
&=\prod_{s}^t\big(\mathbf{I}+\mathbf{A}(x)\ dx\big)\mathbf{B}(t)+\mathbf{X}_{12}(t)\mathbf{C}(t).
\end{align*}
We hope to show that \(\frac{d}{dt}\mathbf{X}(t)=\mathbf{X}(t)\mathbf{D}(t)\). Calculating the right side we have
\begin{align*}
\mathbf{X}(t)\mathbf{D}(t)&=
\begin{bmatrix}
\mathbf{X}_{11}(t) & \mathbf{X}_{12}(t)\\
\mathbf{0} & \mathbf{X}_{22}(t)
\end{bmatrix}
\begin{bmatrix}
\mathbf{A}(x) & \mathbf{B}(x)\\
\mathbf{0} & \mathbf{C}(x)
\end{bmatrix}\\
&=\begin{bmatrix}
\mathbf{X}_{11}(t)\mathbf{A}(x) & \mathbf{X}_{11}(t)\mathbf{B}(x)+\mathbf{X}_{12}(t)\mathbf{C}(x)\\
\mathbf{0} & \mathbf{X}_{22}(t)\mathbf{C}(x)
\end{bmatrix},
\end{align*}
given that \(\mathbf{X}\) satisfies the desired differential equation and so it follows that \(\mathbf{X}\) is the product integral \(\prod_{s}^t\big(\mathbf{I}+\mathbf{D}(x)\ dx\big)\) as desired.\(\blacksquare\)

\hypertarget{linear-algebra}{%
\chapter{Linear Algebra}\label{linear-algebra}}

\hypertarget{invertible-matrices}{%
\section{Invertible matrices}\label{invertible-matrices}}

This sections study some fundamental properties of the \emph{invertible matrix}\index{invertible matrix}. We start by defining what an invertible matrix is.

\textbf{Definition.} \emph{Let \(A\) be an \(n\times m\) matrix and \(B\) be an \(m\times n\) matrix. We say that \(A\) is invertible if}

\[
AB=I_{\min(m,n)}.
\]

\emph{In general, we only consider square matrices. If the above holds we say that \(B\) is \(A\)'s inverse and we write \(B=A^{-1}\).}

We can consider some equivalence statements regarding invertible matrices.

\textbf{Theorem.} \textbf{(The Invertible Matrix Theorem)} \emph{Let \(A\) be a \(n\times n\) matrix over a field \(K\) (\(\mathbb{R}^n\)), then the following statements are equivalent}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{There exists an \(n\times n\) matrix \(B\) such that \(AB=I_n=BA\).}
\item
  \emph{There exist either a left inverse \(B\) or a right invers \(C\) i.e.~\(BA=I_n=AC\). In this case, \(B=C\).}
\item
  \emph{\(A\) has an inverse and is nonsingular and is nondegenerate.}
\item
  \emph{\(A\) is row-equivalent to \(I_n\).}
\item
  \emph{\(A\) is column-equivalent to \(I_n\).}
\item
  \emph{\(A\) has \(n\) pivot positions.}
\item
  \emph{\(A\) has full rank i.e.~\(\text{rank}(A)=n\) (spans \(K\)).}
\item
  \emph{The equation \(Ax=0\) (\(x\in K\)) has only the trivial solution \(x=0\).}
\item
  \emph{The equation \(Ax=b\) has only one solution \(x\).}
\item
  \emph{The kernal of \(A\) is trivial i.e.~\(\text{ker}(A)=\{0\}\).}
\item
  \emph{The columns of \(A\) are linearly independent.}
\item
  \emph{The columns of \(A\) span \(K\).}
\item
  \emph{\(\text{span}(A)=K\).}
\item
  \emph{The columns of \(A\) form a basis of \(K\).}
\item
  \emph{The linear transformation \(Ax\) is a bijection from \(K\) to \(K\).}
\item
  \emph{\(A\) has non-zero determinant i.e.~\(\text{det}(A)\ne 0\).}
\item
  \emph{\(A\) has not 0 as an eigenvalue.}
\item
  \emph{The transpose of \(A\) is invertible.}
\item
  \emph{\(A\) can be expressed as a finite product of elemtary matrices.}
\end{enumerate}

We futhermore have some properties.

\textbf{Proposition.} \textbf{(Properties)} \emph{Let \(A\) be an \(n\times n\) invertible matrix. Then}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \((A^{-1})^{-1}=A\)
\item
  \((kA)^{-1}=k^{-1}A^{-1}\) \emph{with \(k\ne 0\).}
\item
  \((Ax)^+=x^+A^{-1}\) \emph{if \(A\) has orthonormal columns. \((\cdot)^+\) denotes the Moore-Penrose inverse and \(x\) is a vector.}
\item
  \emph{If \(B\) is an \(n\times n\) invertible matrix then \((AB)^{-1}=B^{-1}A^{-1}\).}
\item
  \(\text{det}(A^{-1})=(\text{det}(A))^{-1}\)
\end{enumerate}

The property 2 is especially useful in some settings. Consider for instance

\[
A=
\begin{bmatrix}
\sigma & 0\\
\sigma & \sigma
\end{bmatrix}=\sigma\begin{bmatrix}
1 & 0\\
1 & 1
\end{bmatrix}=\sigma \tilde{A}.
\]

Then we simply find the inverse of \(\tilde{A}\) and multiply by \(\sigma^{-1}\). That is,

\[
A^{-1}=\frac{1}{\sigma}\tilde{A}^{-1}=\frac{1}{\sigma}
\begin{bmatrix}
1 & 0\\
-1 & 1
\end{bmatrix}=
\begin{bmatrix}
1/\sigma & 0\\
-1/\sigma & 1/\sigma
\end{bmatrix}.
\]

We have an easy propositions regarding diagonal matrices.

\textbf{Proposition.} \emph{If \(A\) is an diagonal matrix\index{diagonal matrix}, then \(A\) is invertible. In particular,}

\[
A^{-1}=\text{diag}(A_{11}^{-1},...,A_{nn}^{-1}).
\]

\hypertarget{coding}{%
\chapter{Coding}\label{coding}}

\hypertarget{r-packages}{%
\section{R-Packages}\label{r-packages}}

\hypertarget{mlr3}{%
\subsection{mlr3}\label{mlr3}}

This short introduction to the \texttt{mlr3} package is based on the official documentation and introduction \href{https://mlr3book.mlr-org.com}{book} and exercises done in the course Machine Learning in Non-Life Insurance.

We start by installing the package \texttt{mlr3verse} containing all of the importatant packages.

\newpage

\printindex

  \bibliography{book.bib,packages.bib}

\end{document}
